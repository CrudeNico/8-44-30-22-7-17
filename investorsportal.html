<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investor Portal - Opessocius</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Image Modal/Lightbox Styles */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            animation: fadeIn 0.3s;
        }
        .image-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            animation: zoomIn 0.3s;
        }
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10001;
            background: rgba(0, 0, 0, 0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .image-modal-close:hover {
            background: rgba(0, 0, 0, 0.8);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="dashboard-active">
    <section class="user-dashboard" id="user-dashboard">
        <div class="dashboard-sidebar">
            <div class="sidebar-profile">
                <div class="sidebar-profile-image-container" id="profile-picture-container" style="position: relative; cursor: pointer; width: 80px; height: 80px; margin: 0 auto;">
                    <img src="" alt="Profile Picture" class="sidebar-profile-image" id="profile-picture-img" style="display: none; width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #ffffff; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);" />
                    <div class="profile-picture-placeholder" id="profile-picture-placeholder" style="width: 80px; height: 80px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 2rem; border: 3px solid #ffffff; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                        <span>ðŸ‘¤</span>
                    </div>
                    <div class="profile-picture-upload-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; font-size: 0.75rem; text-align: center; padding: 0.5rem; cursor: pointer;">
                        Click to upload
                    </div>
                </div>
                <input type="file" id="profile-picture-input" accept="image/*" style="display: none;" />
                <div class="sidebar-profile-name">John Investor</div>
            </div>
            <nav class="sidebar-navigation">
                <a href="#" class="sidebar-nav-item active">
                    <span>Dashboard</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Portfolio</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Transactions</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Performance</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Market News</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Account Settings</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Reports</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Learning</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Community</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <a href="index.html" class="sidebar-footer-item">
                    <span>Return to Home</span>
                </a>
                <a href="login.html" class="sidebar-footer-item" id="logout-btn">
                    <span>Logout</span>
                </a>
            </div>
        </div>
        <div class="dashboard-content">
            <!-- Dashboard View -->
            <div class="dashboard-view" id="dashboard-view" style="display: block;">
                <div class="dashboard-widgets-grid">
                    <!-- Crude Oil Price - Top Left -->
                    <div class="dashboard-widget dashboard-widget-oil" style="grid-column: 1; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Crude Oil Price</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="tradingview-widget-container-dashboard">
                                <div class="tradingview-widget-container__widget"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                                {
                                    "symbol": "USOIL",
                                    "width": "100%",
                                    "height": "160",
                                    "locale": "en",
                                    "dateRange": "1D",
                                    "colorTheme": "light",
                                    "trendLineColor": "rgba(37, 99, 235, 1)",
                                    "underLineColor": "rgba(37, 99, 235, 0.3)",
                                    "isTransparent": false,
                                    "autosize": true,
                                    "largeChartUrl": ""
                                }
                                </script>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Balance - Top Right Row 1 -->
                    <div class="dashboard-widget" style="grid-column: 2; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Current Balance</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="dashboard-main-metric" id="dashboard-current-balance">â‚¬287,450</div>
                            <div class="dashboard-sub-metric">Capital Invested: â‚¬230,000</div>
                        </div>
                    </div>
                    
                    <!-- Total Gain - Top Right Row 1 -->
                    <div class="dashboard-widget" style="grid-column: 3; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Total Gain</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="dashboard-main-metric dashboard-metric-positive" id="dashboard-total-gain">+24.98%</div>
                            <div class="dashboard-sub-metric">â‚¬57,450 profit</div>
                        </div>
                    </div>
                    
                    <!-- 12 Month Projection - Top Right Row 1 -->
                    <div class="dashboard-widget" style="grid-column: 4; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">12 Month Projection</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="dashboard-projection-value" id="dashboard-projection-value">â‚¬355,108</div>
                            <div class="dashboard-sub-metric">Projected ending capital</div>
                        </div>
                    </div>
                    
                    <!-- Latest News - Second Row -->
                    <div class="dashboard-widget dashboard-widget-clickable" id="dashboard-news-widget" style="grid-column: 1; grid-row: 2;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Latest News</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="dashboard-news-item">
                                <div class="dashboard-news-title">OPEC+ Maintains Production Cuts</div>
                            </div>
                            <div class="dashboard-news-item">
                                <div class="dashboard-news-title">Crude Oil Prices Rally on Middle East Tensions</div>
                            </div>
                            <div class="dashboard-news-item">
                                <div class="dashboard-news-title">US Shale Production Hits Record High</div>
                            </div>
                            <div class="dashboard-news-item">
                                <div class="dashboard-news-title">China's Oil Demand Growth Slows in Q4</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Latest Report - Second Row -->
                    <div class="dashboard-widget" id="dashboard-report-widget" style="grid-column: 2; grid-row: 2;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Latest Report</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <!-- Reports will be loaded dynamically by JavaScript -->
                            <div style="text-align: center; padding: 1rem; color: #9ca3af;">Loading reports...</div>
                        </div>
                    </div>
                    
                    <!-- Deposit Widget - Second Row -->
                    <div class="dashboard-widget" style="grid-column: 3; grid-row: 2;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Deposit Funds</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <form class="dashboard-transaction-form" id="deposit-form">
                                <div class="dashboard-form-group">
                                    <label for="deposit-amount" class="dashboard-form-label">Amount (â‚¬)</label>
                                    <input type="number" id="deposit-amount" class="dashboard-form-input" placeholder="Enter amount" min="1" step="0.01" required>
                                </div>
                                <button type="submit" class="dashboard-form-button dashboard-form-button-deposit">
                                    Send to Advisor
                                </button>
                                <div class="dashboard-form-note">Your advisor will receive the request and respond within 24 hours.</div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Withdrawal Widget - Second Row -->
                    <div class="dashboard-widget" style="grid-column: 4; grid-row: 2;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Withdraw Funds</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <form class="dashboard-transaction-form" id="withdrawal-form">
                                <div class="dashboard-form-group">
                                    <label for="withdrawal-amount" class="dashboard-form-label">Amount (â‚¬)</label>
                                    <input type="number" id="withdrawal-amount" class="dashboard-form-input" placeholder="Enter amount" min="1" step="0.01" required>
                                </div>
                                <button type="submit" class="dashboard-form-button dashboard-form-button-withdrawal">
                                    Send to Advisor
                                </button>
                                <div class="dashboard-form-note">Your advisor will receive the request and respond within 24 hours.</div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Top Stories -->
                    <div class="dashboard-widget">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Top Stories</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="tradingview-widget-container-dashboard">
                                <div class="tradingview-widget-container__widget"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-timeline.js" async>
                                {
                                    "feedMode": "all_symbols",
                                    "colorTheme": "light",
                                    "isTransparent": false,
                                    "displayMode": "regular",
                                    "width": "100%",
                                    "height": "300",
                                    "locale": "en"
                                }
                                </script>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Economic Calendar - Third Row, spans 3 columns -->
                    <div class="dashboard-widget dashboard-widget-wide" style="grid-column: 2 / 5; grid-row: 3;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Economic Calendar</h3>
                            <p class="dashboard-widget-subtitle" style="font-size: 0.75rem; color: #6b7280; margin: 0;">Keep track of key economic events</p>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="tradingview-widget-container-dashboard">
                                <div class="tradingview-widget-container__widget"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-events.js" async>
                                {
                                    "colorTheme": "light",
                                    "isTransparent": false,
                                    "width": "100%",
                                    "height": "300",
                                    "locale": "en",
                                    "importanceFilter": "-1,0,1"
                                }
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio View -->
            <div class="portfolio-view" id="portfolio-view" style="display: none;">
                <div class="portfolio-balance-cards">
                    <div class="balance-card">
                        <div class="balance-label">Capital Invested</div>
                        <div class="balance-amount" id="capital-invested">â‚¬230,000</div>
                    </div>
                    <div class="balance-card">
                        <div class="balance-label">Current Account Balance</div>
                        <div class="balance-amount" id="current-balance">â‚¬287,450</div>
                    </div>
                    <div class="balance-card">
                        <div class="balance-label">Total Gain</div>
                        <div class="balance-amount balance-amount-gain" id="total-gain">+24.98%</div>
                    </div>
                    <div class="balance-card">
                        <div class="balance-label">12 Month Projection</div>
                        <div class="balance-amount" id="portfolio-projection">â‚¬355,108</div>
                    </div>
                </div>
                <div class="portfolio-chart-container">
                    <div class="portfolio-chart-card">
                        <h3 class="portfolio-chart-title">Investment Performance & Projection</h3>
                        <div class="chart-wrapper">
                            <canvas id="portfolio-chart" width="800" height="400"></canvas>
                            <div id="chart-tooltip" class="chart-tooltip" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transactions View -->
            <div class="transactions-view" id="transactions-view" style="display: none;">
                <div class="transactions-table-container">
                    <table class="transactions-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Starting Balance</th>
                                <th>Ending Balance</th>
                                <th>Growth %</th>
                                <th>Deposits</th>
                                <th>Withdrawals</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table-body">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Performance View -->
            <div class="performance-view" id="performance-view" style="display: none;">
                <div class="performance-header">
                    <p class="performance-subtitle">Investment Performance Overview</p>
                </div>
                <div class="performance-chart-container">
                    <div class="portfolio-chart-card">
                        <h3 class="portfolio-chart-title">Investment Performance</h3>
                        <div class="chart-wrapper">
                            <canvas id="performance-chart" width="800" height="700"></canvas>
                            <div id="performance-tooltip" class="chart-tooltip" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Settings View -->
            <div class="account-settings-view" id="account-settings-view" style="display: none;">
                <div class="account-settings-content">
                    <h2 class="account-settings-title">Account Information</h2>
                    <div class="account-info-card">
                        <div class="account-info-row">
                            <div class="account-info-label">Full Name</div>
                            <div class="account-info-value">John Investor</div>
                        </div>
                        <div class="account-info-row">
                            <div class="account-info-label">Email Address</div>
                            <div class="account-info-value">john.investor@example.com</div>
                        </div>
                        <div class="account-info-row">
                            <div class="account-info-label">Phone Number</div>
                            <div class="account-info-value">+34 123 456 789</div>
                        </div>
                        <div class="account-info-row">
                            <div class="account-info-label">Account Number</div>
                            <div class="account-info-value">ACC-2024-001234</div>
                        </div>
                        <div class="account-info-row">
                            <div class="account-info-label">Account Status</div>
                            <div class="account-info-value account-status-active">Active</div>
                        </div>
                        <div class="account-info-row">
                            <div class="account-info-label">Member Since</div>
                            <div class="account-info-value">January 2024</div>
                        </div>
                        <div class="account-info-row">
                            <div class="account-info-label">Country</div>
                            <div class="account-info-value">Spain</div>
                        </div>
                    </div>

                    <h2 class="account-settings-title" style="margin-top: 3rem;">Investment Details</h2>
                    <div class="account-info-card">
                        <div class="account-info-row">
                            <div class="account-info-label">Initial Investment</div>
                            <div class="account-info-value">â‚¬230,000</div>
                        </div>
                        <div class="account-info-row">
                            <div class="account-info-label">Current Balance</div>
                            <div class="account-info-value">â‚¬287,450</div>
                        </div>
                        <div class="account-info-row">
                            <div class="account-info-label">Total Return</div>
                            <div class="account-info-value account-value-positive">+24.98%</div>
                        </div>
                        <div class="account-info-row">
                            <div class="account-info-label">Investment Strategy</div>
                            <div class="account-info-value">Crude Oil Futures</div>
                        </div>
                        <div class="account-info-row">
                            <div class="account-info-label">Assigned Operator Email</div>
                            <div class="account-info-value">operator@opessocius.com</div>
                        </div>
                    </div>

                    <div class="account-settings-note">
                        <p>Want to make changes? Contact support via your assigned operator.</p>
                    </div>
                </div>
            </div>

            <!-- Reports View -->
            <div class="reports-view" id="reports-view" style="display: none;">
                <div class="reports-content" style="padding: 2rem;">
                    <div style="margin-bottom: 2rem;">
                        <h2 style="margin: 0; font-size: 1.5rem; color: #1f2937; font-weight: 600;">Monthly Reports</h2>
                        <p style="margin-top: 0.5rem; color: #6b7280; font-size: 0.875rem;">View and download your monthly investment reports.</p>
                    </div>
                    <div id="reports-widgets-container">
                        <!-- Reports will be generated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Report Viewer Modal -->
            <div id="report-viewer-modal" class="admin-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; overflow-y: auto; pointer-events: none;">
                <div class="admin-modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; min-height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999; pointer-events: auto;"></div>
                <div class="admin-modal-container" id="report-viewer-container" style="max-width: 100%; width: auto; max-height: 85vh; position: fixed; top: auto; bottom: auto; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);">
                    <div class="admin-modal-content" style="padding: 0;">
                        <div style="padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: white; border-radius: 12px 12px 0 0;">
                            <h2 class="admin-modal-title" id="report-viewer-title" style="margin: 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Monthly Report</h2>
                            <span id="report-viewer-close" style="cursor: pointer; color: #6b7280; font-size: 1.5rem; line-height: 1; padding: 0.25rem; transition: color 0.2s;" onmouseover="this.style.color='#1f2937'" onmouseout="this.style.color='#6b7280'">&times;</span>
                        </div>
                        <div style="padding: 1.5rem; overflow: auto; max-height: calc(85vh - 80px); background: #f9fafb;">
                            <iframe id="report-viewer-iframe" style="width: 100%; height: 750px; border: 1px solid #e5e7eb; border-radius: 8px; background: white; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);"></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Learning View -->
            <div class="learning-view" id="learning-view" style="display: none;">
                <!-- Modules List View -->
                <div class="learning-content" id="modules-list-view">
                    <div style="margin-bottom: 2rem;">
                        <h2 style="margin: 0; font-size: 1.5rem; color: #1f2937;">Learning Modules</h2>
                        <p style="margin-top: 0.5rem; color: #6b7280; font-size: 0.875rem;">Explore our comprehensive learning modules to enhance your trading knowledge.</p>
                    </div>
                    
                    <div class="modules-grid" id="modules-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                        <!-- Modules will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Module Detail View -->
                <div class="module-detail-view" id="module-detail-view" style="display: none;">
                    <div style="position: relative; max-width: 900px; margin: 0 auto; padding: 2rem;">
                        <button id="close-module-btn" style="position: absolute; top: 1rem; right: 1rem; background: #1f2937; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 1000; transition: background 0.2s;" onmouseover="this.style.background='#374151'" onmouseout="this.style.background='#1f2937'">&times;</button>
                        <div id="module-detail-content" style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                            <!-- Module content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- One-on-ones View (Tier 3 only) -->
            <div class="one-on-ones-view" id="one-on-ones-view" style="display: none;">
                <div class="one-on-ones-content" style="max-width: 1400px; margin: 0 auto; display: flex; flex-direction: column; height: 100%;">
                    <div class="dashboard-widget" style="display: flex; flex-direction: column; flex: 1; min-height: 800px; height: calc(100vh - 120px);">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">One-on-one with Professor</h3>
                        </div>
                        <div class="dashboard-widget-content" style="flex: 1; display: flex; flex-direction: column; padding: 0; overflow: hidden;">
                            <!-- Chat Messages Area -->
                            <div id="one-on-one-chat-messages-container" style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 1rem; background: #f9fafb; display: flex; flex-direction: column; gap: 0.75rem; min-height: 0;">
                                <!-- Messages will be populated by JavaScript -->
                            </div>
                            
                            <!-- Chat Input Area -->
                            <div style="border-top: 1px solid #e5e7eb; padding: 1rem; background: white;">
                                <div id="one-on-one-chat-images-preview" style="display: none; margin-bottom: 0.75rem; padding: 0.75rem; background: #f3f4f6; border-radius: 6px;">
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;" id="one-on-one-chat-images-preview-container">
                                        <!-- Image previews will be shown here -->
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                                    <textarea id="one-on-one-chat-message-input" placeholder="Type your message..." style="flex: 1; padding: 0.5rem 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; resize: none; font-family: inherit; font-size: 0.875rem; min-height: 40px; max-height: 80px;" rows="1"></textarea>
                                    <label for="one-on-one-chat-image-input" style="cursor: pointer; padding: 0.5rem 1rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; color: #374151; display: inline-flex; align-items: center; gap: 0.5rem; white-space: nowrap; height: fit-content;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                            <polyline points="21 15 16 10 5 21"></polyline>
                                        </svg>
                                        Add Image
                                    </label>
                                    <input type="file" id="one-on-one-chat-image-input" accept="image/*" multiple style="display: none;">
                                    <button type="button" id="one-on-one-chat-send-btn" style="cursor: pointer; padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; border-radius: 6px; font-size: 0.875rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; white-space: nowrap; height: fit-content; transition: background 0.2s;">
                                        Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Community View -->
            <div class="community-view" id="community-view" style="display: none;">
                <div class="community-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <!-- Left Side - Professors Messages Widget -->
                    <div class="dashboard-widget" style="display: flex; flex-direction: column; height: 600px; max-height: 600px;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Professors' Messages</h3>
                        </div>
                        <div class="dashboard-widget-content" style="flex: 1; display: flex; flex-direction: column; padding: 0; overflow: hidden;">
                            <!-- Professors Messages Area -->
                            <div id="professors-messages-container" style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 1rem; background: #f9fafb; display: flex; flex-direction: column; gap: 1rem; min-height: 0;">
                                <!-- Professors messages will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Side - Group Chat Widget -->
                    <div class="dashboard-widget" style="display: flex; flex-direction: column; height: 600px; max-height: 600px;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Group Chat</h3>
                        </div>
                        <div class="dashboard-widget-content" style="flex: 1; display: flex; flex-direction: column; padding: 0; overflow: hidden;">
                            <!-- Chat Messages Area -->
                            <div id="community-chat-messages-container" style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 1rem; background: #f9fafb; display: flex; flex-direction: column; gap: 0.75rem; min-height: 0;">
                                <!-- Messages will be populated by JavaScript -->
                            </div>
                            
                            <!-- Chat Input Area -->
                            <div style="border-top: 1px solid #e5e7eb; padding: 1rem; background: white;">
                                <div id="community-chat-images-preview" style="display: none; margin-bottom: 0.75rem; padding: 0.75rem; background: #f3f4f6; border-radius: 6px;">
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;" id="community-chat-images-preview-container">
                                        <!-- Image previews will be shown here -->
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                                    <textarea id="community-chat-message-input" placeholder="Type your message..." style="flex: 1; padding: 0.5rem 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; resize: none; font-family: inherit; font-size: 0.875rem; min-height: 40px; max-height: 80px;" rows="1"></textarea>
                                    <label for="community-chat-image-input" style="cursor: pointer; padding: 0.5rem 1rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; color: #374151; display: inline-flex; align-items: center; gap: 0.5rem; white-space: nowrap; height: fit-content;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                            <polyline points="21 15 16 10 5 21"></polyline>
                                        </svg>
                                        Add Image
                                    </label>
                                    <input type="file" id="community-chat-image-input" accept="image/*" multiple style="display: none;">
                                    <button type="button" id="community-chat-send-btn" style="cursor: pointer; padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; border-radius: 6px; font-size: 0.875rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; white-space: nowrap; height: fit-content; transition: background 0.2s;">
                                        Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Weekly Reports Widget - Full Width Below -->
                    <div class="dashboard-widget" style="grid-column: 1 / -1; margin-top: 0.25rem;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Weekly Reports</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div id="weekly-reports-display" style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                                <!-- Weekly Reports will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market News View -->
            <div class="market-news-view" id="market-news-view" style="display: none;">
                <div class="market-news-content">
                    <div class="market-news-chart-section">
                        <div class="tradingview-widget-container market-news-chart">
                            <div id="market_news_chart"></div>
                            <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
                            <script type="text/javascript">
                                new TradingView.widget({
                                    "width": "100%",
                                    "height": 500,
                                    "symbol": "USOIL",
                                    "interval": "60",
                                    "theme": "light",
                                    "style": "1",
                                    "timezone": "Europe/Amsterdam",
                                    "locale": "en",
                                    "allow_symbol_change": true,
                                    "withdateranges": true,
                                    "container_id": "market_news_chart",
                                    "hide_volume": true,
                                    "studies": [
                                        {
                                            "id": "MASimple@tv-basicstudies",
                                            "inputs": {
                                                "length": 200,
                                                "source": "close",
                                                "maType": "EMA"
                                            },
                                            "overrides": {
                                                "plot.color": "#FFFF00",
                                                "plot.linewidth": 3
                                            }
                                        }
                                    ]
                                });
                            </script>
                        </div>
                    </div>
                    <div class="market-news-articles-section">
                        <div class="news-grid" id="news-grid">
                            <!-- News articles will be loaded from Firestore -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <script src="script.js"></script>
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
    
    <!-- Community Messages Firestore Service -->
    <script src="firestore-service-community-messages.js"></script>
    
    <!-- Weekly Reports Firestore Service -->
    <script src="firestore-service-weekly-reports.js"></script>
    
    <!-- Firebase Configuration and Service -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD9DvEzXUxUppgsp71H5d3abPKWkjkea6A",
            authDomain: "opessocius-17ab9.firebaseapp.com",
            projectId: "opessocius-17ab9",
            storageBucket: "opessocius-17ab9.firebasestorage.app",
            messagingSenderId: "835445796116",
            appId: "1:835445796116:web:71b8595886ecb53e612601",
            measurementId: "G-44CX9N3E3J"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Initialize services
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();
        const analytics = firebase.analytics();
        
        // Make available globally
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseStorage = storage;
        window.firebaseAnalytics = analytics;
        window.firebase = firebase;
        
        // Firestore Service Functions for News (using CDN API)
        window.firestoreService = {
            NEWS_COLLECTION: 'marketNews',
            
            // Get all news articles
            getAllNews: async function() {
                try {
                    const snapshot = await db.collection(this.NEWS_COLLECTION)
                        .orderBy('order', 'asc')
                        .orderBy('createdAt', 'desc')
                        .get();
                    const news = [];
                    snapshot.forEach((doc) => {
                        news.push({ id: doc.id, ...doc.data() });
                    });
                    return news;
                } catch (error) {
                    console.error('Error getting news:', error);
                    // If orderBy fails (no index), try without order
                    try {
                        const snapshot = await db.collection(this.NEWS_COLLECTION)
                            .orderBy('createdAt', 'desc')
                            .get();
                        const news = [];
                        snapshot.forEach((doc) => {
                            news.push({ id: doc.id, ...doc.data() });
                        });
                        // Sort by order manually
                        news.sort((a, b) => (a.order || 0) - (b.order || 0));
                        return news;
                    } catch (error2) {
                        console.error('Error getting news (fallback):', error2);
                        return [];
                    }
                }
            }
        };
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Profile Picture Functions (defined first)
            function loadProfilePicture(profilePictureUrl) {
                const profileImg = document.getElementById('profile-picture-img');
                const placeholder = document.getElementById('profile-picture-placeholder');
                
                if (profilePictureUrl && profilePictureUrl.trim() !== '') {
                    profileImg.src = profilePictureUrl;
                    profileImg.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                } else {
                    profileImg.style.display = 'none';
                    if (placeholder) placeholder.style.display = 'flex';
                }
            }
            
            // Load and display user data
            async function loadUserData() {
                try {
                    // Try to get user-specific session first, then fall back to 'user'
                    let userSession = sessionStorage.getItem('investorUser') || sessionStorage.getItem('user');
                    if (!userSession) {
                        console.warn('No user session found');
                        return;
                    }
                    
                    const user = JSON.parse(userSession);
                    let userData = user.userData || {};
                    
                    // Ensure we're not loading admin data - check if it's an investor
                    if (userData.type && userData.type === 'admin') {
                        console.warn('Admin session detected in investor portal');
                        return;
                    }
                    
                    // Fetch fresh user data from Firestore to ensure we have the latest data for THIS specific user
                    if (window.firebaseDb) {
                        try {
                            let userDoc = null;
                            
                            // First try using userData.id (Firestore document ID)
                            let foundUserDoc = null;
                            if (userData.id) {
                                const docSnapshot = await window.firebaseDb.collection('users').doc(userData.id).get();
                                if (docSnapshot.exists) {
                                    foundUserDoc = { id: docSnapshot.id, data: docSnapshot.data() };
                                }
                            }
                            
                            // If not found or no ID, find by username (most reliable identifier)
                            if (!foundUserDoc && user.username) {
                                const userQuery = await window.firebaseDb.collection('users')
                                    .where('username', '==', user.username)
                                    .where('type', '==', 'investor')
                                    .limit(1)
                                    .get();
                                
                                if (!userQuery.empty) {
                                    const doc = userQuery.docs[0];
                                    foundUserDoc = { id: doc.id, data: doc.data() };
                                }
                            }
                            
                            // If still not found, try by email
                            if (!foundUserDoc && userData.email) {
                                const userQuery = await window.firebaseDb.collection('users')
                                    .where('email', '==', userData.email)
                                    .where('type', '==', 'investor')
                                    .limit(1)
                                    .get();
                                
                                if (!userQuery.empty) {
                                    const doc = userQuery.docs[0];
                                    foundUserDoc = { id: doc.id, data: doc.data() };
                                }
                            }
                            
                            if (foundUserDoc && foundUserDoc.id && foundUserDoc.data) {
                                // Update with fresh data from Firestore
                                userData = { 
                                    id: foundUserDoc.id, 
                                    ...foundUserDoc.data 
                                };
                                
                                // Update sessionStorage with fresh data
                                user.userData = userData;
                                sessionStorage.setItem('investorUser', JSON.stringify(user));
                                sessionStorage.setItem('user', JSON.stringify(user));
                                console.log('Loaded fresh user data from Firestore for user:', userData.id, 'username:', userData.username);
                            } else {
                                console.warn('User document not found in Firestore for username:', user.username);
                            }
                        } catch (error) {
                            console.error('Error fetching user data from Firestore:', error);
                            // Continue with cached data if Firestore fetch fails
                        }
                    }
                    
                    // Update sidebar profile name
                    const sidebarProfileName = document.querySelector('.sidebar-profile-name');
                    if (sidebarProfileName) {
                        sidebarProfileName.textContent = userData.fullName || user.username || 'Investor';
                    }
                    
                    // Load and display profile picture from userData (which comes from Firestore)
                    loadProfilePicture(userData.profilePictureUrl);
                    
                    // Store user tier globally for access control
                    window.currentUserTier = userData.tier || 'tier1';
                    window.currentUserId = userData.id;
                    window.currentUserType = 'investor';
                    
                    // Add One-on-ones navigation item for Tier 3 users
                    const sidebarNav = document.querySelector('.sidebar-navigation');
                    if (sidebarNav && window.currentUserTier === 'tier3') {
                        // Check if One-on-ones nav item already exists
                        let oneOnOnesNavItem = document.querySelector('.sidebar-nav-item[data-nav="one-on-ones"]');
                        if (!oneOnOnesNavItem) {
                            oneOnOnesNavItem = document.createElement('a');
                            oneOnOnesNavItem.href = '#';
                            oneOnOnesNavItem.className = 'sidebar-nav-item';
                            oneOnOnesNavItem.setAttribute('data-nav', 'one-on-ones');
                            oneOnOnesNavItem.innerHTML = '<span>One-on-ones</span>';
                            sidebarNav.appendChild(oneOnOnesNavItem);
                            // Re-setup navigation handlers
                            setTimeout(setupNavigation, 100);
                        }
                    } else if (sidebarNav) {
                        // Remove One-on-ones nav item if user is not Tier 3
                        const existingOneOnOnesNavItem = document.querySelector('.sidebar-nav-item[data-nav="one-on-ones"]');
                        if (existingOneOnOnesNavItem) {
                            existingOneOnOnesNavItem.remove();
                        }
                    }
                    
                    // Format date helper
                    function formatDate(dateValue) {
                        if (!dateValue) return 'N/A';
                        try {
                            let date;
                            if (dateValue.toDate) {
                                // Firestore Timestamp
                                date = dateValue.toDate();
                            } else if (dateValue instanceof Date) {
                                date = dateValue;
                            } else if (typeof dateValue === 'string') {
                                date = new Date(dateValue);
                            } else {
                                return 'N/A';
                            }
                            
                            return date.toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'long' 
                            });
                        } catch (error) {
                            console.error('Error formatting date:', error);
                            return 'N/A';
                        }
                    }
                    
                    // Format currency helper
                    function formatCurrency(amount) {
                        if (amount === null || amount === undefined) return 'â‚¬0';
                        const numAmount = typeof amount === 'number' ? amount : parseFloat(amount) || 0;
                        return new Intl.NumberFormat('en-US', {
                            style: 'currency',
                            currency: 'EUR',
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }).format(numAmount);
                    }
                    
                    // Format percentage helper
                    function formatPercentage(value) {
                        if (value === null || value === undefined) return '0%';
                        const numValue = typeof value === 'number' ? value : parseFloat(value) || 0;
                        const sign = numValue >= 0 ? '+' : '';
                        return `${sign}${numValue.toFixed(2)}%`;
                    }
                    
                    // Load transactions to calculate accurate dashboard values
                    let transactions = [];
                    let currentBalance = userData.initialInvestment || 0;
                    let totalGrowthSum = 0;
                    
                    if (window.firebaseDb && userData.id) {
                        try {
                            const transactionsSnapshot = await window.firebaseDb.collection('users').doc(userData.id)
                                .collection('transactions')
                                .get();
                            
                            if (!transactionsSnapshot.empty) {
                                transactionsSnapshot.forEach((doc) => {
                                    transactions.push(doc.data());
                                });
                                
                                // Sort by year, then monthIndex
                                transactions.sort((a, b) => {
                                    if (a.year !== b.year) {
                                        return a.year - b.year;
                                    }
                                    return (a.monthIndex || 0) - (b.monthIndex || 0);
                                });
                                
                                // Get most recent transaction's final balance (ending balance - withdrawals)
                                if (transactions.length > 0) {
                                    const lastTransaction = transactions[transactions.length - 1];
                                    currentBalance = lastTransaction.endingBalance - (lastTransaction.withdrawals || 0);
                                }
                                
                                // Sum all growth percentages
                                totalGrowthSum = transactions.reduce((sum, entry) => sum + (entry.growth || 0), 0);
                            }
                        } catch (error) {
                            console.error('Error loading transactions for dashboard:', error);
                            // Use fallback values from userData
                            currentBalance = userData.currentBalance || userData.initialInvestment || 0;
                            totalGrowthSum = userData.totalReturn || 0;
                        }
                    } else {
                        // Fallback to userData values
                        currentBalance = userData.currentBalance || userData.initialInvestment || 0;
                        totalGrowthSum = userData.totalReturn || 0;
                    }
                    
                    // Update Dashboard Widgets with Transaction-Based Data
                    const currentBalanceWidget = document.getElementById('dashboard-current-balance');
                    const currentBalanceContainer = currentBalanceWidget?.closest('.dashboard-widget-content');
                    const capitalInvestedSubMetric = currentBalanceContainer?.querySelector('.dashboard-sub-metric');
                    const totalGainWidget = document.getElementById('dashboard-total-gain');
                    const totalGainContainer = totalGainWidget?.closest('.dashboard-widget-content');
                    const profitSubMetric = totalGainContainer?.querySelector('.dashboard-sub-metric');
                    
                    const initialInvestment = userData.initialInvestment || 0;
                    
                    if (currentBalanceWidget) {
                        currentBalanceWidget.textContent = formatCurrency(currentBalance);
                    }
                    
                    if (capitalInvestedSubMetric) {
                        capitalInvestedSubMetric.textContent = `Capital Invested: ${formatCurrency(initialInvestment)}`;
                    }
                    
                    if (totalGainWidget) {
                        const returnText = formatPercentage(totalGrowthSum);
                        totalGainWidget.textContent = returnText;
                        
                        // Update class for positive/negative
                        totalGainWidget.className = 'dashboard-main-metric';
                        if (totalGrowthSum >= 0) {
                            totalGainWidget.classList.add('dashboard-metric-positive');
                        } else {
                            totalGainWidget.classList.add('dashboard-metric-negative');
                        }
                    }
                    
                    if (profitSubMetric) {
                        // Calculate profit: Most current Ending Balance - First ever Starting Balance - all Deposits + all Withdrawals
                        let profit = 0;
                        if (transactions.length > 0) {
                            // Get most current ending balance (final balance after withdrawals)
                            const mostCurrentEntry = transactions[transactions.length - 1];
                            const mostCurrentEndingBalance = mostCurrentEntry.endingBalance || 0;
                            const mostCurrentWithdrawals = mostCurrentEntry.withdrawals || 0;
                            const mostCurrentFinalBalance = mostCurrentEndingBalance - mostCurrentWithdrawals;
                            
                            // Get first ever starting balance
                            const firstStartingBalance = transactions[0].startingBalance || 0;
                            
                            // Sum all deposits
                            let totalDeposits = 0;
                            transactions.forEach((entry) => {
                                totalDeposits += (entry.deposits || 0);
                            });
                            
                            // Sum all withdrawals
                            let totalWithdrawals = 0;
                            transactions.forEach((entry) => {
                                totalWithdrawals += (entry.withdrawals || 0);
                            });
                            
                            // Calculate profit: Most current Ending Balance - First ever Starting Balance - all Deposits + all Withdrawals
                            profit = mostCurrentFinalBalance - firstStartingBalance - totalDeposits + totalWithdrawals;
                        }
                        
                        const profitText = `â‚¬${profit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} profit`;
                        profitSubMetric.textContent = profitText;
                    }
                    
                    // Update projection with current balance from transactions
                    setTimeout(function() {
                        calculateProjectionValue({ currentBalance: currentBalance, initialInvestment: initialInvestment });
                    }, 100);
                    
                    // Update Account Settings - Account Information
                    const accountSettingsView = document.getElementById('account-settings-view');
                    if (accountSettingsView) {
                        // Full Name
                        const fullNameElement = accountSettingsView.querySelector('.account-info-row:nth-child(1) .account-info-value');
                        if (fullNameElement) {
                            fullNameElement.textContent = userData.fullName || user.username || 'N/A';
                        }
                        
                        // Email Address
                        const emailElement = accountSettingsView.querySelector('.account-info-row:nth-child(2) .account-info-value');
                        if (emailElement) {
                            emailElement.textContent = userData.email || user.email || 'N/A';
                        }
                        
                        // Phone Number
                        const phoneElement = accountSettingsView.querySelector('.account-info-row:nth-child(3) .account-info-value');
                        if (phoneElement) {
                            phoneElement.textContent = userData.phone || 'N/A';
                        }
                        
                        // Account Number
                        const accountNumberElement = accountSettingsView.querySelector('.account-info-row:nth-child(4) .account-info-value');
                        if (accountNumberElement) {
                            accountNumberElement.textContent = userData.accountNumber || 'N/A';
                        }
                        
                        // Account Status
                        const accountStatusElement = accountSettingsView.querySelector('.account-info-row:nth-child(5) .account-info-value');
                        if (accountStatusElement) {
                            const status = userData.accountStatus || 'Active';
                            accountStatusElement.textContent = status;
                            // Update status class
                            accountStatusElement.className = 'account-info-value';
                            if (status.toLowerCase() === 'active') {
                                accountStatusElement.classList.add('account-status-active');
                            } else if (status.toLowerCase() === 'inactive' || status.toLowerCase() === 'suspended') {
                                accountStatusElement.classList.add('account-status-inactive');
                            }
                        }
                        
                        // Member Since
                        const memberSinceElement = accountSettingsView.querySelector('.account-info-row:nth-child(6) .account-info-value');
                        if (memberSinceElement) {
                            memberSinceElement.textContent = formatDate(userData.memberSince);
                        }
                        
                        // Country
                        const countryElement = accountSettingsView.querySelector('.account-info-row:nth-child(7) .account-info-value');
                        if (countryElement) {
                            countryElement.textContent = userData.country || 'N/A';
                        }
                        
                        // Investment Details
                        // Initial Investment
                        const initialInvestmentElement = accountSettingsView.querySelectorAll('.account-info-card')[1]?.querySelector('.account-info-row:nth-child(1) .account-info-value');
                        if (initialInvestmentElement) {
                            initialInvestmentElement.textContent = formatCurrency(userData.initialInvestment);
                        }
                        
                        // Current Balance
                        const currentBalanceElement = accountSettingsView.querySelectorAll('.account-info-card')[1]?.querySelector('.account-info-row:nth-child(2) .account-info-value');
                        if (currentBalanceElement) {
                            currentBalanceElement.textContent = formatCurrency(userData.currentBalance);
                        }
                        
                        // Total Return
                        const totalReturnElement = accountSettingsView.querySelectorAll('.account-info-card')[1]?.querySelector('.account-info-row:nth-child(3) .account-info-value');
                        if (totalReturnElement) {
                            const returnValue = userData.totalReturn || 0;
                            totalReturnElement.textContent = formatPercentage(returnValue);
                            // Update class for positive/negative
                            totalReturnElement.className = 'account-info-value';
                            if (returnValue >= 0) {
                                totalReturnElement.classList.add('account-value-positive');
                            } else {
                                totalReturnElement.classList.add('account-value-negative');
                            }
                        }
                        
                        // Investment Strategy
                        const strategyElement = accountSettingsView.querySelectorAll('.account-info-card')[1]?.querySelector('.account-info-row:nth-child(4) .account-info-value');
                        if (strategyElement) {
                            strategyElement.textContent = userData.investmentStrategy || 'N/A';
                        }
                        
                        // Assigned Operator Email
                        const operatorElement = accountSettingsView.querySelectorAll('.account-info-card')[1]?.querySelector('.account-info-row:nth-child(5) .account-info-value');
                        if (operatorElement) {
                            operatorElement.textContent = userData.assignedOperatorEmail || 'N/A';
                        }
                    }
                    
                    // Recalculate projection with user-specific data
                    setTimeout(function() {
                        calculateProjectionValue(userData);
                    }, 100);
                    
                    console.log('User data loaded successfully');
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            }
            
            // Load user data on page load
            loadUserData();
            
            // Navigation handling
            let navItems = document.querySelectorAll('.sidebar-nav-item');
            const dashboardView = document.getElementById('dashboard-view');
            const portfolioView = document.getElementById('portfolio-view');
            const transactionsView = document.getElementById('transactions-view');
            const performanceView = document.getElementById('performance-view');
            
            function setupNavigation() {
                navItems = document.querySelectorAll('.sidebar-nav-item');
                navItems.forEach(item => {
                    // Remove existing listeners by cloning (simplified approach)
                    const newItem = item.cloneNode(true);
                    item.parentNode.replaceChild(newItem, item);
                    
                    // Add click listener to new item
                    newItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        // Get text from span element or data attribute
                        const span = this.querySelector('span');
                        const navText = span ? span.textContent.trim() : this.textContent.trim();
                        const navData = this.getAttribute('data-nav');
                        
                        // Remove active class from all items
                        document.querySelectorAll('.sidebar-nav-item').forEach(nav => nav.classList.remove('active'));
                        // Add active class to clicked item
                        this.classList.add('active');
                        
                        // Get all views
                        const marketNewsView = document.getElementById('market-news-view');
                        const accountSettingsView = document.getElementById('account-settings-view');
                        const reportsView = document.getElementById('reports-view');
                        const learningView = document.getElementById('learning-view');
                        const communityView = document.getElementById('community-view');
                        const oneOnOnesView = document.getElementById('one-on-ones-view');
                        
                        // Hide all views
                        if (dashboardView) dashboardView.style.display = 'none';
                        if (portfolioView) portfolioView.style.display = 'none';
                        if (transactionsView) transactionsView.style.display = 'none';
                        if (performanceView) performanceView.style.display = 'none';
                        if (marketNewsView) marketNewsView.style.display = 'none';
                        if (accountSettingsView) accountSettingsView.style.display = 'none';
                        if (reportsView) reportsView.style.display = 'none';
                        if (learningView) learningView.style.display = 'none';
                        if (communityView) communityView.style.display = 'none';
                        if (oneOnOnesView) oneOnOnesView.style.display = 'none';
                        
                        // Show selected view
                        if ((navText === 'Dashboard' || !navData) && dashboardView) {
                            dashboardView.style.display = 'block';
                        } else if (navText === 'Portfolio' && portfolioView) {
                            portfolioView.style.display = 'block';
                            setTimeout(async function() {
                                await drawPortfolioChart(); // This will update the balance cards
                                calculateProjectionValue();
                            }, 100);
                        } else if (navText === 'Transactions' && transactionsView) {
                            transactionsView.style.display = 'block';
                            populateTransactionsTable();
                        } else if (navText === 'Performance' && performanceView) {
                            performanceView.style.display = 'block';
                            setTimeout(async function() {
                                await drawPerformanceChart();
                                setTimeout(setupPerformanceChartHover, 150);
                            }, 100);
                        } else if (navText === 'Market News' && marketNewsView) {
                            marketNewsView.style.display = 'block';
                            loadMarketNews();
                        } else if (navText === 'Account Settings' && accountSettingsView) {
                            accountSettingsView.style.display = 'block';
                        } else if (navText === 'Reports' && reportsView) {
                            reportsView.style.display = 'block';
                            setTimeout(function() {
                                generateReportWidgets();
                            }, 100);
                        } else if (navText === 'Learning' && learningView) {
                            learningView.style.display = 'block';
                            loadModulesList();
                        } else if (navText === 'Community' && communityView) {
                            communityView.style.display = 'block';
                            loadCommunityChatMessages();
                            loadProfessorsMessages();
                            loadWeeklyReports();
                        } else if ((navText === 'One-on-ones' || navData === 'one-on-ones') && oneOnOnesView) {
                            oneOnOnesView.style.display = 'block';
                            loadOneOnOneChatMessages();
                        }
                    });
                });
            }
            
            // Initial setup
            setupNavigation();

            // Portfolio Chart Function - Load from Firestore
            let chartDataPoints = [];
            
            async function drawPortfolioChart() {
                const canvas = document.getElementById('portfolio-chart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const container = canvas.parentElement;
                const width = container ? container.clientWidth - 64 : 800;
                const height = 480;
                
                // Set canvas size
                canvas.width = width;
                canvas.height = height;
                
                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                
                // Chart configuration
                const padding = { top: 40, right: 40, bottom: 60, left: 80 };
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;
                
                try {
                    // Get user session
                    const userSession = sessionStorage.getItem('investorUser') || sessionStorage.getItem('user');
                    if (!userSession || !window.firebaseDb) {
                        // Show empty state
                        ctx.fillStyle = '#6b7280';
                        ctx.font = '16px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('No entries yet. Chart will appear here once transactions are added.', width / 2, height / 2);
                        return;
                    }

                    const user = JSON.parse(userSession);
                    const userData = user.userData || {};
                    const userId = userData.id;
                    const initialInvestment = userData.initialInvestment || 0;

                    if (!userId) {
                        ctx.fillStyle = '#6b7280';
                        ctx.font = '16px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('No entries yet. Chart will appear here once transactions are added.', width / 2, height / 2);
                        return;
                    }

                    // Load transactions from Firestore (without composite index - sort in JavaScript)
                    const transactionsSnapshot = await window.firebaseDb.collection('users').doc(userId)
                        .collection('transactions')
                        .get();

                    if (transactionsSnapshot.empty) {
                        // Show empty state
                        ctx.fillStyle = '#6b7280';
                        ctx.font = '16px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('No performance data yet. Chart will appear here once transactions are added.', width / 2, height / 2);
                        return;
                    }

                    // Build historical data from transactions - sort by year, then monthIndex
                    const transactions = [];
                    transactionsSnapshot.forEach((doc) => {
                        transactions.push(doc.data());
                    });
                    
                    // Sort by year, then monthIndex
                    transactions.sort((a, b) => {
                        if (a.year !== b.year) {
                            return a.year - b.year;
                        }
                        return (a.monthIndex || 0) - (b.monthIndex || 0);
                    });
                    
                    // Store transaction metadata for labels
                    const monthNameMap = {
                        'January': 'Jan', 'February': 'Feb', 'March': 'Mar', 'April': 'Apr',
                        'May': 'May', 'June': 'Jun', 'July': 'Jul', 'August': 'Aug',
                        'September': 'Sep', 'October': 'Oct', 'November': 'Nov', 'December': 'Dec'
                    };
                    
                    const transactionLabels = transactions.map(entry => {
                        const monthShort = entry.month ? (monthNameMap[entry.month] || entry.month.substring(0, 3)) : '';
                        const yearShort = entry.year ? String(entry.year).slice(-2) : '';
                        return `${monthShort} ${yearShort}`;
                    });
                    
                    const historicalData = transactions.map(entry => entry.endingBalance);
                    const historicalGrowth = transactions.map(entry => entry.growth || 0); // Store actual growth % from transaction

                    // If no transactions, start with initial investment
                    if (historicalData.length === 0) {
                        historicalData.push(initialInvestment);
                        historicalGrowth.push(0);
                        transactionLabels.push('Start');
                    }

                    // Generate projection data (12 months forward with 2% monthly growth)
                    const lastHistoricalValue = historicalData[historicalData.length - 1];
                    const monthlyGrowthRate = 0.02; // 2% per month
                    const projectionData = [];
                    const projectionLabels = [];
                    let projectionBalance = lastHistoricalValue;
                    
                    // Calculate next month/year for projection labels
                    let projectionMonth = transactions.length > 0 ? transactions[transactions.length - 1].monthIndex : 0;
                    let projectionYear = transactions.length > 0 ? transactions[transactions.length - 1].year : new Date().getFullYear();
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    
                    for (let i = 0; i < 12; i++) {
                        projectionBalance = projectionBalance * (1 + monthlyGrowthRate);
                        projectionData.push(projectionBalance);
                        
                        // Calculate next month label
                        projectionMonth = (projectionMonth + 1) % 12;
                        if (projectionMonth === 0) projectionYear++;
                        const yearShort = String(projectionYear).slice(-2);
                        projectionLabels.push(`${monthNames[projectionMonth]} ${yearShort}`);
                    }
                    
                    // Combine data
                    const allData = [...historicalData, ...projectionData];
                    const maxValue = Math.max(...allData) * 1.1;
                    const minValue = Math.min(...allData) * 0.9;
                    const valueRange = maxValue - minValue;
                
                    // Store data points for hover interaction
                    chartDataPoints = [];
                    
                    const historicalCount = historicalData.length;
                    const totalDataPoints = historicalCount + projectionData.length;
                    const dataPointWidth = chartWidth / Math.max(totalDataPoints, 1);
                    
                    // Combine labels
                    const allLabels = [...transactionLabels, ...projectionLabels];
                    
                    // Calculate x and y positions for all points
                    allData.forEach((value, index) => {
                        const x = padding.left + dataPointWidth * index + dataPointWidth / 2;
                        const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                        
                        // For historical data, use actual growth from transaction; for projection, use 2%
                        let growthPercent;
                        if (index < historicalCount) {
                            growthPercent = historicalGrowth[index].toFixed(2);
                        } else {
                            growthPercent = '2.00'; // Projection growth
                        }
                        
                        chartDataPoints.push({
                            x: x,
                            y: y,
                            value: value,
                            month: allLabels[index] || `Month ${index + 1}`,
                            growthPercent: growthPercent,
                            isHistorical: index < historicalCount
                        });
                    });
                    
                    // Helper function for currency formatting
                    function formatCurrency(amount) {
                        if (amount === null || amount === undefined) return 'â‚¬0';
                        const numAmount = typeof amount === 'number' ? amount : parseFloat(amount) || 0;
                        return new Intl.NumberFormat('en-US', {
                            style: 'currency',
                            currency: 'EUR',
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }).format(numAmount);
                    }
                    
                    // Update Portfolio balance cards
                    const capitalInvestedEl = document.getElementById('capital-invested');
                    const currentBalanceEl = document.getElementById('current-balance');
                    const totalGainEl = document.getElementById('total-gain');
                    
                    if (capitalInvestedEl) {
                        capitalInvestedEl.textContent = formatCurrency(initialInvestment);
                    }
                    
                    if (currentBalanceEl && transactions.length > 0) {
                        // Use ending balance of most recent transaction
                        const mostRecentTransaction = transactions[transactions.length - 1];
                        currentBalanceEl.textContent = formatCurrency(mostRecentTransaction.endingBalance);
                    } else if (currentBalanceEl) {
                        currentBalanceEl.textContent = formatCurrency(initialInvestment);
                    }
                    
                    if (totalGainEl && transactions.length > 0) {
                        // Sum all growth percentages from transactions
                        const totalGrowthSum = transactions.reduce((sum, entry) => sum + (entry.growth || 0), 0);
                        const sign = totalGrowthSum >= 0 ? '+' : '';
                        totalGainEl.textContent = `${sign}${totalGrowthSum.toFixed(2)}%`;
                        totalGainEl.className = 'balance-amount balance-amount-gain';
                        if (totalGrowthSum < 0) {
                            totalGainEl.classList.add('balance-amount-loss');
                        }
                    } else if (totalGainEl) {
                        totalGainEl.textContent = '+0.00%';
                        totalGainEl.className = 'balance-amount balance-amount-gain';
                    }
                    
                    // Draw grid lines
                    ctx.strokeStyle = '#e5e7eb';
                    ctx.lineWidth = 1;
                    for (let i = 0; i <= 5; i++) {
                        const y = padding.top + (chartHeight / 5) * i;
                        ctx.beginPath();
                        ctx.moveTo(padding.left, y);
                        ctx.lineTo(width - padding.right, y);
                        ctx.stroke();
                    }
                    
                    // Draw area fill below the line (only historical section with gradient)
                    if (historicalData.length > 0) {
                        const gradient = ctx.createLinearGradient(
                            padding.left, 
                            padding.top, 
                            padding.left + dataPointWidth * historicalCount, 
                            padding.top + chartHeight
                        );
                        gradient.addColorStop(0, 'rgba(37, 99, 235, 0.25)');
                        gradient.addColorStop(1, 'rgba(37, 99, 235, 0.05)');
                        
                        ctx.beginPath();
                        const firstX = padding.left + dataPointWidth / 2;
                        const firstY = padding.top + chartHeight - ((historicalData[0] - minValue) / valueRange) * chartHeight;
                        ctx.moveTo(firstX, height - padding.bottom);
                        ctx.lineTo(firstX, firstY);
                        
                        // Historical area only
                        historicalData.forEach((value, index) => {
                            const x = padding.left + dataPointWidth * index + dataPointWidth / 2;
                            const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                            ctx.lineTo(x, y);
                        });
                        
                        // Close at the last historical point
                        const lastHistoricalX = padding.left + dataPointWidth * (historicalCount - 1) + dataPointWidth / 2;
                        ctx.lineTo(lastHistoricalX, height - padding.bottom);
                        ctx.closePath();
                        ctx.fillStyle = gradient;
                        ctx.fill();
                    }
                    
                    // Draw historical line
                    if (historicalData.length > 0) {
                        ctx.beginPath();
                        ctx.strokeStyle = '#2563eb';
                        ctx.lineWidth = 2.5;
                        historicalData.forEach((value, index) => {
                            const x = padding.left + dataPointWidth * index + dataPointWidth / 2;
                            const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                            
                            if (index === 0) {
                                ctx.moveTo(x, y);
                            } else {
                                ctx.lineTo(x, y);
                            }
                        });
                        ctx.stroke();
                    }
                    
                    // Draw projection line (dashed, green, continuing from historical)
                    if (projectionData.length > 0 && historicalData.length > 0) {
                        ctx.beginPath();
                        ctx.strokeStyle = '#10b981';
                        ctx.lineWidth = 2.5;
                        ctx.setLineDash([6, 4]);
                        projectionData.forEach((value, index) => {
                            const x = padding.left + dataPointWidth * (historicalCount + index) + dataPointWidth / 2;
                            const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                            
                            if (index === 0) {
                                // Connect to last historical point
                                const lastHistX = padding.left + dataPointWidth * (historicalCount - 1) + dataPointWidth / 2;
                                const lastHistY = padding.top + chartHeight - ((historicalData[historicalCount - 1] - minValue) / valueRange) * chartHeight;
                                ctx.moveTo(lastHistX, lastHistY);
                            }
                            ctx.lineTo(x, y);
                        });
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }
                    
                    // Draw smaller, more formal data points (blue for historical, green for projection)
                    allData.forEach((value, index) => {
                        const x = padding.left + dataPointWidth * index + dataPointWidth / 2;
                        const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                        const isHistorical = index < historicalCount;
                        
                        ctx.fillStyle = '#ffffff';
                        ctx.strokeStyle = isHistorical ? '#2563eb' : '#10b981';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(x, y, 3, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.stroke();
                    });
                    
                    // Helper function for currency formatting
                    function formatCurrencyAxis(amount) {
                        if (amount >= 1000000) {
                            return 'â‚¬' + (amount / 1000000).toFixed(1) + 'M';
                        } else if (amount >= 1000) {
                            return 'â‚¬' + (amount / 1000).toFixed(0) + 'k';
                        } else {
                            return 'â‚¬' + Math.round(amount).toLocaleString('en-US');
                        }
                    }
                    
                    // Draw Y-axis labels with proper formatting
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '12px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'middle';
                    for (let i = 0; i <= 5; i++) {
                        const value = minValue + (valueRange / 5) * (5 - i);
                        const y = padding.top + (chartHeight / 5) * i;
                        const formattedValue = formatCurrencyAxis(value);
                        ctx.fillText(formattedValue, padding.left - 10, y);
                    }
                    
                    // Draw X-axis labels with actual month names
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';
                    const labelInterval = Math.max(1, Math.floor(totalDataPoints / Math.min(12, totalDataPoints)));
                    for (let i = 0; i < totalDataPoints; i += labelInterval) {
                        const x = padding.left + dataPointWidth * i + dataPointWidth / 2;
                        const label = allLabels[i] || `M${i + 1}`;
                        ctx.fillText(label, x, height - padding.bottom + 10);
                    }
                } catch (error) {
                    console.error('Error drawing portfolio chart:', error);
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '16px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('No entries yet. Chart will appear here once transactions are added.', width / 2, height / 2);
                }
            }
            
            // Add hover tooltip functionality
            function setupChartHover() {
                const canvas = document.getElementById('portfolio-chart');
                const tooltip = document.getElementById('chart-tooltip');
                if (!canvas || !tooltip) return;
                
                canvas.addEventListener('mousemove', function(e) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Find nearest data point
                    let nearestPoint = null;
                    let minDistance = Infinity;
                    
                    chartDataPoints.forEach(point => {
                        const distance = Math.sqrt(Math.pow(x - point.x, 2) + Math.pow(y - point.y, 2));
                        if (distance < 30 && distance < minDistance) {
                            minDistance = distance;
                            nearestPoint = point;
                        }
                    });
                    
                    if (nearestPoint) {
                        const formattedValue = 'â‚¬' + nearestPoint.value.toLocaleString('en-US');
                        const growthSign = parseFloat(nearestPoint.growthPercent) >= 0 ? '+' : '';
                        tooltip.innerHTML = `
                            <div class="tooltip-balance">${formattedValue}</div>
                            <div class="tooltip-growth">${growthSign}${nearestPoint.growthPercent}%</div>
                        `;
                        tooltip.style.display = 'block';
                        tooltip.style.left = (nearestPoint.x + 10) + 'px';
                        tooltip.style.top = (nearestPoint.y - 40) + 'px';
                    } else {
                        tooltip.style.display = 'none';
                    }
                });
                
                canvas.addEventListener('mouseleave', function() {
                    if (tooltip) tooltip.style.display = 'none';
                });
            }
            
            // Setup hover after chart is drawn
            setTimeout(setupChartHover, 150);

            // Transactions Table Population - Load from Firestore
            async function populateTransactionsTable() {
                const tableBody = document.getElementById('transactions-table-body');
                if (!tableBody) return;

                // Show loading state
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #6b7280;">Loading transactions...</td></tr>';

                try {
                    // Get user session
                    const userSession = sessionStorage.getItem('investorUser') || sessionStorage.getItem('user');
                    if (!userSession) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #6b7280;">No transactions yet. Performance entries will appear here once added by your administrator.</td></tr>';
                        return;
                    }

                    const user = JSON.parse(userSession);
                    const userData = user.userData || {};
                    const userId = userData.id;

                    if (!userId || !window.firebaseDb) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #6b7280;">No transactions yet. Performance entries will appear here once added by your administrator.</td></tr>';
                        return;
                    }

                    // Load transactions from Firestore (without composite index - sort in JavaScript)
                    const transactionsSnapshot = await window.firebaseDb.collection('users').doc(userId)
                        .collection('transactions')
                        .get();

                    tableBody.innerHTML = '';

                    if (transactionsSnapshot.empty) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #6b7280;">No transactions yet. Performance entries will appear here once added by your administrator.</td></tr>';
                        return;
                    }

                    // Sort transactions in JavaScript (by year, then monthIndex)
                    const transactions = [];
                    transactionsSnapshot.forEach((doc) => {
                        transactions.push(doc.data());
                    });
                    
                    // Sort by year, then monthIndex
                    transactions.sort((a, b) => {
                        if (a.year !== b.year) {
                            return a.year - b.year;
                        }
                        return (a.monthIndex || 0) - (b.monthIndex || 0);
                    });

                    // Populate table with transactions
                    transactions.forEach((entry) => {
                        
                        const row = document.createElement('tr');
                        
                        // Format dates
                        const depositDisplay = entry.deposits > 0 && entry.depositDate
                            ? `â‚¬${entry.deposits.toLocaleString('en-US')}<br><span class="transaction-date">${formatDate(entry.depositDate.toDate())}</span>`
                            : entry.deposits > 0 ? `â‚¬${entry.deposits.toLocaleString('en-US')}` : '-';
                        
                        const withdrawalDisplay = entry.withdrawals > 0 && entry.withdrawalDate
                            ? `â‚¬${entry.withdrawals.toLocaleString('en-US')}<br><span class="transaction-date">${formatDate(entry.withdrawalDate.toDate())}</span>`
                            : entry.withdrawals > 0 ? `â‚¬${entry.withdrawals.toLocaleString('en-US')}` : '-';

                        row.innerHTML = `
                            <td>${entry.month} ${entry.year}</td>
                            <td>â‚¬${entry.startingBalance.toLocaleString('en-US')}</td>
                            <td>â‚¬${entry.endingBalance.toLocaleString('en-US')}</td>
                            <td class="${entry.growth >= 0 ? 'growth-positive' : 'growth-negative'}">${entry.growth >= 0 ? '+' : ''}${entry.growth.toFixed(2)}%</td>
                            <td class="transaction-cell">${depositDisplay}</td>
                            <td class="transaction-cell">${withdrawalDisplay}</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                } catch (error) {
                    console.error('Error loading transactions:', error);
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #6b7280;">No transactions yet. Performance entries will appear here once added by your administrator.</td></tr>';
                }
            }

            function formatDate(dateString) {
                const date = new Date(dateString);
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            }

            // Performance Chart Function
            let performanceDataPoints = [];
            
            async function drawPerformanceChart() {
                const canvas = document.getElementById('performance-chart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const container = canvas.parentElement;
                const width = container ? container.clientWidth - 64 : 800;
                const height = 700;
                
                // Set canvas size
                canvas.width = width;
                canvas.height = height;
                
                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                
                // Chart configuration
                const padding = { top: 80, right: 40, bottom: 60, left: 80 };
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;
                
                // Get userData from sessionStorage
                const userSession = sessionStorage.getItem('investorUser') || sessionStorage.getItem('user');
                if (!userSession) {
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '16px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('Please log in to view performance data.', width / 2, height / 2);
                    return;
                }
                
                const user = JSON.parse(userSession);
                const userData = user.userData || {};
                
                // Get initial investment from userData
                const initialInvestment = userData.initialInvestment || 230000;
                
                // Load transactions to build Opessocius historical data
                let opessociusHistorical = [initialInvestment]; // Start with Month 0
                let transactionCount = 0;
                let transactionMonths = []; // Store actual transaction months for labels
                let lastTransactionMonth = null;
                let lastTransactionYear = null;
                let lastTransactionMonthIndex = null;
                
                if (window.firebaseDb && userData.id) {
                    try {
                        const transactionsSnapshot = await window.firebaseDb.collection('users').doc(userData.id)
                            .collection('transactions')
                            .get();
                        
                        if (!transactionsSnapshot.empty) {
                            // Build historical data from transactions - sort by year, then monthIndex
                            const transactions = [];
                            transactionsSnapshot.forEach((doc) => {
                                transactions.push(doc.data());
                            });
                            
                            // Sort by year, then monthIndex
                            transactions.sort((a, b) => {
                                if (a.year !== b.year) {
                                    return a.year - b.year;
                                }
                                return (a.monthIndex || 0) - (b.monthIndex || 0);
                            });
                            
                            // Count actual transactions
                            transactionCount = transactions.length;
                            
                            // Month name mapping
                            const monthNameMap = {
                                'January': 'Jan', 'February': 'Feb', 'March': 'Mar', 'April': 'Apr',
                                'May': 'May', 'June': 'Jun', 'July': 'Jul', 'August': 'Aug',
                                'September': 'Sep', 'October': 'Oct', 'November': 'Nov', 'December': 'Dec'
                            };
                            
                            // Build historical data array and store transaction months
                            transactionMonths.push('Start'); // Month 0
                            transactions.forEach((entry) => {
                                if (entry.endingBalance !== undefined && entry.endingBalance !== null) {
                                    opessociusHistorical.push(entry.endingBalance);
                                    
                                    // Store month label
                                    const monthShort = entry.month ? (monthNameMap[entry.month] || entry.month.substring(0, 3)) : '';
                                    const yearShort = entry.year ? String(entry.year).slice(-2) : '';
                                    transactionMonths.push(`${monthShort} ${yearShort}`);
                                    
                                    // Store last transaction info for projections
                                    lastTransactionMonth = entry.month;
                                    lastTransactionYear = entry.year;
                                    lastTransactionMonthIndex = entry.monthIndex || 0;
                                }
                            });
                        } else {
                            // No transactions - transactionCount remains 0
                            transactionCount = 0;
                            transactionMonths.push('Start');
                        }
                    } catch (error) {
                        console.error('Error loading transactions for performance chart:', error);
                        transactionCount = 0;
                        transactionMonths.push('Start');
                    }
                } else {
                    transactionMonths.push('Start');
                }
                
                // Determine total months to show (historical + projection)
                // Show at least 12 months total, but adjust based on transaction count
                const totalMonthsToShow = Math.max(12, transactionCount + 4); // At least 12, or transactionCount + 4 projections
                const projectionMonths = totalMonthsToShow - transactionCount;
                
                // Build Opessocius projection data (2% compound growth per month)
                const lastHistoricalValue = opessociusHistorical[opessociusHistorical.length - 1];
                const opessociusProjection = [];
                let projectionBalance = lastHistoricalValue;
                for (let i = 0; i < projectionMonths; i++) {
                    projectionBalance = projectionBalance * 1.02;
                    opessociusProjection.push(projectionBalance);
                }
                
                // S&P 500 monthly returns (%): +2.3%, âˆ’1.4%, +3.1%, +0.6%, âˆ’2.8%, +4.5%, +1.2%, âˆ’3.6%, +2.9%, +0.4%, +5.1%, âˆ’1.9%, +1.7%, +3.8%, âˆ’0.7%, +2.5%
                const sp500MonthlyReturns = [
                    2.3, -1.4, 3.1, 0.6, -2.8, 4.5, 1.2, -3.6, 2.9, 0.4, 5.1, -1.9,  // 12 historical
                    1.7, 3.8, -0.7, 2.5, 2.1, 1.5, 0.8, 3.2  // projection months
                ];
                
                // Calculate S&P 500 values - SIMPLE INTEREST (no compound, each return based on initial investment)
                const sp500DataRaw = [initialInvestment]; // Month 0
                let cumulativeReturn = 0;
                // Use only the returns needed for historical + projection
                const returnsNeeded = transactionCount + projectionMonths;
                for (let i = 0; i < returnsNeeded && i < sp500MonthlyReturns.length; i++) {
                    cumulativeReturn += sp500MonthlyReturns[i];
                    const monthValue = initialInvestment * (1 + cumulativeReturn / 100);
                    sp500DataRaw.push(monthValue);
                }
                
                // Light smoothing for S&P 500 (2-point average) to reduce sharp peaks but keep volatility visible
                function lightSmooth(data) {
                    const smoothed = [data[0]]; // Keep month 0 unchanged
                    for (let i = 1; i < data.length; i++) {
                        if (i === data.length - 1) {
                            smoothed.push(data[i]);
                        } else {
                            // Average with adjacent points (60% current, 20% each adjacent)
                            smoothed.push(data[i] * 0.6 + data[i - 1] * 0.2 + data[i + 1] * 0.2);
                        }
                    }
                    return smoothed;
                }
                
                const sp500Data = lightSmooth(sp500DataRaw);
                
                // Split S&P 500 data into historical and projection based on transaction count
                const sp500Historical = sp500Data.slice(0, transactionCount + 1); // Month 0 + transactionCount months
                const sp500Projection = sp500Data.slice(transactionCount + 1, transactionCount + 1 + projectionMonths);
                
                // Banks: constant 0.20% monthly growth - SIMPLE INTEREST (no compound)
                // Build historical data for transactionCount months
                const banksMonthlyGrowth = 0.20; // 0.20% per month
                const banksHistorical = [initialInvestment]; // Month 0
                for (let i = 1; i <= transactionCount; i++) {
                    // Simple interest: add 0.20% of initial investment each month
                    const monthValue = initialInvestment * (1 + (banksMonthlyGrowth * i) / 100);
                    banksHistorical.push(monthValue);
                }
                
                // Build Banks projection data
                const banksProjection = [];
                const lastBankValue = banksHistorical[banksHistorical.length - 1];
                for (let i = 1; i <= projectionMonths; i++) {
                    const monthValue = initialInvestment * (1 + (banksMonthlyGrowth * (transactionCount + i)) / 100);
                    banksProjection.push(monthValue);
                }
                
                
                // Combine all data for max/min calculation
                const allOpessociusData = [...opessociusHistorical, ...opessociusProjection];
                const allSp500Data = [...sp500Historical, ...sp500Projection];
                const allBanksData = [...banksHistorical, ...banksProjection];
                const allData = [...allOpessociusData, ...allSp500Data, ...allBanksData];
                const maxValue = Math.max(...allData) * 1.1;
                const minValue = Math.min(...allData) * 0.9;
                const valueRange = maxValue - minValue;
                
                // Store data points for hover
                performanceDataPoints = [];
                
                // Draw grid lines
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 5; i++) {
                    const y = padding.top + (chartHeight / 5) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding.left, y);
                    ctx.lineTo(width - padding.right, y);
                    ctx.stroke();
                }
                
                // Total months: Month 0 + transactionCount historical + projectionMonths projection
                const totalMonths = 1 + transactionCount + projectionMonths;
                
                // Generate months array using actual transaction months + projection months
                const monthNamesShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const months = [...transactionMonths]; // Start with actual transaction months
                
                // Add projection month labels
                if (lastTransactionMonthIndex !== null && lastTransactionYear !== null) {
                    let projectionMonthIndex = lastTransactionMonthIndex;
                    let projectionYear = lastTransactionYear;
                    
                    for (let i = 0; i < projectionMonths; i++) {
                        projectionMonthIndex = (projectionMonthIndex + 1) % 12;
                        if (projectionMonthIndex === 0) projectionYear++;
                        const yearShort = String(projectionYear).slice(-2);
                        months.push(`${monthNamesShort[projectionMonthIndex]} ${yearShort}`);
                    }
                } else {
                    // Fallback: generate generic month names if no transactions
                    for (let i = transactionMonths.length; i < totalMonths; i++) {
                        const monthIndex = (i - 1) % 12;
                        months.push(monthNamesShort[monthIndex]);
                    }
                }
                
                // Draw area fill for user investment historical section only (Month 0 + transactionCount months)
                const historicalMonthsCount = transactionCount + 1; // Month 0 + transactionCount
                const gradient = ctx.createLinearGradient(
                    padding.left, 
                    padding.top, 
                    padding.left + (chartWidth / totalMonths) * historicalMonthsCount, 
                    padding.top + chartHeight
                );
                gradient.addColorStop(0, 'rgba(37, 99, 235, 0.25)');
                gradient.addColorStop(1, 'rgba(37, 99, 235, 0.05)');
                
                ctx.beginPath();
                const firstX = padding.left + (chartWidth / totalMonths) / 2;
                const firstY = padding.top + chartHeight - ((opessociusHistorical[0] - minValue) / valueRange) * chartHeight;
                ctx.moveTo(firstX, height - padding.bottom);
                ctx.lineTo(firstX, firstY);
                
                opessociusHistorical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    ctx.lineTo(x, y);
                });
                
                const lastHistoricalX = padding.left + (chartWidth / totalMonths) * transactionCount + (chartWidth / totalMonths) / 2;
                ctx.lineTo(lastHistoricalX, height - padding.bottom);
                ctx.closePath();
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // Draw area fill for S&P 500 historical section only - orange shade (Month 0 + transactionCount months)
                const sp500Gradient = ctx.createLinearGradient(
                    padding.left, 
                    padding.top, 
                    padding.left + (chartWidth / totalMonths) * historicalMonthsCount, 
                    padding.top + chartHeight
                );
                sp500Gradient.addColorStop(0, 'rgba(249, 115, 22, 0.25)');
                sp500Gradient.addColorStop(1, 'rgba(249, 115, 22, 0.05)');
                
                ctx.beginPath();
                const sp500FirstX = padding.left + (chartWidth / totalMonths) / 2;
                const sp500FirstY = padding.top + chartHeight - ((sp500Historical[0] - minValue) / valueRange) * chartHeight;
                ctx.moveTo(sp500FirstX, height - padding.bottom);
                ctx.lineTo(sp500FirstX, sp500FirstY);
                
                sp500Historical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    ctx.lineTo(x, y);
                });
                
                const sp500LastHistoricalX = padding.left + (chartWidth / totalMonths) * transactionCount + (chartWidth / totalMonths) / 2;
                ctx.lineTo(sp500LastHistoricalX, height - padding.bottom);
                ctx.closePath();
                ctx.fillStyle = sp500Gradient;
                ctx.fill();
                
                // Draw area fill for Banks historical section only - grey shade (Month 0 + transactionCount months)
                const banksGradient = ctx.createLinearGradient(
                    padding.left, 
                    padding.top, 
                    padding.left + (chartWidth / totalMonths) * historicalMonthsCount, 
                    padding.top + chartHeight
                );
                banksGradient.addColorStop(0, 'rgba(107, 114, 128, 0.25)');
                banksGradient.addColorStop(1, 'rgba(107, 114, 128, 0.05)');
                
                ctx.beginPath();
                const banksFirstX = padding.left + (chartWidth / totalMonths) / 2;
                const banksFirstY = padding.top + chartHeight - ((banksHistorical[0] - minValue) / valueRange) * chartHeight;
                ctx.moveTo(banksFirstX, height - padding.bottom);
                ctx.lineTo(banksFirstX, banksFirstY);
                
                banksHistorical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    ctx.lineTo(x, y);
                });
                
                const banksLastHistoricalX = padding.left + (chartWidth / totalMonths) * transactionCount + (chartWidth / totalMonths) / 2;
                ctx.lineTo(banksLastHistoricalX, height - padding.bottom);
                ctx.closePath();
                ctx.fillStyle = banksGradient;
                ctx.fill();
                
                // Draw Opessocius historical line
                ctx.beginPath();
                ctx.strokeStyle = '#2563eb';
                ctx.lineWidth = 2.5;
                opessociusHistorical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Draw Opessocius projection line (dashed, green)
                ctx.beginPath();
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 2.5;
                ctx.setLineDash([6, 4]);
                opessociusProjection.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (transactionCount + 1 + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        // Connect to last historical point
                        const lastHistX = padding.left + (chartWidth / totalMonths) * transactionCount + (chartWidth / totalMonths) / 2;
                        const lastHistY = padding.top + chartHeight - ((opessociusHistorical[transactionCount] - minValue) / valueRange) * chartHeight;
                        ctx.moveTo(lastHistX, lastHistY);
                    }
                    ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw S&P 500 historical line (orange) - straight lines to show ups and downs
                ctx.beginPath();
                ctx.strokeStyle = '#f97316';
                ctx.lineWidth = 2.5;
                sp500Historical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Draw S&P 500 projection line (dashed, orange)
                ctx.beginPath();
                ctx.strokeStyle = '#f97316';
                ctx.lineWidth = 2.5;
                ctx.setLineDash([6, 4]);
                sp500Projection.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (transactionCount + 1 + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        // Connect to last historical point
                        const lastHistX = padding.left + (chartWidth / totalMonths) * transactionCount + (chartWidth / totalMonths) / 2;
                        const lastHistY = padding.top + chartHeight - ((sp500Historical[transactionCount] - minValue) / valueRange) * chartHeight;
                        ctx.moveTo(lastHistX, lastHistY);
                    }
                    ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw Banks historical line (grey) - constant growth
                ctx.beginPath();
                ctx.strokeStyle = '#6b7280';
                ctx.lineWidth = 2.5;
                banksHistorical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Draw Banks projection line (dashed, grey)
                ctx.beginPath();
                ctx.strokeStyle = '#6b7280';
                ctx.lineWidth = 2.5;
                ctx.setLineDash([6, 4]);
                banksProjection.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (transactionCount + 1 + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        // Connect to last historical point
                        const lastHistX = padding.left + (chartWidth / totalMonths) * transactionCount + (chartWidth / totalMonths) / 2;
                        const lastHistY = padding.top + chartHeight - ((banksHistorical[transactionCount] - minValue) / valueRange) * chartHeight;
                        ctx.moveTo(lastHistX, lastHistY);
                    }
                    ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw data points for Opessocius investment
                [...opessociusHistorical, ...opessociusProjection].forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    const isHistorical = index <= transactionCount; // Month 0 + transactionCount months
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = isHistorical ? '#2563eb' : '#10b981';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Store for hover
                    const growthPercent = ((value - initialInvestment) / initialInvestment * 100).toFixed(2);
                    performanceDataPoints.push({
                        x: x,
                        y: y,
                        value: value,
                        month: months[index],
                        name: 'Investment',
                        color: isHistorical ? '#2563eb' : '#10b981',
                        growthPercent: growthPercent,
                        isHistorical: isHistorical
                    });
                });
                
                // Draw data points for S&P 500
                [...sp500Historical, ...sp500Projection].forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    const isHistorical = index <= transactionCount; // Month 0 + transactionCount months
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = '#f97316';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Store for hover
                    const growthPercent = ((value - initialInvestment) / initialInvestment * 100).toFixed(2);
                    performanceDataPoints.push({
                        x: x,
                        y: y,
                        value: value,
                        month: months[index],
                        name: 'S&P 500',
                        color: '#f97316',
                        growthPercent: growthPercent,
                        isHistorical: isHistorical
                    });
                });
                
                // Draw data points for Banks
                [...banksHistorical, ...banksProjection].forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    const isHistorical = index <= transactionCount; // Month 0 + transactionCount months
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = '#6b7280';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Store for hover
                    const growthPercent = ((value - initialInvestment) / initialInvestment * 100).toFixed(2);
                    performanceDataPoints.push({
                        x: x,
                        y: y,
                        value: value,
                        month: months[index],
                        name: 'Banks',
                        color: '#6b7280',
                        growthPercent: growthPercent,
                        isHistorical: isHistorical
                    });
                });
                
                // Helper function for dynamic currency formatting on Y-axis
                function formatCurrencyAxis(amount) {
                    if (amount >= 1000000) {
                        return 'â‚¬' + (amount / 1000000).toFixed(1) + 'M';
                    } else if (amount >= 1000) {
                        return 'â‚¬' + (amount / 1000).toFixed(1) + 'k';
                    } else {
                        return 'â‚¬' + Math.round(amount).toLocaleString('en-US');
                    }
                }
                
                // Draw Y-axis labels (in euros)
                ctx.fillStyle = '#6b7280';
                ctx.font = '12px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                for (let i = 0; i <= 5; i++) {
                    const value = minValue + (valueRange / 5) * (5 - i);
                    const y = padding.top + (chartHeight / 5) * i;
                    const formattedValue = formatCurrencyAxis(value);
                    ctx.fillText(formattedValue, padding.left - 10, y);
                }
                
                // Draw X-axis labels (dynamic based on transaction count)
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                const labelInterval = Math.max(1, Math.floor(totalMonths / 8)); // Show about 8 labels
                for (let i = 0; i < totalMonths; i += labelInterval) {
                    const x = padding.left + (chartWidth / totalMonths) * i + (chartWidth / totalMonths) / 2;
                    ctx.fillText(months[i] || `M${i}`, x, height - padding.bottom + 10);
                }
                // Always show the last label
                if (totalMonths > 1 && (totalMonths - 1) % labelInterval !== 0) {
                    const lastX = padding.left + (chartWidth / totalMonths) * (totalMonths - 1) + (chartWidth / totalMonths) / 2;
                    ctx.fillText(months[totalMonths - 1] || `M${totalMonths - 1}`, lastX, height - padding.bottom + 10);
                }
                
                // Draw legend at the top
                const legendY = padding.top - 50;
                const legendX = padding.left;
                
                // Determine Opessocius risk based on investment strategy
                const investmentStrategy = userData.investmentStrategy || 'Low risk 2% a month';
                const opessociusRisk = investmentStrategy === 'High risk 4% a month' ? '100%' : '0%';
                
                const legendItems = [
                    { name: 'Opessocius', color: '#2563eb', risk: opessociusRisk },
                    { name: 'Savings Account', color: '#6b7280', risk: '0%' },
                    { name: 'S&P 500', color: '#f97316', risk: '100%' }
                ];
                
                let currentX = legendX;
                const legendSpacing = 180;
                
                legendItems.forEach((item) => {
                    // Draw colored line
                    ctx.strokeStyle = item.color;
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(currentX, legendY);
                    ctx.lineTo(currentX + 30, legendY);
                    ctx.stroke();
                    
                    // Draw name
                    ctx.fillStyle = '#1f2937';
                    ctx.font = 'bold 13px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                    ctx.textAlign = 'left';
                    ctx.fillText(item.name, currentX + 35, legendY + 5);
                    
                    // Draw risk percentage below
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '11px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                    ctx.fillText(`Risk: ${item.risk}`, currentX + 35, legendY + 20);
                    
                    // Move to next position
                    currentX += legendSpacing;
                });
            }
            
            // Setup performance chart hover
            function setupPerformanceChartHover() {
                const canvas = document.getElementById('performance-chart');
                const tooltip = document.getElementById('performance-tooltip');
                if (!canvas || !tooltip) return;
                
                canvas.addEventListener('mousemove', function(e) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Find nearest data point
                    let nearestPoint = null;
                    let minDistance = Infinity;
                    
                    performanceDataPoints.forEach(point => {
                        const distance = Math.sqrt(Math.pow(x - point.x, 2) + Math.pow(y - point.y, 2));
                        if (distance < 30 && distance < minDistance) {
                            minDistance = distance;
                            nearestPoint = point;
                        }
                    });
                    
                    if (nearestPoint) {
                        const formattedValue = 'â‚¬' + nearestPoint.value.toLocaleString('en-US');
                        const growthSign = parseFloat(nearestPoint.growthPercent) >= 0 ? '+' : '';
                        tooltip.innerHTML = `
                            <div class="tooltip-name" style="color: ${nearestPoint.color}; font-weight: 600;">${nearestPoint.name}</div>
                            <div class="tooltip-balance">${formattedValue}</div>
                            <div class="tooltip-growth">${growthSign}${nearestPoint.growthPercent}%</div>
                        `;
                        tooltip.style.display = 'block';
                        tooltip.style.left = (nearestPoint.x + 10) + 'px';
                        tooltip.style.top = (nearestPoint.y - 40) + 'px';
                    } else {
                        tooltip.style.display = 'none';
                    }
                });
                
                canvas.addEventListener('mouseleave', function() {
                    if (tooltip) tooltip.style.display = 'none';
                });
            }
            
            // Setup performance hover after chart is drawn
            setTimeout(setupPerformanceChartHover, 150);

            // Reports Section - Generate widgets
            async function generateReportWidgets() {
                const container = document.getElementById('reports-widgets-container');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">Loading reports...</div>';
                
                try {
                    // Get user ID from sessionStorage
                    const userSession = sessionStorage.getItem('investorUser') || sessionStorage.getItem('user');
                    if (!userSession || !window.firebaseDb) {
                        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">Please log in to view reports.</div>';
                        return;
                    }
                    
                    const user = JSON.parse(userSession);
                    const userData = user.userData || {};
                    const userId = userData.id;
                    
                    if (!userId) {
                        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">User ID not found.</div>';
                        return;
                    }
                    
                    // Load reports from Firestore (without orderBy to avoid index requirement)
                    const reportsSnapshot = await window.firebaseDb.collection('users').doc(userId)
                        .collection('reports')
                        .get();
                    
                    container.innerHTML = '';
                    
                    if (reportsSnapshot.empty) {
                        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No reports available yet. Reports will appear here once uploaded by your administrator.</div>';
                        return;
                    }
                    
                    // Process reports
                    const reportsList = [];
                    reportsSnapshot.forEach((doc) => {
                        const reportData = doc.data();
                        // Handle base64 stored files
                        let fileUrl = reportData.fileUrl;
                        let fileBase64 = null;
                        if (reportData.storageMethod === 'base64' && reportData.fileBase64) {
                            fileBase64 = reportData.fileBase64;
                            fileUrl = 'data:application/pdf;base64,' + reportData.fileBase64;
                        }
                        reportsList.push({
                            id: doc.id,
                            month: reportData.month,
                            year: reportData.year,
                            fileName: reportData.fileName,
                            fileUrl: fileUrl,
                            fileBase64: fileBase64,
                            storageMethod: reportData.storageMethod || 'storage',
                            uploadDate: reportData.uploadDate
                        });
                    });
                    
                    // Sort by year (desc) and month (desc) to show newest first
                    reportsList.sort((a, b) => {
                        const yearDiff = b.year - a.year;
                        if (yearDiff !== 0) return yearDiff;
                        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                        return months.indexOf(b.month) - months.indexOf(a.month);
                    });
                    
                    // Store reports data in a Map for easy access (especially for base64)
                    window.investorReportsDataMap = window.investorReportsDataMap || new Map();
                    reportsList.forEach((report) => {
                        const reportKey = `report_${report.id}`;
                        window.investorReportsDataMap.set(reportKey, report);
                    });
                    
                    // Generate report cards (matching admin portal style)
                    if (reportsList.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No reports available yet. Reports will appear here once uploaded by your administrator.</div>';
                    } else {
                        let reportsHtml = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
                        reportsList.forEach((report) => {
                            const uploadDate = report.uploadDate ? (report.uploadDate.toDate ? report.uploadDate.toDate().toLocaleDateString() : new Date(report.uploadDate).toLocaleDateString()) : 'N/A';
                            const reportKey = `report_${report.id}`;
                            reportsHtml += `
                                <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; background: #ffffff; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #1f2937; font-size: 1.125rem; margin-bottom: 0.25rem;">${report.month} ${report.year}</div>
                                            <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; word-break: break-word;">${report.fileName}</div>
                                            <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.5rem;">Uploaded: ${uploadDate}</div>
                                        </div>
                                        <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                                            <button class="report-view-btn" data-report-key="${reportKey}" data-title="${report.month} ${report.year}" style="padding: 0.5rem 1.25rem; font-size: 0.875rem; white-space: nowrap; background: #2563eb; color: #ffffff; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.2s;" onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#2563eb'">View</button>
                                            <button class="report-download-btn" data-report-key="${reportKey}" style="padding: 0.5rem 1.25rem; font-size: 0.875rem; white-space: nowrap; background: #2563eb; color: #ffffff; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.2s;" onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#2563eb'">Download</button>
                                        </div>
                                    </div>
                                    <div class="report-viewer-widget" id="viewer-${reportKey}" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                        <div style="position: relative;">
                                            <button class="report-close-btn" data-report-key="${reportKey}" style="position: absolute; top: 0; right: 0; background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0.25rem 0.5rem; line-height: 1; z-index: 10;" onmouseover="this.style.color='#1f2937'" onmouseout="this.style.color='#6b7280'">&times;</button>
                                            <div style="padding-right: 2rem;">
                                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.75rem; font-size: 1rem;">Monthly Report - ${report.month} ${report.year}</div>
                                                <iframe class="report-iframe" data-report-key="${reportKey}" style="width: 100%; height: 600px; border: 1px solid #e5e7eb; border-radius: 6px;"></iframe>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        reportsHtml += '</div>';
                        container.innerHTML = reportsHtml;
                        
                        // Add event listeners to buttons
                        container.querySelectorAll('.report-view-btn').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const reportKey = this.getAttribute('data-report-key');
                                const title = this.getAttribute('data-title');
                                const report = window.investorReportsDataMap.get(reportKey);
                                const viewerWidget = document.getElementById(`viewer-${reportKey}`);
                                
                                if (report && viewerWidget) {
                                    // Toggle viewer visibility
                                    if (viewerWidget.style.display === 'none') {
                                        // Show viewer
                                        viewerWidget.style.display = 'block';
                                        
                                        // Load report in iframe
                                        const iframe = viewerWidget.querySelector('.report-iframe');
                                        if (iframe) {
                                            if (report.storageMethod === 'base64' && report.fileBase64) {
                                                iframe.src = 'data:application/pdf;base64,' + report.fileBase64;
                                            } else if (report.fileUrl) {
                                                iframe.src = report.fileUrl;
                                            }
                                        }
                                    } else {
                                        // Hide viewer
                                        viewerWidget.style.display = 'none';
                                        const iframe = viewerWidget.querySelector('.report-iframe');
                                        if (iframe) {
                                            iframe.src = '';
                                        }
                                    }
                                }
                            });
                        });
                        
                        container.querySelectorAll('.report-download-btn').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const reportKey = this.getAttribute('data-report-key');
                                const report = window.investorReportsDataMap.get(reportKey);
                                if (report) {
                                    downloadReportFile(report.fileUrl, report.fileName, report.fileBase64, report.storageMethod);
                                }
                            });
                        });
                        
                        // Add close button listeners
                        container.querySelectorAll('.report-close-btn').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const reportKey = this.getAttribute('data-report-key');
                                const viewerWidget = document.getElementById(`viewer-${reportKey}`);
                                if (viewerWidget) {
                                    viewerWidget.style.display = 'none';
                                    const iframe = viewerWidget.querySelector('.report-iframe');
                                    if (iframe) {
                                        iframe.src = '';
                                    }
                                }
                            });
                        });
                    }
                    
                } catch (error) {
                    console.error('Error loading reports:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #dc2626;">Error loading reports: ' + error.message + '</div>';
                }
            }
            
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            
            function createReportWidget(periodName, year, balance, gainPercent, value, type, fileUrl = null, fileName = null, reportId = null) {
                const widget = document.createElement('div');
                widget.className = 'report-widget';
                widget.style.cursor = 'pointer';
                
                const periodText = type === 'yearly' ? `${year}` : `${periodName} ${year}`;
                const displayFileName = fileName || (type === 'yearly' 
                    ? `Yearly_Report_${year}.pdf`
                    : `Monthly_Report_${periodName}_${year}.pdf`);
                
                // If we have fileUrl, show view button, otherwise show placeholder
                const hasReport = fileUrl !== null;
                const reportKey = reportId ? `report_${reportId}` : null;
                
                widget.innerHTML = `
                    <div class="report-widget-header">
                        <div class="report-widget-period">${periodText}</div>
                        ${hasReport ? `
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="report-widget-view" data-report-key="${reportKey || ''}" title="View Report">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                </button>
                                <button class="report-widget-download" data-report-key="${reportKey || ''}" title="Download Report">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </button>
                            </div>
                        ` : `
                            <span style="font-size: 0.875rem; color: #9ca3af;">No report available</span>
                        `}
                    </div>
                    ${hasReport ? `
                        <div class="report-widget-body">
                            <div style="padding: 1rem; text-align: center; color: #6b7280; font-size: 0.875rem;">
                                Click to view or download
                            </div>
                        </div>
                    ` : ''}
                `;
                
                // Add view functionality
                if (hasReport && reportKey) {
                    const viewBtn = widget.querySelector('.report-widget-view');
                    if (viewBtn) {
                        viewBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const key = this.getAttribute('data-report-key');
                            const report = window.investorReportsDataMap ? window.investorReportsDataMap.get(key) : null;
                            if (report) {
                                viewReportInModal(report.fileUrl, periodText, report.fileName, report.fileBase64, report.storageMethod);
                            } else {
                                // Fallback to direct URL if map not available
                                viewReportInModal(fileUrl, periodText);
                            }
                        });
                    }
                    
                    // Add download functionality
                    const downloadBtn = widget.querySelector('.report-widget-download');
                    if (downloadBtn) {
                        downloadBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const key = this.getAttribute('data-report-key');
                            const report = window.investorReportsDataMap ? window.investorReportsDataMap.get(key) : null;
                            if (report) {
                                downloadReportFile(report.fileUrl, report.fileName, report.fileBase64, report.storageMethod);
                            } else {
                                // Fallback to direct URL if map not available
                                downloadReportFile(fileUrl, displayFileName);
                            }
                        });
                    }
                }
                
                return widget;
            }
            
            function viewReportInModal(fileUrl, title, fileName = null, fileBase64 = null, storageMethod = 'storage') {
                const modal = document.getElementById('report-viewer-modal');
                const iframe = document.getElementById('report-viewer-iframe');
                const titleEl = document.getElementById('report-viewer-title');
                const downloadBtn = document.getElementById('download-report-btn');
                
                if (!modal || !iframe || !titleEl || !downloadBtn) {
                    console.error('Report viewer modal elements not found');
                    alert('Error: Report viewer not available. Please refresh the page.');
                    return;
                }
                
                titleEl.textContent = `Monthly Report - ${title}`;
                
                // Handle base64 files
                if (storageMethod === 'base64' && fileBase64) {
                    iframe.src = 'data:application/pdf;base64,' + fileBase64;
                    downloadBtn.setAttribute('data-url', '');
                    downloadBtn.setAttribute('data-filename', fileName || title.replace(' ', '_') + '.pdf');
                    downloadBtn.setAttribute('data-base64', fileBase64);
                    downloadBtn.setAttribute('data-storage-method', 'base64');
                } else if (fileUrl && fileUrl.startsWith('data:')) {
                    iframe.src = fileUrl;
                    downloadBtn.setAttribute('data-url', fileUrl);
                    downloadBtn.setAttribute('data-filename', fileName || title.replace(' ', '_') + '.pdf');
                    downloadBtn.setAttribute('data-base64', '');
                    downloadBtn.setAttribute('data-storage-method', 'storage');
                } else if (fileUrl) {
                    iframe.src = fileUrl;
                    downloadBtn.setAttribute('data-url', fileUrl);
                    downloadBtn.setAttribute('data-filename', fileName || title.replace(' ', '_') + '.pdf');
                    downloadBtn.setAttribute('data-base64', '');
                    downloadBtn.setAttribute('data-storage-method', 'storage');
                } else {
                    console.error('No file URL or base64 data provided');
                    alert('Error: Report file data not available.');
                    return;
                }
                
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function closeReportViewerModal() {
                const modal = document.getElementById('report-viewer-modal');
                const iframe = document.getElementById('report-viewer-iframe');
                if (iframe) iframe.src = '';
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            }
            
            function downloadReportFile(fileUrl, fileName, fileBase64 = null, storageMethod = 'storage') {
                // Handle base64 files
                if (storageMethod === 'base64' && fileBase64) {
                    // Convert base64 to blob and download
                    const byteCharacters = atob(fileBase64);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName || 'report.pdf';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } else if (fileUrl && fileUrl.startsWith('data:')) {
                    // Convert data URL to blob and download
                    const base64Data = fileUrl.split(',')[1];
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName || 'report.pdf';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } else if (fileUrl) {
                    // Regular download for Storage URLs
                    const link = document.createElement('a');
                    link.href = fileUrl;
                    link.download = fileName || 'report.pdf';
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert('Error: Report file data not available.');
                }
            }
            
            // Generate widgets when Reports view is shown
            const reportsView = document.getElementById('reports-view');
            if (reportsView) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            if (reportsView.style.display !== 'none') {
                                generateReportWidgets();
                            }
                        }
                    });
                });
                observer.observe(reportsView, { attributes: true, attributeFilter: ['style'] });
            }
            
            // Report viewer modal event listeners
            const reportViewerModal = document.getElementById('report-viewer-modal');
            if (reportViewerModal) {
                // Close button (simple X on the right)
                const closeBtn = document.getElementById('report-viewer-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeReportViewerModal);
                }
                
                // Close on overlay click
                reportViewerModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeReportViewerModal);
            }
            
            // Dashboard form handlers
            const depositForm = document.getElementById('deposit-form');
            const withdrawalForm = document.getElementById('withdrawal-form');
            
            if (depositForm) {
                depositForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const amount = document.getElementById('deposit-amount').value;
                    if (amount) {
                        alert(`Deposit request of â‚¬${parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} has been sent to your advisor. You will receive a response within 24 hours.`);
                        depositForm.reset();
                    }
                });
            }
            
            if (withdrawalForm) {
                withdrawalForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const amount = document.getElementById('withdrawal-amount').value;
                    if (amount) {
                        alert(`Withdrawal request of â‚¬${parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} has been sent to your advisor. You will receive a response within 24 hours.`);
                        withdrawalForm.reset();
                    }
                });
            }
            
            // Dashboard navigation links
            const dashboardNewsLink = document.getElementById('dashboard-news-link');
            
            if (dashboardNewsLink) {
                dashboardNewsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const navItems = document.querySelectorAll('.sidebar-nav-item');
                    navItems.forEach(item => {
                        const span = item.querySelector('span');
                        if (span && span.textContent.trim() === 'Market News') {
                            item.click();
                        }
                    });
                });
            }
            
            // Dashboard report download buttons - load from Firestore
            // Format month and year as "Nov 24", "Dec 25", etc.
            function formatMonthYear(month, year) {
                const monthAbbr = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthIndex = months.indexOf(month);
                const yearShort = year.toString().slice(-2);
                return `${monthAbbr[monthIndex]} ${yearShort}`;
            }
            
            // Load and display dashboard reports with real data
            async function loadDashboardReports() {
                const reportWidget = document.getElementById('dashboard-report-widget');
                if (!reportWidget) return;
                
                const reportContent = reportWidget.querySelector('.dashboard-widget-content');
                if (!reportContent) return;
                
                try {
                    const userSession = sessionStorage.getItem('investorUser') || sessionStorage.getItem('user');
                    if (!userSession || !window.firebaseDb) {
                        reportContent.innerHTML = '<div style="text-align: center; padding: 1rem; color: #9ca3af;">Loading reports...</div>';
                        return;
                    }
                    
                    const user = JSON.parse(userSession);
                    const userData = user.userData || {};
                    const userId = userData.id;
                    
                    if (!userId) {
                        reportContent.innerHTML = '<div style="text-align: center; padding: 1rem; color: #9ca3af;">No user data available</div>';
                        return;
                    }
                    
                    // Load reports
                    const reportsSnapshot = await window.firebaseDb.collection('users').doc(userId)
                        .collection('reports')
                        .get();
                    
                    // Load transactions to get growth and balance data
                    const transactionsSnapshot = await window.firebaseDb.collection('users').doc(userId)
                        .collection('transactions')
                        .get();
                    
                    const reportsList = [];
                    reportsSnapshot.forEach((doc) => {
                        const reportData = doc.data();
                        reportsList.push({
                            id: doc.id,
                            fileUrl: reportData.fileUrl,
                            fileName: reportData.fileName,
                            month: reportData.month,
                            year: reportData.year,
                            fileBase64: reportData.fileBase64,
                            storageMethod: reportData.storageMethod || 'storage',
                            uploadDate: reportData.uploadDate
                        });
                    });
                    
                    // Build transactions map by month/year
                    const transactionsMap = {};
                    transactionsSnapshot.forEach((doc) => {
                        const txData = doc.data();
                        const monthKey = `${txData.year}-${String(txData.monthIndex + 1).padStart(2, '0')}`;
                        transactionsMap[monthKey] = {
                            endingBalance: txData.endingBalance,
                            returnPercent: txData.returnPercent || txData.monthlyReturn || null,
                            startingBalance: txData.startingBalance || null
                        };
                    });
                    
                    // Sort reports by year (desc) and month (desc) to show newest first
                    reportsList.sort((a, b) => {
                        const yearDiff = b.year - a.year;
                        if (yearDiff !== 0) return yearDiff;
                        return months.indexOf(b.month) - months.indexOf(a.month);
                    });
                    
                    // Take top 3 reports
                    const latestReports = reportsList.slice(0, 3);
                    
                    if (latestReports.length === 0) {
                        reportContent.innerHTML = '<div style="text-align: center; padding: 1rem; color: #9ca3af;">No reports available yet</div>';
                        return;
                    }
                    
                    // Build HTML for reports
                    let reportsHtml = '';
                    latestReports.forEach((report) => {
                        const monthIndex = months.indexOf(report.month);
                        const monthKey = `${report.year}-${String(monthIndex + 1).padStart(2, '0')}`;
                        const transaction = transactionsMap[monthKey];
                        
                        // Get growth percentage and balance
                        let growthPercent = null;
                        let balance = null;
                        
                        if (transaction) {
                            balance = transaction.endingBalance;
                            if (transaction.returnPercent !== null && transaction.returnPercent !== undefined) {
                                growthPercent = transaction.returnPercent;
                            } else if (transaction.startingBalance && transaction.endingBalance) {
                                // Calculate growth from starting and ending balance
                                growthPercent = ((transaction.endingBalance - transaction.startingBalance) / transaction.startingBalance) * 100;
                            }
                        }
                        
                        // Format values
                        const formattedPeriod = formatMonthYear(report.month, report.year);
                        const formattedGrowth = growthPercent !== null ? `${growthPercent >= 0 ? '+' : ''}${growthPercent.toFixed(2)}%` : 'N/A';
                        const formattedBalance = balance !== null ? `â‚¬${balance.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}` : 'N/A';
                        
                        reportsHtml += `
                            <div class="dashboard-report-item">
                                <div class="dashboard-report-period">${formattedPeriod}</div>
                                <div class="dashboard-report-metrics">
                                    <span class="dashboard-report-gain">${formattedGrowth}</span>
                                    <span class="dashboard-report-balance">${formattedBalance}</span>
                                </div>
                                <button class="dashboard-report-download" data-report-key="report_${report.id}" style="background: none; border: none; cursor: pointer; padding: 0.25rem; display: flex; align-items: center; justify-content: center;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </button>
                            </div>
                        `;
                    });
                    
                    reportContent.innerHTML = reportsHtml;
                    
                    // Store reports data for download
                    window.dashboardReportsMap = window.dashboardReportsMap || new Map();
                    latestReports.forEach((report) => {
                        const reportKey = `report_${report.id}`;
                        window.dashboardReportsMap.set(reportKey, report);
                    });
                    
                    // Add download button listeners
                    reportContent.querySelectorAll('.dashboard-report-download').forEach(btn => {
                        btn.addEventListener('click', async function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const reportKey = this.getAttribute('data-report-key');
                            const report = window.dashboardReportsMap.get(reportKey);
                            
                            if (report) {
                                downloadReportFile(report.fileUrl, report.fileName, report.fileBase64, report.storageMethod);
                            } else {
                                alert('Report not available.');
                            }
                        });
                    });
                } catch (error) {
                    console.error('Error loading dashboard reports:', error);
                    reportContent.innerHTML = '<div style="text-align: center; padding: 1rem; color: #dc2626;">Error loading reports</div>';
                }
            }
            
            async function setupDashboardReportDownloads() {
                // This function is now replaced by loadDashboardReports, but keeping for backward compatibility
                await loadDashboardReports();
            }
            
            // Setup dashboard report downloads when dashboard is shown
            const dashboardViewEl = document.getElementById('dashboard-view');
            if (dashboardViewEl) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            if (dashboardViewEl.style.display !== 'none') {
                                setTimeout(setupDashboardReportDownloads, 100);
                                // Load latest news titles in dashboard widget
                                setTimeout(loadDashboardLatestNews, 100);
                            }
                        }
                    });
                });
                observer.observe(dashboardViewEl, { attributes: true, attributeFilter: ['style'] });
            }
            
            // Load dashboard news and reports on initial page load if dashboard is visible
            if (dashboardViewEl && dashboardViewEl.style.display !== 'none') {
                setTimeout(loadDashboardLatestNews, 500);
                setTimeout(loadDashboardReports, 500);
            }
            
            // Dashboard news widget click handler
            const dashboardNewsWidget = document.getElementById('dashboard-news-widget');
            if (dashboardNewsWidget) {
                dashboardNewsWidget.style.cursor = 'pointer';
                dashboardNewsWidget.addEventListener('click', function() {
                    const navItems = document.querySelectorAll('.sidebar-nav-item');
                    navItems.forEach(item => {
                        const span = item.querySelector('span');
                        if (span && span.textContent.trim() === 'Market News') {
                            item.click();
                        }
                    });
                });
            }
            
            // Draw dashboard charts when dashboard is shown (already handled above, removing duplicate)
            
            // Calculate 12-month projection value
            // Accepts optional userData parameter to use user-specific balance
            async function calculateProjectionValue(userData = null) {
                const projectionValueEl = document.getElementById('dashboard-projection-value');
                const portfolioProjectionEl = document.getElementById('portfolio-projection');
                
                // Get user-specific balance - try to get from most recent transaction
                let balance = null;
                
                if (userData && userData.currentBalance) {
                    balance = userData.currentBalance;
                } else {
                    // Try to get from sessionStorage and load most recent transaction
                    try {
                        const userSession = sessionStorage.getItem('investorUser') || sessionStorage.getItem('user');
                        if (userSession && window.firebaseDb) {
                            const user = JSON.parse(userSession);
                            const data = user.userData || {};
                            const userId = data.id;
                            
                            if (userId) {
                                // Load transactions to get most recent ending balance
                                const transactionsSnapshot = await window.firebaseDb.collection('users').doc(userId)
                                    .collection('transactions')
                                    .get();
                                
                                if (!transactionsSnapshot.empty) {
                                    const transactions = [];
                                    transactionsSnapshot.forEach((doc) => {
                                        transactions.push(doc.data());
                                    });
                                    
                                    // Sort by year, then monthIndex
                                    transactions.sort((a, b) => {
                                        if (a.year !== b.year) {
                                            return a.year - b.year;
                                        }
                                        return (a.monthIndex || 0) - (b.monthIndex || 0);
                                    });
                                    
                                    // Get most recent transaction's ending balance
                                    if (transactions.length > 0) {
                                        balance = transactions[transactions.length - 1].endingBalance;
                                    }
                                }
                            }
                            
                            // Fallback to userData values
                            if (!balance) {
                                balance = data.currentBalance || data.initialInvestment || null;
                            }
                        }
                    } catch (e) {
                        console.warn('Could not get user data for projection:', e);
                    }
                }
                
                // Fallback to default if no user data available
                if (balance === null || balance === undefined) {
                    balance = 287450; // Default fallback
                }
                
                // Use same calculation as portfolio chart (2% compound growth per month)
                const monthlyGrowthRate = 0.02; // 2% per month
                
                // Calculate 12 months forward
                let projectedBalance = balance;
                for (let i = 0; i < 12; i++) {
                    projectedBalance = projectedBalance * (1 + monthlyGrowthRate);
                }
                
                // Round to whole number and format
                const projectedValue = Math.round(projectedBalance);
                const formattedValue = 'â‚¬' + projectedValue.toLocaleString('en-US');
                
                if (projectionValueEl) {
                    projectionValueEl.textContent = formattedValue;
                }
                if (portfolioProjectionEl) {
                    portfolioProjectionEl.textContent = formattedValue;
                }
            }
            
            // Initial draw if dashboard is visible
            // Note: calculateProjectionValue will be called from loadUserData() with user-specific data
            // This fallback is only if user data hasn't loaded yet
            if (dashboardViewEl && dashboardViewEl.style.display !== 'none') {
                setTimeout(function() {
                    // Try to get user data first
                    try {
                        const userSession = sessionStorage.getItem('investorUser') || sessionStorage.getItem('user');
                        if (userSession) {
                            const user = JSON.parse(userSession);
                            const userData = user.userData || {};
                            calculateProjectionValue(userData);
                        } else {
                            calculateProjectionValue();
                        }
                    } catch (e) {
                        calculateProjectionValue();
                    }
                }, 500); // Delay to allow loadUserData to run first
            }

            // Redraw chart on window resize
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(async function() {
                    if (portfolioView && portfolioView.style.display !== 'none') {
                        drawPortfolioChart();
                    }
                    if (performanceView && performanceView.style.display !== 'none') {
                        await drawPerformanceChart();
                        setTimeout(setupPerformanceChartHover, 150);
                    }
                    // Dashboard widgets resized
                }, 250);
            });
            
            // Learning Modules Section
            // Modules data (same as admin portal, but users can only view)
            let modulesData = [
                {
                    id: 1,
                    title: 'Introduction to Crude Oil Trading',
                    description: 'Learn the fundamentals of crude oil trading, including market basics, key terminology, and trading strategies.',
                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=800&h=400&fit=crop',
                    content: `
                        <h3>Understanding Crude Oil Markets</h3>
                        <p>Crude oil is one of the most important commodities in the global economy. This module covers:</p>
                        <ul>
                            <li>Market fundamentals</li>
                            <li>Trading terminology</li>
                            <li>Price factors</li>
                            <li>Risk management</li>
                        </ul>
                        
                        <h3 style="margin-top: 2rem;">What is Crude Oil?</h3>
                        <p>Crude oil, also known as petroleum, is a naturally occurring, unrefined petroleum product composed of hydrocarbon deposits and other organic materials. It is a fossil fuel that is extracted from the ground and refined into various products such as gasoline, diesel, jet fuel, and heating oil.</p>
                        <p>The global crude oil market is one of the largest and most liquid commodity markets in the world, with daily trading volumes exceeding billions of dollars. Understanding this market is crucial for anyone looking to trade energy commodities.</p>
                        
                        <h3 style="margin-top: 2rem;">Types of Crude Oil</h3>
                        <p>There are several types of crude oil, each with different characteristics that affect their price and trading:</p>
                        <ul>
                            <li><strong>West Texas Intermediate (WTI):</strong> A high-quality crude oil benchmark produced in the United States. It is light and sweet, making it ideal for refining into gasoline.</li>
                            <li><strong>Brent Crude:</strong> A major trading classification of sweet light crude oil that serves as a major benchmark price for purchases of oil worldwide. It is extracted from the North Sea.</li>
                            <li><strong>Dubai Crude:</strong> A medium sour crude oil produced in Dubai and used as a benchmark for pricing Middle Eastern crude oil exports to Asia.</li>
                            <li><strong>OPEC Basket:</strong> A weighted average of oil prices from various OPEC member countries, used as a reference price for OPEC crude oil.</li>
                        </ul>
                        
                        <h3 style="margin-top: 2rem;">Market Fundamentals</h3>
                        <p>The crude oil market is driven by a complex interplay of supply and demand factors. Understanding these fundamentals is essential for successful trading:</p>
                        
                        <h4 style="margin-top: 1.5rem;">Supply Factors</h4>
                        <p>Supply factors that influence crude oil prices include:</p>
                        <ul>
                            <li><strong>Production Levels:</strong> The amount of crude oil being produced by major oil-producing countries, particularly OPEC members, Russia, and the United States.</li>
                            <li><strong>Geopolitical Events:</strong> Wars, sanctions, and political instability in oil-producing regions can disrupt supply chains and affect prices.</li>
                            <li><strong>Natural Disasters:</strong> Hurricanes, earthquakes, and other natural disasters can damage oil infrastructure and reduce production.</li>
                            <li><strong>Technological Advances:</strong> Innovations in extraction technology, such as fracking and deep-water drilling, can increase supply.</li>
                            <li><strong>Storage Levels:</strong> The amount of crude oil in storage facilities affects available supply and can signal market sentiment.</li>
                        </ul>
                        
                        <h4 style="margin-top: 1.5rem;">Demand Factors</h4>
                        <p>Demand factors that influence crude oil prices include:</p>
                        <ul>
                            <li><strong>Economic Growth:</strong> Strong economic growth typically increases energy consumption, driving up demand for crude oil.</li>
                            <li><strong>Seasonal Variations:</strong> Demand for heating oil increases in winter, while gasoline demand peaks during summer driving season.</li>
                            <li><strong>Transportation Needs:</strong> The global transportation sector is heavily dependent on petroleum products, making it a major demand driver.</li>
                            <li><strong>Industrial Activity:</strong> Manufacturing and industrial processes require significant amounts of energy derived from crude oil.</li>
                            <li><strong>Alternative Energy:</strong> The growth of renewable energy sources and electric vehicles can reduce long-term demand for crude oil.</li>
                        </ul>
                        
                        <h3 style="margin-top: 2rem;">Trading Terminology</h3>
                        <p>To effectively trade crude oil, you need to understand the key terminology used in the market:</p>
                        <ul>
                            <li><strong>Barrel:</strong> The standard unit of measurement for crude oil, equal to 42 US gallons or approximately 159 liters.</li>
                            <li><strong>Spot Price:</strong> The current market price at which crude oil can be bought or sold for immediate delivery.</li>
                            <li><strong>Futures Contract:</strong> A standardized agreement to buy or sell a specific quantity of crude oil at a predetermined price on a future date.</li>
                            <li><strong>Contango:</strong> A market condition where futures prices are higher than spot prices, typically indicating expectations of higher future prices.</li>
                            <li><strong>Backwardation:</strong> A market condition where futures prices are lower than spot prices, often indicating supply shortages or high immediate demand.</li>
                            <li><strong>Spread:</strong> The price difference between two related crude oil contracts, such as the WTI-Brent spread.</li>
                            <li><strong>Volatility:</strong> A measure of how much crude oil prices fluctuate over time, indicating market uncertainty.</li>
                        </ul>
                        
                        <h3 style="margin-top: 2rem;">Price Factors</h3>
                        <p>Several key factors influence crude oil prices on a daily basis:</p>
                        
                        <h4 style="margin-top: 1.5rem;">OPEC Decisions</h4>
                        <p>The Organization of the Petroleum Exporting Countries (OPEC) plays a crucial role in global oil markets. OPEC decisions regarding production quotas can significantly impact prices. When OPEC reduces production, prices typically rise, and when they increase production, prices usually fall.</p>
                        
                        <h4 style="margin-top: 1.5rem;">US Dollar Strength</h4>
                        <p>Crude oil is priced in US dollars, so the strength of the dollar directly affects oil prices. A stronger dollar makes oil more expensive for buyers using other currencies, potentially reducing demand and lowering prices. Conversely, a weaker dollar makes oil cheaper for international buyers, potentially increasing demand.</p>
                        
                        <h4 style="margin-top: 1.5rem;">Inventory Reports</h4>
                        <p>Weekly inventory reports from organizations like the US Energy Information Administration (EIA) and the American Petroleum Institute (API) provide crucial data on oil stockpiles. Higher-than-expected inventory levels typically indicate oversupply and can push prices down, while lower-than-expected levels suggest tight supply and can drive prices up.</p>
                        
                        <h4 style="margin-top: 1.5rem;">Economic Indicators</h4>
                        <p>Economic indicators such as GDP growth, employment data, and manufacturing indices provide insights into economic health and energy demand. Strong economic indicators often correlate with higher oil demand and prices.</p>
                        
                        <h3 style="margin-top: 2rem;">Risk Management</h3>
                        <p>Effective risk management is essential when trading crude oil, as the market can be highly volatile. Here are key risk management strategies:</p>
                        
                        <h4 style="margin-top: 1.5rem;">Position Sizing</h4>
                        <p>Never risk more than you can afford to lose on a single trade. A common rule is to risk no more than 1-2% of your trading capital on any single position. This helps protect your account from significant losses during adverse market movements.</p>
                        
                        <h4 style="margin-top: 1.5rem;">Stop-Loss Orders</h4>
                        <p>Always use stop-loss orders to limit potential losses. A stop-loss order automatically closes your position if the price moves against you by a predetermined amount. This prevents emotional decision-making and helps protect your capital.</p>
                        
                        <h4 style="margin-top: 1.5rem;">Diversification</h4>
                        <p>Don't put all your capital into crude oil trading. Diversify your portfolio across different asset classes and commodities to reduce overall risk. This way, losses in one area can be offset by gains in others.</p>
                        
                        <h4 style="margin-top: 1.5rem;">Stay Informed</h4>
                        <p>Keep up with market news, economic data releases, and geopolitical events that could affect oil prices. Being informed helps you make better trading decisions and avoid unexpected market moves.</p>
                        
                        <h4 style="margin-top: 1.5rem;">Use Leverage Wisely</h4>
                        <p>While leverage can amplify profits, it also amplifies losses. Use leverage conservatively and understand the risks involved. High leverage can quickly wipe out your trading account if the market moves against you.</p>
                        
                        <h3 style="margin-top: 2rem;">Trading Strategies</h3>
                        <p>There are several approaches to trading crude oil, each with its own advantages and risks:</p>
                        
                        <h4 style="margin-top: 1.5rem;">Day Trading</h4>
                        <p>Day trading involves opening and closing positions within the same trading day. This strategy requires constant monitoring of the market and quick decision-making. Day traders typically focus on short-term price movements and technical analysis.</p>
                        
                        <h4 style="margin-top: 1.5rem;">Swing Trading</h4>
                        <p>Swing trading involves holding positions for several days to weeks, capturing medium-term price movements. This approach allows traders to take advantage of larger price swings while avoiding the stress of constant monitoring required in day trading.</p>
                        
                        <h4 style="margin-top: 1.5rem;">Trend Following</h4>
                        <p>Trend following strategies involve identifying and trading in the direction of established market trends. This approach assumes that prices will continue moving in the same direction until the trend reverses.</p>
                        
                        <h4 style="margin-top: 1.5rem;">Fundamental Analysis</h4>
                        <p>Fundamental analysis focuses on supply and demand factors, economic indicators, and geopolitical events to predict price movements. This approach is better suited for longer-term trading and investment decisions.</p>
                        
                        <h3 style="margin-top: 2rem;">Conclusion</h3>
                        <p>Crude oil trading offers significant opportunities for profit, but it also comes with substantial risks. Success in this market requires a solid understanding of market fundamentals, trading terminology, price factors, and risk management principles.</p>
                        <p>Remember that no trading strategy guarantees profits, and losses are an inevitable part of trading. The key to long-term success is consistent application of sound trading principles, continuous learning, and disciplined risk management.</p>
                        <p>As you continue your journey in crude oil trading, always stay informed about market developments, practice with a demo account before risking real money, and never invest more than you can afford to lose.</p>
                    `,
                    additionalImages: [],
                    order: 1,
                    published: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: 2,
                    title: 'Technical Analysis Fundamentals',
                    description: 'Master the art of technical analysis with charts, indicators, and patterns used by professional traders.',
                    image: 'https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=800&h=400&fit=crop',
                    content: '<h3>Chart Patterns and Indicators</h3><p>Technical analysis is crucial for successful trading. This module teaches:</p><ul><li>Reading price charts</li><li>Common patterns</li><li>Technical indicators</li><li>Entry and exit signals</li></ul>',
                    additionalImages: [],
                    order: 2,
                    published: true,
                    createdAt: new Date().toISOString()
                }
            ];
            
            function loadModulesList() {
                const container = document.getElementById('modules-grid');
                if (!container) return;
                
                container.innerHTML = '';
                
                // Sort modules by order and filter only published ones
                const sortedModules = [...modulesData]
                    .filter(m => m.published)
                    .sort((a, b) => a.order - b.order);
                
                sortedModules.forEach(module => {
                    const moduleCard = document.createElement('div');
                    moduleCard.style.background = 'white';
                    moduleCard.style.borderRadius = '8px';
                    moduleCard.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                    moduleCard.style.overflow = 'hidden';
                    moduleCard.style.display = 'flex';
                    moduleCard.style.flexDirection = 'column';
                    moduleCard.style.cursor = 'pointer';
                    moduleCard.style.transition = 'transform 0.2s, box-shadow 0.2s';
                    
                    moduleCard.addEventListener('mouseenter', function() {
                        this.style.transform = 'translateY(-2px)';
                        this.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
                    });
                    
                    moduleCard.addEventListener('mouseleave', function() {
                        this.style.transform = 'translateY(0)';
                        this.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                    });
                    
                    moduleCard.addEventListener('click', function() {
                        viewModule(module.id);
                    });
                    
                    const imageContainer = document.createElement('div');
                    imageContainer.style.width = '100%';
                    imageContainer.style.height = '200px';
                    imageContainer.style.overflow = 'hidden';
                    imageContainer.style.background = '#f3f4f6';
                    
                    const img = document.createElement('img');
                    img.src = module.image || 'https://via.placeholder.com/400x200?text=No+Image';
                    img.alt = module.title;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    
                    imageContainer.appendChild(img);
                    
                    const cardBody = document.createElement('div');
                    cardBody.style.padding = '1.5rem';
                    cardBody.style.flex = '1';
                    cardBody.style.display = 'flex';
                    cardBody.style.flexDirection = 'column';
                    
                    const title = document.createElement('h3');
                    title.textContent = module.title;
                    title.style.margin = '0 0 0.5rem 0';
                    title.style.fontSize = '1.25rem';
                    title.style.color = '#1f2937';
                    title.style.fontWeight = '600';
                    
                    const description = document.createElement('p');
                    description.textContent = module.description || 'No description available.';
                    description.style.margin = '0 0 1rem 0';
                    description.style.color = '#6b7280';
                    description.style.fontSize = '0.875rem';
                    description.style.lineHeight = '1.5';
                    
                    const viewBtn = document.createElement('button');
                    viewBtn.textContent = 'View Module';
                    viewBtn.style.width = '100%';
                    viewBtn.style.marginTop = 'auto';
                    viewBtn.style.padding = '0.75rem 1.5rem';
                    viewBtn.style.fontSize = '0.875rem';
                    viewBtn.style.fontWeight = '600';
                    viewBtn.style.background = '#1f2937';
                    viewBtn.style.color = 'white';
                    viewBtn.style.border = 'none';
                    viewBtn.style.borderRadius = '8px';
                    viewBtn.style.cursor = 'pointer';
                    viewBtn.style.transition = 'background 0.2s';
                    viewBtn.addEventListener('mouseenter', function() {
                        this.style.background = '#374151';
                    });
                    viewBtn.addEventListener('mouseleave', function() {
                        this.style.background = '#1f2937';
                    });
                    viewBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        viewModule(module.id);
                    });
                    
                    cardBody.appendChild(title);
                    cardBody.appendChild(description);
                    cardBody.appendChild(viewBtn);
                    
                    moduleCard.appendChild(imageContainer);
                    moduleCard.appendChild(cardBody);
                    container.appendChild(moduleCard);
                });
            }
            
            function viewModule(moduleId) {
                const module = modulesData.find(m => m.id === moduleId);
                if (!module) return;
                
                const modulesListView = document.getElementById('modules-list-view');
                const moduleDetailView = document.getElementById('module-detail-view');
                const moduleDetailContent = document.getElementById('module-detail-content');
                
                if (!modulesListView || !moduleDetailView || !moduleDetailContent) return;
                
                // Hide modules list and show module detail
                modulesListView.style.display = 'none';
                moduleDetailView.style.display = 'block';
                
                // Populate module content
                moduleDetailContent.innerHTML = `
                    <h2 style="margin: 0 0 1rem 0; font-size: 2rem; color: #1f2937; font-weight: 700;">${module.title}</h2>
                    ${module.image ? `<img src="${module.image}" alt="${module.title}" style="width: 100%; max-height: 400px; object-fit: cover; border-radius: 8px; margin-bottom: 2rem;">` : ''}
                    ${module.description ? `<p style="color: #6b7280; margin-bottom: 2rem; font-size: 1.125rem; line-height: 1.6;">${module.description}</p>` : ''}
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 2rem; color: #374151; line-height: 1.8;">
                        ${module.content || '<p>No content available.</p>'}
                    </div>
                    ${module.additionalImages && module.additionalImages.length > 0 ? `
                        <div style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;">
                            ${module.additionalImages.map(img => `<img src="${img}" alt="Additional image" style="width: 100%; border-radius: 8px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">`).join('')}
                        </div>
                    ` : ''}
                `;
                
                // Scroll to top
                window.scrollTo(0, 0);
                
                // Attach close button handler
                const closeBtn = document.getElementById('close-module-btn');
                if (closeBtn) {
                    // Remove existing listeners by cloning and replacing
                    const newCloseBtn = closeBtn.cloneNode(true);
                    closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
                    newCloseBtn.addEventListener('click', closeModuleView);
                }
            }
            
            function closeModuleView() {
                const modulesListView = document.getElementById('modules-list-view');
                const moduleDetailView = document.getElementById('module-detail-view');
                
                if (modulesListView) modulesListView.style.display = 'block';
                if (moduleDetailView) moduleDetailView.style.display = 'none';
                
                // Scroll to top
                window.scrollTo(0, 0);
            }
            
            // Close module button handler
            const closeModuleBtn = document.getElementById('close-module-btn');
            if (closeModuleBtn) {
                closeModuleBtn.addEventListener('click', closeModuleView);
            }
            
            // Community Group Chat Section
            // Helper function to get user display name
            function getUserDisplayName() {
                try {
                    const userSession = sessionStorage.getItem('user');
                    if (userSession) {
                        const user = JSON.parse(userSession);
                        const userData = user.userData || {};
                        return userData.fullName || user.username || 'Investor';
                    }
                } catch (error) {
                    console.error('Error getting user display name:', error);
                }
                return 'Investor';
            }
            
            let communityChatMessages = [
                {
                    id: 1,
                    sender: 'Admin',
                    message: 'Welcome to the community chat! Feel free to ask questions and share insights.',
                    images: [],
                    timestamp: new Date(Date.now() - 3600000).toISOString() // 1 hour ago
                },
                {
                    id: 2,
                    sender: getUserDisplayName(),
                    message: 'Thanks! Looking forward to learning more about the market trends.',
                    images: [],
                    timestamp: new Date(Date.now() - 3300000).toISOString() // 55 minutes ago
                }
            ];
            
            function loadCommunityChatMessages() {
                const container = document.getElementById('community-chat-messages-container');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (communityChatMessages.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No messages yet. Start the conversation!</p>';
                    return;
                }
                
                communityChatMessages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.style.display = 'flex';
                    messageDiv.style.flexDirection = 'column';
                    messageDiv.style.gap = '0.25rem';
                    messageDiv.style.maxWidth = '80%';
                    messageDiv.style.marginLeft = msg.sender === 'Admin' ? 'auto' : '0';
                    
                    const senderName = document.createElement('div');
                    senderName.style.fontSize = '0.75rem';
                    senderName.style.fontWeight = '600';
                    senderName.style.color = msg.sender === 'Admin' ? '#2563eb' : '#6b7280';
                    senderName.textContent = msg.sender;
                    
                    const messageBubble = document.createElement('div');
                    messageBubble.style.padding = '0.75rem 1rem';
                    messageBubble.style.borderRadius = '12px';
                    messageBubble.style.background = msg.sender === 'Admin' ? '#2563eb' : 'white';
                    messageBubble.style.color = msg.sender === 'Admin' ? 'white' : '#1f2937';
                    messageBubble.style.border = msg.sender === 'Admin' ? 'none' : '1px solid #e5e7eb';
                    messageBubble.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
                    
                    if (msg.message) {
                        const messageText = document.createElement('div');
                        messageText.style.fontSize = '0.875rem';
                        messageText.style.lineHeight = '1.5';
                        messageText.style.whiteSpace = 'pre-wrap';
                        messageText.style.wordBreak = 'break-word';
                        messageText.textContent = msg.message;
                        messageBubble.appendChild(messageText);
                    }
                    
                    if (msg.images && msg.images.length > 0) {
                        const imagesContainer = document.createElement('div');
                        imagesContainer.style.display = 'grid';
                        imagesContainer.style.gridTemplateColumns = 'repeat(auto-fill, minmax(150px, 1fr))';
                        imagesContainer.style.gap = '0.5rem';
                        imagesContainer.style.marginTop = msg.message ? '0.5rem' : '0';
                        
                        msg.images.forEach(imgUrl => {
                            const img = document.createElement('img');
                            img.src = imgUrl;
                            img.style.width = '100%';
                            img.style.height = '150px';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '6px';
                            img.style.cursor = 'pointer';
                            img.onclick = function() {
                                openImageModal(imgUrl);
                            };
                            imagesContainer.appendChild(img);
                        });
                        messageBubble.appendChild(imagesContainer);
                    }
                    
                    const timestamp = document.createElement('div');
                    timestamp.style.fontSize = '0.625rem';
                    timestamp.style.color = '#9ca3af';
                    timestamp.style.marginTop = '0.25rem';
                    timestamp.style.textAlign = msg.sender === 'Admin' ? 'right' : 'left';
                    const date = new Date(msg.timestamp);
                    timestamp.textContent = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    
                    messageDiv.appendChild(senderName);
                    messageDiv.appendChild(messageBubble);
                    messageDiv.appendChild(timestamp);
                    container.appendChild(messageDiv);
                });
                
                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            }
            
            // Community Chat image preview
            let selectedCommunityChatImages = [];
            const communityChatImageInput = document.getElementById('community-chat-image-input');
            const communityChatImagesPreview = document.getElementById('community-chat-images-preview');
            const communityChatImagesPreviewContainer = document.getElementById('community-chat-images-preview-container');
            
            if (communityChatImageInput && communityChatImagesPreview && communityChatImagesPreviewContainer) {
                communityChatImageInput.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files);
                    selectedCommunityChatImages = files;
                    communityChatImagesPreviewContainer.innerHTML = '';
                    
                    if (files.length > 0) {
                        communityChatImagesPreview.style.display = 'block';
                    } else {
                        communityChatImagesPreview.style.display = 'none';
                    }
                    
                    files.forEach((file, index) => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const imgDiv = document.createElement('div');
                                imgDiv.style.position = 'relative';
                                imgDiv.style.width = '80px';
                                imgDiv.style.height = '80px';
                                
                                const img = document.createElement('img');
                                img.src = e.target.result;
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                img.style.borderRadius = '6px';
                                img.style.border = '1px solid #e5e7eb';
                                
                                const removeBtn = document.createElement('button');
                                removeBtn.textContent = 'Ã—';
                                removeBtn.style.position = 'absolute';
                                removeBtn.style.top = '-8px';
                                removeBtn.style.right = '-8px';
                                removeBtn.style.background = '#ef4444';
                                removeBtn.style.color = 'white';
                                removeBtn.style.border = 'none';
                                removeBtn.style.borderRadius = '50%';
                                removeBtn.style.width = '20px';
                                removeBtn.style.height = '20px';
                                removeBtn.style.cursor = 'pointer';
                                removeBtn.style.fontSize = '14px';
                                removeBtn.style.lineHeight = '1';
                                removeBtn.onclick = function() {
                                    selectedCommunityChatImages = selectedCommunityChatImages.filter((f, i) => i !== index);
                                    const dt = new DataTransfer();
                                    selectedCommunityChatImages.forEach(f => dt.items.add(f));
                                    communityChatImageInput.files = dt.files;
                                    if (selectedCommunityChatImages.length === 0) {
                                        communityChatImagesPreview.style.display = 'none';
                                    } else {
                                        communityChatImageInput.dispatchEvent(new Event('change'));
                                    }
                                };
                                
                                imgDiv.appendChild(img);
                                imgDiv.appendChild(removeBtn);
                                communityChatImagesPreviewContainer.appendChild(imgDiv);
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                });
            }
            
            // Send community chat message
            const communityChatSendBtn = document.getElementById('community-chat-send-btn');
            const communityChatMessageInput = document.getElementById('community-chat-message-input');
            
            function sendCommunityChatMessage() {
                const messageText = communityChatMessageInput.value.trim();
                const images = selectedCommunityChatImages;
                
                if (!messageText && images.length === 0) {
                    return;
                }
                
                // Process images
                const imageUrls = [];
                images.forEach(file => {
                    imageUrls.push(URL.createObjectURL(file));
                });
                
                // Add message
                const newMessage = {
                    id: communityChatMessages.length + 1,
                    sender: getUserDisplayName(),
                    message: messageText,
                    images: imageUrls,
                    timestamp: new Date().toISOString()
                };
                
                communityChatMessages.push(newMessage);
                loadCommunityChatMessages();
                
                // Clear input
                communityChatMessageInput.value = '';
                selectedCommunityChatImages = [];
                communityChatImageInput.value = '';
                communityChatImagesPreview.style.display = 'none';
                communityChatImagesPreviewContainer.innerHTML = '';
            }
            
            if (communityChatSendBtn) {
                communityChatSendBtn.addEventListener('click', sendCommunityChatMessage);
                // Add hover effect
                communityChatSendBtn.addEventListener('mouseenter', function() {
                    this.style.background = '#1d4ed8';
                });
                communityChatSendBtn.addEventListener('mouseleave', function() {
                    this.style.background = '#2563eb';
                });
            }
            
            if (communityChatMessageInput) {
                communityChatMessageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendCommunityChatMessage();
                    }
                });
            }
            
            // One-on-One Chat Section (Tier 3 only)
            let oneOnOneChatMessages = [];
            let selectedOneOnOneChatImages = [];
            
            async function loadOneOnOneChatMessages() {
                const container = document.getElementById('one-on-one-chat-messages-container');
                if (!container) return;
                
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">Loading chat...</p>';
                
                try {
                    const userId = window.currentUserId;
                    const userType = window.currentUserType || 'investor';
                    if (!userId) {
                        container.innerHTML = '<p style="text-align: center; color: #dc2626; padding: 2rem;">Error: User ID not found.</p>';
                        return;
                    }
                    
                    // Try to load from Firestore first
                    if (window.firebaseDb) {
                        try {
                            const chatCollection = userType === 'learning' 
                                ? window.firebaseDb.collection('learningUsers').doc(userId).collection('oneOnOneChat')
                                : window.firebaseDb.collection('users').doc(userId).collection('oneOnOneChat');
                            
                            const snapshot = await chatCollection.orderBy('timestamp', 'asc').get();
                            oneOnOneChatMessages = [];
                            
                            snapshot.forEach(doc => {
                                oneOnOneChatMessages.push({
                                    id: doc.id,
                                    ...doc.data()
                                });
                            });
                        } catch (error) {
                            console.error('Error loading one-on-one chat from Firestore:', error);
                            // Fallback to localStorage
                            const stored = localStorage.getItem(`oneOnOneChat_${userId}`);
                            if (stored) {
                                oneOnOneChatMessages = JSON.parse(stored);
                            }
                        }
                    } else {
                        // Fallback to localStorage
                        const stored = localStorage.getItem(`oneOnOneChat_${userId}`);
                        if (stored) {
                            oneOnOneChatMessages = JSON.parse(stored);
                        }
                    }
                } catch (error) {
                    console.error('Error loading one-on-one chat:', error);
                }
                
                renderOneOnOneChatMessages();
            }
            
            function renderOneOnOneChatMessages() {
                const container = document.getElementById('one-on-one-chat-messages-container');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (oneOnOneChatMessages.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No messages yet. Start the conversation!</p>';
                    return;
                }
                
                oneOnOneChatMessages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.style.display = 'flex';
                    messageDiv.style.flexDirection = 'column';
                    messageDiv.style.gap = '0.25rem';
                    messageDiv.style.maxWidth = '80%';
                    messageDiv.style.marginLeft = msg.sender === 'Admin' ? 'auto' : '0';
                    
                    const senderName = document.createElement('div');
                    senderName.style.fontSize = '0.75rem';
                    senderName.style.fontWeight = '600';
                    senderName.style.color = msg.sender === 'Admin' ? '#2563eb' : '#6b7280';
                    senderName.textContent = msg.sender;
                    
                    const messageBubble = document.createElement('div');
                    messageBubble.style.padding = '0.75rem 1rem';
                    messageBubble.style.borderRadius = '12px';
                    messageBubble.style.background = msg.sender === 'Admin' ? '#2563eb' : 'white';
                    messageBubble.style.color = msg.sender === 'Admin' ? 'white' : '#1f2937';
                    messageBubble.style.border = msg.sender === 'Admin' ? 'none' : '1px solid #e5e7eb';
                    messageBubble.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
                    
                    if (msg.message) {
                        const messageText = document.createElement('div');
                        messageText.style.fontSize = '0.875rem';
                        messageText.style.lineHeight = '1.5';
                        messageText.style.whiteSpace = 'pre-wrap';
                        messageText.style.wordBreak = 'break-word';
                        messageText.textContent = msg.message;
                        messageBubble.appendChild(messageText);
                    }
                    
                    if (msg.images && msg.images.length > 0) {
                        const imagesContainer = document.createElement('div');
                        imagesContainer.style.display = 'grid';
                        imagesContainer.style.gridTemplateColumns = 'repeat(auto-fill, minmax(150px, 1fr))';
                        imagesContainer.style.gap = '0.5rem';
                        imagesContainer.style.marginTop = msg.message ? '0.5rem' : '0';
                        
                        msg.images.forEach(imgUrl => {
                            const img = document.createElement('img');
                            img.src = imgUrl;
                            img.style.width = '100%';
                            img.style.height = '150px';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '6px';
                            img.style.cursor = 'pointer';
                            img.onclick = function() {
                                openImageModal(imgUrl);
                            };
                            imagesContainer.appendChild(img);
                        });
                        messageBubble.appendChild(imagesContainer);
                    }
                    
                    const timestamp = document.createElement('div');
                    timestamp.style.fontSize = '0.625rem';
                    timestamp.style.color = '#9ca3af';
                    timestamp.style.marginTop = '0.25rem';
                    timestamp.style.textAlign = msg.sender === 'Admin' ? 'right' : 'left';
                    const date = new Date(msg.timestamp);
                    timestamp.textContent = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    
                    messageDiv.appendChild(senderName);
                    messageDiv.appendChild(messageBubble);
                    messageDiv.appendChild(timestamp);
                    container.appendChild(messageDiv);
                });
                
                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            }
            
            // One-on-One Chat image preview
            const oneOnOneChatImageInput = document.getElementById('one-on-one-chat-image-input');
            const oneOnOneChatImagesPreview = document.getElementById('one-on-one-chat-images-preview');
            const oneOnOneChatImagesPreviewContainer = document.getElementById('one-on-one-chat-images-preview-container');
            
            if (oneOnOneChatImageInput && oneOnOneChatImagesPreview && oneOnOneChatImagesPreviewContainer) {
                oneOnOneChatImageInput.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files);
                    selectedOneOnOneChatImages = files;
                    oneOnOneChatImagesPreviewContainer.innerHTML = '';
                    
                    if (files.length > 0) {
                        oneOnOneChatImagesPreview.style.display = 'block';
                    } else {
                        oneOnOneChatImagesPreview.style.display = 'none';
                    }
                    
                    files.forEach((file, index) => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const imgDiv = document.createElement('div');
                                imgDiv.style.position = 'relative';
                                imgDiv.style.width = '80px';
                                imgDiv.style.height = '80px';
                                
                                const img = document.createElement('img');
                                img.src = e.target.result;
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                img.style.borderRadius = '6px';
                                img.style.border = '1px solid #e5e7eb';
                                
                                const removeBtn = document.createElement('button');
                                removeBtn.textContent = 'Ã—';
                                removeBtn.style.position = 'absolute';
                                removeBtn.style.top = '-8px';
                                removeBtn.style.right = '-8px';
                                removeBtn.style.background = '#ef4444';
                                removeBtn.style.color = 'white';
                                removeBtn.style.border = 'none';
                                removeBtn.style.borderRadius = '50%';
                                removeBtn.style.width = '20px';
                                removeBtn.style.height = '20px';
                                removeBtn.style.cursor = 'pointer';
                                removeBtn.style.fontSize = '14px';
                                removeBtn.style.lineHeight = '1';
                                removeBtn.onclick = function() {
                                    selectedOneOnOneChatImages.splice(index, 1);
                                    const dt = new DataTransfer();
                                    selectedOneOnOneChatImages.forEach(f => dt.items.add(f));
                                    oneOnOneChatImageInput.files = dt.files;
                                    if (selectedOneOnOneChatImages.length === 0) {
                                        oneOnOneChatImagesPreview.style.display = 'none';
                                    } else {
                                        oneOnOneChatImageInput.dispatchEvent(new Event('change'));
                                    }
                                };
                                
                                imgDiv.appendChild(img);
                                imgDiv.appendChild(removeBtn);
                                oneOnOneChatImagesPreviewContainer.appendChild(imgDiv);
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                });
            }
            
            // Send one-on-one chat message
            const oneOnOneChatSendBtn = document.getElementById('one-on-one-chat-send-btn');
            const oneOnOneChatMessageInput = document.getElementById('one-on-one-chat-message-input');
            
            async function sendOneOnOneChatMessage() {
                const messageText = oneOnOneChatMessageInput.value.trim();
                const images = selectedOneOnOneChatImages;
                
                if (!messageText && images.length === 0) {
                    return;
                }
                
                const userId = window.currentUserId;
                const userType = window.currentUserType || 'investor';
                if (!userId) {
                    alert('Error: User ID not found.');
                    return;
                }
                
                // Process images - convert to base64 data URLs for persistence
                const imageUrls = [];
                for (const file of images) {
                    try {
                        const base64 = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                        imageUrls.push(base64);
                    } catch (error) {
                        console.error('Error converting image to base64:', error);
                        alert('Error processing image. Please try again.');
                        return;
                    }
                }
                
                // Create message object
                const newMessage = {
                    sender: getUserDisplayName(),
                    message: messageText,
                    images: imageUrls,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                // Add to local array
                oneOnOneChatMessages.push(newMessage);
                renderOneOnOneChatMessages();
                
                // Save to Firestore or localStorage
                try {
                    if (window.firebaseDb) {
                        const chatCollection = userType === 'learning'
                            ? window.firebaseDb.collection('learningUsers').doc(userId).collection('oneOnOneChat')
                            : window.firebaseDb.collection('users').doc(userId).collection('oneOnOneChat');
                        
                        await chatCollection.add(newMessage);
                        
                        // Mark as unread for admin
                        const adminNotificationsRef = window.firebaseDb.collection('adminNotifications').doc('oneOnOneChat');
                        const adminNotificationsDoc = await adminNotificationsRef.get();
                        let notifications = {};
                        if (adminNotificationsDoc.exists) {
                            notifications = adminNotificationsDoc.data();
                        }
                        if (!notifications[userId]) {
                            notifications[userId] = 0;
                        }
                        notifications[userId] = (notifications[userId] || 0) + 1;
                        await adminNotificationsRef.set(notifications, { merge: true });
                    } else {
                        // Fallback to localStorage
                        localStorage.setItem(`oneOnOneChat_${userId}`, JSON.stringify(oneOnOneChatMessages));
                    }
                } catch (error) {
                    console.error('Error saving one-on-one chat message:', error);
                    // Still save to localStorage as backup
                    localStorage.setItem(`oneOnOneChat_${userId}`, JSON.stringify(oneOnOneChatMessages));
                }
                
                // Clear input
                oneOnOneChatMessageInput.value = '';
                selectedOneOnOneChatImages = [];
                if (oneOnOneChatImageInput) oneOnOneChatImageInput.value = '';
                if (oneOnOneChatImagesPreview) oneOnOneChatImagesPreview.style.display = 'none';
                if (oneOnOneChatImagesPreviewContainer) oneOnOneChatImagesPreviewContainer.innerHTML = '';
            }
            
            if (oneOnOneChatSendBtn) {
                oneOnOneChatSendBtn.addEventListener('click', sendOneOnOneChatMessage);
                oneOnOneChatSendBtn.addEventListener('mouseenter', function() {
                    this.style.background = '#1d4ed8';
                });
                oneOnOneChatSendBtn.addEventListener('mouseleave', function() {
                    this.style.background = '#2563eb';
                });
            }
            
            if (oneOnOneChatMessageInput) {
                oneOnOneChatMessageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendOneOnOneChatMessage();
                    }
                });
            }
            
            // Image Modal/Lightbox functionality
            function openImageModal(imgSrc) {
                const modal = document.getElementById('image-modal');
                const modalImg = document.getElementById('image-modal-img');
                if (modal && modalImg) {
                    modalImg.src = imgSrc;
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }
            
            function closeImageModal() {
                const modal = document.getElementById('image-modal');
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
            
            // Close modal handlers
            const imageModalClose = document.querySelector('.image-modal-close');
            const imageModal = document.getElementById('image-modal');
            
            if (imageModalClose) {
                imageModalClose.addEventListener('click', closeImageModal);
            }
            
            if (imageModal) {
                imageModal.addEventListener('click', function(e) {
                    if (e.target === imageModal) {
                        closeImageModal();
                    }
                });
                
                // Close on Escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && imageModal.classList.contains('active')) {
                        closeImageModal();
                    }
                });
            }
            
            // Professors' Messages Section
            let professorsMessages = []; // Will be loaded from Firestore
            
            async function loadProfessorsMessages() {
                const container = document.getElementById('professors-messages-container');
                if (!container) return;
                
                // Show loading state
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">Loading messages...</p>';
                
                try {
                    // Check if Firestore service is available
                    if (!window.communityMessagesFirestoreService) {
                        console.error('Community messages service not available');
                        container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">Service not available. Please refresh the page.</p>';
                        return;
                    }
                    
                    // Load messages from Firestore
                    professorsMessages = await window.communityMessagesFirestoreService.getAllCommunityMessages();
                    
                    container.innerHTML = '';
                    
                    if (professorsMessages.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No messages from professors yet.</p>';
                        return;
                    }
                    
                    // Sort messages by timestamp (newest first) so most recent messages appear at the top
                    const sortedMessages = [...professorsMessages].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    sortedMessages.forEach(msg => {
                        const messageCard = document.createElement('div');
                        messageCard.style.background = 'white';
                        messageCard.style.padding = '1rem';
                        messageCard.style.borderRadius = '8px';
                        messageCard.style.border = '1px solid #e5e7eb';
                        messageCard.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
                        messageCard.style.flexShrink = '0';
                        messageCard.style.width = '100%';
                        messageCard.style.boxSizing = 'border-box';
                        
                        const professorName = document.createElement('div');
                        professorName.style.fontSize = '0.875rem';
                        professorName.style.fontWeight = '700';
                        professorName.style.color = '#1f2937';
                        professorName.style.marginBottom = '0.25rem';
                        professorName.textContent = msg.professor || 'Admin';
                        
                        const professorTitle = document.createElement('div');
                        professorTitle.style.fontSize = '0.75rem';
                        professorTitle.style.color = '#2563eb';
                        professorTitle.style.marginBottom = '0.5rem';
                        professorTitle.textContent = msg.professorTitle || 'Administrator';
                        
                        // Append professor name and title first
                        messageCard.appendChild(professorName);
                        messageCard.appendChild(professorTitle);
                        
                        // Message title (if exists)
                        if (msg.messageTitle) {
                            const messageTitle = document.createElement('div');
                            messageTitle.style.fontSize = '0.875rem';
                            messageTitle.style.fontWeight = '600';
                            messageTitle.style.color = '#1f2937';
                            messageTitle.style.marginBottom = '0.5rem';
                            messageTitle.textContent = msg.messageTitle;
                            messageCard.appendChild(messageTitle);
                        }
                        
                        // Subheading (if exists)
                        if (msg.subheading) {
                            const subheading = document.createElement('div');
                            subheading.style.fontSize = '0.8125rem';
                            subheading.style.color = '#6b7280';
                            subheading.style.marginBottom = '0.5rem';
                            subheading.style.fontStyle = 'italic';
                            subheading.textContent = msg.subheading;
                            messageCard.appendChild(subheading);
                        }
                        
                        const messageText = document.createElement('div');
                        messageText.style.fontSize = '0.875rem';
                        messageText.style.color = '#374151';
                        messageText.style.lineHeight = '1.6';
                        messageText.style.marginBottom = '0.75rem';
                        messageText.style.whiteSpace = 'pre-wrap';
                        messageText.style.wordBreak = 'break-word';
                        messageText.textContent = msg.message || '';
                        messageCard.appendChild(messageText);
                        
                        // Link (if exists)
                        if (msg.link) {
                            const linkDiv = document.createElement('div');
                            linkDiv.style.marginBottom = '0.75rem';
                            const link = document.createElement('a');
                            link.href = msg.link;
                            link.target = '_blank';
                            link.rel = 'noopener noreferrer';
                            link.style.cssText = 'color: #2563eb; text-decoration: none; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.25rem;';
                            link.innerHTML = msg.link + ' <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>';
                            linkDiv.appendChild(link);
                            messageCard.appendChild(linkDiv);
                        }
                        
                        // Images (if exist)
                        if (msg.imageUrls && msg.imageUrls.length > 0) {
                            const imagesContainer = document.createElement('div');
                            imagesContainer.style.display = 'grid';
                            imagesContainer.style.gridTemplateColumns = 'repeat(auto-fill, minmax(150px, 1fr))';
                            imagesContainer.style.gap = '0.5rem';
                            imagesContainer.style.marginBottom = '0.75rem';
                            
                            msg.imageUrls.forEach(imageUrl => {
                                const imgWrapper = document.createElement('div');
                                imgWrapper.style.position = 'relative';
                                imgWrapper.style.borderRadius = '6px';
                                imgWrapper.style.overflow = 'hidden';
                                imgWrapper.style.cursor = 'pointer';
                                
                                const img = document.createElement('img');
                                img.src = imageUrl;
                                img.style.width = '100%';
                                img.style.height = '150px';
                                img.style.objectFit = 'cover';
                                img.style.display = 'block';
                                img.onclick = function() {
                                    // Open image in new tab/window
                                    window.open(imageUrl, '_blank');
                                };
                                
                                imgWrapper.appendChild(img);
                                imagesContainer.appendChild(imgWrapper);
                            });
                            
                            messageCard.appendChild(imagesContainer);
                        }
                        
                        const timestamp = document.createElement('div');
                        timestamp.style.fontSize = '0.625rem';
                        timestamp.style.color = '#9ca3af';
                        const date = new Date(msg.timestamp);
                        timestamp.textContent = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) + ' â€¢ ' + date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        messageCard.appendChild(timestamp);
                        container.appendChild(messageCard);
                    });
                    
                    // Scroll to top to show most recent messages initially (newest messages are at the top)
                    container.scrollTop = 0;
                } catch (error) {
                    console.error('Error loading professors messages:', error);
                    container.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 2rem;">Error loading messages. Please refresh the page.</p>';
                }
            }
            
            // Weekly Reports Section
            let weeklyReportData = null; // Will be loaded from Firestore
            
            async function loadWeeklyReports() {
                const container = document.getElementById('weekly-reports-display');
                if (!container) return;
                
                // Show loading state
                container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #6b7280;">Loading weekly report...</div>';
                
                try {
                    // Check if Firestore service is available
                    if (!window.weeklyReportsFirestoreService) {
                        console.error('Weekly reports service not available');
                        container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #6b7280;">Service not available. Please refresh the page.</div>';
                        return;
                    }
                    
                    // Load weekly report from Firestore
                    weeklyReportData = await window.weeklyReportsFirestoreService.getWeeklyReport();
                    
                    container.innerHTML = '';
                    
                    if (!weeklyReportData) {
                        container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #6b7280;">No weekly reports available yet.</div>';
                        return;
                    }
                
                // Weekly Report Header - with left and right sections
                const reportHeader = document.createElement('div');
                reportHeader.style.gridColumn = '1 / -1';
                reportHeader.style.background = 'white';
                reportHeader.style.padding = '1.5rem';
                reportHeader.style.borderRadius = '8px';
                reportHeader.style.border = '1px solid #e5e7eb';
                reportHeader.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                reportHeader.style.marginBottom = '1rem';
                reportHeader.style.display = 'flex';
                reportHeader.style.justifyContent = 'space-between';
                reportHeader.style.alignItems = 'flex-start';
                reportHeader.style.gap = '2rem';
                
                // Left side: Weekly Report title, Author, and Date Published
                const leftSection = document.createElement('div');
                leftSection.style.flex = '1';
                
                const headerTitle = document.createElement('h3');
                headerTitle.style.margin = '0 0 0.75rem 0';
                headerTitle.style.fontSize = '1.25rem';
                headerTitle.style.fontWeight = '600';
                headerTitle.style.color = '#1f2937';
                headerTitle.textContent = 'Weekly Report';
                
                const authorInfo = document.createElement('div');
                authorInfo.style.fontSize = '0.875rem';
                authorInfo.style.color = '#6b7280';
                authorInfo.style.marginBottom = '0.5rem';
                authorInfo.innerHTML = `<strong>Author:</strong> ${weeklyReportData.author || 'N/A'}`;
                
                const dateInfo = document.createElement('div');
                dateInfo.style.fontSize = '0.875rem';
                dateInfo.style.color = '#6b7280';
                dateInfo.innerHTML = `<strong>Date Published:</strong> ${weeklyReportData.datePublished ? new Date(weeklyReportData.datePublished).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A'}`;
                
                leftSection.appendChild(headerTitle);
                leftSection.appendChild(authorInfo);
                leftSection.appendChild(dateInfo);
                
                // Middle section: PDF Report section (moved more to the left)
                const middleSection = document.createElement('div');
                middleSection.style.flex = '1';
                middleSection.style.display = 'flex';
                middleSection.style.flexDirection = 'column';
                middleSection.style.alignItems = 'flex-start';
                middleSection.style.gap = '0.5rem';
                middleSection.style.marginLeft = '2rem';
                
                const pdfTitle = document.createElement('h4');
                pdfTitle.style.margin = '0';
                pdfTitle.style.fontSize = '1.125rem';
                pdfTitle.style.fontWeight = '600';
                pdfTitle.style.color = '#1f2937';
                pdfTitle.textContent = 'PDF Report';
                
                const pdfInfo = document.createElement('div');
                pdfInfo.style.fontSize = '0.875rem';
                pdfInfo.style.color = '#6b7280';
                pdfInfo.innerHTML = `<strong>File:</strong> ${weeklyReportData.pdfFileName || 'N/A'}`;
                
                // Check if PDF URL exists and is not null/empty
                const hasPdfUrl = weeklyReportData.pdfUrl && weeklyReportData.pdfUrl !== null && weeklyReportData.pdfUrl !== '';
                console.log('Weekly report PDF check:', {
                    pdfUrl: weeklyReportData.pdfUrl,
                    hasPdfUrl: hasPdfUrl,
                    pdfFileName: weeklyReportData.pdfFileName
                });
                
                middleSection.appendChild(pdfTitle);
                middleSection.appendChild(pdfInfo);
                
                // Wider "View" button
                if (hasPdfUrl) {
                    const viewButton = document.createElement('button');
                    viewButton.textContent = 'View';
                    viewButton.style.padding = '0.375rem 1.5rem';
                    viewButton.style.fontSize = '0.75rem';
                    viewButton.style.fontWeight = '600';
                    viewButton.style.color = 'white';
                    viewButton.style.background = '#2563eb';
                    viewButton.style.border = 'none';
                    viewButton.style.borderRadius = '6px';
                    viewButton.style.cursor = 'pointer';
                    viewButton.style.transition = 'background 0.2s';
                    viewButton.style.whiteSpace = 'nowrap';
                    viewButton.style.marginTop = '0.5rem';
                    viewButton.style.width = 'auto';
                    viewButton.style.minWidth = '80px';
                    
                    viewButton.addEventListener('mouseenter', function() {
                        this.style.background = '#1d4ed8';
                    });
                    
                    viewButton.addEventListener('mouseleave', function() {
                        this.style.background = '#2563eb';
                    });
                    
                    viewButton.addEventListener('click', function(e) {
                        // Use storageMethod and fileBase64 from data if available, otherwise extract from URL
                        let fileBase64 = weeklyReportData.fileBase64 || null;
                        let storageMethod = weeklyReportData.storageMethod || 'storage';
                        
                        // If we have a data URL but no fileBase64, extract it
                        if (!fileBase64 && weeklyReportData.pdfUrl && weeklyReportData.pdfUrl.startsWith('data:')) {
                            storageMethod = 'base64';
                            fileBase64 = weeklyReportData.pdfUrl.split(',')[1];
                        }
                        
                        viewWeeklyReport(
                            weeklyReportData.pdfUrl, 
                            weeklyReportData.pdfFileName || 'Weekly Report',
                            fileBase64,
                            storageMethod,
                            e.target
                        );
                    });
                    
                    middleSection.appendChild(viewButton);
                }
                
                // Right section: Weekly Video section (always show)
                const rightSection = document.createElement('div');
                rightSection.style.flex = '1';
                rightSection.style.display = 'flex';
                rightSection.style.flexDirection = 'column';
                rightSection.style.alignItems = 'flex-start';
                rightSection.style.gap = '0.5rem';
                rightSection.style.marginLeft = '2rem';
                
                const hasVideo = weeklyReportData.videoUrl && weeklyReportData.videoUrl !== null && weeklyReportData.videoUrl !== '';
                
                const videoTitle = document.createElement('h4');
                videoTitle.style.margin = '0';
                videoTitle.style.fontSize = '1.125rem';
                videoTitle.style.fontWeight = '600';
                videoTitle.style.color = '#1f2937';
                videoTitle.textContent = 'Weekly Video';
                
                const videoInfo = document.createElement('div');
                videoInfo.style.fontSize = '0.875rem';
                videoInfo.style.color = '#6b7280';
                if (hasVideo && weeklyReportData.videoTitle) {
                    videoInfo.innerHTML = `<strong>Title:</strong> ${weeklyReportData.videoTitle}`;
                } else {
                    videoInfo.innerHTML = `<strong>Title:</strong> N/A`;
                }
                
                rightSection.appendChild(videoTitle);
                rightSection.appendChild(videoInfo);
                
                // "Watch" button (only enabled if video exists)
                const watchButton = document.createElement('button');
                watchButton.textContent = 'Watch';
                watchButton.style.padding = '0.375rem 1.5rem';
                watchButton.style.fontSize = '0.75rem';
                watchButton.style.fontWeight = '600';
                watchButton.style.color = 'white';
                watchButton.style.background = hasVideo ? '#2563eb' : '#9ca3af';
                watchButton.style.border = 'none';
                watchButton.style.borderRadius = '6px';
                watchButton.style.cursor = hasVideo ? 'pointer' : 'not-allowed';
                watchButton.style.transition = 'background 0.2s';
                watchButton.style.whiteSpace = 'nowrap';
                watchButton.style.marginTop = '0.5rem';
                watchButton.style.width = 'auto';
                watchButton.style.minWidth = '80px';
                watchButton.disabled = !hasVideo;
                
                if (hasVideo) {
                    watchButton.addEventListener('mouseenter', function() {
                        this.style.background = '#1d4ed8';
                    });
                    
                    watchButton.addEventListener('mouseleave', function() {
                        this.style.background = '#2563eb';
                    });
                    
                    watchButton.addEventListener('click', function(e) {
                        // If video is a link, redirect to it; otherwise show in modal
                        if (weeklyReportData.videoType === 'link' && weeklyReportData.videoUrl) {
                            window.open(weeklyReportData.videoUrl, '_blank');
                        } else {
                            viewWeeklyVideo(
                                weeklyReportData.videoUrl,
                                weeklyReportData.videoTitle || 'Weekly Video',
                                e.target
                            );
                        }
                    });
                }
                
                rightSection.appendChild(watchButton);
                
                reportHeader.appendChild(leftSection);
                reportHeader.appendChild(middleSection);
                reportHeader.appendChild(rightSection);
                container.appendChild(reportHeader);
                } catch (error) {
                    console.error('Error loading weekly reports:', error);
                    container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #ef4444;">Error loading weekly report. Please refresh the page.</div>';
                }
            }
            
            // View weekly report in modal (uses existing report-viewer-modal, same as regular reports)
            function viewWeeklyReport(pdfUrl, fileName, fileBase64 = null, storageMethod = 'storage', viewButton = null) {
                // Use the existing report-viewer-modal (same as regular reports)
                const modal = document.getElementById('report-viewer-modal');
                const iframe = document.getElementById('report-viewer-iframe');
                const titleEl = document.getElementById('report-viewer-title');
                const container = document.getElementById('report-viewer-container');
                
                if (!modal || !iframe || !titleEl || !container) {
                    console.error('Report viewer modal elements not found');
                    alert('Error: Report viewer not available. Please refresh the page.');
                    return;
                }
                
                titleEl.textContent = `Weekly Report - ${fileName || 'Report'}`;
                
                // Handle base64 files
                if (storageMethod === 'base64' && fileBase64) {
                    iframe.src = 'data:application/pdf;base64,' + fileBase64;
                } else if (pdfUrl && pdfUrl.startsWith('data:')) {
                    // Extract base64 from data URL
                    iframe.src = pdfUrl;
                } else if (pdfUrl) {
                    // Regular Storage URL
                    iframe.src = pdfUrl;
                } else {
                    console.error('No file URL or base64 data provided');
                    alert('Error: Report file data not available.');
                    return;
                }
                
                // Position modal aligned with the weekly report widget, appearing higher up
                const weeklyReportsWidget = document.getElementById('weekly-reports-display')?.closest('.dashboard-widget');
                
                if (weeklyReportsWidget) {
                    const widgetRect = weeklyReportsWidget.getBoundingClientRect();
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                    
                    // Position to start from widget's top, appearing much higher (2x higher)
                    const topPosition = widgetRect.top + scrollTop - 600;
                    
                    // Align to widget's left edge and match its width
                    const widgetWidth = widgetRect.width;
                    const widgetLeft = widgetRect.left + scrollLeft;
                    
                    container.style.top = topPosition + 'px';
                    container.style.left = widgetLeft + 'px';
                    container.style.width = widgetWidth + 'px';
                    container.style.maxWidth = widgetWidth + 'px';
                    container.style.transform = 'none';
                    container.style.margin = '0';
                    container.style.position = 'absolute'; // Use absolute positioning so it scrolls with page
                    container.style.pointerEvents = 'auto'; // Allow interaction with modal content
                    container.style.zIndex = '10001'; // Above overlay
                } else if (viewButton) {
                    // Fallback: position above button, appearing higher
                    const buttonRect = viewButton.getBoundingClientRect();
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    
                    // Position above the button
                    const topPosition = buttonRect.top + scrollTop - 300; // Appear 300px above button
                    
                    container.style.top = topPosition + 'px';
                    container.style.left = '50%';
                    container.style.transform = 'translateX(-50%)';
                    container.style.margin = '0';
                    container.style.position = 'absolute';
                    container.style.pointerEvents = 'auto';
                    container.style.zIndex = '10001';
                } else {
                    // Final fallback: center on screen
                    container.style.top = '50%';
                    container.style.left = '50%';
                    container.style.transform = 'translate(-50%, -50%)';
                    container.style.position = 'fixed';
                }
                
                // Show modal - allow page scrolling
                modal.style.display = 'block';
                // Don't disable scrolling - allow user to scroll to see the modal
                document.body.style.overflow = '';
            }
            
            // View weekly video in modal (similar to PDF viewer)
            function viewWeeklyVideo(videoUrl, videoTitle, watchButton = null) {
                // Create or use video viewer modal
                let videoModal = document.getElementById('weekly-video-viewer-modal');
                
                if (!videoModal) {
                    // Create video modal if it doesn't exist
                    videoModal = document.createElement('div');
                    videoModal.id = 'weekly-video-viewer-modal';
                    videoModal.style.display = 'none';
                    videoModal.style.position = 'fixed';
                    videoModal.style.top = '0';
                    videoModal.style.left = '0';
                    videoModal.style.width = '100%';
                    videoModal.style.height = '100%';
                    videoModal.style.zIndex = '10000';
                    videoModal.style.overflowY = 'auto';
                    videoModal.style.pointerEvents = 'none';
                    
                    const overlay = document.createElement('div');
                    overlay.className = 'admin-modal-overlay';
                    overlay.style.position = 'fixed';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.width = '100%';
                    overlay.style.minHeight = '100%';
                    overlay.style.background = 'rgba(0, 0, 0, 0.5)';
                    overlay.style.zIndex = '999';
                    overlay.style.pointerEvents = 'auto';
                    overlay.addEventListener('click', function() {
                        closeWeeklyVideoViewer();
                    });
                    
                    const container = document.createElement('div');
                    container.id = 'weekly-video-viewer-container';
                    container.style.maxWidth = '100%';
                    container.style.width = 'auto';
                    container.style.maxHeight = '85vh';
                    container.style.position = 'absolute';
                    container.style.background = 'white';
                    container.style.borderRadius = '12px';
                    container.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.2)';
                    container.style.pointerEvents = 'auto';
                    container.style.zIndex = '10001';
                    
                    const content = document.createElement('div');
                    content.style.padding = '0';
                    
                    const header = document.createElement('div');
                    header.style.padding = '1rem 1.5rem';
                    header.style.borderBottom = '1px solid #e5e7eb';
                    header.style.display = 'flex';
                    header.style.justifyContent = 'space-between';
                    header.style.alignItems = 'center';
                    header.style.background = 'white';
                    header.style.borderRadius = '12px 12px 0 0';
                    
                    const titleEl = document.createElement('h2');
                    titleEl.id = 'weekly-video-viewer-title';
                    titleEl.style.margin = '0';
                    titleEl.style.fontSize = '1.125rem';
                    titleEl.style.fontWeight = '600';
                    titleEl.style.color = '#1f2937';
                    
                    const closeBtn = document.createElement('span');
                    closeBtn.id = 'weekly-video-viewer-close';
                    closeBtn.style.cursor = 'pointer';
                    closeBtn.style.color = '#6b7280';
                    closeBtn.style.fontSize = '1.5rem';
                    closeBtn.style.lineHeight = '1';
                    closeBtn.style.padding = '0.25rem';
                    closeBtn.style.transition = 'color 0.2s';
                    closeBtn.textContent = 'Ã—';
                    closeBtn.addEventListener('mouseenter', function() {
                        this.style.color = '#1f2937';
                    });
                    closeBtn.addEventListener('mouseleave', function() {
                        this.style.color = '#6b7280';
                    });
                    closeBtn.addEventListener('click', closeWeeklyVideoViewer);
                    
                    header.appendChild(titleEl);
                    header.appendChild(closeBtn);
                    
                    const body = document.createElement('div');
                    body.style.padding = '1.5rem';
                    body.style.overflow = 'auto';
                    body.style.maxHeight = 'calc(85vh - 80px)';
                    body.style.background = '#f9fafb';
                    
                    const videoPlayer = document.createElement('video');
                    videoPlayer.id = 'weekly-video-viewer-player';
                    videoPlayer.controls = true;
                    videoPlayer.style.width = '100%';
                    videoPlayer.style.height = 'auto';
                    videoPlayer.style.border = '1px solid #e5e7eb';
                    videoPlayer.style.borderRadius = '8px';
                    videoPlayer.style.background = 'black';
                    videoPlayer.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                    
                    body.appendChild(videoPlayer);
                    content.appendChild(header);
                    content.appendChild(body);
                    container.appendChild(content);
                    videoModal.appendChild(overlay);
                    videoModal.appendChild(container);
                    document.body.appendChild(videoModal);
                }
                
                const container = document.getElementById('weekly-video-viewer-container');
                const titleEl = document.getElementById('weekly-video-viewer-title');
                const videoPlayer = document.getElementById('weekly-video-viewer-player');
                
                if (!container || !titleEl || !videoPlayer) {
                    console.error('Video viewer elements not found');
                    return;
                }
                
                titleEl.textContent = `Weekly Video - ${videoTitle || 'Video'}`;
                videoPlayer.src = videoUrl;
                
                // Position modal aligned with the weekly report widget
                const weeklyReportsWidget = document.getElementById('weekly-reports-display')?.closest('.dashboard-widget');
                
                if (weeklyReportsWidget) {
                    const widgetRect = weeklyReportsWidget.getBoundingClientRect();
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                    
                    const topPosition = widgetRect.top + scrollTop - 200;
                    const widgetWidth = widgetRect.width;
                    const widgetLeft = widgetRect.left + scrollLeft;
                    
                    container.style.top = topPosition + 'px';
                    container.style.left = widgetLeft + 'px';
                    container.style.width = widgetWidth + 'px';
                    container.style.maxWidth = widgetWidth + 'px';
                    container.style.transform = 'none';
                    container.style.margin = '0';
                    container.style.position = 'absolute';
                    container.style.pointerEvents = 'auto';
                    container.style.zIndex = '10001';
                } else if (watchButton) {
                    const buttonRect = watchButton.getBoundingClientRect();
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const topPosition = buttonRect.top + scrollTop - 300;
                    
                    container.style.top = topPosition + 'px';
                    container.style.left = '50%';
                    container.style.transform = 'translateX(-50%)';
                    container.style.margin = '0';
                    container.style.position = 'absolute';
                    container.style.pointerEvents = 'auto';
                    container.style.zIndex = '10001';
                } else {
                    container.style.top = '50%';
                    container.style.left = '50%';
                    container.style.transform = 'translate(-50%, -50%)';
                    container.style.position = 'fixed';
                }
                
                videoModal.style.display = 'block';
                document.body.style.overflow = '';
            }
            
            // Close weekly video viewer
            function closeWeeklyVideoViewer() {
                const videoModal = document.getElementById('weekly-video-viewer-modal');
                const videoPlayer = document.getElementById('weekly-video-viewer-player');
                if (videoModal) videoModal.style.display = 'none';
                if (videoPlayer) {
                    videoPlayer.pause();
                    videoPlayer.src = '';
                }
                document.body.style.overflow = '';
            }
            
            // Load chat messages when community view is shown
            const communityView = document.getElementById('community-view');
            if (communityView) {
                // Use MutationObserver to detect when community view becomes visible
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            if (communityView.style.display !== 'none') {
                                loadCommunityChatMessages();
                                loadProfessorsMessages();
                                loadWeeklyReports();
                            }
                        }
                    });
                });
                observer.observe(communityView, { attributes: true, attributeFilter: ['style'] });
            }
            
            // Market News Functions - Load from Firestore
            async function loadMarketNews() {
                const container = document.getElementById('news-grid');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">Loading news...</div>';
                
                try {
                    let newsData = [];
                    if (window.firestoreService) {
                        newsData = await window.firestoreService.getAllNews();
                        console.log('News loaded from Firestore:', newsData.length);
                    } else {
                        console.warn('Firestore service not available');
                        newsData = [];
                    }
                    
                    container.innerHTML = '';
                    
                    if (newsData.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);"><p style="margin: 0 0 1rem 0;">No news articles available at the moment.</p><p style="margin: 0; font-size: 0.875rem;">Please check back later for the latest market news.</p></div>';
                        return;
                    }
                    
                    newsData.forEach((news) => {
                        const newsCard = document.createElement('a');
                        newsCard.href = news.link;
                        newsCard.target = '_blank';
                        newsCard.rel = 'noopener noreferrer';
                        newsCard.className = 'news-card';
                        newsCard.innerHTML = `
                            <div class="news-image-container">
                                <img src="${news.image}" alt="${news.title}" class="news-image" />
                                <h3 class="news-title">${news.title}</h3>
                            </div>
                        `;
                        container.appendChild(newsCard);
                    });
                } catch (error) {
                    console.error('Error loading news:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #dc2626; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);"><p style="margin: 0;">Error loading news. Please try again later.</p></div>';
                }
            }
            
            // Load Latest News titles in Dashboard widget from Market News
            async function loadDashboardLatestNews() {
                const newsWidget = document.getElementById('dashboard-news-widget');
                if (!newsWidget) return;
                
                const newsContent = newsWidget.querySelector('.dashboard-widget-content');
                if (!newsContent) return;
                
                try {
                    let newsData = [];
                    if (window.firestoreService) {
                        newsData = await window.firestoreService.getAllNews();
                    } else {
                        console.warn('Firestore service not available');
                        return;
                    }
                    
                    // Clear existing content
                    newsContent.innerHTML = '';
                    
                    if (newsData.length === 0) {
                        newsContent.innerHTML = '<div class="dashboard-news-item"><div class="dashboard-news-title" style="color: #9ca3af;">No news available</div></div>';
                        return;
                    }
                    
                    // Show up to 4 latest news items
                    const latestNews = newsData.slice(0, 4);
                    
                    latestNews.forEach((news) => {
                        const newsItem = document.createElement('div');
                        newsItem.className = 'dashboard-news-item';
                        newsItem.style.cursor = 'pointer';
                        newsItem.innerHTML = `<div class="dashboard-news-title">${news.title}</div>`;
                        
                        // Make it clickable to open the news link
                        newsItem.addEventListener('click', function() {
                            if (news.link) {
                                window.open(news.link, '_blank', 'noopener,noreferrer');
                            }
                        });
                        
                        newsContent.appendChild(newsItem);
                    });
                } catch (error) {
                    console.error('Error loading dashboard news:', error);
                    newsContent.innerHTML = '<div class="dashboard-news-item"><div class="dashboard-news-title" style="color: #dc2626;">Error loading news</div></div>';
                }
            }
            
            // Make loadMarketNews available globally
            window.loadMarketNews = loadMarketNews;
            window.loadDashboardLatestNews = loadDashboardLatestNews;
            
            // Setup profile picture upload
            const profileContainer = document.getElementById('profile-picture-container');
            const profileInput = document.getElementById('profile-picture-input');
            const profileOverlay = profileContainer?.querySelector('.profile-picture-upload-overlay');
            
            if (profileContainer && profileInput) {
                // Show overlay on hover
                profileContainer.addEventListener('mouseenter', function() {
                    if (profileOverlay) profileOverlay.style.display = 'flex';
                });
                
                profileContainer.addEventListener('mouseleave', function() {
                    if (profileOverlay) profileOverlay.style.display = 'none';
                });
                
                // Click to upload
                profileContainer.addEventListener('click', function() {
                    profileInput.click();
                });
                
                // Handle file selection
                profileInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file.');
                        return;
                    }
                    
                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Image size must be less than 5MB.');
                        return;
                    }
                    
                    try {
                        // Get user data - use investor-specific key to avoid admin conflicts
                        let userSession = sessionStorage.getItem('investorUser') || sessionStorage.getItem('user');
                        if (!userSession) {
                            alert('User session not found. Please log in again.');
                            return;
                        }
                        
                        const user = JSON.parse(userSession);
                        const userData = user.userData || {};
                        
                        // Ensure this is an investor, not admin
                        if (userData.type && userData.type === 'admin') {
                            alert('This is an admin session. Please use the admin portal.');
                            return;
                        }
                        
                        // Get user document ID from Firestore (must be the specific user's ID)
                        // First try to get it from userData.id (Firestore document ID)
                        let userDocId = userData.id;
                        
                        // If not found, try to find by username (most reliable)
                        if (!userDocId && user.username) {
                            if (window.firebaseDb) {
                                const userQuery = await window.firebaseDb.collection('users')
                                    .where('username', '==', user.username)
                                    .where('type', '==', 'investor') // Ensure it's an investor
                                    .limit(1)
                                    .get();
                                
                                if (!userQuery.empty) {
                                    userDocId = userQuery.docs[0].id;
                                    // Update userData with the correct ID
                                    userData.id = userDocId;
                                    user.userData = userData;
                                    sessionStorage.setItem('investorUser', JSON.stringify(user));
                                    sessionStorage.setItem('user', JSON.stringify(user));
                                }
                            }
                        }
                        
                        // If still not found, try by email
                        if (!userDocId && userData.email) {
                            if (window.firebaseDb) {
                                const userQuery = await window.firebaseDb.collection('users')
                                    .where('email', '==', userData.email)
                                    .where('type', '==', 'investor') // Ensure it's an investor
                                    .limit(1)
                                    .get();
                                
                                if (!userQuery.empty) {
                                    userDocId = userQuery.docs[0].id;
                                    // Update userData with the correct ID
                                    userData.id = userDocId;
                                    user.userData = userData;
                                    sessionStorage.setItem('investorUser', JSON.stringify(user));
                                    sessionStorage.setItem('user', JSON.stringify(user));
                                }
                            }
                        }
                        
                        if (!userDocId) {
                            alert('User ID not found. Please log out and log in again.');
                            console.error('User data:', user);
                            console.error('UserData:', userData);
                            return;
                        }
                        
                        console.log('Using Firestore document ID for profile picture:', userDocId);
                        
                        // Show loading state - use spinner instead of text
                        const profileImg = document.getElementById('profile-picture-img');
                        const placeholder = document.getElementById('profile-picture-placeholder');
                        if (placeholder) {
                            placeholder.innerHTML = '<div style="width: 20px; height: 20px; border: 2px solid #6b7280; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>';
                            placeholder.style.opacity = '0.7';
                        }
                        
                        // Convert image to base64 data URL (avoids Storage CORS issues)
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            try {
                                const base64DataUrl = e.target.result;
                                
                                // Update user document in Firestore with base64 data URL
                                if (window.firebaseDb && userDocId) {
                                    await window.firebaseDb.collection('users').doc(userDocId).update({
                                        profilePictureUrl: base64DataUrl,
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    
                                    // Update sessionStorage - only update this specific user's data
                                    user.userData = user.userData || {};
                                    user.userData.profilePictureUrl = base64DataUrl;
                                    // Use investor-specific key to avoid conflicts with admin
                                    sessionStorage.setItem('investorUser', JSON.stringify(user));
                                    // Also keep 'user' for backward compatibility (only if it's an investor)
                                    if (!userData.type || userData.type !== 'admin') {
                                        sessionStorage.setItem('user', JSON.stringify(user));
                                    }
                                    
                                    // Update display
                                    loadProfilePicture(base64DataUrl);
                                    
                                    // Reset placeholder opacity
                                    if (placeholder) {
                                        placeholder.style.opacity = '1';
                                    }
                                    
                                    console.log('Profile picture updated successfully');
                                }
                            } catch (error) {
                                console.error('Error saving profile picture:', error);
                                alert('Error saving profile picture: ' + error.message);
                                if (placeholder) {
                                    placeholder.innerHTML = '<span>ðŸ‘¤</span>';
                                    placeholder.style.opacity = '1';
                                }
                            }
                        };
                        
                        reader.onerror = function(error) {
                            console.error('Error reading file:', error);
                            alert('Error reading image file.');
                            if (placeholder) {
                                placeholder.innerHTML = '<span>ðŸ‘¤</span>';
                                placeholder.style.opacity = '1';
                            }
                        };
                        
                        // Read file as data URL
                        reader.readAsDataURL(file);
                    } catch (error) {
                        console.error('Error uploading profile picture:', error);
                        alert('Error uploading profile picture: ' + error.message);
                    }
                });
            }
    });
    </script>
    
    <!-- Image Modal/Lightbox -->
    <div id="image-modal" class="image-modal">
        <span class="image-modal-close">&times;</span>
        <img class="image-modal-content" id="image-modal-img" src="" alt="Full size image">
    </div>
</body>
</html>

