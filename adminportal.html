<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Opessocius</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Admin Modal Styles */
        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
        }
        .admin-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
        .admin-modal-container {
            position: relative;
            background: white;
            max-width: 500px;
            margin: 50px auto;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        .admin-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6b7280;
            z-index: 1;
        }
        .admin-modal-close:hover {
            color: #1f2937;
        }
        .admin-modal-content {
            padding: 2rem;
        }
        .admin-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #1f2937;
        }
        .admin-form-group {
            margin-bottom: 1.25rem;
        }
        .admin-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        .admin-form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .admin-form-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .admin-form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: flex-end;
        }
        .admin-btn-save, .admin-btn-cancel, .admin-btn-add, .admin-edit-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .admin-btn-save {
            background: #2563eb;
            color: white;
        }
        .admin-btn-save:hover {
            background: #1d4ed8;
        }
        .admin-btn-cancel {
            background: #e5e7eb;
            color: #374151;
        }
        .admin-btn-cancel:hover {
            background: #d1d5db;
        }
        .admin-btn-add {
            background: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .admin-btn-add:hover {
            background: #059669;
        }
        .admin-edit-btn {
            background: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        .admin-edit-btn:hover {
            background: #4b5563;
        }
        .admin-btn-view {
            background: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .admin-btn-view:hover {
            background: #4b5563;
        }
        
        /* Investors/Users Grid */
        .investors-grid, .users-grid, .reports-users-grid, .consultations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        /* Consultation Card Styles */
        .consultation-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s;
        }
        .consultation-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .consultation-card.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }
        .consultation-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        .consultation-status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .consultation-status-done {
            background: #d1fae5;
            color: #065f46;
        }
        .investor-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .investor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .investor-card-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: #1f2937;
        }
        .investor-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .investor-status-active {
            background: #d1fae5;
            color: #065f46;
        }
        .investor-status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }
        .investor-card-body p {
            margin: 0.5rem 0;
            color: #6b7280;
        }
        .investor-card-actions {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .return-positive {
            color: #10b981;
            font-weight: 600;
        }
        
        /* News Edit Button */
        .news-card-wrapper {
            position: relative;
        }
        .news-edit-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(37, 99, 235, 0.9);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            z-index: 10;
        }
        .news-edit-btn:hover {
            background: rgba(37, 99, 235, 1);
        }
        
        /* Transactions table edit button */
        .transactions-table th:last-child,
        .transactions-table td:last-child {
            text-align: center;
        }
    </style>
</head>
<body class="dashboard-active">
    <section class="user-dashboard" id="user-dashboard">
        <div class="dashboard-sidebar">
            <div class="sidebar-profile">
                <div class="sidebar-profile-image-container" id="admin-profile-picture-container" style="position: relative; cursor: pointer; width: 80px; height: 80px; margin: 0 auto;">
                    <img src="" alt="Profile Picture" class="sidebar-profile-image" id="admin-profile-picture-img" style="display: none; width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #ffffff; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);" />
                    <div class="profile-picture-placeholder" id="admin-profile-picture-placeholder" style="width: 80px; height: 80px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 2rem; border: 3px solid #ffffff; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                        <span>ðŸ‘¤</span>
                    </div>
                    <div class="profile-picture-upload-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; font-size: 0.75rem; text-align: center; padding: 0.5rem; cursor: pointer;">
                        Click to upload
                    </div>
                </div>
                <input type="file" id="admin-profile-picture-input" accept="image/*" style="display: none;" />
                <div class="sidebar-profile-name">Admin</div>
            </div>
            <nav class="sidebar-navigation">
                <a href="#" class="sidebar-nav-item active">
                    <span>Dashboard</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Portfolio</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Transactions</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Performance</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Market News</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Account Settings</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Reports</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Consultations</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Emails</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <a href="index.html" class="sidebar-footer-item">
                    <span>Return to Home</span>
                </a>
                <a href="login.html" class="sidebar-footer-item" id="logout-btn">
                    <span>Logout</span>
                </a>
            </div>
        </div>
        <div class="dashboard-content">
            <!-- Dashboard View -->
            <div class="dashboard-view" id="dashboard-view" style="display: block;">
                <div class="dashboard-widgets-grid">
                    <!-- Crude Oil Price - Top Left -->
                    <div class="dashboard-widget dashboard-widget-oil" style="grid-column: 1; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Crude Oil Price</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="tradingview-widget-container-dashboard">
                                <div class="tradingview-widget-container__widget"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                                {
                                    "symbol": "USOIL",
                                    "width": "100%",
                                    "height": "160",
                                    "locale": "en",
                                    "dateRange": "1D",
                                    "colorTheme": "light",
                                    "trendLineColor": "rgba(37, 99, 235, 1)",
                                    "underLineColor": "rgba(37, 99, 235, 0.3)",
                                    "isTransparent": false,
                                    "autosize": true,
                                    "largeChartUrl": ""
                                }
                                </script>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Balance - Top Right Row 1 -->
                    <div class="dashboard-widget" style="grid-column: 2; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Current Balance</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="dashboard-main-metric" id="dashboard-current-balance">â‚¬287,450</div>
                            <div class="dashboard-sub-metric">Capital Invested: â‚¬230,000</div>
                        </div>
                    </div>
                    
                    <!-- Total Gain - Top Right Row 1 -->
                    <div class="dashboard-widget" style="grid-column: 3; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Total Gain</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="dashboard-main-metric dashboard-metric-positive" id="dashboard-total-gain">+24.98%</div>
                            <div class="dashboard-sub-metric">â‚¬57,450 profit</div>
                        </div>
                    </div>
                    
                    <!-- 12 Month Projection - Top Right Row 1 -->
                    <div class="dashboard-widget" style="grid-column: 4; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">12 Month Projection</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="dashboard-projection-value" id="dashboard-projection-value">â‚¬355,108</div>
                            <div class="dashboard-sub-metric">Projected ending capital</div>
                        </div>
                    </div>
                    
                    <!-- Latest News - Second Row -->
                    <div class="dashboard-widget dashboard-widget-clickable" id="dashboard-news-widget" style="grid-column: 1; grid-row: 2;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Latest News</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="dashboard-news-item">
                                <div class="dashboard-news-title">OPEC+ Maintains Production Cuts</div>
                            </div>
                            <div class="dashboard-news-item">
                                <div class="dashboard-news-title">Crude Oil Prices Rally on Middle East Tensions</div>
                            </div>
                            <div class="dashboard-news-item">
                                <div class="dashboard-news-title">US Shale Production Hits Record High</div>
                            </div>
                            <div class="dashboard-news-item">
                                <div class="dashboard-news-title">China's Oil Demand Growth Slows in Q4</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Latest Report - Second Row -->
                    <div class="dashboard-widget" style="grid-column: 2; grid-row: 2;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Latest Report</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="dashboard-report-item">
                                <div class="dashboard-report-period">November 2024</div>
                                <div class="dashboard-report-metrics">
                                    <span class="dashboard-report-gain">+17.39%</span>
                                    <span class="dashboard-report-balance">â‚¬270,000</span>
                                </div>
                                <button class="dashboard-report-download" data-month="2024-11">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </button>
                            </div>
                            <div class="dashboard-report-item">
                                <div class="dashboard-report-period">December 2024</div>
                                <div class="dashboard-report-metrics">
                                    <span class="dashboard-report-gain">+19.57%</span>
                                    <span class="dashboard-report-balance">â‚¬275,000</span>
                                </div>
                                <button class="dashboard-report-download" data-month="2024-12">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </button>
                            </div>
                            <div class="dashboard-report-item">
                                <div class="dashboard-report-period">January 2025</div>
                                <div class="dashboard-report-metrics">
                                    <span class="dashboard-report-gain">+21.74%</span>
                                    <span class="dashboard-report-balance">â‚¬280,000</span>
                                </div>
                                <button class="dashboard-report-download" data-month="2025-01">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Investors Payment Tracking Widget - Second Row -->
                    <div class="dashboard-widget" style="grid-column: 3 / 5; grid-row: 2 / 3;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Investors Payment Tracking</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div id="investors-payment-list">
                                <!-- Investors will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Stories -->
                    <div class="dashboard-widget">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Top Stories</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="tradingview-widget-container-dashboard">
                                <div class="tradingview-widget-container__widget"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-timeline.js" async>
                                {
                                    "feedMode": "all_symbols",
                                    "colorTheme": "light",
                                    "isTransparent": false,
                                    "displayMode": "regular",
                                    "width": "100%",
                                    "height": "300",
                                    "locale": "en"
                                }
                                </script>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Economic Calendar - Third Row, spans 3 columns -->
                    <div class="dashboard-widget dashboard-widget-wide" style="grid-column: 2 / 5; grid-row: 3;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Economic Calendar</h3>
                            <p class="dashboard-widget-subtitle" style="font-size: 0.75rem; color: #6b7280; margin: 0;">Keep track of key economic events</p>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="tradingview-widget-container-dashboard">
                                <div class="tradingview-widget-container__widget"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-events.js" async>
                                {
                                    "colorTheme": "light",
                                    "isTransparent": false,
                                    "width": "100%",
                                    "height": "300",
                                    "locale": "en",
                                    "importanceFilter": "-1,0,1"
                                }
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio View -->
            <div class="portfolio-view" id="portfolio-view" style="display: none;">
                <div class="portfolio-balance-cards">
                    <div class="balance-card">
                        <div class="balance-label">Total Fund Capital Invested</div>
                        <div class="balance-amount" id="capital-invested">â‚¬8,500,000</div>
                    </div>
                    <div class="balance-card">
                        <div class="balance-label">Total Fund Balance</div>
                        <div class="balance-amount" id="current-balance">â‚¬10,625,000</div>
                    </div>
                    <div class="balance-card">
                        <div class="balance-label">Total Fund Gain</div>
                        <div class="balance-amount balance-amount-gain" id="total-gain">+25.00%</div>
                    </div>
                    <div class="balance-card">
                        <div class="balance-label">12 Month Projection</div>
                        <div class="balance-amount" id="portfolio-projection">â‚¬13,150,000</div>
                    </div>
                </div>
                <div class="portfolio-chart-container">
                    <div class="portfolio-chart-card">
                        <h3 class="portfolio-chart-title">Fund Performance & Projection</h3>
                        <div class="chart-wrapper">
                            <canvas id="portfolio-chart" width="800" height="400"></canvas>
                            <div id="chart-tooltip" class="chart-tooltip" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transactions View -->
            <div class="transactions-view" id="transactions-view" style="display: none;">
                <div class="transactions-add-section" style="background: white; padding: 2rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                    <h3 style="margin-top: 0; margin-bottom: 1.5rem; font-size: 1.25rem; color: #1f2937;">Add Fund Performance</h3>
                    <form id="fund-performance-form" class="admin-modal-form" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; align-items: end;">
                        <div class="admin-form-group">
                            <label for="fund-month">Month</label>
                            <select id="fund-month" class="admin-form-input" required>
                                <option value="">Select Month</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-year">Year</label>
                            <input type="number" id="fund-year" class="admin-form-input" min="2020" max="2030" value="2024" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-starting-balance">Starting Balance (â‚¬)</label>
                            <input type="number" id="fund-starting-balance" class="admin-form-input" step="0.01" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-ending-balance">Ending Balance (â‚¬)</label>
                            <input type="number" id="fund-ending-balance" class="admin-form-input" step="0.01" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-growth">Growth %</label>
                            <input type="number" id="fund-growth" class="admin-form-input" step="0.01" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-deposits">Deposits (â‚¬)</label>
                            <input type="number" id="fund-deposits" class="admin-form-input" step="0.01" value="0" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-deposit-date">Deposit Date</label>
                            <input type="date" id="fund-deposit-date" class="admin-form-input">
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-withdrawals">Withdrawals (â‚¬)</label>
                            <input type="number" id="fund-withdrawals" class="admin-form-input" step="0.01" value="0" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-withdrawal-date">Withdrawal Date</label>
                            <input type="date" id="fund-withdrawal-date" class="admin-form-input">
                        </div>
                        <div class="admin-form-group">
                            <button type="submit" class="admin-btn-save" style="width: 100%;">Add Performance</button>
                        </div>
                    </form>
                </div>
                <div class="transactions-table-container">
                    <table class="transactions-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Starting Balance</th>
                                <th>Ending Balance</th>
                                <th>Growth %</th>
                                <th>Deposits</th>
                                <th>Withdrawals</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table-body">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Transaction Edit Modal -->
            <div id="transaction-edit-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title">Edit Transaction</h2>
                        <form id="transaction-edit-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="edit-starting-balance">Starting Balance (â‚¬)</label>
                                <input type="number" id="edit-starting-balance" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-ending-balance">Ending Balance (â‚¬)</label>
                                <input type="number" id="edit-ending-balance" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-growth">Growth %</label>
                                <input type="number" id="edit-growth" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-deposits">Deposits (â‚¬)</label>
                                <input type="number" id="edit-deposits" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-deposit-date">Deposit Date</label>
                                <input type="date" id="edit-deposit-date" class="admin-form-input">
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-withdrawals">Withdrawals (â‚¬)</label>
                                <input type="number" id="edit-withdrawals" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-withdrawal-date">Withdrawal Date</label>
                                <input type="date" id="edit-withdrawal-date" class="admin-form-input">
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="delete-transaction-btn" style="background: #dc2626; color: white; margin-right: auto;">Delete Transaction</button>
                                <button type="button" class="admin-btn-cancel" id="cancel-transaction-edit">Cancel</button>
                                <button type="submit" class="admin-btn-save">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Performance View - Investors List -->
            <div class="performance-view" id="performance-view" style="display: none;">
                <div class="investors-list-container">
                    <div class="investors-grid" id="investors-grid">
                        <!-- Investors will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Investor Performance Modal -->
            <div id="investor-performance-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="investor-performance-modal-title">Add Performance</h2>
                        <form id="investor-performance-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="performance-month">Month</label>
                                <select id="performance-month" class="admin-form-input" required>
                                    <option value="">Select Month</option>
                                    <option value="January">January</option>
                                    <option value="February">February</option>
                                    <option value="March">March</option>
                                    <option value="April">April</option>
                                    <option value="May">May</option>
                                    <option value="June">June</option>
                                    <option value="July">July</option>
                                    <option value="August">August</option>
                                    <option value="September">September</option>
                                    <option value="October">October</option>
                                    <option value="November">November</option>
                                    <option value="December">December</option>
                                </select>
                            </div>
                            <div class="admin-form-group">
                                <label for="performance-year">Year</label>
                                <input type="number" id="performance-year" class="admin-form-input" min="2020" max="2030" value="2024" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="performance-return-percent">Return % (Actual monthly return - overrides strategy default)</label>
                                <input type="number" id="performance-return-percent" class="admin-form-input" step="0.01" placeholder="Leave empty to use strategy default (2% or 4%)">
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">If actual performance differs from target, enter the actual return % here. All calculations will use this value.</span>
                            </div>
                            <div class="admin-form-group" id="performance-growth-group" style="display: none;">
                                <label for="performance-growth">Growth Rate (%) - Only for Personalized Strategy</label>
                                <input type="number" id="performance-growth" class="admin-form-input" step="0.01" value="0">
                            </div>
                            <div class="admin-form-group">
                                <label for="performance-deposits">Deposits (â‚¬)</label>
                                <input type="number" id="performance-deposits" class="admin-form-input" step="0.01" value="0" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="performance-deposit-date">Deposit Date (Required if deposit amount > 0)</label>
                                <input type="date" id="performance-deposit-date" class="admin-form-input">
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">Growth will be prorated based on deposit date</span>
                            </div>
                            <div class="admin-form-group">
                                <label for="performance-withdrawals">Withdrawals (â‚¬)</label>
                                <input type="number" id="performance-withdrawals" class="admin-form-input" step="0.01" value="0" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="performance-withdrawal-date">Withdrawal Date</label>
                                <input type="date" id="performance-withdrawal-date" class="admin-form-input">
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="cancel-investor-performance">Cancel</button>
                                <button type="submit" class="admin-btn-save">Add Performance</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Investor Performance Table Modal -->
            <div id="investor-performance-table-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container" style="max-width: 900px;">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="investor-performance-table-title">Performance History</h2>
                        <div class="performance-table-container">
                            <table class="transactions-table">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Starting Balance</th>
                                        <th>Ending Balance</th>
                                        <th>Growth %</th>
                                        <th>Deposits</th>
                                        <th>Withdrawals</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="investor-performance-table-body">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Investor Edit/Add Modal -->
            <div id="investor-edit-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container" style="max-width: 600px;">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="investor-modal-title">Edit Investor</h2>
                        <form id="investor-edit-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="edit-investor-name">Full Name</label>
                                <input type="text" id="edit-investor-name" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-email">Email Address</label>
                                <input type="email" id="edit-investor-email" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-phone">Phone Number</label>
                                <input type="tel" id="edit-investor-phone" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-account">Account Number</label>
                                <input type="text" id="edit-investor-account" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-initial">Initial Investment (â‚¬)</label>
                                <input type="number" id="edit-investor-initial" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-balance">Current Balance (â‚¬)</label>
                                <input type="number" id="edit-investor-balance" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-status">Account Status</label>
                                <select id="edit-investor-status" class="admin-form-input" required>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Suspended">Suspended</option>
                                </select>
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="cancel-investor-edit">Cancel</button>
                                <button type="submit" class="admin-btn-save">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Account Settings View -->
            <div class="account-settings-view" id="account-settings-view" style="display: none;">
                <div class="account-settings-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="margin: 0; font-size: 1.5rem; color: #1f2937;">User Management</h2>
                        <button class="admin-btn-save" onclick="openAddUserModal()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                            + Add New User
                        </button>
                    </div>
                    <div class="users-list-container">
                        <div class="users-grid" id="users-grid">
                            <!-- Users will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Edit Modal -->
            <div id="user-edit-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container" style="max-width: 700px;">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="user-modal-title">Edit User</h2>
                        <form id="user-edit-form" class="admin-modal-form">
                            <h3 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem; color: #1f2937;">Account Information</h3>
                            <div class="admin-form-group">
                                <label for="edit-user-username">Username</label>
                                <input type="text" id="edit-user-username" class="admin-form-input" placeholder="Enter username for login" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-user-password">Password (View Only)</label>
                                <input type="text" id="edit-user-password" class="admin-form-input" placeholder="Password" readonly style="background-color: #f3f4f6; cursor: not-allowed;">
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;" id="user-password-hint">Password is view-only. Cannot be changed after user creation.</span>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-user-name">Full Name</label>
                                <input type="text" id="edit-user-name" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-user-email">Email Address</label>
                                <input type="email" id="edit-user-email" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-user-phone">Phone Number</label>
                                <input type="tel" id="edit-user-phone" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-user-status">Account Status</label>
                                <select id="edit-user-status" class="admin-form-input" required>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Suspended">Suspended</option>
                                </select>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-user-country">Country</label>
                                <input type="text" id="edit-user-country" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-user-member-since">Initiation Date</label>
                                <input type="date" id="edit-user-member-since" class="admin-form-input" required>
                            </div>

                            <h3 style="margin-top: 2rem; margin-bottom: 1rem; font-size: 1.1rem; color: #1f2937;">Investment Details</h3>
                            <div class="admin-form-group">
                                <label for="edit-user-initial">Initial Investment (â‚¬)</label>
                                <input type="number" id="edit-user-initial" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-user-strategy">Investment Strategy</label>
                                <select id="edit-user-strategy" class="admin-form-input" required>
                                    <option value="Low risk 2% a month">Low risk 2% a month</option>
                                    <option value="High risk 4% a month">High risk 4% a month</option>
                                    <option value="Personalized">Personalized</option>
                                </select>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-user-operator">Assigned Operator Email</label>
                                <input type="email" id="edit-user-operator" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group" style="padding: 1rem; background: #f3f4f6; border-radius: 6px; margin-top: 1rem;">
                                <p style="margin: 0; color: #6b7280; font-size: 0.875rem;"><strong>Note:</strong> Current Balance and Total Return are calculated automatically based on performance entries.</p>
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="delete-user-btn" style="background: #dc2626; color: white; font-size: 0.875rem; padding: 0.5rem 1rem; display: none;">Delete</button>
                                <button type="button" class="admin-btn-cancel" id="cancel-user-edit">Cancel</button>
                                <button type="submit" class="admin-btn-save">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Reports View -->
            <div class="reports-view" id="reports-view" style="display: none;">
                <div class="reports-content">
                    <div class="reports-users-grid" id="reports-users-grid">
                        <!-- Users will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Admin Reports Widget Modal -->
            <div id="admin-reports-widget-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container" style="max-width: 800px;">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title">Admin Account Reports</h2>
                        <div class="reports-widgets-container" id="admin-reports-widgets-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                            <!-- Report widgets will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Report Upload Modal -->
            <div id="report-upload-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="report-upload-modal-title">Upload Monthly Report</h2>
                        <form id="report-upload-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="report-month">Month</label>
                                <select id="report-month" class="admin-form-input" required>
                                    <option value="">Select Month</option>
                                    <option value="January">January</option>
                                    <option value="February">February</option>
                                    <option value="March">March</option>
                                    <option value="April">April</option>
                                    <option value="May">May</option>
                                    <option value="June">June</option>
                                    <option value="July">July</option>
                                    <option value="August">August</option>
                                    <option value="September">September</option>
                                    <option value="October">October</option>
                                    <option value="November">November</option>
                                    <option value="December">December</option>
                                </select>
                            </div>
                            <div class="admin-form-group">
                                <label for="report-year">Year</label>
                                <input type="number" id="report-year" class="admin-form-input" min="2020" max="2030" value="2024" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="report-file">Upload PDF Report</label>
                                <input type="file" id="report-file" class="admin-form-input" accept=".pdf" required>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">Maximum file size: 10MB</span>
                                <div id="file-selected-info" style="margin-top: 0.5rem; padding: 0.75rem; background: #eff6ff; border-radius: 6px; display: none;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                        </svg>
                                        <div>
                                            <div style="font-weight: 600; color: #1e40af;" id="selected-file-name"></div>
                                            <div style="font-size: 0.75rem; color: #3b82f6;" id="selected-file-size"></div>
                                        </div>
                                    </div>
                                </div>
                                <div id="upload-progress" style="margin-top: 1rem; display: none;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: #374151;">Uploading...</span>
                                        <span style="font-size: 0.875rem; font-weight: 600; color: #2563eb;" id="upload-progress-percent">0%</span>
                                    </div>
                                    <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                        <div id="upload-progress-bar" style="height: 100%; background: #2563eb; width: 0%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="cancel-report-upload">Cancel</button>
                                <button type="submit" class="admin-btn-save" id="upload-report-btn">Upload Report</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Reports List Modal -->
            <div id="reports-list-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container" style="max-width: 700px;">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="reports-list-title">User Reports</h2>
                        <div id="reports-list-container" style="margin-top: 1.5rem;">
                            <!-- Reports list will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Report Viewer Modal (for Admin) -->
            <div id="report-viewer-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container" style="max-width: 90%; max-height: 90vh;">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content" style="padding: 0;">
                        <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="admin-modal-title" id="report-viewer-title" style="margin: 0;">Monthly Report</h2>
                            <button id="download-report-btn" class="admin-btn-save" style="padding: 0.5rem 1rem; margin-right: 2.5rem;">Download</button>
                        </div>
                        <div style="padding: 2rem; overflow: auto; max-height: calc(90vh - 100px);">
                            <iframe id="report-viewer-iframe" style="width: 100%; height: 800px; border: 1px solid #e5e7eb; border-radius: 6px;"></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Consultations View -->
            <div class="consultations-view" id="consultations-view" style="display: none;">
                <div class="consultations-content">
                    <!-- Filter Tabs -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid #e5e7eb;">
                        <button class="consultation-tab-btn active" data-filter="all" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 600; cursor: pointer; font-size: 1rem;">All Consultations</button>
                        <button class="consultation-tab-btn" data-filter="pending" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; font-size: 1rem;">Pending</button>
                        <button class="consultation-tab-btn" data-filter="done" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; font-size: 1rem;">Done</button>
                    </div>

                    <!-- Consultations List -->
                    <div class="consultations-list-container">
                        <div class="consultations-grid" id="consultations-grid">
                            <!-- Consultations will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Send Email Section (for Pending Consultations) -->
                    <div class="send-email-section" id="send-email-section" style="display: none; background: white; padding: 2rem; border-radius: 8px; margin-top: 2rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                        <h3 style="margin-top: 0; margin-bottom: 1.5rem; font-size: 1.25rem; color: #1f2937;">Send Google Meet Link</h3>
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Selected Consultation:</label>
                            <div id="selected-consultation-info" style="padding: 1rem; background: #f3f4f6; border-radius: 6px; color: #6b7280;">
                                No consultation selected
                            </div>
                        </div>
                        <form id="send-email-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="google-meet-link">Google Meet Link</label>
                                <input type="url" id="google-meet-link" class="admin-form-input" placeholder="https://meet.google.com/xxx-xxxx-xxx" required>
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="cancel-send-email">Clear Selection</button>
                                <button type="submit" class="admin-btn-save">Send Google Meet Link</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Emails View -->
            <div class="emails-view" id="emails-view" style="display: none;">
                <div class="emails-content">
                    <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                        <h2 style="margin-top: 0; margin-bottom: 2rem; font-size: 1.5rem; color: #1f2937;">Send Email</h2>
                        
                        <form id="send-email-to-user-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="email-recipient">Email Recipient(s)</label>
                                <div id="email-recipients-container">
                                    <div class="email-recipient-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="email" class="admin-form-input email-recipient-input" placeholder="Enter email address" required style="flex: 1;">
                                        <button type="button" class="remove-email-btn" style="display: none; background: #fca5a5; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Remove</button>
                                    </div>
                                </div>
                                <button type="button" id="add-email-recipient-btn" style="margin-top: 0.5rem; padding: 0.5rem 1rem; font-size: 0.875rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">+ Add Another Email</button>
                            </div>

                            <div class="admin-form-group">
                                <label for="email-subject-input">Email Subject</label>
                                <input type="text" id="email-subject-input" class="admin-form-input" placeholder="Enter email subject" required>
                            </div>

                            <div class="admin-form-group">
                                <label for="email-message-input">Email Message</label>
                                <textarea id="email-message-input" class="admin-form-input" rows="10" placeholder="Write your email message here..." required></textarea>
                            </div>

                            <div class="admin-form-group">
                                <label for="email-attachment">Attach PDF (Optional)</label>
                                <input type="file" id="email-attachment" class="admin-form-input" accept=".pdf" multiple>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">You can attach multiple PDF files</span>
                                <div id="attachment-list" style="margin-top: 0.5rem;">
                                    <!-- Selected attachments will be listed here -->
                                </div>
                            </div>

                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="clear-email-form">Clear Form</button>
                                <button type="submit" class="admin-btn-save">Send Email</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Market News View -->
            <div class="market-news-view" id="market-news-view" style="display: none;">
                <div class="market-news-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="margin: 0; font-size: 1.5rem; color: #1f2937;">Market News</h2>
                        <button class="admin-btn-save" onclick="openAddNewsModal()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                            + Add New Article
                        </button>
                    </div>
                    <div class="market-news-chart-section">
                        <div class="tradingview-widget-container market-news-chart">
                            <div id="market_news_chart"></div>
                            <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
                            <script type="text/javascript">
                                new TradingView.widget({
                                    "width": "100%",
                                    "height": 500,
                                    "symbol": "USOIL",
                                    "interval": "60",
                                    "theme": "light",
                                    "style": "1",
                                    "timezone": "Europe/Amsterdam",
                                    "locale": "en",
                                    "allow_symbol_change": true,
                                    "withdateranges": true,
                                    "container_id": "market_news_chart",
                                    "hide_volume": true,
                                    "studies": [
                                        {
                                            "id": "MASimple@tv-basicstudies",
                                            "inputs": {
                                                "length": 200,
                                                "source": "close",
                                                "maType": "EMA"
                                            },
                                            "overrides": {
                                                "plot.color": "#FFFF00",
                                                "plot.linewidth": 3
                                            }
                                        }
                                    ]
                                });
                            </script>
                        </div>
                    </div>
                    <div class="market-news-articles-section">
                        <div class="news-grid" id="news-grid">
                            <!-- News articles will be loaded from Firestore -->
                        </div>
                    </div>
            </div>

            <!-- News Edit Modal -->
            <div id="news-edit-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="news-modal-title">Edit News Article</h2>
                        <form id="news-edit-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="edit-news-title">Title</label>
                                <input type="text" id="edit-news-title" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-news-link">Link URL</label>
                                <input type="url" id="edit-news-link" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-news-image">Image URL</label>
                                <input type="url" id="edit-news-image" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-news-order">Display Order</label>
                                <input type="number" id="edit-news-order" class="admin-form-input" min="0" value="0">
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">Lower numbers appear first</span>
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="delete-news-btn" onclick="deleteNews()" style="background: #dc2626; color: white; font-size: 0.875rem; padding: 0.5rem 1rem; display: none;">Delete</button>
                                <button type="button" class="admin-btn-cancel" id="cancel-news-edit" onclick="closeNewsEditModal()">Cancel</button>
                                <button type="submit" class="admin-btn-save">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </section>
    
    <script src="script.js"></script>
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
    
    <!-- Firebase Configuration and Service -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD9DvEzXUxUppgsp71H5d3abPKWkjkea6A",
            authDomain: "opessocius-17ab9.firebaseapp.com",
            projectId: "opessocius-17ab9",
            storageBucket: "opessocius-17ab9.firebasestorage.app",
            messagingSenderId: "835445796116",
            appId: "1:835445796116:web:71b8595886ecb53e612601",
            measurementId: "G-44CX9N3E3J"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Initialize services
        const db = firebase.firestore();
        const auth = firebase.auth();
        const analytics = firebase.analytics();
        
        // Make available globally
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseAnalytics = analytics;
        window.firebase = firebase;
        
        // Firestore Service Functions (using CDN API)
        window.firestoreService = {
            USERS_COLLECTION: 'users',
            
            // Convert HTML date to Firestore Timestamp
            convertToFirestoreDate: function(dateString) {
                if (!dateString) return null;
                try {
                    const date = new Date(dateString);
                    return firebase.firestore.Timestamp.fromDate(date);
                } catch (error) {
                    console.error('Error converting date:', error);
                    return null;
                }
            },
            
            // Convert Firestore Timestamp to HTML date format
            convertFromFirestoreDate: function(firestoreDate) {
                if (!firestoreDate) return '';
                try {
                    let date;
                    if (firestoreDate.toDate) {
                        date = firestoreDate.toDate();
                    } else if (firestoreDate instanceof Date) {
                        date = firestoreDate;
                    } else {
                        date = new Date(firestoreDate);
                    }
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                } catch (error) {
                    console.error('Error converting Firestore date:', error);
                    return '';
                }
            },
            
            // Create user
            createUser: async function(userData) {
                try {
                    console.log('createUser called with data:', userData);
                    const userDoc = {
                        username: userData.username,
                        email: userData.email,
                        password: userData.password || '', // Store password in Firestore (for admin viewing/editing)
                        phone: userData.phone || '',
                        accountNumber: userData.account || '',
                        accountStatus: userData.status || 'Active',
                        country: userData.country || '',
                        memberSince: userData.memberSince ? this.convertToFirestoreDate(userData.memberSince) : null,
                        fullName: userData.name || '',
                        initialInvestment: userData.initial || 0,
                        currentBalance: userData.initial || 0,
                        totalReturn: 0,
                        investmentStrategy: userData.strategy || '',
                        assignedOperatorEmail: userData.operator || '',
                        profilePictureUrl: null, // Initialize profile picture as null - user can upload later
                        type: userData.type || 'investor',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    console.log('User document to save:', userDoc);
                    const docRef = await db.collection(this.USERS_COLLECTION).add(userDoc);
                    console.log('User created successfully with ID: ', docRef.id);
                    return docRef.id;
                } catch (error) {
                    console.error('Error creating user:', error);
                    throw error;
                }
            },
            
            // Update user
            updateUser: async function(userId, userData) {
                try {
                    const updateData = {
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    if (userData.username !== undefined) updateData.username = userData.username;
                    if (userData.email !== undefined) updateData.email = userData.email;
                    // Update password in Firestore if provided (not undefined and not empty)
                    if (userData.password !== undefined && userData.password !== '') {
                        updateData.password = userData.password;
                        console.log('Password will be updated in Firestore for user:', userId);
                        console.log('Password value (first 3 chars):', userData.password.substring(0, 3) + '***'); // Log for debugging
                    } else {
                        console.log('Password not included in update (keeping current password)');
                    }
                    if (userData.name !== undefined) updateData.fullName = userData.name;
                    if (userData.phone !== undefined) updateData.phone = userData.phone;
                    if (userData.status !== undefined) updateData.accountStatus = userData.status;
                    if (userData.country !== undefined) updateData.country = userData.country;
                    if (userData.memberSince !== undefined) {
                        updateData.memberSince = userData.memberSince ? this.convertToFirestoreDate(userData.memberSince) : null;
                    }
                    if (userData.account !== undefined) updateData.accountNumber = userData.account;
                    if (userData.initial !== undefined) updateData.initialInvestment = userData.initial;
                    if (userData.strategy !== undefined) updateData.investmentStrategy = userData.strategy;
                    if (userData.operator !== undefined) updateData.assignedOperatorEmail = userData.operator;
                    await db.collection(this.USERS_COLLECTION).doc(userId).update(updateData);
                    console.log('User updated successfully in Firestore');
                    console.log('Updated fields:', Object.keys(updateData));
                } catch (error) {
                    console.error('Error updating user:', error);
                    throw error;
                }
            },
            
            // Delete user
            deleteUser: async function(userId) {
                try {
                    // Get user data first to get email for Firebase Auth deletion
                    const userDoc = await db.collection(this.USERS_COLLECTION).doc(userId).get();
                    const userData = userDoc.exists ? userDoc.data() : null;
                    
                    // Delete from Firestore
                    await db.collection(this.USERS_COLLECTION).doc(userId).delete();
                    console.log('User deleted from Firestore:', userId);
                    
                    // Delete from Firebase Auth if email exists
                    if (userData && userData.email && window.firebaseAuth) {
                        try {
                            // Get user by email from Firebase Auth
                            // Note: We need to use Admin SDK for this, but as a workaround,
                            // we can try to sign in and then delete (if password is known)
                            // However, the best approach is to store the Firebase Auth UID in Firestore
                            
                            // For now, we'll just delete from Firestore
                            // Firebase Auth users will need to be cleaned up manually or via Admin SDK
                            console.log('User deleted from Firestore. Note: Firebase Auth user with email ' + userData.email + ' may still exist and needs to be deleted via Firebase Console or Admin SDK.');
                        } catch (authError) {
                            console.warn('Could not delete from Firebase Auth:', authError);
                            // Continue - Firestore deletion succeeded
                        }
                    }
                    
                    console.log('User deleted successfully');
                } catch (error) {
                    console.error('Error deleting user:', error);
                    throw error;
                }
            },
            
            // Get user by ID
            getUserById: async function(userId) {
                try {
                    const doc = await db.collection(this.USERS_COLLECTION).doc(userId).get();
                    if (doc.exists) {
                        return { id: doc.id, ...doc.data() };
                    }
                    return null;
                } catch (error) {
                    console.error('Error getting user:', error);
                    throw error;
                }
            },
            
            // Get user by username
            getUserByUsername: async function(username) {
                try {
                    const snapshot = await db.collection(this.USERS_COLLECTION)
                        .where('username', '==', username)
                        .limit(1)
                        .get();
                    if (!snapshot.empty) {
                        const doc = snapshot.docs[0];
                        return { id: doc.id, ...doc.data() };
                    }
                    return null;
                } catch (error) {
                    console.error('Error getting user by username:', error);
                    throw error;
                }
            },
            
            // Get user by email
            getUserByEmail: async function(email) {
                try {
                    const snapshot = await db.collection(this.USERS_COLLECTION)
                        .where('email', '==', email)
                        .limit(1)
                        .get();
                    if (!snapshot.empty) {
                        const doc = snapshot.docs[0];
                        return { id: doc.id, ...doc.data() };
                    }
                    return null;
                } catch (error) {
                    console.error('Error getting user by email:', error);
                    throw error;
                }
            },
            
            // Get all users
            getAllUsers: async function(userType = null) {
                try {
                    let query = db.collection(this.USERS_COLLECTION).orderBy('createdAt', 'desc');
                    if (userType) {
                        query = query.where('type', '==', userType);
                    }
                    const snapshot = await query.get();
                    const users = [];
                    snapshot.forEach((doc) => {
                        users.push({ id: doc.id, ...doc.data() });
                    });
                    return users;
                } catch (error) {
                    console.error('Error getting all users:', error);
                    throw error;
                }
            },
            
            // Format user for admin portal
            formatUserForAdminPortal: function(firestoreUser) {
                return {
                    id: firestoreUser.id,
                    username: firestoreUser.username || '',
                    email: firestoreUser.email || '',
                    password: firestoreUser.password || '', // Include password from Firestore
                    name: firestoreUser.fullName || '',
                    phone: firestoreUser.phone || '',
                    status: firestoreUser.accountStatus || 'Active',
                    country: firestoreUser.country || '',
                    memberSince: this.convertFromFirestoreDate(firestoreUser.memberSince) || '',
                    initial: firestoreUser.initialInvestment || 0,
                    balance: firestoreUser.currentBalance || 0,
                    return: firestoreUser.totalReturn || 0,
                    strategy: firestoreUser.investmentStrategy || '',
                    operator: firestoreUser.assignedOperatorEmail || '',
                    type: firestoreUser.type || 'investor',
                    createdAt: firestoreUser.createdAt,
                    updatedAt: firestoreUser.updatedAt
                };
            },
            
            // Update user balance and return
            updateUserBalance: async function(userId, newBalance) {
                try {
                    const userRef = db.collection(this.USERS_COLLECTION).doc(userId);
                    const userSnap = await userRef.get();
                    
                    if (userSnap.exists) {
                        const userData = userSnap.data();
                        const initialInvestment = userData.initialInvestment || 0;
                        const totalReturn = initialInvestment > 0 
                            ? ((newBalance - initialInvestment) / initialInvestment * 100) 
                            : 0;
                        
                        await userRef.update({
                            currentBalance: newBalance,
                            totalReturn: totalReturn,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                } catch (error) {
                    console.error('Error updating user balance:', error);
                    throw error;
                }
            },
            
            // Market News Functions
            NEWS_COLLECTION: 'marketNews',
            
            // Create news article
            createNews: async function(newsData) {
                try {
                    const newsDoc = {
                        title: newsData.title,
                        link: newsData.link,
                        image: newsData.image,
                        order: newsData.order || 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    const docRef = await db.collection(this.NEWS_COLLECTION).add(newsDoc);
                    return docRef.id;
                } catch (error) {
                    console.error('Error creating news:', error);
                    throw error;
                }
            },
            
            // Update news article
            updateNews: async function(newsId, newsData) {
                try {
                    const updateData = {
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    if (newsData.title !== undefined) updateData.title = newsData.title;
                    if (newsData.link !== undefined) updateData.link = newsData.link;
                    if (newsData.image !== undefined) updateData.image = newsData.image;
                    if (newsData.order !== undefined) updateData.order = newsData.order;
                    await db.collection(this.NEWS_COLLECTION).doc(newsId).update(updateData);
                } catch (error) {
                    console.error('Error updating news:', error);
                    throw error;
                }
            },
            
            // Delete news article
            deleteNews: async function(newsId) {
                try {
                    await db.collection(this.NEWS_COLLECTION).doc(newsId).delete();
                } catch (error) {
                    console.error('Error deleting news:', error);
                    throw error;
                }
            },
            
            // Get all news articles
            getAllNews: async function() {
                try {
                    const snapshot = await db.collection(this.NEWS_COLLECTION)
                        .orderBy('order', 'asc')
                        .orderBy('createdAt', 'desc')
                        .get();
                    const news = [];
                    snapshot.forEach((doc) => {
                        news.push({ id: doc.id, ...doc.data() });
                    });
                    return news;
                } catch (error) {
                    console.error('Error getting news:', error);
                    // If orderBy fails (no index), try without order
                    try {
                        const snapshot = await db.collection(this.NEWS_COLLECTION)
                            .orderBy('createdAt', 'desc')
                            .get();
                        const news = [];
                        snapshot.forEach((doc) => {
                            news.push({ id: doc.id, ...doc.data() });
                        });
                        // Sort by order manually
                        news.sort((a, b) => (a.order || 0) - (b.order || 0));
                        return news;
                    } catch (fallbackError) {
                        console.error('Error getting news (fallback):', fallbackError);
                        throw fallbackError;
                    }
                }
            },
            
            // Consultations Functions
            CONSULTATIONS_COLLECTION: 'consultations',
            
            // Get all consultations
            getAllConsultations: async function() {
                try {
                    const snapshot = await db.collection(this.CONSULTATIONS_COLLECTION)
                        .orderBy('createdAt', 'desc')
                        .get();
                    const consultations = [];
                    snapshot.forEach((doc) => {
                        consultations.push({ id: doc.id, ...doc.data() });
                    });
                    return consultations;
                } catch (error) {
                    console.error('Error getting consultations:', error);
                    throw error;
                }
            },
            
            // Update consultation status
            updateConsultationStatus: async function(consultationId, status) {
                try {
                    await db.collection(this.CONSULTATIONS_COLLECTION)
                        .doc(consultationId)
                        .update({
                            status: status,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                } catch (error) {
                    console.error('Error updating consultation status:', error);
                    throw error;
                }
            }
        };
        
        // Dispatch event when services are ready
        window.dispatchEvent(new CustomEvent('firestoreReady'));
        
        console.log('Firebase and Firestore services loaded from CDN');
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Navigation handling
            const navItems = document.querySelectorAll('.sidebar-nav-item');
            const dashboardView = document.getElementById('dashboard-view');
            const portfolioView = document.getElementById('portfolio-view');
            const transactionsView = document.getElementById('transactions-view');
            const performanceView = document.getElementById('performance-view');

            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Get text from span element
                    const span = this.querySelector('span');
                    const navText = span ? span.textContent.trim() : this.textContent.trim();
                    
                    // Remove active class from all items
                    navItems.forEach(nav => nav.classList.remove('active'));
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Get all views
                    const marketNewsView = document.getElementById('market-news-view');
                    const accountSettingsView = document.getElementById('account-settings-view');
                    const reportsView = document.getElementById('reports-view');
                    const consultationsView = document.getElementById('consultations-view');
                    const emailsView = document.getElementById('emails-view');
                    
                    // Hide all views
                    if (dashboardView) dashboardView.style.display = 'none';
                    if (portfolioView) portfolioView.style.display = 'none';
                    if (transactionsView) transactionsView.style.display = 'none';
                    if (performanceView) performanceView.style.display = 'none';
                    if (marketNewsView) marketNewsView.style.display = 'none';
                    if (accountSettingsView) accountSettingsView.style.display = 'none';
                    if (reportsView) reportsView.style.display = 'none';
                    if (consultationsView) consultationsView.style.display = 'none';
                    if (emailsView) emailsView.style.display = 'none';
                    
                    // Show selected view
                    if (navText === 'Dashboard' && dashboardView) {
                        dashboardView.style.display = 'block';
                        // Load users first if not already loaded, then load transactions and payment list
                        const loadDashboardData = async () => {
                            try {
                                // Load users if not already loaded
                                if (!usersData || usersData.length === 0) {
                                    if (window.firestoreService) {
                                        const firestoreUsers = await window.firestoreService.getAllUsers();
                                        usersData = firestoreUsers.map(user => 
                                            window.firestoreService.formatUserForAdminPortal(user)
                                        );
                                    }
                                }
                                // Load transactions first, then update dashboard
                                await populateTransactionsTable();
                                updateDashboardMetrics();
                                loadInvestorsPaymentList();
                                // Load latest news widget
                                setTimeout(loadDashboardLatestNews, 100);
                            } catch (error) {
                                console.error('Error loading dashboard data:', error);
                                // If load fails, still try to load payment list
                                loadInvestorsPaymentList();
                                // Load latest news widget
                                setTimeout(loadDashboardLatestNews, 100);
                            }
                        };
                        loadDashboardData();
                    } else if (navText === 'Portfolio' && portfolioView) {
                        portfolioView.style.display = 'block';
                        // Load transactions first, then update metrics and chart
                        populateTransactionsTable().then(() => {
                            setTimeout(function() {
                                drawPortfolioChart();
                            }, 100);
                        }).catch(() => {
                            // If load fails, still try to draw chart with existing data
                            setTimeout(function() {
                                drawPortfolioChart();
                            }, 100);
                        });
                    } else if (navText === 'Transactions' && transactionsView) {
                        transactionsView.style.display = 'block';
                        populateTransactionsTable();
                    } else if (navText === 'Performance' && performanceView) {
                        performanceView.style.display = 'block';
                        loadInvestorsList();
                    } else if (navText === 'Market News' && marketNewsView) {
                        marketNewsView.style.display = 'block';
                        loadMarketNews();
                        // Update dashboard latest news widget
                        setTimeout(loadDashboardLatestNews, 100);
                    } else if (navText === 'Account Settings' && accountSettingsView) {
                        accountSettingsView.style.display = 'block';
                        // Wait for Firestore service if needed
                        if (window.firestoreService) {
                            loadUsersList();
                        } else {
                            // Wait for service to load
                            const checkService = setInterval(() => {
                                if (window.firestoreService) {
                                    clearInterval(checkService);
                                    loadUsersList();
                                }
                            }, 100);
                            // Timeout after 5 seconds
                            setTimeout(() => clearInterval(checkService), 5000);
                        }
                    } else if (navText === 'Reports' && reportsView) {
                        reportsView.style.display = 'block';
                        loadReportsUsersList();
                    } else if (navText === 'Consultations' && consultationsView) {
                        consultationsView.style.display = 'block';
                        loadConsultationsList();
                    } else if (navText === 'Emails' && emailsView) {
                        emailsView.style.display = 'block';
                    }
                });
            });

            // Portfolio Chart Function
            let chartDataPoints = [];
            
            function drawPortfolioChart() {
                const canvas = document.getElementById('portfolio-chart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const container = canvas.parentElement;
                const width = container ? container.clientWidth - 64 : 800;
                const height = 480;
                
                // Set canvas size
                canvas.width = width;
                canvas.height = height;
                
                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                
                // Chart configuration
                const padding = { top: 40, right: 40, bottom: 60, left: 80 };
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;
                
                // Get historical data from transactionData
                let historicalData = [];
                let initialInvestment = 0;
                
                if (transactionData && transactionData.length > 0) {
                    // Use actual transaction data - show final balance (ending balance - withdrawals)
                    initialInvestment = transactionData[0].starting;
                    
                    // Calculate final balance for each entry: ending balance - withdrawals
                    historicalData = transactionData.map(entry => {
                        const finalBalance = entry.ending - (entry.withdrawals || 0);
                        return finalBalance;
                    });
                } else {
                    // Default fallback data
                    initialInvestment = 8500000;
                    historicalData = [
                        8500000, 8700000, 8800000, 8950000, 9100000, 9250000, 9400000, 9550000, 9750000, 9950000, 10150000, 10350000
                    ];
                }
                
                // Calculate projection data based on average growth
                let projectionData = [];
                const lastHistoricalValue = historicalData[historicalData.length - 1];
                
                if (transactionData && transactionData.length > 1) {
                    // Calculate average monthly growth rate
                    let totalGrowth = 0;
                    let growthCount = 0;
                    transactionData.forEach(entry => {
                        if (entry.growth && entry.growth !== 0) {
                            totalGrowth += entry.growth;
                            growthCount++;
                        }
                    });
                    
                    const avgMonthlyGrowth = growthCount > 0 ? (totalGrowth / growthCount) / 100 : 0.02;
                    
                    // Project 12 months forward
                    let projectionValue = lastHistoricalValue;
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * (1 + avgMonthlyGrowth);
                        projectionData.push(projectionValue);
                    }
                } else {
                    // Default projection (2% monthly growth)
                    let projectionValue = lastHistoricalValue;
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * 1.02;
                        projectionData.push(projectionValue);
                    }
                }
                
                // Month labels for chart
                const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const totalMonths = historicalData.length + projectionData.length;
                const months = [];
                
                // Generate month labels based on actual data
                if (transactionData && transactionData.length > 0) {
                    // Only add transaction months (one label per transaction entry)
                    transactionData.forEach((entry) => {
                        const monthAbbr = entry.month.substring(0, 3);
                        const monthIndex = monthLabels.indexOf(monthAbbr);
                        if (monthIndex >= 0) {
                            months.push(monthLabels[monthIndex]);
                        } else {
                            months.push(monthAbbr);
                        }
                    });
                    
                    // Add projection months (12 months forward from last transaction)
                    const lastTransactionMonth = transactionData[transactionData.length - 1].month.substring(0, 3);
                    const lastMonthIndex = monthLabels.indexOf(lastTransactionMonth);
                    let currentMonthIndex = (lastMonthIndex + 1) % 12; // Start from next month
                    for (let i = 0; i < 12; i++) {
                        months.push(monthLabels[currentMonthIndex]);
                        currentMonthIndex = (currentMonthIndex + 1) % 12;
                    }
                } else {
                    // Default labels
                    months.push(...monthLabels, ...monthLabels);
                }
                
                // Combine data
                const allData = [...historicalData, ...projectionData];
                const maxValue = Math.max(...allData) * 1.1;
                const minValue = Math.min(...allData) * 0.9;
                const valueRange = maxValue - minValue;
                
                // Store data points for hover interaction - only for transaction entries
                chartDataPoints = [];
                
                // Historical data points (transaction entries only)
                historicalData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    // Use the growth percentage directly from transactionData - exactly as stored, no calculations
                    // This matches exactly how the transactions table displays it: growth.toFixed(2)
                    // The growth value is stored as a number (e.g., 5.5 for 5.5%), same as in transactions table
                    const growth = transactionData && transactionData[index] ? (transactionData[index].growth || 0) : 0;
                    const growthValue = parseFloat(growth);
                    const growthPercent = growthValue.toFixed(2);
                    chartDataPoints.push({
                        x: x,
                        y: y,
                        value: value,
                        month: months[index] || `M${index + 1}`,
                        growthPercent: growthPercent,
                        growthValue: growthValue, // Store the numeric value for sign calculation
                        isHistorical: true
                    });
                });
                
                // Projection data points
                projectionData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (historicalData.length + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    const growthPercent = ((value - initialInvestment) / initialInvestment * 100).toFixed(2);
                    chartDataPoints.push({
                        x: x,
                        y: y,
                        value: value,
                        month: months[historicalData.length + index] || `P${index + 1}`,
                        growthPercent: growthPercent,
                        isHistorical: false
                    });
                });
                
                // Draw grid lines
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 5; i++) {
                    const y = padding.top + (chartHeight / 5) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding.left, y);
                    ctx.lineTo(width - padding.right, y);
                    ctx.stroke();
                }
                
                // Draw area fill below the line (only historical section with gradient)
                if (historicalData.length > 0) {
                    const gradient = ctx.createLinearGradient(
                        padding.left, 
                        padding.top, 
                        padding.left + (chartWidth / totalMonths) * historicalData.length, 
                        padding.top + chartHeight
                    );
                    gradient.addColorStop(0, 'rgba(37, 99, 235, 0.25)');
                    gradient.addColorStop(1, 'rgba(37, 99, 235, 0.05)');
                    
                    ctx.beginPath();
                    const firstX = padding.left + (chartWidth / totalMonths) / 2;
                    const firstY = padding.top + chartHeight - ((historicalData[0] - minValue) / valueRange) * chartHeight;
                    ctx.moveTo(firstX, height - padding.bottom);
                    ctx.lineTo(firstX, firstY);
                    
                    // Historical area only
                    historicalData.forEach((value, index) => {
                        const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                        const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                        ctx.lineTo(x, y);
                    });
                    
                    // Close at the last historical point
                    const lastHistoricalIndex = historicalData.length - 1;
                    const lastHistoricalX = padding.left + (chartWidth / totalMonths) * lastHistoricalIndex + (chartWidth / totalMonths) / 2;
                    ctx.lineTo(lastHistoricalX, height - padding.bottom);
                    ctx.closePath();
                    ctx.fillStyle = gradient;
                    ctx.fill();
                }
                
                // Draw historical line
                if (historicalData.length > 0) {
                    ctx.beginPath();
                    ctx.strokeStyle = '#2563eb';
                    ctx.lineWidth = 2.5;
                    historicalData.forEach((value, index) => {
                        const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                        const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                        
                        if (index === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    ctx.stroke();
                }
                
                // Draw projection line (dashed, green, continuing from historical)
                if (projectionData.length > 0 && historicalData.length > 0) {
                    ctx.beginPath();
                    ctx.strokeStyle = '#10b981';
                    ctx.lineWidth = 2.5;
                    ctx.setLineDash([6, 4]);
                    projectionData.forEach((value, index) => {
                        const x = padding.left + (chartWidth / totalMonths) * (historicalData.length + index) + (chartWidth / totalMonths) / 2;
                        const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                        
                        if (index === 0) {
                            // Connect to last historical point
                            const lastHistX = padding.left + (chartWidth / totalMonths) * (historicalData.length - 1) + (chartWidth / totalMonths) / 2;
                            const lastHistY = padding.top + chartHeight - ((historicalData[historicalData.length - 1] - minValue) / valueRange) * chartHeight;
                            ctx.moveTo(lastHistX, lastHistY);
                        }
                        ctx.lineTo(x, y);
                    });
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
                
                // Draw data points - only for transaction entries (one dot per transaction)
                historicalData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = '#2563eb';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                });
                
                // Draw projection data points
                projectionData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (historicalData.length + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = '#10b981';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                });
                
                // Draw Y-axis labels
                ctx.fillStyle = '#6b7280';
                ctx.font = '12px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                for (let i = 0; i <= 5; i++) {
                    const value = minValue + (valueRange / 5) * (5 - i);
                    const y = padding.top + (chartHeight / 5) * i;
                    const formattedValue = 'â‚¬' + (value / 1000).toFixed(0) + 'k';
                    ctx.fillText(formattedValue, padding.left - 10, y);
                }
                
                // Draw X-axis labels
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                const labelInterval = Math.max(1, Math.floor(totalMonths / 12)); // Show approximately 12 labels
                for (let i = 0; i < totalMonths; i += labelInterval) {
                    const x = padding.left + (chartWidth / totalMonths) * i + (chartWidth / totalMonths) / 2;
                    if (months[i]) {
                        ctx.fillText(months[i], x, height - padding.bottom + 10);
                    }
                }
            }
            
            // Add hover tooltip functionality
            function setupChartHover() {
                const canvas = document.getElementById('portfolio-chart');
                const tooltip = document.getElementById('chart-tooltip');
                if (!canvas || !tooltip) return;
                
                canvas.addEventListener('mousemove', function(e) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Find nearest data point
                    let nearestPoint = null;
                    let minDistance = Infinity;
                    
                    chartDataPoints.forEach(point => {
                        const distance = Math.sqrt(Math.pow(x - point.x, 2) + Math.pow(y - point.y, 2));
                        if (distance < 30 && distance < minDistance) {
                            minDistance = distance;
                            nearestPoint = point;
                        }
                    });
                    
                    if (nearestPoint) {
                        const formattedValue = 'â‚¬' + nearestPoint.value.toLocaleString('en-US');
                        // Match the exact format from transactions table: ${growthValue >= 0 ? '+' : ''}${growth.toFixed(2)}%
                        const growthValue = nearestPoint.growthValue !== undefined ? nearestPoint.growthValue : parseFloat(nearestPoint.growthPercent);
                        const growthSign = growthValue >= 0 ? '+' : '';
                        const growthDisplay = growthValue.toFixed(2);
                        tooltip.innerHTML = `
                            <div class="tooltip-balance">${formattedValue}</div>
                            <div class="tooltip-growth">${growthSign}${growthDisplay}%</div>
                        `;
                        tooltip.style.display = 'block';
                        tooltip.style.left = (nearestPoint.x + 10) + 'px';
                        tooltip.style.top = (nearestPoint.y - 40) + 'px';
                    } else {
                        tooltip.style.display = 'none';
                    }
                });
                
                canvas.addEventListener('mouseleave', function() {
                    if (tooltip) tooltip.style.display = 'none';
                });
            }
            
            // Setup hover after chart is drawn
            setTimeout(setupChartHover, 150);

            // Store transaction data globally for editing
            let transactionData = [];
            
            // Admin Fund Performance Firestore Functions
            const ADMIN_FUND_PERFORMANCE_COLLECTION = 'adminFundPerformance';
            
            // Save admin fund performance to Firestore
            async function saveAdminFundPerformance(performanceData) {
                try {
                    const monthIndex = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'].indexOf(performanceData.month);
                    
                    const docData = {
                        month: performanceData.month,
                        year: performanceData.year,
                        monthIndex: monthIndex,
                        startingBalance: performanceData.starting,
                        endingBalance: performanceData.ending,
                        growth: performanceData.growth,
                        deposits: performanceData.deposits || 0,
                        withdrawals: performanceData.withdrawals || 0,
                        depositDate: performanceData.depositDate ? firebase.firestore.Timestamp.fromDate(new Date(performanceData.depositDate)) : null,
                        withdrawalDate: performanceData.withdrawalDate ? firebase.firestore.Timestamp.fromDate(new Date(performanceData.withdrawalDate)) : null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Check if entry exists for this month/year
                    const querySnapshot = await db.collection(ADMIN_FUND_PERFORMANCE_COLLECTION)
                        .where('month', '==', performanceData.month)
                        .where('year', '==', performanceData.year)
                        .get();
                    
                    if (!querySnapshot.empty) {
                        // Update existing document
                        const docId = querySnapshot.docs[0].id;
                        await db.collection(ADMIN_FUND_PERFORMANCE_COLLECTION).doc(docId).update({
                            ...docData,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        return docId;
                    } else {
                        // Create new document
                        const docRef = await db.collection(ADMIN_FUND_PERFORMANCE_COLLECTION).add(docData);
                        return docRef.id;
                    }
                } catch (error) {
                    console.error('Error saving admin fund performance:', error);
                    throw error;
                }
            }
            
            // Load admin fund performance from Firestore
            async function loadAdminFundPerformance() {
                try {
                    const snapshot = await db.collection(ADMIN_FUND_PERFORMANCE_COLLECTION)
                        .orderBy('year', 'asc')
                        .orderBy('monthIndex', 'asc')
                        .get();
                    
                    const performanceData = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        performanceData.push({
                            id: doc.id,
                            month: data.month,
                            year: data.year,
                            starting: data.startingBalance,
                            ending: data.endingBalance,
                            growth: data.growth,
                            deposits: data.deposits || 0,
                            withdrawals: data.withdrawals || 0,
                            depositDate: data.depositDate ? data.depositDate.toDate().toISOString().split('T')[0] : null,
                            withdrawalDate: data.withdrawalDate ? data.withdrawalDate.toDate().toISOString().split('T')[0] : null
                        });
                    });
                    
                    return performanceData;
                } catch (error) {
                    console.error('Error loading admin fund performance:', error);
                    // If ordering fails, load all and sort in JavaScript
                    try {
                        const snapshot = await db.collection(ADMIN_FUND_PERFORMANCE_COLLECTION).get();
                        const performanceData = [];
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            performanceData.push({
                                id: doc.id,
                                month: data.month,
                                year: data.year,
                                starting: data.startingBalance,
                                ending: data.endingBalance,
                                growth: data.growth,
                                deposits: data.deposits || 0,
                                withdrawals: data.withdrawals || 0,
                                depositDate: data.depositDate ? data.depositDate.toDate().toISOString().split('T')[0] : null,
                                withdrawalDate: data.withdrawalDate ? data.withdrawalDate.toDate().toISOString().split('T')[0] : null
                            });
                        });
                        
                        // Sort in JavaScript
                        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                        performanceData.sort((a, b) => {
                            const yearDiff = a.year - b.year;
                            if (yearDiff !== 0) return yearDiff;
                            return months.indexOf(a.month) - months.indexOf(b.month);
                        });
                        
                        return performanceData;
                    } catch (fallbackError) {
                        console.error('Error in fallback load:', fallbackError);
                        return [];
                    }
                }
            }
            
            // Update admin fund performance in Firestore
            async function updateAdminFundPerformance(docId, performanceData) {
                try {
                    const monthIndex = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'].indexOf(performanceData.month);
                    
                    await db.collection(ADMIN_FUND_PERFORMANCE_COLLECTION).doc(docId).update({
                        month: performanceData.month,
                        year: performanceData.year,
                        monthIndex: monthIndex,
                        startingBalance: performanceData.starting,
                        endingBalance: performanceData.ending,
                        growth: performanceData.growth,
                        deposits: performanceData.deposits || 0,
                        withdrawals: performanceData.withdrawals || 0,
                        depositDate: performanceData.depositDate ? firebase.firestore.Timestamp.fromDate(new Date(performanceData.depositDate)) : null,
                        withdrawalDate: performanceData.withdrawalDate ? firebase.firestore.Timestamp.fromDate(new Date(performanceData.withdrawalDate)) : null,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error updating admin fund performance:', error);
                    throw error;
                }
            }
            
            // Delete admin fund performance from Firestore
            async function deleteAdminFundPerformance(docId) {
                try {
                    await db.collection(ADMIN_FUND_PERFORMANCE_COLLECTION).doc(docId).delete();
                    console.log('Admin fund performance deleted successfully');
                } catch (error) {
                    console.error('Error deleting admin fund performance:', error);
                    throw error;
                }
            }
            
            // Transactions Table Population
            async function populateTransactionsTable() {
                const tableBody = document.getElementById('transactions-table-body');
                if (!tableBody) return Promise.resolve();

                // Load from Firestore
                try {
                    transactionData = await loadAdminFundPerformance();
                    
                    // If no data exists, initialize with empty array (no default data)
                    if (transactionData.length === 0) {
                        transactionData = [];
                    }
                } catch (error) {
                    console.error('Error loading transactions:', error);
                    transactionData = [];
                }

                tableBody.innerHTML = '';

                if (transactionData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="7" style="text-align: center; padding: 2rem; color: #6b7280;">No performance data available. Add your first performance entry above.</td>';
                    tableBody.appendChild(row);
                } else {
                    transactionData.forEach((data, index) => {
                        const startingBalance = data.starting;
                        const endingBalance = data.ending;
                        const growth = data.growth;
                        const growthValue = parseFloat(growth);
                        const monthYear = `${data.month} ${data.year}`;
                        
                        const row = document.createElement('tr');
                        row.setAttribute('data-index', index);
                        row.setAttribute('data-id', data.id || '');
                        
                        // Format dates
                        const depositDisplay = data.deposits > 0 && data.depositDate 
                            ? `â‚¬${data.deposits.toLocaleString('en-US')}<br><span class="transaction-date">${formatDate(data.depositDate)}</span>`
                            : data.deposits > 0 ? `â‚¬${data.deposits.toLocaleString('en-US')}` : '-';
                        
                        const withdrawalDisplay = data.withdrawals > 0 && data.withdrawalDate 
                            ? `â‚¬${data.withdrawals.toLocaleString('en-US')}<br><span class="transaction-date">${formatDate(data.withdrawalDate)}</span>`
                            : data.withdrawals > 0 ? `â‚¬${data.withdrawals.toLocaleString('en-US')}` : '-';

                        const finalBalance = endingBalance - (data.withdrawals || 0);
                        
                        row.innerHTML = `
                            <td>${monthYear}</td>
                            <td>â‚¬${startingBalance.toLocaleString('en-US')}</td>
                            <td>â‚¬${finalBalance.toLocaleString('en-US')}</td>
                            <td class="${growthValue >= 0 ? 'growth-positive' : 'growth-negative'}">${growthValue >= 0 ? '+' : ''}${growth.toFixed(2)}%</td>
                            <td class="transaction-cell">${depositDisplay}</td>
                            <td class="transaction-cell">${withdrawalDisplay}</td>
                            <td><button class="admin-edit-btn" data-index="${index}">Edit</button></td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                    // Add edit button handlers
                    document.querySelectorAll('.admin-edit-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const index = parseInt(this.getAttribute('data-index'));
                            openTransactionEditModal(index);
                        });
                    });
                }
                
                // Update Portfolio section after loading transactions
                updatePortfolioMetrics();
            }
            
            // Update Dashboard Metrics based on transaction data
            function updateDashboardMetrics() {
                if (!transactionData || transactionData.length === 0) {
                    // Set default values if no data
                    const dashboardBalanceEl = document.getElementById('dashboard-current-balance');
                    const dashboardProjectionEl = document.getElementById('dashboard-projection-value');
                    if (dashboardBalanceEl) dashboardBalanceEl.textContent = 'â‚¬0';
                    if (dashboardProjectionEl) dashboardProjectionEl.textContent = 'â‚¬0';
                    return;
                }
                
                // Get latest final balance (ending balance - withdrawals)
                const latestEntry = transactionData[transactionData.length - 1];
                const currentBalance = latestEntry.ending - (latestEntry.withdrawals || 0);
                
                // Calculate total capital invested
                let totalCapitalInvested = 0;
                const firstStartingBalance = transactionData[0].starting;
                transactionData.forEach(entry => {
                    totalCapitalInvested += (entry.deposits || 0);
                });
                totalCapitalInvested += firstStartingBalance;
                
                // Calculate total fund gain percentage by summing all transaction growth percentages
                let totalGain = 0;
                transactionData.forEach(entry => {
                    if (entry.growth) {
                        totalGain += entry.growth;
                    }
                });
                
                // Calculate 12-month projection
                let projectionValue = currentBalance;
                if (transactionData.length > 1) {
                    let totalGrowth = 0;
                    let growthCount = 0;
                    transactionData.forEach(entry => {
                        if (entry.growth && entry.growth !== 0) {
                            totalGrowth += entry.growth;
                            growthCount++;
                        }
                    });
                    const avgMonthlyGrowth = growthCount > 0 ? (totalGrowth / growthCount) / 100 : 0.02;
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * (1 + avgMonthlyGrowth);
                    }
                } else {
                    const monthlyGrowthRate = 0.02;
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * (1 + monthlyGrowthRate);
                    }
                }
                
                // Update dashboard widgets
                const dashboardBalanceEl = document.getElementById('dashboard-current-balance');
                const dashboardGainEl = document.getElementById('dashboard-total-gain');
                const dashboardProjectionEl = document.getElementById('dashboard-projection-value');
                
                if (dashboardBalanceEl) {
                    dashboardBalanceEl.textContent = 'â‚¬' + Math.round(currentBalance).toLocaleString('en-US');
                }
                if (dashboardGainEl) {
                    dashboardGainEl.textContent = (totalGain >= 0 ? '+' : '') + totalGain.toFixed(2) + '%';
                    // Update profit text
                    const profit = currentBalance - totalCapitalInvested;
                    const profitElement = dashboardGainEl.nextElementSibling;
                    if (profitElement && profitElement.classList.contains('dashboard-sub-metric')) {
                        profitElement.textContent = 'â‚¬' + Math.round(profit).toLocaleString('en-US') + ' profit';
                    }
                }
                
                // Update capital invested text
                const dashboardCapitalEl = document.querySelector('#dashboard-view .dashboard-widget[style*="grid-column: 2"] .dashboard-sub-metric');
                if (dashboardCapitalEl) {
                    dashboardCapitalEl.textContent = 'Capital Invested: â‚¬' + Math.round(totalCapitalInvested).toLocaleString('en-US');
                }
                if (dashboardProjectionEl) {
                    dashboardProjectionEl.textContent = 'â‚¬' + Math.round(projectionValue).toLocaleString('en-US');
                }
                
                // Update Latest Report section with latest transactions
                updateLatestReports();
            }
            
            // Update Latest Reports section with latest admin reports
            async function updateLatestReports() {
                const reportContainer = document.querySelector('.dashboard-widget[style*="grid-column: 2; grid-row: 2"] .dashboard-widget-content');
                if (!reportContainer) return;
                
                reportContainer.innerHTML = '<div style="text-align: center; padding: 1rem; color: #6b7280;">Loading reports...</div>';
                
                try {
                    // Load admin reports from Firestore
                    const adminReportsSnapshot = await db.collection('users').doc(ADMIN_ACCOUNT_ID)
                        .collection('reports')
                        .get();
                    
                    const reportsList = [];
                    adminReportsSnapshot.forEach((doc) => {
                        const reportData = doc.data();
                        reportsList.push({
                            id: doc.id,
                            month: reportData.month,
                            year: reportData.year,
                            fileName: reportData.fileName,
                            fileUrl: reportData.fileUrl || (reportData.fileBase64 ? 'data:application/pdf;base64,' + reportData.fileBase64 : ''),
                            fileBase64: reportData.fileBase64,
                            storageMethod: reportData.storageMethod || 'storage'
                        });
                    });
                    
                    // Sort by year and month (most recent first)
                    reportsList.sort((a, b) => {
                        const monthMap = {
                            'January': 1, 'February': 2, 'March': 3, 'April': 4,
                            'May': 5, 'June': 6, 'July': 7, 'August': 8,
                            'September': 9, 'October': 10, 'November': 11, 'December': 12
                        };
                        const aMonth = monthMap[a.month] || 1;
                        const bMonth = monthMap[b.month] || 1;
                        if (b.year !== a.year) return b.year - a.year;
                        return bMonth - aMonth;
                    });
                    
                    // Get last 3 reports (most recent)
                    const latestReports = reportsList.slice(0, 3);
                    
                    reportContainer.innerHTML = '';
                    
                    if (latestReports.length === 0) {
                        reportContainer.innerHTML = '<div style="text-align: center; padding: 1rem; color: #6b7280;">No reports available</div>';
                        return;
                    }
                    
                    latestReports.forEach(report => {
                        const reportItem = document.createElement('div');
                        reportItem.className = 'dashboard-report-item';
                        
                        const period = document.createElement('div');
                        period.className = 'dashboard-report-period';
                        period.textContent = `${report.month} ${report.year}`;
                        
                        const metrics = document.createElement('div');
                        metrics.className = 'dashboard-report-metrics';
                        
                        // For admin reports, we don't have growth/balance data, so show placeholder or empty
                        const gain = document.createElement('span');
                        gain.className = 'dashboard-report-gain';
                        gain.textContent = 'â€”';
                        gain.style.opacity = '0.5';
                        
                        const balance = document.createElement('span');
                        balance.className = 'dashboard-report-balance';
                        balance.textContent = 'Admin Report';
                        balance.style.fontSize = '0.875rem';
                        balance.style.opacity = '0.7';
                        
                        metrics.appendChild(gain);
                        metrics.appendChild(balance);
                        
                        // Convert month name to number for data attribute
                        const monthMap = {
                            'January': '01', 'February': '02', 'March': '03', 'April': '04',
                            'May': '05', 'June': '06', 'July': '07', 'August': '08',
                            'September': '09', 'October': '10', 'November': '11', 'December': '12'
                        };
                        const monthNum = monthMap[report.month] || '01';
                        
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'dashboard-report-download';
                        downloadBtn.setAttribute('data-report-id', report.id);
                        downloadBtn.setAttribute('data-file-url', report.fileUrl || '');
                        downloadBtn.setAttribute('data-file-name', report.fileName || `Report_${report.month}_${report.year}.pdf`);
                        downloadBtn.setAttribute('data-file-base64', report.fileBase64 || '');
                        downloadBtn.setAttribute('data-storage-method', report.storageMethod || 'storage');
                        downloadBtn.setAttribute('data-month', `${report.year}-${monthNum}`);
                        downloadBtn.innerHTML = `
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        `;
                        
                        // Add click handler for admin report download
                        downloadBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            const fileUrl = this.getAttribute('data-file-url');
                            const fileName = this.getAttribute('data-file-name');
                            const fileBase64 = this.getAttribute('data-file-base64');
                            const storageMethod = this.getAttribute('data-storage-method');
                            downloadReportFromList(fileUrl, fileName, fileBase64, storageMethod);
                        });
                        
                        reportItem.appendChild(period);
                        reportItem.appendChild(metrics);
                        reportItem.appendChild(downloadBtn);
                        reportContainer.appendChild(reportItem);
                    });
                } catch (error) {
                    console.error('Error loading admin reports:', error);
                    reportContainer.innerHTML = '<div style="text-align: center; padding: 1rem; color: #dc2626;">Error loading reports</div>';
                }
            }
            
            // Update Portfolio Metrics based on transaction data
            function updatePortfolioMetrics() {
                if (!transactionData || transactionData.length === 0) {
                    // Set default values if no data
                    document.getElementById('capital-invested').textContent = 'â‚¬0';
                    document.getElementById('current-balance').textContent = 'â‚¬0';
                    document.getElementById('total-gain').textContent = '0.00%';
                    document.getElementById('portfolio-projection').textContent = 'â‚¬0';
                    return;
                }
                
                // Calculate total capital invested (sum of all deposits)
                let totalCapitalInvested = 0;
                let firstStartingBalance = transactionData[0].starting;
                
                // Sum all deposits
                transactionData.forEach(entry => {
                    totalCapitalInvested += (entry.deposits || 0);
                });
                
                // Initial capital is the first starting balance
                totalCapitalInvested += firstStartingBalance;
                
                // Get latest final balance (ending balance - withdrawals)
                const latestEntry = transactionData[transactionData.length - 1];
                const currentBalance = latestEntry.ending - (latestEntry.withdrawals || 0);
                
                // Calculate total fund gain percentage by summing all transaction growth percentages
                let totalGain = 0;
                transactionData.forEach(entry => {
                    if (entry.growth) {
                        totalGain += entry.growth;
                    }
                });
                
                // Calculate 12-month projection based on average monthly growth
                let projectionValue = currentBalance;
                if (transactionData.length > 1) {
                    // Calculate average monthly growth rate
                    let totalGrowth = 0;
                    let growthCount = 0;
                    transactionData.forEach(entry => {
                        if (entry.growth && entry.growth !== 0) {
                            totalGrowth += entry.growth;
                            growthCount++;
                        }
                    });
                    
                    const avgMonthlyGrowth = growthCount > 0 ? (totalGrowth / growthCount) / 100 : 0.02; // Default to 2% if no growth data
                    
                    // Project 12 months forward with compound growth
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * (1 + avgMonthlyGrowth);
                    }
                } else {
                    // If only one entry, use 2% monthly growth as default
                    const monthlyGrowthRate = 0.02;
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * (1 + monthlyGrowthRate);
                    }
                }
                
                // Update UI elements
                document.getElementById('capital-invested').textContent = 'â‚¬' + Math.round(totalCapitalInvested).toLocaleString('en-US');
                document.getElementById('current-balance').textContent = 'â‚¬' + Math.round(currentBalance).toLocaleString('en-US');
                document.getElementById('total-gain').textContent = (totalGain >= 0 ? '+' : '') + totalGain.toFixed(2) + '%';
                document.getElementById('portfolio-projection').textContent = 'â‚¬' + Math.round(projectionValue).toLocaleString('en-US');
            }
            
            // Update Dashboard Metrics based on transaction data
            // Transaction Edit Modal Functions
            function openTransactionEditModal(index) {
                const data = transactionData[index];
                const modal = document.getElementById('transaction-edit-modal');
                document.getElementById('edit-starting-balance').value = data.starting;
                document.getElementById('edit-ending-balance').value = data.ending;
                document.getElementById('edit-deposits').value = data.deposits || 0;
                document.getElementById('edit-withdrawals').value = data.withdrawals || 0;
                document.getElementById('edit-deposit-date').value = data.depositDate || '';
                document.getElementById('edit-withdrawal-date').value = data.withdrawalDate || '';
                // Auto-calculate growth percentage using the correct formula
                updateEditGrowthPercentage();
                modal.setAttribute('data-edit-index', index);
                modal.setAttribute('data-transaction-id', data.id || '');
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function closeTransactionEditModal() {
                const modal = document.getElementById('transaction-edit-modal');
                modal.style.display = 'none';
                modal.removeAttribute('data-edit-index');
                modal.removeAttribute('data-transaction-id');
                document.body.style.overflow = '';
            }
            
            // Delete transaction handler
            const deleteTransactionBtn = document.getElementById('delete-transaction-btn');
            if (deleteTransactionBtn) {
                deleteTransactionBtn.addEventListener('click', async function() {
                    const modal = document.getElementById('transaction-edit-modal');
                    const transactionId = modal.getAttribute('data-transaction-id');
                    const index = parseInt(modal.getAttribute('data-edit-index'));
                    
                    if (!transactionId) {
                        alert('Cannot delete: Transaction ID not found.');
                        return;
                    }
                    
                    if (!confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
                        return;
                    }
                    
                    try {
                        // Disable button during deletion
                        this.disabled = true;
                        this.textContent = 'Deleting...';
                        
                        // Delete from Firestore
                        await deleteAdminFundPerformance(transactionId);
                        
                        // Close modal
                        closeTransactionEditModal();
                        
                        // Reload transactions table
                        await populateTransactionsTable();
                        
                        // Update portfolio chart if Portfolio view is visible
                        const portfolioView = document.getElementById('portfolio-view');
                        if (portfolioView && portfolioView.style.display !== 'none') {
                            setTimeout(() => {
                                drawPortfolioChart();
                            }, 100);
                        }
                        
                        // Update dashboard if visible
                        const dashboardView = document.getElementById('dashboard-view');
                        if (dashboardView && dashboardView.style.display !== 'none') {
                            updateDashboardMetrics();
                        }
                        
                        alert('Transaction deleted successfully!');
                    } catch (error) {
                        console.error('Error deleting transaction:', error);
                        alert('Error deleting transaction. Please try again.');
                    } finally {
                        this.disabled = false;
                        this.textContent = 'Delete Transaction';
                    }
                });
            }
            
            // Transaction edit form handler
            const transactionEditForm = document.getElementById('transaction-edit-form');
            if (transactionEditForm) {
                transactionEditForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Disable submit button
                    const submitBtn = transactionEditForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Saving...';
                    
                    try {
                        const index = parseInt(document.getElementById('transaction-edit-modal').getAttribute('data-edit-index'));
                        const transaction = transactionData[index];
                        const starting = parseFloat(document.getElementById('edit-starting-balance').value);
                        const ending = parseFloat(document.getElementById('edit-ending-balance').value);
                        const deposits = parseFloat(document.getElementById('edit-deposits').value) || 0;
                        const withdrawals = parseFloat(document.getElementById('edit-withdrawals').value) || 0;
                        // Auto-calculate growth if not manually overridden
                        let growth = parseFloat(document.getElementById('edit-growth').value);
                        if (isNaN(growth) || growth === 0) {
                            growth = calculateGrowthPercentage(starting, ending, deposits, withdrawals);
                        }
                        
                        const updatedEntry = {
                            month: transaction.month,
                            year: transaction.year,
                            starting: starting,
                            ending: ending,
                            growth: growth,
                            deposits: deposits,
                            withdrawals: withdrawals,
                            depositDate: document.getElementById('edit-deposit-date').value || null,
                            withdrawalDate: document.getElementById('edit-withdrawal-date').value || null
                        };
                        
                        // Update in Firestore if document ID exists
                        if (transaction.id) {
                            await updateAdminFundPerformance(transaction.id, updatedEntry);
                        } else {
                            // If no ID, save as new entry
                            await saveAdminFundPerformance(updatedEntry);
                        }
                        
                        // Reload transactions table
                        await populateTransactionsTable();
                        
                        // Update portfolio chart if Portfolio view is visible
                        const portfolioView = document.getElementById('portfolio-view');
                        if (portfolioView && portfolioView.style.display !== 'none') {
                            setTimeout(() => {
                                drawPortfolioChart();
                            }, 100);
                        }
                        
                        // Update dashboard if visible
                        const dashboardView = document.getElementById('dashboard-view');
                        if (dashboardView && dashboardView.style.display !== 'none') {
                            updateDashboardMetrics();
                        }
                        
                        closeTransactionEditModal();
                    } catch (error) {
                        console.error('Error updating transaction:', error);
                        alert('Error updating transaction. Please try again.');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
            
            // Close transaction modal handlers
            const transactionModal = document.getElementById('transaction-edit-modal');
            if (transactionModal) {
                transactionModal.querySelector('.admin-modal-close')?.addEventListener('click', closeTransactionEditModal);
                transactionModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeTransactionEditModal);
                document.getElementById('cancel-transaction-edit')?.addEventListener('click', closeTransactionEditModal);
            }
            
            // Helper function to calculate growth percentage
            // Return (%) = ((Ending balance - Starting balance - Deposits) / (Starting balance + Deposits)) Ã— 100
            // Note: Withdrawals do NOT affect the percentage calculation - they only reduce the ending balance
            function calculateGrowthPercentage(startingBalance, endingBalance, deposits, withdrawals) {
                const denominator = startingBalance + deposits;
                if (denominator > 0) {
                    // Growth is based on performance, not affected by withdrawals
                    // Withdrawals just reduce ending balance but don't change the growth percentage
                    return ((endingBalance - startingBalance - deposits) / denominator * 100);
                }
                return 0;
            }
            
            // Auto-calculate growth percentage for fund performance form
            function updateFundGrowthPercentage() {
                const starting = parseFloat(document.getElementById('fund-starting-balance').value) || 0;
                const ending = parseFloat(document.getElementById('fund-ending-balance').value) || 0;
                const deposits = parseFloat(document.getElementById('fund-deposits').value) || 0;
                const withdrawals = parseFloat(document.getElementById('fund-withdrawals').value) || 0;
                const growthInput = document.getElementById('fund-growth');
                
                if (starting > 0 || deposits > 0) {
                    const calculatedGrowth = calculateGrowthPercentage(starting, ending, deposits, withdrawals);
                    growthInput.value = calculatedGrowth.toFixed(2);
                }
            }
            
            // Auto-calculate growth percentage for edit transaction form
            function updateEditGrowthPercentage() {
                const starting = parseFloat(document.getElementById('edit-starting-balance').value) || 0;
                const ending = parseFloat(document.getElementById('edit-ending-balance').value) || 0;
                const deposits = parseFloat(document.getElementById('edit-deposits').value) || 0;
                const withdrawals = parseFloat(document.getElementById('edit-withdrawals').value) || 0;
                const growthInput = document.getElementById('edit-growth');
                
                if (starting > 0 || deposits > 0) {
                    const calculatedGrowth = calculateGrowthPercentage(starting, ending, deposits, withdrawals);
                    growthInput.value = calculatedGrowth.toFixed(2);
                }
            }
            
            // Add event listeners for auto-calculation
            const fundStartingBalance = document.getElementById('fund-starting-balance');
            const fundEndingBalance = document.getElementById('fund-ending-balance');
            const fundDeposits = document.getElementById('fund-deposits');
            const fundWithdrawals = document.getElementById('fund-withdrawals');
            
            if (fundStartingBalance) fundStartingBalance.addEventListener('input', updateFundGrowthPercentage);
            if (fundEndingBalance) fundEndingBalance.addEventListener('input', updateFundGrowthPercentage);
            if (fundDeposits) fundDeposits.addEventListener('input', updateFundGrowthPercentage);
            if (fundWithdrawals) fundWithdrawals.addEventListener('input', updateFundGrowthPercentage);
            
            const editStartingBalance = document.getElementById('edit-starting-balance');
            const editEndingBalance = document.getElementById('edit-ending-balance');
            const editDeposits = document.getElementById('edit-deposits');
            const editWithdrawals = document.getElementById('edit-withdrawals');
            
            if (editStartingBalance) editStartingBalance.addEventListener('input', updateEditGrowthPercentage);
            if (editEndingBalance) editEndingBalance.addEventListener('input', updateEditGrowthPercentage);
            if (editDeposits) editDeposits.addEventListener('input', updateEditGrowthPercentage);
            if (editWithdrawals) editWithdrawals.addEventListener('input', updateEditGrowthPercentage);
            
            // Fund Performance Form Handler
            const fundPerformanceForm = document.getElementById('fund-performance-form');
            if (fundPerformanceForm) {
                fundPerformanceForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Disable submit button to prevent double submission
                    const submitBtn = fundPerformanceForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Saving...';
                    
                    try {
                        const month = document.getElementById('fund-month').value;
                        const year = parseInt(document.getElementById('fund-year').value);
                        const starting = parseFloat(document.getElementById('fund-starting-balance').value);
                        const ending = parseFloat(document.getElementById('fund-ending-balance').value);
                        const deposits = parseFloat(document.getElementById('fund-deposits').value) || 0;
                        const withdrawals = parseFloat(document.getElementById('fund-withdrawals').value) || 0;
                        // Auto-calculate growth if not manually overridden
                        let growth = parseFloat(document.getElementById('fund-growth').value);
                        if (isNaN(growth) || growth === 0) {
                            growth = calculateGrowthPercentage(starting, ending, deposits, withdrawals);
                        }
                        
                        const depositDate = document.getElementById('fund-deposit-date').value || (deposits > 0 ? new Date().toISOString().split('T')[0] : null);
                        const withdrawalDate = document.getElementById('fund-withdrawal-date').value || (withdrawals > 0 ? new Date().toISOString().split('T')[0] : null);
                        
                        const newEntry = {
                            month: month,
                            year: year,
                            starting: starting,
                            ending: ending,
                            growth: growth,
                            deposits: deposits,
                            withdrawals: withdrawals,
                            depositDate: depositDate,
                            withdrawalDate: withdrawalDate
                        };
                        
                        // Save to Firestore
                        await saveAdminFundPerformance(newEntry);
                        
                        // Reload transactions table
                        await populateTransactionsTable();
                        
                        // Update portfolio chart if Portfolio view is visible
                        const portfolioView = document.getElementById('portfolio-view');
                        if (portfolioView && portfolioView.style.display !== 'none') {
                            setTimeout(() => {
                                drawPortfolioChart();
                            }, 100);
                        }
                        
                        // Update dashboard if visible
                        const dashboardView = document.getElementById('dashboard-view');
                        if (dashboardView && dashboardView.style.display !== 'none') {
                            updateDashboardMetrics();
                        }
                        
                        // Reset form
                        fundPerformanceForm.reset();
                        document.getElementById('fund-year').value = new Date().getFullYear();
                        
                        alert('Fund performance saved successfully!');
                    } catch (error) {
                        console.error('Error saving fund performance:', error);
                        alert('Error saving fund performance. Please try again.');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }

            function formatDate(dateString) {
                const date = new Date(dateString);
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            }

            // Performance Chart Function
            let performanceDataPoints = [];
            
            function drawPerformanceChart() {
                const canvas = document.getElementById('performance-chart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const container = canvas.parentElement;
                const width = container ? container.clientWidth - 64 : 800;
                const height = 700;
                
                // Set canvas size
                canvas.width = width;
                canvas.height = height;
                
                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                
                // Chart configuration
                const padding = { top: 80, right: 40, bottom: 60, left: 80 };
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;
                
                const months = ['Start', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec',
                              'Jan', 'Feb', 'Mar', 'Apr'];
                
                // Use actual account balance values (not normalized)
                const initialInvestment = 230000;
                
                // Historical data (12 months) - actual account balances - with Month 0
                // All lines start from the exact same initial investment
                const opessociusHistorical = [
                    initialInvestment,  // Month 0 - exact same starting balance as S&P 500 and Banks
                    235000, 238000, 242000, 245000, 248000, 252000, 255000, 260000, 265000, 270000, 275000, 280000
                ];
                
                // Projection data (4 months) - fixed values (2% compound growth per month for Opessocius)
                const lastHistoricalValue = opessociusHistorical[12];
                const projectionData = [
                    lastHistoricalValue * 1.02,
                    lastHistoricalValue * 1.02 * 1.02,
                    lastHistoricalValue * 1.02 * 1.02 * 1.02,
                    lastHistoricalValue * 1.02 * 1.02 * 1.02 * 1.02
                ];
                
                // S&P 500 monthly returns (%): +2.3%, âˆ’1.4%, +3.1%, +0.6%, âˆ’2.8%, +4.5%, +1.2%, âˆ’3.6%, +2.9%, +0.4%, +5.1%, âˆ’1.9%, +1.7%, +3.8%, âˆ’0.7%, +2.5%
                const sp500MonthlyReturns = [
                    2.3, -1.4, 3.1, 0.6, -2.8, 4.5, 1.2, -3.6, 2.9, 0.4, 5.1, -1.9,  // 12 historical
                    1.7, 3.8, -0.7, 2.5  // 4 projection
                ];
                
                // Calculate S&P 500 values - SIMPLE INTEREST (no compound, each return based on initial investment)
                const sp500DataRaw = [initialInvestment]; // Month 0
                let cumulativeReturn = 0;
                sp500MonthlyReturns.forEach((returnPercent) => {
                    cumulativeReturn += returnPercent;
                    const monthValue = initialInvestment * (1 + cumulativeReturn / 100);
                    sp500DataRaw.push(monthValue);
                });
                
                // Light smoothing for S&P 500 (2-point average) to reduce sharp peaks but keep volatility visible
                function lightSmooth(data) {
                    const smoothed = [data[0]]; // Keep month 0 unchanged
                    for (let i = 1; i < data.length; i++) {
                        if (i === data.length - 1) {
                            smoothed.push(data[i]);
                        } else {
                            // Average with adjacent points (60% current, 20% each adjacent)
                            smoothed.push(data[i] * 0.6 + data[i - 1] * 0.2 + data[i + 1] * 0.2);
                        }
                    }
                    return smoothed;
                }
                
                const sp500Data = lightSmooth(sp500DataRaw);
                
                // Split S&P 500 data into historical and projection (Month 0 + 12 historical, 4 projection)
                const sp500Historical = sp500Data.slice(0, 13); // Month 0 + 12 months
                const sp500Projection = sp500Data.slice(13, 17); // 4 months
                
                // Banks: constant 0.20% monthly growth - SIMPLE INTEREST (no compound)
                // Ensure it starts from exact same initial investment
                const banksMonthlyGrowth = 0.20; // 0.20% per month
                const banksData = [initialInvestment]; // Month 0 - exact same starting balance
                for (let i = 1; i <= 16; i++) {
                    // Simple interest: add 0.20% of initial investment each month
                    const monthValue = initialInvestment * (1 + (banksMonthlyGrowth * i) / 100);
                    banksData.push(monthValue);
                }
                
                // Split Banks data into historical and projection
                const banksHistorical = banksData.slice(0, 13); // Month 0 + 12 months
                const banksProjection = banksData.slice(13, 17); // 4 months
                
                
                // Combine all data for max/min calculation
                const allData = [...opessociusHistorical, ...projectionData, ...sp500Data, ...banksData];
                const maxValue = Math.max(...allData) * 1.1;
                const minValue = Math.min(...allData) * 0.9;
                const valueRange = maxValue - minValue;
                
                // Store data points for hover
                performanceDataPoints = [];
                
                // Draw grid lines
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 5; i++) {
                    const y = padding.top + (chartHeight / 5) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding.left, y);
                    ctx.lineTo(width - padding.right, y);
                    ctx.stroke();
                }
                
                // Total months: 17 (Month 0 + 12 historical + 4 projection)
                const totalMonths = 17;
                
                // Draw area fill for user investment historical section only (Month 0 + 12 months)
                const gradient = ctx.createLinearGradient(
                    padding.left, 
                    padding.top, 
                    padding.left + (chartWidth / totalMonths) * 13, 
                    padding.top + chartHeight
                );
                gradient.addColorStop(0, 'rgba(37, 99, 235, 0.25)');
                gradient.addColorStop(1, 'rgba(37, 99, 235, 0.05)');
                
                ctx.beginPath();
                const firstX = padding.left + (chartWidth / totalMonths) / 2;
                const firstY = padding.top + chartHeight - ((opessociusHistorical[0] - minValue) / valueRange) * chartHeight;
                ctx.moveTo(firstX, height - padding.bottom);
                ctx.lineTo(firstX, firstY);
                
                opessociusHistorical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    ctx.lineTo(x, y);
                });
                
                const lastHistoricalX = padding.left + (chartWidth / totalMonths) * 12 + (chartWidth / totalMonths) / 2;
                ctx.lineTo(lastHistoricalX, height - padding.bottom);
                ctx.closePath();
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // Draw area fill for S&P 500 historical section only - orange shade (Month 0 + 12 months)
                const sp500Gradient = ctx.createLinearGradient(
                    padding.left, 
                    padding.top, 
                    padding.left + (chartWidth / totalMonths) * 13, 
                    padding.top + chartHeight
                );
                sp500Gradient.addColorStop(0, 'rgba(249, 115, 22, 0.25)');
                sp500Gradient.addColorStop(1, 'rgba(249, 115, 22, 0.05)');
                
                ctx.beginPath();
                const sp500FirstX = padding.left + (chartWidth / totalMonths) / 2;
                const sp500FirstY = padding.top + chartHeight - ((sp500Historical[0] - minValue) / valueRange) * chartHeight;
                ctx.moveTo(sp500FirstX, height - padding.bottom);
                ctx.lineTo(sp500FirstX, sp500FirstY);
                
                sp500Historical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    ctx.lineTo(x, y);
                });
                
                const sp500LastHistoricalX = padding.left + (chartWidth / totalMonths) * 12 + (chartWidth / totalMonths) / 2;
                ctx.lineTo(sp500LastHistoricalX, height - padding.bottom);
                ctx.closePath();
                ctx.fillStyle = sp500Gradient;
                ctx.fill();
                
                // Draw area fill for Banks historical section only - grey shade (Month 0 + 12 months)
                const banksGradient = ctx.createLinearGradient(
                    padding.left, 
                    padding.top, 
                    padding.left + (chartWidth / totalMonths) * 13, 
                    padding.top + chartHeight
                );
                banksGradient.addColorStop(0, 'rgba(107, 114, 128, 0.25)');
                banksGradient.addColorStop(1, 'rgba(107, 114, 128, 0.05)');
                
                ctx.beginPath();
                const banksFirstX = padding.left + (chartWidth / totalMonths) / 2;
                const banksFirstY = padding.top + chartHeight - ((banksHistorical[0] - minValue) / valueRange) * chartHeight;
                ctx.moveTo(banksFirstX, height - padding.bottom);
                ctx.lineTo(banksFirstX, banksFirstY);
                
                banksHistorical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    ctx.lineTo(x, y);
                });
                
                const banksLastHistoricalX = padding.left + (chartWidth / totalMonths) * 12 + (chartWidth / totalMonths) / 2;
                ctx.lineTo(banksLastHistoricalX, height - padding.bottom);
                ctx.closePath();
                ctx.fillStyle = banksGradient;
                ctx.fill();
                
                // Draw Opessocius historical line
                ctx.beginPath();
                ctx.strokeStyle = '#2563eb';
                ctx.lineWidth = 2.5;
                opessociusHistorical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Draw Opessocius projection line (dashed, green)
                ctx.beginPath();
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 2.5;
                ctx.setLineDash([6, 4]);
                projectionData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (13 + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        // Connect to last historical point
                        const lastHistX = padding.left + (chartWidth / totalMonths) * 12 + (chartWidth / totalMonths) / 2;
                        const lastHistY = padding.top + chartHeight - ((opessociusHistorical[12] - minValue) / valueRange) * chartHeight;
                        ctx.moveTo(lastHistX, lastHistY);
                    }
                    ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw S&P 500 historical line (orange) - straight lines to show ups and downs
                ctx.beginPath();
                ctx.strokeStyle = '#f97316';
                ctx.lineWidth = 2.5;
                sp500Historical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Draw S&P 500 projection line (dashed, orange)
                ctx.beginPath();
                ctx.strokeStyle = '#f97316';
                ctx.lineWidth = 2.5;
                ctx.setLineDash([6, 4]);
                sp500Projection.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (13 + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        // Connect to last historical point
                        const lastHistX = padding.left + (chartWidth / totalMonths) * 12 + (chartWidth / totalMonths) / 2;
                        const lastHistY = padding.top + chartHeight - ((sp500Historical[12] - minValue) / valueRange) * chartHeight;
                        ctx.moveTo(lastHistX, lastHistY);
                    }
                    ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw Banks historical line (grey) - constant growth
                ctx.beginPath();
                ctx.strokeStyle = '#6b7280';
                ctx.lineWidth = 2.5;
                banksHistorical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Draw Banks projection line (dashed, grey)
                ctx.beginPath();
                ctx.strokeStyle = '#6b7280';
                ctx.lineWidth = 2.5;
                ctx.setLineDash([6, 4]);
                banksProjection.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (13 + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        // Connect to last historical point
                        const lastHistX = padding.left + (chartWidth / totalMonths) * 12 + (chartWidth / totalMonths) / 2;
                        const lastHistY = padding.top + chartHeight - ((banksHistorical[12] - minValue) / valueRange) * chartHeight;
                        ctx.moveTo(lastHistX, lastHistY);
                    }
                    ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw data points for Opessocius investment
                [...opessociusHistorical, ...projectionData].forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    const isHistorical = index < 13; // Month 0 + 12 months
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = isHistorical ? '#2563eb' : '#10b981';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Store for hover
                    const growthPercent = ((value - initialInvestment) / initialInvestment * 100).toFixed(2);
                    performanceDataPoints.push({
                        x: x,
                        y: y,
                        value: value,
                        month: months[index],
                        name: 'Investment',
                        color: isHistorical ? '#2563eb' : '#10b981',
                        growthPercent: growthPercent,
                        isHistorical: isHistorical
                    });
                });
                
                // Draw data points for S&P 500
                sp500Data.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    const isHistorical = index < 13; // Month 0 + 12 months
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = '#f97316';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Store for hover
                    const growthPercent = ((value - initialInvestment) / initialInvestment * 100).toFixed(2);
                    performanceDataPoints.push({
                        x: x,
                        y: y,
                        value: value,
                        month: months[index],
                        name: 'S&P 500',
                        color: '#f97316',
                        growthPercent: growthPercent,
                        isHistorical: isHistorical
                    });
                });
                
                // Draw data points for Banks
                banksData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    const isHistorical = index < 13; // Month 0 + 12 months
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = '#6b7280';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Store for hover
                    const growthPercent = ((value - initialInvestment) / initialInvestment * 100).toFixed(2);
                    performanceDataPoints.push({
                        x: x,
                        y: y,
                        value: value,
                        month: months[index],
                        name: 'Banks',
                        color: '#6b7280',
                        growthPercent: growthPercent,
                        isHistorical: isHistorical
                    });
                });
                
                // Draw Y-axis labels (in euros)
                ctx.fillStyle = '#6b7280';
                ctx.font = '12px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                for (let i = 0; i <= 5; i++) {
                    const value = minValue + (valueRange / 5) * (5 - i);
                    const y = padding.top + (chartHeight / 5) * i;
                    const formattedValue = 'â‚¬' + (value / 1000).toFixed(0) + 'k';
                    ctx.fillText(formattedValue, padding.left - 10, y);
                }
                
                // Draw X-axis labels (17 months total: Month 0 + 12 historical + 4 projection)
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                for (let i = 0; i < totalMonths; i += 2) {
                    const x = padding.left + (chartWidth / totalMonths) * i + (chartWidth / totalMonths) / 2;
                    ctx.fillText(months[i], x, height - padding.bottom + 10);
                }
                
                // Draw legend at the top
                const legendY = padding.top - 50;
                const legendX = padding.left;
                const legendItems = [
                    { name: 'Opessocius', color: '#2563eb', risk: '0%' },
                    { name: 'Savings Account', color: '#6b7280', risk: '0%' },
                    { name: 'S&P 500', color: '#f97316', risk: '100%' }
                ];
                
                let currentX = legendX;
                const legendSpacing = 180;
                
                legendItems.forEach((item) => {
                    // Draw colored line
                    ctx.strokeStyle = item.color;
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(currentX, legendY);
                    ctx.lineTo(currentX + 30, legendY);
                    ctx.stroke();
                    
                    // Draw name
                    ctx.fillStyle = '#1f2937';
                    ctx.font = 'bold 13px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                    ctx.textAlign = 'left';
                    ctx.fillText(item.name, currentX + 35, legendY + 5);
                    
                    // Draw risk percentage below
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '11px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                    ctx.fillText(`Risk: ${item.risk}`, currentX + 35, legendY + 20);
                    
                    // Move to next position
                    currentX += legendSpacing;
                });
            }
            
            // Setup performance chart hover
            function setupPerformanceChartHover() {
                const canvas = document.getElementById('performance-chart');
                const tooltip = document.getElementById('performance-tooltip');
                if (!canvas || !tooltip) return;
                
                canvas.addEventListener('mousemove', function(e) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Find nearest data point
                    let nearestPoint = null;
                    let minDistance = Infinity;
                    
                    performanceDataPoints.forEach(point => {
                        const distance = Math.sqrt(Math.pow(x - point.x, 2) + Math.pow(y - point.y, 2));
                        if (distance < 30 && distance < minDistance) {
                            minDistance = distance;
                            nearestPoint = point;
                        }
                    });
                    
                    if (nearestPoint) {
                        const formattedValue = 'â‚¬' + nearestPoint.value.toLocaleString('en-US');
                        const growthSign = parseFloat(nearestPoint.growthPercent) >= 0 ? '+' : '';
                        tooltip.innerHTML = `
                            <div class="tooltip-name" style="color: ${nearestPoint.color}; font-weight: 600;">${nearestPoint.name}</div>
                            <div class="tooltip-balance">${formattedValue}</div>
                            <div class="tooltip-growth">${growthSign}${nearestPoint.growthPercent}%</div>
                        `;
                        tooltip.style.display = 'block';
                        tooltip.style.left = (nearestPoint.x + 10) + 'px';
                        tooltip.style.top = (nearestPoint.y - 40) + 'px';
                    } else {
                        tooltip.style.display = 'none';
                    }
                });
                
                canvas.addEventListener('mouseleave', function() {
                    if (tooltip) tooltip.style.display = 'none';
                });
            }
            
            // Setup performance hover after chart is drawn
            setTimeout(setupPerformanceChartHover, 150);

            // Reports Section - Store reports data
            let reportsData = {}; // Structure: { userId: { '2024-01': { file: File, month: 'January', year: 2024 }, ... } }
            
            // Predetermined Admin Account ID
            const ADMIN_ACCOUNT_ID = 'admin';
            
            async function loadReportsUsersList() {
                const container = document.getElementById('reports-users-grid');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">Loading users...</div>';
                
                try {
                    // First, add the predetermined admin account card
                    container.innerHTML = '';
                    
                    // Get admin reports count
                    let adminReportCount = 0;
                    try {
                        const adminReportsSnapshot = await db.collection('users').doc(ADMIN_ACCOUNT_ID)
                            .collection('reports')
                            .get();
                        adminReportCount = adminReportsSnapshot.size;
                    } catch (error) {
                        console.log('Admin reports collection may not exist yet:', error);
                    }
                    
                    // Create admin account card
                    const adminCard = document.createElement('div');
                    adminCard.className = 'investor-card';
                    adminCard.innerHTML = `
                        <div class="investor-card-header">
                            <h3>Admin</h3>
                            <span class="investor-status investor-status-active">Admin</span>
                        </div>
                        <div class="investor-card-body">
                            <p><strong>Email:</strong> admin@opessocius.com</p>
                            <p><strong>Reports Uploaded:</strong> ${adminReportCount}</p>
                        </div>
                        <div class="investor-card-actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="admin-btn-save" onclick="openReportUploadModal('${ADMIN_ACCOUNT_ID}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Upload Report</button>
                            ${adminReportCount > 0 ? `<button class="admin-btn-view" onclick="viewUserReports('${ADMIN_ACCOUNT_ID}')">View Reports</button>` : ''}
                        </div>
                    `;
                    container.appendChild(adminCard);
                    
                    // Load users from Firestore
                    const usersSnapshot = await db.collection('users')
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    if (usersSnapshot.empty) {
                        return;
                    }
                    
                    // Process each user
                    for (const userDoc of usersSnapshot.docs) {
                        const userData = userDoc.data();
                        const userId = userDoc.id;
                        const isAdmin = userData.type === 'admin';
                        const isInvestor = userData.type === 'investor' || !userData.type;
                        
                        // Get transaction count for investors
                        let transactionCount = 0;
                        if (isInvestor) {
                            const transactionsSnapshot = await db.collection('users').doc(userId)
                                .collection('transactions')
                                .get();
                            transactionCount = transactionsSnapshot.size;
                        }
                        
                        // Get reports from Firestore
                        const reportsSnapshot = await db.collection('users').doc(userId)
                            .collection('reports')
                            .get();
                        
                        const reportCount = reportsSnapshot.size;
                        
                        const card = document.createElement('div');
                        card.className = 'investor-card';
                        
                        const userName = userData.fullName || userData.username || 'Unknown';
                        const userEmail = userData.email || 'N/A';
                        const userStatus = userData.accountStatus || 'Active';
                        const currentBalance = userData.currentBalance || userData.initialInvestment || 0;
                        const initialInvestment = userData.initialInvestment || 0;
                        const totalReturn = userData.totalReturn || 0;
                        
                        card.innerHTML = `
                            <div class="investor-card-header">
                                <h3>${userName}</h3>
                                <span class="investor-status investor-status-${userStatus.toLowerCase()}">${isAdmin ? 'Admin' : userStatus}</span>
                            </div>
                            <div class="investor-card-body">
                                <p><strong>Email:</strong> ${userEmail}</p>
                                ${isInvestor ? `
                                    <p><strong>Initial Investment:</strong> â‚¬${initialInvestment.toLocaleString('en-US')}</p>
                                    <p><strong>Current Balance:</strong> â‚¬${currentBalance.toLocaleString('en-US')}</p>
                                    <p><strong>Total Return:</strong> <span class="${totalReturn >= 0 ? 'return-positive' : 'return-negative'}">${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%</span></p>
                                    <p><strong>Performance Entries:</strong> ${transactionCount}</p>
                                ` : ''}
                                <p><strong>Reports Uploaded:</strong> ${reportCount}</p>
                            </div>
                            <div class="investor-card-actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="admin-btn-save" onclick="openReportUploadModal('${userId}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Upload Report</button>
                                ${isAdmin ? `<button class="admin-btn-view" onclick="viewAdminReportsWidget()">View Admin Reports</button>` : ''}
                                ${reportCount > 0 ? `<button class="admin-btn-view" onclick="viewUserReports('${userId}')">View Reports</button>` : ''}
                            </div>
                        `;
                        container.appendChild(card);
                    }
                } catch (error) {
                    console.error('Error loading reports users list:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #dc2626;">Error loading users: ' + error.message + '</div>';
                }
            }
            
            async function openReportUploadModal(userId) {
                try {
                    let userName = 'Unknown';
                    
                    // Handle admin account
                    if (userId === ADMIN_ACCOUNT_ID) {
                        userName = 'Admin';
                    } else {
                        // Get user data from Firestore
                        const userDoc = await db.collection('users').doc(userId).get();
                        if (!userDoc.exists) {
                            alert('User not found');
                            return;
                        }
                        const userData = userDoc.data();
                        userName = userData.fullName || userData.username || 'Unknown';
                    }
                    
                    const modal = document.getElementById('report-upload-modal');
                    document.getElementById('report-upload-modal-title').textContent = `Upload Report - ${userName}`;
                    document.getElementById('report-upload-form').reset();
                    modal.setAttribute('data-user-id', userId);
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                } catch (error) {
                    console.error('Error opening report upload modal:', error);
                    alert('Error loading user data: ' + error.message);
                }
            }
            
            function closeReportUploadModal() {
                document.getElementById('report-upload-modal').style.display = 'none';
                document.body.style.overflow = '';
            }
            
            async function viewUserReports(userId) {
                try {
                    let userName = 'Unknown';
                    
                    // Handle admin account
                    if (userId === ADMIN_ACCOUNT_ID) {
                        userName = 'Admin';
                    } else {
                        const userDoc = await db.collection('users').doc(userId).get();
                        if (!userDoc.exists) {
                            alert('User not found');
                            return;
                        }
                        const userData = userDoc.data();
                        userName = userData.fullName || userData.username || 'Unknown';
                    }
                    
                    // Load reports from Firestore (without orderBy to avoid index requirement)
                    const reportsSnapshot = await db.collection('users').doc(userId)
                        .collection('reports')
                        .get();
                    
                    if (reportsSnapshot.empty) {
                        alert('No reports available for this user.');
                        return;
                    }
                    
                    const reportsList = [];
                    reportsSnapshot.forEach((doc) => {
                        const reportData = doc.data();
                        // Handle base64 stored files
                        let fileUrl = reportData.fileUrl;
                        let fileBase64 = null;
                        if (reportData.storageMethod === 'base64' && reportData.fileBase64) {
                            fileBase64 = reportData.fileBase64;
                            fileUrl = 'data:application/pdf;base64,' + reportData.fileBase64;
                        }
                        reportsList.push({
                            id: doc.id,
                            month: reportData.month,
                            year: reportData.year,
                            fileName: reportData.fileName,
                            fileUrl: fileUrl,
                            fileBase64: fileBase64,
                            uploadDate: reportData.uploadDate,
                            storageMethod: reportData.storageMethod || 'storage'
                        });
                    });
                    
                    // Sort by year (desc) and month (desc) to show newest first
                    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                    reportsList.sort((a, b) => {
                        const yearDiff = b.year - a.year;
                        if (yearDiff !== 0) return yearDiff;
                        return months.indexOf(b.month) - months.indexOf(a.month);
                    });
                    
                    // Show reports list modal
                    const modal = document.getElementById('reports-list-modal');
                    const title = document.getElementById('reports-list-title');
                    const container = document.getElementById('reports-list-container');
                    
                    title.textContent = `Reports - ${userName}`;
                    
                    // Store reports data in a Map for easy access (especially for base64)
                    window.reportsDataMap = window.reportsDataMap || new Map();
                    reportsList.forEach((report, index) => {
                        const reportKey = `${userId}_${report.id}`;
                        window.reportsDataMap.set(reportKey, report);
                    });
                    
                    // Store userId for delete operations
                    container.setAttribute('data-user-id', userId);
                    
                    // Build reports list HTML
                    let reportsHtml = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
                    reportsList.forEach((report, index) => {
                        const uploadDate = report.uploadDate ? (report.uploadDate.toDate ? report.uploadDate.toDate().toLocaleDateString() : new Date(report.uploadDate).toLocaleDateString()) : 'N/A';
                        const reportKey = `${userId}_${report.id}`;
                        reportsHtml += `
                            <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #1f2937;">${report.month} ${report.year}</div>
                                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">${report.fileName}</div>
                                    <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">Uploaded: ${uploadDate}</div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="admin-btn-view report-view-btn" data-report-key="${reportKey}" data-title="${report.month} ${report.year}" style="padding: 0.5rem 1rem; font-size: 0.875rem;">View</button>
                                    <button class="admin-btn-save report-download-btn" data-report-key="${reportKey}" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Download</button>
                                    <button class="admin-btn-cancel report-delete-btn" data-report-id="${report.id}" data-report-key="${reportKey}" data-month="${report.month}" data-year="${report.year}" style="padding: 0.5rem 1rem; font-size: 0.875rem; background: #dc2626; color: white;">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                    reportsHtml += '</div>';
                    
                    container.innerHTML = reportsHtml;
                    
                    // Add event listeners to buttons
                    container.querySelectorAll('.report-view-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const reportKey = this.getAttribute('data-report-key');
                            const title = this.getAttribute('data-title');
                            const report = window.reportsDataMap.get(reportKey);
                            if (report) {
                                viewReportFromList(report.fileUrl, title, report.fileName, report.fileBase64, report.storageMethod);
                            }
                        });
                    });
                    
                    container.querySelectorAll('.report-download-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const reportKey = this.getAttribute('data-report-key');
                            const report = window.reportsDataMap.get(reportKey);
                            if (report) {
                                downloadReportFromList(report.fileUrl, report.fileName, report.fileBase64, report.storageMethod);
                            }
                        });
                    });
                    
                    // Add delete button event listeners
                    container.querySelectorAll('.report-delete-btn').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const reportId = this.getAttribute('data-report-id');
                            const reportKey = this.getAttribute('data-report-key');
                            const month = this.getAttribute('data-month');
                            const year = this.getAttribute('data-year');
                            const userId = container.getAttribute('data-user-id');
                            
                            if (!confirm(`Are you sure you want to delete the report for ${month} ${year}? This action cannot be undone.`)) {
                                return;
                            }
                            
                            try {
                                // Disable button during deletion
                                this.disabled = true;
                                this.textContent = 'Deleting...';
                                
                                // Delete report from Firestore
                                await db.collection('users').doc(userId)
                                    .collection('reports')
                                    .doc(reportId)
                                    .delete();
                                
                                // Remove from reportsDataMap
                                if (window.reportsDataMap) {
                                    window.reportsDataMap.delete(reportKey);
                                }
                                
                                // Reload the reports list
                                await viewUserReports(userId);
                                
                                // Reload reports users list to update counts
                                loadReportsUsersList();
                                
                                // Update dashboard widget if this is an admin report
                                if (userId === ADMIN_ACCOUNT_ID) {
                                    updateLatestReports();
                                }
                                
                                alert(`Report for ${month} ${year} deleted successfully!`);
                            } catch (error) {
                                console.error('Error deleting report:', error);
                                alert('Error deleting report: ' + error.message);
                                this.disabled = false;
                                this.textContent = 'Delete';
                            }
                        });
                    });
                    
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                } catch (error) {
                    console.error('Error loading user reports:', error);
                    alert('Error loading reports: ' + error.message);
                }
            }
            
            function viewReportFromList(fileUrl, title, fileName, fileBase64 = null, storageMethod = 'storage') {
                const modal = document.getElementById('report-viewer-modal');
                const iframe = document.getElementById('report-viewer-iframe');
                const titleEl = document.getElementById('report-viewer-title');
                const downloadBtn = document.getElementById('download-report-btn');
                
                titleEl.textContent = `Monthly Report - ${title}`;
                
                // Handle base64 files
                if (storageMethod === 'base64' && fileBase64) {
                    iframe.src = 'data:application/pdf;base64,' + fileBase64;
                    downloadBtn.setAttribute('data-url', '');
                    downloadBtn.setAttribute('data-filename', fileName || title.replace(' ', '_') + '.pdf');
                    downloadBtn.setAttribute('data-base64', fileBase64);
                    downloadBtn.setAttribute('data-storage-method', 'base64');
                } else if (fileUrl.startsWith('data:')) {
                    iframe.src = fileUrl;
                    downloadBtn.setAttribute('data-url', fileUrl);
                    downloadBtn.setAttribute('data-filename', fileName || title.replace(' ', '_') + '.pdf');
                    downloadBtn.setAttribute('data-base64', '');
                    downloadBtn.setAttribute('data-storage-method', 'storage');
                } else {
                    iframe.src = fileUrl;
                    downloadBtn.setAttribute('data-url', fileUrl);
                    downloadBtn.setAttribute('data-filename', fileName || title.replace(' ', '_') + '.pdf');
                    downloadBtn.setAttribute('data-base64', '');
                    downloadBtn.setAttribute('data-storage-method', 'storage');
                }
                
                // Close reports list modal
                document.getElementById('reports-list-modal').style.display = 'none';
                
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function downloadReportFromList(fileUrl, fileName, fileBase64 = null, storageMethod = 'storage') {
                // Handle base64 files
                if (storageMethod === 'base64' && fileBase64) {
                    // Convert base64 to blob and download
                    const byteCharacters = atob(fileBase64);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName || 'report.pdf';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } else if (fileUrl.startsWith('data:')) {
                    // Convert data URL to blob and download
                    const base64Data = fileUrl.split(',')[1];
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName || 'report.pdf';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } else {
                    // Regular download for Storage URLs
                    const link = document.createElement('a');
                    link.href = fileUrl;
                    link.download = fileName || 'report.pdf';
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            
            // Keep old function names for backward compatibility
            function viewReport(fileUrl, title) {
                viewReportFromList(fileUrl, title, null);
            }
            
            function downloadReport(fileUrl, fileName) {
                downloadReportFromList(fileUrl, fileName);
            }
            
            function closeReportViewerModal() {
                const modal = document.getElementById('report-viewer-modal');
                const iframe = document.getElementById('report-viewer-iframe');
                iframe.src = '';
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
            
            function closeReportsListModal() {
                const modal = document.getElementById('reports-list-modal');
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
            
            window.openReportUploadModal = openReportUploadModal;
            window.viewUserReports = viewUserReports;
            window.viewReport = viewReport;
            window.viewReportFromList = viewReportFromList;
            window.downloadReport = downloadReport;
            window.downloadReportFromList = downloadReportFromList;
            
            // Report upload form handler
            const reportUploadForm = document.getElementById('report-upload-form');
            if (reportUploadForm) {
                reportUploadForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const userId = document.getElementById('report-upload-modal').getAttribute('data-user-id');
                    const month = document.getElementById('report-month').value;
                    const year = parseInt(document.getElementById('report-year').value);
                    const fileInput = document.getElementById('report-file');
                    const file = fileInput.files[0];
                    
                    if (!file) {
                        alert('Please select a PDF file to upload.');
                        return;
                    }
                    
                    if (file.size > 10 * 1024 * 1024) {
                        alert('File size exceeds 10MB limit.');
                        return;
                    }
                    
                    if (!file.type.includes('pdf')) {
                        alert('Please upload a PDF file.');
                        return;
                    }
                    
                    if (!userId) {
                        alert('Error: User ID not found');
                        return;
                    }
                    
                    try {
                        // Show loading state
                        const submitBtn = document.getElementById('upload-report-btn');
                        const originalText = submitBtn.textContent;
                        const progressDiv = document.getElementById('upload-progress');
                        const progressBar = document.getElementById('upload-progress-bar');
                        const progressPercent = document.getElementById('upload-progress-percent');
                        
                        submitBtn.textContent = 'Uploading...';
                        submitBtn.disabled = true;
                        progressDiv.style.display = 'block';
                        
                        // Sanitize file name to avoid encoding issues
                        function sanitizeFileName(fileName) {
                            // Remove extension
                            const nameWithoutExt = fileName.replace(/\.[^/.]+$/, '');
                            // Replace special characters and spaces with underscores
                            const sanitized = nameWithoutExt
                                .replace(/[^a-zA-Z0-9_-]/g, '_')
                                .replace(/_+/g, '_')
                                .substring(0, 50); // Limit length
                            // Get original extension
                            const ext = fileName.substring(fileName.lastIndexOf('.'));
                            return sanitized + ext;
                        }
                        
                        // Check if Firebase Storage is available
                        if (!firebase.storage) {
                            throw new Error('Firebase Storage is not initialized. Please check your Firebase configuration.');
                        }
                        
                        const reportKey = `${year}-${String(month).padStart(2, '0')}`;
                        const sanitizedFileName = sanitizeFileName(file.name);
                        let downloadURL;
                        let useBase64 = false;
                        
                        // Check file size first - if too large, skip Storage attempt
                        if (file.size > 900000) { // 900KB limit for base64 fallback
                            console.warn('File too large for base64 fallback, attempting Storage only');
                        }
                        
                        // Check file size - use base64 for files under 900KB to avoid CORS issues
                        // Once Firebase Storage rules are configured, you can enable Storage uploads
                        if (file.size > 900000) { // 900KB limit (Firestore has 1MB limit, leave buffer)
                            throw new Error('File is too large (' + (file.size / 1024 / 1024).toFixed(2) + 'MB). Maximum size: 900KB. Please configure Firebase Storage rules to allow larger file uploads.');
                        }
                        
                        // Use base64 storage (avoids CORS issues until Storage rules are configured)
                        useBase64 = true;
                        
                        // Convert file to base64 and store in Firestore
                        progressPercent.textContent = 'Converting file...';
                        progressBar.style.width = '30%';
                        
                        const reader = new FileReader();
                        const fileBase64 = await new Promise((resolve, reject) => {
                            reader.onload = () => {
                                const base64String = reader.result.split(',')[1]; // Remove data:application/pdf;base64, prefix
                                resolve(base64String);
                            };
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                        
                        progressBar.style.width = '60%';
                        progressPercent.textContent = 'Saving to database...';
                        
                        // Store base64 in Firestore
                        downloadURL = 'data:application/pdf;base64,' + fileBase64;
                        
                        progressBar.style.width = '100%';
                        progressPercent.textContent = '100%';
                        
                        // Save report metadata to Firestore
                        const reportData = {
                            month: month,
                            year: year,
                            fileName: file.name,
                            fileSize: file.size,
                            storageMethod: useBase64 ? 'base64' : 'storage',
                            uploadDate: firebase.firestore.FieldValue.serverTimestamp(),
                            uploadedBy: 'admin' // Could store admin user ID if needed
                        };
                        
                        // If using base64, store it in the document
                        if (useBase64 || downloadURL.startsWith('data:')) {
                            // Store base64 data (Firestore has 1MB limit per document)
                            const base64Data = downloadURL.split(',')[1];
                            reportData.fileBase64 = base64Data;
                            reportData.fileUrl = 'base64'; // Marker to indicate base64 storage
                        } else {
                            // Store Storage URL
                            reportData.fileUrl = downloadURL;
                        }
                        
                        // Save to reports subcollection for the user
                        await db.collection('users').doc(userId)
                            .collection('reports')
                            .doc(reportKey)
                            .set(reportData);
                        
                        // Hide progress and show success
                        setTimeout(() => {
                            progressDiv.style.display = 'none';
                            
                            // Reset form and close modal
                            reportUploadForm.reset();
                            document.getElementById('file-selected-info').style.display = 'none';
                            closeReportUploadModal();
                            
                            // Reload reports list
                            loadReportsUsersList();
                            
                            // Update dashboard widget if this is an admin report
                            if (userId === ADMIN_ACCOUNT_ID) {
                                updateLatestReports();
                            }
                            
                            alert(`Report for ${month} ${year} uploaded successfully!`);
                        }, 500);
                    } catch (error) {
                        console.error('Error uploading report:', error);
                        
                        // Hide progress
                        document.getElementById('upload-progress').style.display = 'none';
                        
                        // Re-enable button
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        
                        // Show error message
                        let errorMessage = 'Error uploading report:\n\n';
                        if (error.code === 'storage/unauthorized') {
                            errorMessage += 'You do not have permission to upload files.\n\n';
                            errorMessage += 'Please check Firebase Storage security rules in the Firebase Console.\n';
                            errorMessage += 'Rules should allow authenticated users to write to the reports/ path.';
                        } else if (error.code === 'storage/canceled') {
                            errorMessage += 'Upload was canceled.';
                        } else if (error.code === 'storage/quota-exceeded') {
                            errorMessage += 'Storage quota exceeded. Please contact administrator.';
                        } else if (error.code === 'storage/unauthenticated') {
                            errorMessage += 'You must be authenticated to upload files.\n\n';
                            errorMessage += 'Please ensure you are logged in as an admin.';
                        } else if (error.message && error.message.includes('CORS')) {
                            errorMessage += 'CORS error detected.\n\n';
                            errorMessage += 'This usually means Firebase Storage security rules need to be configured.\n\n';
                            errorMessage += 'Please check Firebase Console > Storage > Rules and ensure uploads are allowed.\n\n';
                            errorMessage += 'Example rule:\n';
                            errorMessage += 'match /reports/{userId}/{fileName} {\n';
                            errorMessage += '  allow write: if request.auth != null;\n';
                            errorMessage += '  allow read: if request.auth != null;\n';
                            errorMessage += '}';
                        } else if (error.code) {
                            errorMessage += `Error code: ${error.code}\n`;
                            errorMessage += `Message: ${error.message || 'Unknown error'}`;
                        } else {
                            errorMessage += error.message || 'Unknown error occurred.';
                        }
                        
                        alert(errorMessage);
                        console.error('Full error details:', error);
                    }
                });
            }
            
            // Admin Reports Widget Functions
            function viewAdminReportsWidget() {
                const adminId = 1; // Admin user ID
                const adminReports = reportsData[adminId] || {};
                const reportsList = Object.values(adminReports).sort((a, b) => {
                    const yearDiff = a.year - b.year;
                    if (yearDiff !== 0) return yearDiff;
                    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                    return months.indexOf(a.month) - months.indexOf(b.month);
                });
                
                const container = document.getElementById('admin-reports-widgets-container');
                const modal = document.getElementById('admin-reports-widget-modal');
                
                if (reportsList.length === 0) {
                    container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 2rem;">No reports uploaded yet.</p>';
                } else {
                    container.innerHTML = '';
                    reportsList.forEach(report => {
                        const widget = document.createElement('div');
                        widget.className = 'report-widget';
                        widget.style.cssText = 'background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);';
                        widget.innerHTML = `
                            <div style="margin-bottom: 1rem;">
                                <h4 style="margin: 0; font-size: 1.1rem; color: #1f2937;">${report.month} ${report.year}</h4>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #6b7280;">${report.fileName || 'Report.pdf'}</p>
                            </div>
                            <button class="admin-btn-save" onclick="downloadAdminReport(${adminId}, '${report.month}', ${report.year})" style="width: 100%;">
                                Download
                            </button>
                        `;
                        container.appendChild(widget);
                    });
                }
                
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function closeAdminReportsWidget() {
                document.getElementById('admin-reports-widget-modal').style.display = 'none';
                document.body.style.overflow = '';
            }
            
            function downloadAdminReport(userId, month, year) {
                const reportKey = `${year}-${String(month).padStart(2, '0')}`;
                const report = reportsData[userId]?.[reportKey];
                if (report && report.file) {
                    const url = URL.createObjectURL(report.file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = report.fileName || `Report_${month}_${year}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            }
            
            window.downloadAdminReport = downloadAdminReport;
            
            
            // Close modal handlers for reports
            setTimeout(function() {
                const reportUploadModal = document.getElementById('report-upload-modal');
                if (reportUploadModal) {
                    reportUploadModal.querySelector('.admin-modal-close')?.addEventListener('click', closeReportUploadModal);
                    reportUploadModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeReportUploadModal);
                    document.getElementById('cancel-report-upload')?.addEventListener('click', closeReportUploadModal);
                    
                    // File selection handler
                    const fileInput = document.getElementById('report-file');
                    if (fileInput) {
                        fileInput.addEventListener('change', function(e) {
                            const file = e.target.files[0];
                            const fileInfoDiv = document.getElementById('file-selected-info');
                            const fileNameDiv = document.getElementById('selected-file-name');
                            const fileSizeDiv = document.getElementById('selected-file-size');
                            
                            if (file) {
                                fileNameDiv.textContent = file.name;
                                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                                fileSizeDiv.textContent = fileSizeMB + ' MB';
                                fileInfoDiv.style.display = 'block';
                            } else {
                                fileInfoDiv.style.display = 'none';
                            }
                        });
                    }
                }
                
                const reportViewerModal = document.getElementById('report-viewer-modal');
                if (reportViewerModal) {
                    reportViewerModal.querySelector('.admin-modal-close')?.addEventListener('click', closeReportViewerModal);
                    
                    // Reports list modal
                    const reportsListModal = document.getElementById('reports-list-modal');
                    if (reportsListModal) {
                        reportsListModal.querySelector('.admin-modal-close')?.addEventListener('click', closeReportsListModal);
                        reportsListModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeReportsListModal);
                    }
                    
                    // Download report button
                    const downloadReportBtn = document.getElementById('download-report-btn');
                    if (downloadReportBtn) {
                        downloadReportBtn.addEventListener('click', function() {
                            const fileUrl = this.getAttribute('data-url');
                            const fileName = this.getAttribute('data-filename') || 'report.pdf';
                            const fileBase64 = this.getAttribute('data-base64');
                            const storageMethod = this.getAttribute('data-storage-method') || 'storage';
                            if (fileUrl || fileBase64) {
                                downloadReportFromList(fileUrl, fileName, fileBase64, storageMethod);
                            }
                        });
                    }
                    reportViewerModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeReportViewerModal);
                }
                
                const adminReportsWidgetModal = document.getElementById('admin-reports-widget-modal');
                if (adminReportsWidgetModal) {
                    adminReportsWidgetModal.querySelector('.admin-modal-close')?.addEventListener('click', closeAdminReportsWidget);
                    adminReportsWidgetModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeAdminReportsWidget);
                }
            }, 100);
            
            // Investors Payment Tracking
            let investorsPaymentStatus = {}; // Store payment status: { investorId: { paid: true/false, month: YYYY-MM } }
            const PAYMENT_STATUS_COLLECTION = 'investorPaymentStatus';
            
            // Get current month in YYYY-MM format
            function getCurrentMonth() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                return `${year}-${month}`;
            }
            
            // Check if we need to reset payment statuses for new month
            async function checkAndResetMonthlyPayments() {
                try {
                    if (!db) {
                        console.warn('Firestore not initialized');
                        return;
                    }
                    
                    const currentMonth = getCurrentMonth();
                    const statusSnapshot = await db.collection(PAYMENT_STATUS_COLLECTION).get();
                    
                    // Check if any status exists for current month
                    let hasCurrentMonthData = false;
                    statusSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.month === currentMonth) {
                            hasCurrentMonthData = true;
                        }
                    });
                    
                    // If no current month data exists, reset all payments and update balances
                    if (!hasCurrentMonthData && statusSnapshot.size > 0) {
                        console.log('New month detected, resetting payment statuses and updating balances...');
                        
                        // Get all investors
                        if (window.firestoreService) {
                            const investors = await window.firestoreService.getAllUsers('investor');
                            
                            // Update each investor's balance and reset payment status
                            for (const investor of investors) {
                                const investmentStrategy = investor.investmentStrategy || 'Low risk 2% a month';
                                let growthRate = 0.02; // Default 2%
                                
                                if (investmentStrategy === 'High risk 4% a month') {
                                    growthRate = 0.04; // 4%
                                } else if (investmentStrategy === 'Personalized') {
                                    // For personalized, we'd need to get the last transaction's growth rate
                                    // For now, default to 2%
                                    growthRate = 0.02;
                                }
                                
                                // Calculate new balance with monthly growth
                                const currentBalance = investor.currentBalance || investor.initialInvestment || 0;
                                const newBalance = currentBalance * (1 + growthRate);
                                
                                // Update balance in Firestore
                                await window.firestoreService.updateUserBalance(investor.id, newBalance);
                                
                                // Reset payment status for new month
                                await db.collection(PAYMENT_STATUS_COLLECTION)
                                    .doc(investor.id)
                                    .set({
                                        paid: false,
                                        month: currentMonth,
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    }, { merge: true });
                            }
                            
                            // Reload users data to reflect updated balances
                            const firestoreUsers = await window.firestoreService.getAllUsers();
                            usersData = firestoreUsers.map(user => 
                                window.firestoreService.formatUserForAdminPortal(user)
                            );
                        }
                    }
                } catch (error) {
                    console.error('Error checking/resetting monthly payments:', error);
                }
            }
            
            // Load payment statuses from Firestore
            async function loadPaymentStatuses() {
                try {
                    if (!db) {
                        console.warn('Firestore not initialized');
                        return;
                    }
                    
                    // Check and reset if needed
                    await checkAndResetMonthlyPayments();
                    
                    const currentMonth = getCurrentMonth();
                    const statusSnapshot = await db.collection(PAYMENT_STATUS_COLLECTION).get();
                    investorsPaymentStatus = {};
                    
                    statusSnapshot.forEach(doc => {
                        const data = doc.data();
                        const investorId = doc.id; // Use string ID directly
                        const statusMonth = data.month || currentMonth;
                        
                        // Only show as paid if it's for the current month
                        investorsPaymentStatus[investorId] = {
                            paid: (data.paid || false) && (statusMonth === currentMonth),
                            month: statusMonth,
                            updatedAt: data.updatedAt
                        };
                    });
                } catch (error) {
                    console.error('Error loading payment statuses:', error);
                }
            }
            
            // Save payment status to Firestore
            async function savePaymentStatus(investorId, isPaid) {
                try {
                    if (!db) {
                        console.warn('Firestore not initialized');
                        return;
                    }
                    
                    const currentMonth = getCurrentMonth();
                    await db.collection(PAYMENT_STATUS_COLLECTION)
                        .doc(investorId) // Use string ID directly
                        .set({
                            paid: isPaid,
                            month: currentMonth,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                } catch (error) {
                    console.error('Error saving payment status:', error);
                    alert('Error saving payment status: ' + error.message);
                }
            }
            
            async function loadInvestorsPaymentList() {
                const container = document.getElementById('investors-payment-list');
                if (!container) return;
                
                // Load payment statuses from database first
                await loadPaymentStatuses();
                
                // Get all investors (exclude admin)
                const investors = usersData.filter(user => user.type === 'investor');
                
                if (investors.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No investors found.</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                investors.forEach(investor => {
                    // Determine growth rate from investment strategy (2% or 4%) - default to 2% if not specified
                    const investmentStrategy = investor.strategy || 'Low risk 2% a month';
                    let growthRate = 2; // Default 2%
                    
                    if (investmentStrategy === 'High risk 4% a month') {
                        growthRate = 4; // 4%
                    } else if (investmentStrategy === 'Personalized') {
                        // For personalized, try to get from last transaction or default to 2%
                        growthRate = investor.growthRate || 2;
                    }
                    
                    const growthPercent = growthRate;
                    const paymentAmount = (investor.balance * (growthRate / 100)).toFixed(2);
                    const isPaid = investorsPaymentStatus[investor.id]?.paid || false;
                    
                    const item = document.createElement('div');
                    item.className = 'investor-payment-item';
                    item.setAttribute('data-investor-id', investor.id);
                    item.style.cssText = 'display: grid; grid-template-columns: 2fr 1.5fr 0.8fr 1.5fr 0.8fr; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #e5e7eb; gap: 1rem;';
                    if (isPaid) {
                        item.style.opacity = '0.6';
                        item.style.textDecoration = 'line-through';
                        item.style.textDecorationColor = '#6b7280';
                    }
                    
                    item.innerHTML = `
                        <div style="font-weight: 600; color: #1f2937; font-size: 0.875rem; ${isPaid ? 'text-decoration: line-through;' : ''}">${investor.name}</div>
                        <div style="color: #374151; font-size: 0.875rem; text-align: right; ${isPaid ? 'text-decoration: line-through;' : ''}">â‚¬${investor.balance.toLocaleString('en-US')}</div>
                        <div style="color: #374151; font-size: 0.875rem; text-align: center; ${isPaid ? 'text-decoration: line-through;' : ''}">${growthPercent}%</div>
                        <div style="color: #2563eb; font-weight: 600; font-size: 0.875rem; text-align: right; ${isPaid ? 'text-decoration: line-through;' : ''}">â‚¬${parseFloat(paymentAmount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="text-align: center;">
                            <input type="checkbox" 
                                   class="payment-checkbox" 
                                   data-investor-id="${investor.id}"
                                   ${isPaid ? 'checked' : ''}
                                   style="width: 18px; height: 18px; cursor: pointer;">
                        </div>
                    `;
                    
                    container.appendChild(item);
                });
                
                // Add event listeners to checkboxes
                container.querySelectorAll('.payment-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', async function() {
                        const investorId = this.getAttribute('data-investor-id'); // Use string ID directly
                        const isPaid = this.checked;
                        
                        // Update local state
                        if (!investorsPaymentStatus[investorId]) {
                            investorsPaymentStatus[investorId] = {};
                        }
                        investorsPaymentStatus[investorId].paid = isPaid;
                        
                        // Save to database
                        await savePaymentStatus(investorId, isPaid);
                        
                        // Update the row styling immediately
                        const rowItem = this.closest('.investor-payment-item');
                        if (rowItem) {
                            if (isPaid) {
                                rowItem.style.opacity = '0.6';
                                rowItem.style.textDecoration = 'line-through';
                                rowItem.style.textDecorationColor = '#6b7280';
                                // Also add line-through to all child elements
                                rowItem.querySelectorAll('div').forEach(div => {
                                    div.style.textDecoration = 'line-through';
                                });
                            } else {
                                rowItem.style.opacity = '1';
                                rowItem.style.textDecoration = 'none';
                                rowItem.querySelectorAll('div').forEach(div => {
                                    div.style.textDecoration = 'none';
                                });
                            }
                        }
                    });
                });
            }
            
            // Load investors payment list when dashboard view is shown
            // Use the dashboardView already declared in navigation handler
            if (dashboardView) {
                const observer = new MutationObserver(async function(mutations) {
                    mutations.forEach(async function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            if (dashboardView.style.display !== 'none') {
                                // Load users if not already loaded
                                if (!usersData || usersData.length === 0) {
                                    if (window.firestoreService) {
                                        try {
                                            const firestoreUsers = await window.firestoreService.getAllUsers();
                                            usersData = firestoreUsers.map(user => 
                                                window.firestoreService.formatUserForAdminPortal(user)
                                            );
                                        } catch (error) {
                                            console.error('Error loading users in observer:', error);
                                        }
                                    }
                                }
                                loadInvestorsPaymentList();
                            }
                        }
                    });
                });
                observer.observe(dashboardView, { attributes: true, attributeFilter: ['style'] });
                
                // Also load on initial page load if dashboard is visible
                if (dashboardView.style.display !== 'none') {
                    // Wait a bit for Firestore to be ready, then load users and payment list
                    setTimeout(async () => {
                        if (!usersData || usersData.length === 0) {
                            if (window.firestoreService) {
                                try {
                                    const firestoreUsers = await window.firestoreService.getAllUsers();
                                    usersData = firestoreUsers.map(user => 
                                        window.firestoreService.formatUserForAdminPortal(user)
                                    );
                                } catch (error) {
                                    console.error('Error loading users on initial load:', error);
                                }
                            }
                        }
                        loadInvestorsPaymentList();
                    }, 500);
                }
            }
            
            // Dashboard navigation links
            const dashboardNewsLink = document.getElementById('dashboard-news-link');
            
            if (dashboardNewsLink) {
                dashboardNewsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const navItems = document.querySelectorAll('.sidebar-nav-item');
                    navItems.forEach(item => {
                        const span = item.querySelector('span');
                        if (span && span.textContent.trim() === 'Market News') {
                            item.click();
                        }
                    });
                });
            }
            
            // Dashboard report download buttons
            const dashboardReportDownloads = document.querySelectorAll('.dashboard-report-download');
            dashboardReportDownloads.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const month = this.getAttribute('data-month');
                    const monthNames = {
                        '2024-10': 'October_2024',
                        '2024-11': 'November_2024',
                        '2024-12': 'December_2024',
                        '2025-01': 'January_2025'
                    };
                    const filename = `Monthly_Report_${monthNames[month]}.pdf`;
                    alert(`Downloading ${filename}\n\nNote: This is a demo. In production, this would generate and download the actual PDF report.`);
                });
            });
            
            
            // Dashboard news widget click handler
            const dashboardNewsWidget = document.getElementById('dashboard-news-widget');
            if (dashboardNewsWidget) {
                dashboardNewsWidget.style.cursor = 'pointer';
                dashboardNewsWidget.addEventListener('click', function() {
                    const navItems = document.querySelectorAll('.sidebar-nav-item');
                    navItems.forEach(item => {
                        const span = item.querySelector('span');
                        if (span && span.textContent.trim() === 'Market News') {
                            item.click();
                        }
                    });
                });
            }
            
            // Draw dashboard charts when dashboard is shown
            const dashboardViewEl = document.getElementById('dashboard-view');
            if (dashboardViewEl) {
                // Load latest news on initial page load if dashboard is visible
                if (dashboardViewEl.style.display !== 'none') {
                    setTimeout(loadDashboardLatestNews, 500);
                }
                
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            if (dashboardViewEl.style.display !== 'none') {
                                setTimeout(function() {
                                    calculateProjectionValue();
                                    loadDashboardLatestNews();
                                }, 100);
                            }
                        }
                    });
                });
                observer.observe(dashboardViewEl, { attributes: true, attributeFilter: ['style'] });
            }
            
            // Calculate 12-month projection value
            function calculateProjectionValue() {
                const projectionValueEl = document.getElementById('dashboard-projection-value');
                const portfolioProjectionEl = document.getElementById('portfolio-projection');
                
                // Use same calculation as portfolio chart (2% compound growth per month)
                const monthlyGrowthRate = 0.02; // 2% per month
                let balance = 10350000; // Current fund balance (month 12)
                
                // Calculate 12 months forward
                for (let i = 0; i < 12; i++) {
                    balance = balance * (1 + monthlyGrowthRate);
                }
                
                // Round to whole number and format
                const projectedValue = Math.round(balance);
                const formattedValue = 'â‚¬' + projectedValue.toLocaleString('en-US');
                
                if (projectionValueEl) {
                    projectionValueEl.textContent = formattedValue;
                }
                if (portfolioProjectionEl) {
                    portfolioProjectionEl.textContent = formattedValue;
                }
            }
            
            // Investors List Functions - Load from Firestore
            async function loadInvestorsList() {
                const container = document.getElementById('investors-grid');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">Loading investors...</div>';
                
                try {
                    // Load all users from Firestore (without composite index - filter and sort in JavaScript)
                    const usersSnapshot = await db.collection('users')
                        .get();
                    
                    container.innerHTML = '';
                    
                    if (usersSnapshot.empty) {
                        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No investors found</div>';
                        return;
                    }
                    
                    // Filter investors and sort by createdAt
                    const investors = [];
                    usersSnapshot.forEach((doc) => {
                        const userData = doc.data();
                        if (userData.type === 'investor' || (!userData.type && userData.username)) {
                            // Handle Firestore timestamp
                            let createdAt = 0;
                            if (userData.createdAt) {
                                if (userData.createdAt.toMillis) {
                                    createdAt = userData.createdAt.toMillis();
                                } else if (userData.createdAt.seconds) {
                                    createdAt = userData.createdAt.seconds * 1000;
                                } else if (userData.createdAt instanceof Date) {
                                    createdAt = userData.createdAt.getTime();
                                }
                            }
                            
                            investors.push({
                                id: doc.id,
                                data: userData,
                                createdAt: createdAt
                            });
                        }
                    });
                    
                    // Sort by createdAt (newest first)
                    investors.sort((a, b) => b.createdAt - a.createdAt);
                    
                    if (investors.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No investors found</div>';
                        return;
                    }
                    
                    // Process each investor
                    for (const investor of investors) {
                        const userData = investor.data;
                        const userId = investor.id;
                        
                        // Get transaction count and calculate total return from all transactions
                        const transactionsSnapshot = await db.collection('users').doc(userId)
                            .collection('transactions')
                            .get();
                        const transactionCount = transactionsSnapshot.size;
                        
                        // Calculate total return as sum of all monthly growth percentages
                        let totalReturn = 0;
                        if (!transactionsSnapshot.empty) {
                            transactionsSnapshot.forEach((doc) => {
                                const transData = doc.data();
                                const growthPercent = transData.growth || 0;
                                totalReturn += growthPercent;
                            });
                        }
                        
                        // If no transactions, use stored totalReturn or 0
                        if (transactionCount === 0) {
                            totalReturn = userData.totalReturn || 0;
                        }
                        
                        const card = document.createElement('div');
                        card.className = 'investor-card';
                        
                        const userName = userData.fullName || userData.username || 'Unknown';
                        const userEmail = userData.email || 'N/A';
                        const accountNumber = userData.accountNumber || 'N/A';
                        const initialInvestment = userData.initialInvestment || 0;
                        const currentBalance = userData.currentBalance || initialInvestment;
                        const accountStatus = userData.accountStatus || 'Active';
                        
                        card.innerHTML = `
                            <div class="investor-card-header">
                                <h3>${userName}</h3>
                                <span class="investor-status investor-status-${accountStatus.toLowerCase()}">${accountStatus}</span>
                            </div>
                            <div class="investor-card-body">
                                <p><strong>Email:</strong> ${userEmail}</p>
                                <p><strong>Account:</strong> ${accountNumber}</p>
                                <p><strong>Initial Investment:</strong> â‚¬${initialInvestment.toLocaleString('en-US')}</p>
                                <p><strong>Current Balance:</strong> â‚¬${currentBalance.toLocaleString('en-US')}</p>
                                <p><strong>Return:</strong> <span class="${totalReturn >= 0 ? 'return-positive' : 'return-negative'}">${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%</span></p>
                                <p><strong>Performance Entries:</strong> ${transactionCount}</p>
                            </div>
                            <div class="investor-card-actions" style="display: flex; gap: 0.5rem;">
                                <button class="admin-btn-save" onclick="openInvestorPerformanceModal('${userId}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Add Performance</button>
                                <button class="admin-btn-view" onclick="viewInvestorPerformance('${userId}')">View History</button>
                            </div>
                        `;
                        container.appendChild(card);
                    }
                } catch (error) {
                    console.error('Error loading investors list:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #dc2626;">Error loading investors: ' + error.message + '</div>';
                }
            }
            
            async function openInvestorPerformanceModal(investorId) {
                try {
                    // Get user from Firestore
                    const userDoc = await db.collection('users').doc(investorId).get();
                    if (!userDoc.exists) {
                        alert('User not found');
                        return;
                    }
                    
                    const userData = userDoc.data();
                    const investor = {
                        id: investorId,
                        name: userData.fullName || userData.username || 'Unknown'
                    };
                    
                    const investmentStrategy = userData.investmentStrategy || 'Low risk 2% a month';
                    
                    const modal = document.getElementById('investor-performance-modal');
                    document.getElementById('investor-performance-modal-title').textContent = `Add Performance - ${investor.name}`;
                    document.getElementById('investor-performance-form').reset();
                    
                    // Show/hide growth input based on strategy
                    const growthGroup = document.getElementById('performance-growth-group');
                    if (investmentStrategy === 'Personalized') {
                        growthGroup.style.display = 'block';
                        document.getElementById('performance-growth').required = true;
                    } else {
                        growthGroup.style.display = 'none';
                        document.getElementById('performance-growth').required = false;
                        // Display strategy info
                        const strategyInfo = document.createElement('div');
                        strategyInfo.id = 'strategy-info';
                        strategyInfo.style.cssText = 'padding: 0.75rem; background: #eff6ff; border-radius: 6px; margin-bottom: 1rem; font-size: 0.875rem; color: #1e40af;';
                        strategyInfo.textContent = `Investment Strategy: ${investmentStrategy}. Default growth will be used unless you enter a Return % above.`;
                        const form = document.getElementById('investor-performance-form');
                        const existingInfo = document.getElementById('strategy-info');
                        if (existingInfo) existingInfo.remove();
                        form.insertBefore(strategyInfo, form.firstChild);
                    }
                    
                    modal.setAttribute('data-investor-id', investorId);
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                } catch (error) {
                    console.error('Error opening performance modal:', error);
                    alert('Error loading investor data: ' + error.message);
                }
            }
            
            function closeInvestorPerformanceModal() {
                const modal = document.getElementById('investor-performance-modal');
                modal.style.display = 'none';
                document.body.style.overflow = '';
                // Clear edit mode and reset form
                modal.removeAttribute('data-edit-mode');
                modal.removeAttribute('data-edit-transaction-id');
                document.getElementById('investor-performance-form').reset();
                const strategyInfo = document.getElementById('strategy-info');
                if (strategyInfo) strategyInfo.remove();
                const growthGroup = document.getElementById('performance-growth-group');
                if (growthGroup) growthGroup.style.display = 'none';
            }
            
            async function viewInvestorPerformance(investorId) {
                try {
                    const userDoc = await db.collection('users').doc(investorId).get();
                    if (!userDoc.exists) {
                        alert('User not found');
                        return;
                    }
                    
                    const userData = userDoc.data();
                    const investor = {
                        id: investorId,
                        name: userData.fullName || 'Unknown',
                        initial: userData.initialInvestment || 0
                    };
                    
                    const modal = document.getElementById('investor-performance-table-modal');
                    document.getElementById('investor-performance-table-title').textContent = `Performance History - ${investor.name}`;
                    
                    const tableBody = document.getElementById('investor-performance-table-body');
                    
                    // Load transactions from Firestore (without composite index - sort in JavaScript)
                    const transactionsSnapshot = await db.collection('users').doc(investorId)
                        .collection('transactions')
                        .get();
                    
                    if (transactionsSnapshot.empty) {
                        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #6b7280;">No performance entries yet</td></tr>';
                    } else {
                        tableBody.innerHTML = '';
                        
                        // Sort transactions in JavaScript (by year, then monthIndex)
                        const transactions = [];
                        transactionsSnapshot.forEach((doc) => {
                            transactions.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });
                        
                        // Sort by year, then monthIndex
                        transactions.sort((a, b) => {
                            if (a.year !== b.year) {
                                return a.year - b.year;
                            }
                            return (a.monthIndex || 0) - (b.monthIndex || 0);
                        });
                        
                        transactions.forEach((entry) => {
                            
                            const row = document.createElement('tr');
                            const depositDisplay = entry.deposits > 0 && entry.depositDate
                                ? `â‚¬${entry.deposits.toLocaleString('en-US')}<br><span class="transaction-date">${formatDate(entry.depositDate.toDate())}</span>`
                                : entry.deposits > 0 ? `â‚¬${entry.deposits.toLocaleString('en-US')}` : '-';
                            const withdrawalDisplay = entry.withdrawals > 0 && entry.withdrawalDate
                                ? `â‚¬${entry.withdrawals.toLocaleString('en-US')}<br><span class="transaction-date">${formatDate(entry.withdrawalDate.toDate())}</span>`
                                : entry.withdrawals > 0 ? `â‚¬${entry.withdrawals.toLocaleString('en-US')}` : '-';
                            
                            // Format deposit and withdrawal dates for form
                            let depositDateFormatted = '';
                            if (entry.depositDate) {
                                const depositDateObj = entry.depositDate.toDate();
                                depositDateFormatted = depositDateObj.toISOString().split('T')[0];
                            }
                            
                            let withdrawalDateFormatted = '';
                            if (entry.withdrawalDate) {
                                const withdrawalDateObj = entry.withdrawalDate.toDate();
                                withdrawalDateFormatted = withdrawalDateObj.toISOString().split('T')[0];
                            }
                            
                            row.innerHTML = `
                                <td>${entry.month} ${entry.year}</td>
                                <td>â‚¬${entry.startingBalance.toLocaleString('en-US')}</td>
                                <td>â‚¬${entry.endingBalance.toLocaleString('en-US')}</td>
                                <td class="${entry.growth >= 0 ? 'growth-positive' : 'growth-negative'}">${entry.growth >= 0 ? '+' : ''}${entry.growth.toFixed(2)}%</td>
                                <td class="transaction-cell">${depositDisplay}</td>
                                <td class="transaction-cell">${withdrawalDisplay}</td>
                                <td>
                                    <button class="admin-btn-save" onclick="editPerformanceEntry('${investorId}', '${entry.id}', '${entry.month}', ${entry.year}, ${entry.growth || 0}, ${entry.deposits || 0}, ${entry.withdrawals || 0}, '${depositDateFormatted}', '${withdrawalDateFormatted}', ${entry.returnPercent !== null && entry.returnPercent !== undefined ? entry.returnPercent : 'null'})" style="padding: 0.4rem 0.8rem; font-size: 0.875rem;">Edit</button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    }
                    
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                } catch (error) {
                    console.error('Error loading performance history:', error);
                    alert('Error loading performance history: ' + error.message);
                }
            }
            
            function closeInvestorPerformanceTableModal() {
                document.getElementById('investor-performance-table-modal').style.display = 'none';
                document.body.style.overflow = '';
            }
            
            // Function to edit a performance entry
            async function editPerformanceEntry(investorId, transactionId, month, year, growth, deposits, withdrawals, depositDate, withdrawalDate, returnPercent) {
                try {
                    // Close the history modal
                    closeInvestorPerformanceTableModal();
                    
                    // Open the performance modal in edit mode
                    const userDoc = await db.collection('users').doc(investorId).get();
                    if (!userDoc.exists) {
                        alert('User not found');
                        return;
                    }
                    
                    const userData = userDoc.data();
                    const investor = {
                        id: investorId,
                        name: userData.fullName || userData.username || 'Unknown'
                    };
                    
                    const modal = document.getElementById('investor-performance-modal');
                    document.getElementById('investor-performance-modal-title').textContent = `Edit Performance - ${investor.name}`;
                    
                    // Populate form with existing data
                    document.getElementById('performance-month').value = month;
                    document.getElementById('performance-year').value = year;
                    document.getElementById('performance-deposits').value = deposits || 0;
                    document.getElementById('performance-withdrawals').value = withdrawals || 0;
                    document.getElementById('performance-deposit-date').value = depositDate || '';
                    document.getElementById('performance-withdrawal-date').value = withdrawalDate || '';
                    // Populate Return % field if it exists
                    document.getElementById('performance-return-percent').value = returnPercent !== null && returnPercent !== undefined ? returnPercent : '';
                    
                    // Show/hide growth input based on strategy
                    const investmentStrategy = userData.investmentStrategy || 'Low risk 2% a month';
                    const growthGroup = document.getElementById('performance-growth-group');
                    if (investmentStrategy === 'Personalized') {
                        growthGroup.style.display = 'block';
                        document.getElementById('performance-growth').value = growth || 0;
                        document.getElementById('performance-growth').required = true;
                    } else {
                        growthGroup.style.display = 'none';
                        document.getElementById('performance-growth').required = false;
                        // Display strategy info
                        const form = document.getElementById('investor-performance-form');
                        const existingInfo = document.getElementById('strategy-info');
                        if (existingInfo) existingInfo.remove();
                        const strategyInfo = document.createElement('div');
                        strategyInfo.id = 'strategy-info';
                        strategyInfo.style.cssText = 'padding: 0.75rem; background: #eff6ff; border-radius: 6px; margin-bottom: 1rem; font-size: 0.875rem; color: #1e40af;';
                        strategyInfo.textContent = `Investment Strategy: ${investmentStrategy}. Default growth will be used unless you enter a Return % above.`;
                        form.insertBefore(strategyInfo, form.firstChild);
                    }
                    
                    // Store transaction ID for update mode
                    modal.setAttribute('data-investor-id', investorId);
                    modal.setAttribute('data-edit-transaction-id', transactionId);
                    modal.setAttribute('data-edit-mode', 'true');
                    
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                } catch (error) {
                    console.error('Error opening edit performance modal:', error);
                    alert('Error loading entry data: ' + error.message);
                }
            }
            
            window.openInvestorPerformanceModal = openInvestorPerformanceModal;
            window.viewInvestorPerformance = viewInvestorPerformance;
            window.editPerformanceEntry = editPerformanceEntry;
            
            // Investor performance form handler - Save to Firestore
            const investorPerformanceForm = document.getElementById('investor-performance-form');
            if (investorPerformanceForm) {
                investorPerformanceForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const modal = document.getElementById('investor-performance-modal');
                    const investorId = modal.getAttribute('data-investor-id');
                    const isEditMode = modal.getAttribute('data-edit-mode') === 'true';
                    const transactionId = modal.getAttribute('data-edit-transaction-id');
                    
                    if (!investorId) {
                        alert('Error: Investor ID not found');
                        return;
                    }
                    
                    try {
                        const month = document.getElementById('performance-month').value;
                        const year = parseInt(document.getElementById('performance-year').value);
                        const deposits = parseFloat(document.getElementById('performance-deposits').value) || 0;
                        const withdrawals = parseFloat(document.getElementById('performance-withdrawals').value) || 0;
                        const depositDate = document.getElementById('performance-deposit-date').value || null;
                        const withdrawalDate = document.getElementById('performance-withdrawal-date').value || null;
                        
                        // Validate deposit date if deposit amount > 0
                        if (deposits > 0 && !depositDate) {
                            alert('Please enter a deposit date when adding a deposit.');
                            return;
                        }
                        
                        // Get current user data to calculate starting balance and get investment strategy
                        const userDoc = await db.collection('users').doc(investorId).get();
                        if (!userDoc.exists) {
                            alert('Error: User not found');
                            return;
                        }
                        
                        const userData = userDoc.data();
                        const investmentStrategy = userData.investmentStrategy || 'Low risk 2% a month';
                        
                        // Check if Return % is provided (takes priority over strategy default)
                        const returnPercentInput = document.getElementById('performance-return-percent').value;
                        let monthlyGrowthRate = 0.02; // Default to 2%
                        let isPersonalized = false;
                        
                        if (returnPercentInput && returnPercentInput !== '') {
                            // Use the actual return % if provided
                            monthlyGrowthRate = parseFloat(returnPercentInput) / 100;
                        } else {
                            // Otherwise, determine monthly growth rate based on investment strategy
                            if (investmentStrategy === 'High risk 4% a month') {
                                monthlyGrowthRate = 0.04; // 4%
                            } else if (investmentStrategy === 'Personalized') {
                                // For personalized, use manual input
                                const manualGrowth = parseFloat(document.getElementById('performance-growth').value);
                                if (!manualGrowth || manualGrowth === 0) {
                                    alert('Please enter a growth rate for Personalized strategy.');
                                    return;
                                }
                                monthlyGrowthRate = manualGrowth / 100;
                                isPersonalized = true;
                            } else {
                                monthlyGrowthRate = 0.02; // Low risk 2%
                            }
                        }
                        
                        // Get all existing transactions for this user to calculate starting balance
                        // Load all and sort in JavaScript to avoid composite index requirement
                        const transactionsSnapshot = await db.collection('users').doc(investorId)
                            .collection('transactions')
                            .get();
                        
                        let startingBalance = userData.initialInvestment || 0;
                        if (!transactionsSnapshot.empty) {
                            // Sort transactions by year, then monthIndex
                            const transactions = [];
                            transactionsSnapshot.forEach((doc) => {
                                const data = doc.data();
                                // When editing, exclude the current transaction being edited
                                if (isEditMode && transactionId && doc.id === transactionId) {
                                    return; // Skip the transaction being edited
                                }
                                transactions.push(data);
                            });
                            
                            transactions.sort((a, b) => {
                                if (a.year !== b.year) {
                                    return a.year - b.year;
                                }
                                return (a.monthIndex || 0) - (b.monthIndex || 0);
                            });
                            
                            // Find the previous month's transaction
                            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                                           'July', 'August', 'September', 'October', 'November', 'December'];
                            const currentMonthIndex = months.indexOf(month);
                            
                            let previousTransaction = null;
                            
                            if (isEditMode) {
                                // When editing, find the transaction that comes before this month/year
                                for (let i = transactions.length - 1; i >= 0; i--) {
                                    const trans = transactions[i];
                                    const transMonthIndex = months.indexOf(trans.month);
                                    
                                    // Check if this transaction is before the current one
                                    if (trans.year < year || (trans.year === year && transMonthIndex < currentMonthIndex)) {
                                        previousTransaction = trans;
                                        break;
                                    }
                                }
                            } else {
                                // When adding new, get the last transaction (most recent)
                                if (transactions.length > 0) {
                                    previousTransaction = transactions[transactions.length - 1];
                                }
                            }
                            
                            if (previousTransaction) {
                                // Starting balance = previous month's ending balance - withdrawals
                                // (as per user requirement: starting balance should be previous month's ending balance minus withdrawals)
                                startingBalance = (previousTransaction.endingBalance || 0) - (previousTransaction.withdrawals || 0);
                            }
                        }
                        
                        // Calculate growth with prorated deposit growth
                        let endingBalance = startingBalance;
                        let depositGrowth = 0;
                        let daysRemaining = 0;
                        let daysInMonth = 30;
                        
                        // Apply full monthly growth to existing balance
                        const existingBalanceGrowth = startingBalance * monthlyGrowthRate;
                        endingBalance = startingBalance + existingBalanceGrowth;
                        
                        // If there's a deposit with a date, calculate prorated growth for the deposit
                        if (deposits > 0 && depositDate) {
                            // Calculate days into the month
                            const depositDateObj = new Date(depositDate);
                            const depositDay = depositDateObj.getDate();
                            
                            // Get total days in the month
                            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                             'July', 'August', 'September', 'October', 'November', 'December'];
                            const monthIndexForCalc = monthNames.indexOf(month);
                            daysInMonth = new Date(year, monthIndexForCalc + 1, 0).getDate();
                            
                            // Calculate days remaining in month (including deposit day)
                            daysRemaining = daysInMonth - depositDay + 1;
                            
                            // Prorate growth for deposit: (days remaining / total days) * monthly growth rate
                            const proratedGrowthRate = (daysRemaining / daysInMonth) * monthlyGrowthRate;
                            depositGrowth = deposits * proratedGrowthRate;
                            
                            // Add deposit and its prorated growth
                            endingBalance = endingBalance + deposits + depositGrowth;
                        } else if (deposits > 0) {
                            // If deposit but no date, add deposit without growth
                            endingBalance = endingBalance + deposits;
                        }
                        
                        // Subtract withdrawals first to get final ending balance
                        endingBalance = endingBalance - withdrawals;
                        
                        // Calculate the growth percentage
                        // Return (%) = ((Ending balance + Withdrawals) - (Starting balance + Deposits)) / (Starting balance + Deposits) Ã— 100
                        // Note: Withdrawals are added back to ending balance for calculation, but NOT included in the denominator
                        const denominator = startingBalance + deposits;
                        const effectiveGrowthPercent = denominator > 0 
                            ? (((endingBalance + withdrawals) - denominator) / denominator * 100) 
                            : 0;
                        
                        // Month index for sorting (0-11)
                        // Reuse months array already defined above
                        const monthIndex = (['January', 'February', 'March', 'April', 'May', 'June', 
                                            'July', 'August', 'September', 'October', 'November', 'December']).indexOf(month);
                        
                        // Create transaction entry
                        const transactionData = {
                            month: month,
                            monthIndex: monthIndex,
                            year: year,
                            startingBalance: startingBalance,
                            endingBalance: endingBalance,
                            growth: effectiveGrowthPercent, // Store effective growth percentage
                            deposits: deposits,
                            withdrawals: withdrawals,
                            depositDate: depositDate ? firebase.firestore.Timestamp.fromDate(new Date(depositDate)) : null,
                            withdrawalDate: withdrawalDate ? firebase.firestore.Timestamp.fromDate(new Date(withdrawalDate)) : null,
                            investmentStrategy: investmentStrategy, // Store strategy used
                            monthlyGrowthRate: monthlyGrowthRate * 100, // Store as percentage
                            returnPercent: returnPercentInput && returnPercentInput !== '' ? parseFloat(returnPercentInput) : null, // Store actual return % if provided
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // Check if transaction for this month/year already exists (for editing)
                        // Load all transactions and filter in JavaScript to avoid index requirement
                        const allTransactionsSnapshot = await db.collection('users').doc(investorId)
                            .collection('transactions')
                            .get();
                        
                        let existingTransactionDoc = null;
                        if (!allTransactionsSnapshot.empty) {
                            // Find transactions matching this month/year
                            const matchingTransactions = [];
                            allTransactionsSnapshot.forEach((doc) => {
                                const data = doc.data();
                                if (data.year === year && data.month === month) {
                                    matchingTransactions.push({
                                        id: doc.id,
                                        createdAt: data.createdAt?.toMillis() || 0
                                    });
                                }
                            });
                            
                            // Sort by createdAt to get most recent
                            if (matchingTransactions.length > 0) {
                                matchingTransactions.sort((a, b) => b.createdAt - a.createdAt);
                                existingTransactionDoc = matchingTransactions[0];
                            }
                        }
                        
                        let isUpdate = false;
                        
                        // Check if we're in edit mode (from View History Edit button)
                        if (isEditMode && transactionId) {
                            // Update existing transaction (edit mode from View History)
                            await db.collection('users').doc(investorId)
                                .collection('transactions')
                                .doc(transactionId)
                                .update({
                                    ...transactionData,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            isUpdate = true;
                        } else if (existingTransactionDoc) {
                            // Update existing transaction (most recent one for this month/year)
                            await db.collection('users').doc(investorId)
                                .collection('transactions')
                                .doc(existingTransactionDoc.id)
                                .update({
                                    ...transactionData,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            isUpdate = true;
                        } else {
                            // Create new transaction entry
                            await db.collection('users').doc(investorId)
                                .collection('transactions')
                                .add(transactionData);
                        }
                        
                        // Update user's current balance and total return
                        // Total Return = sum of all months' growth percentages
                        const allTransactionsForReturn = await db.collection('users').doc(investorId)
                            .collection('transactions')
                            .get();
                        
                        let totalReturn = 0;
                        if (!allTransactionsForReturn.empty) {
                            allTransactionsForReturn.forEach((doc) => {
                                const transData = doc.data();
                                const growthPercent = transData.growth || 0;
                                totalReturn += growthPercent;
                            });
                        }
                        
                        await db.collection('users').doc(investorId).update({
                            currentBalance: endingBalance,
                            totalReturn: totalReturn,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Clear edit mode attributes
                        modal.removeAttribute('data-edit-mode');
                        modal.removeAttribute('data-edit-transaction-id');
                        
                        // Reload investors list
                        await loadInvestorsList();
                        await loadReportsUsersList();
                        closeInvestorPerformanceModal();
                        alert(isUpdate ? `Performance entry for ${month} ${year} updated successfully!` : 'Performance entry added successfully!');
                    } catch (error) {
                        console.error('Error saving performance entry:', error);
                        alert('Error saving performance entry: ' + error.message);
                    }
                });
            }
            
            async function openInvestorEditModal(id) {
                try {
                    const userDoc = await db.collection('users').doc(id).get();
                    if (!userDoc.exists) {
                        alert('User not found');
                        return;
                    }
                    
                    const userData = userDoc.data();
                    const modal = document.getElementById('investor-edit-modal');
                    document.getElementById('edit-investor-name').value = userData.fullName || '';
                    document.getElementById('edit-investor-email').value = userData.email || '';
                    document.getElementById('edit-investor-phone').value = userData.phone || '';
                    document.getElementById('edit-investor-account').value = userData.accountNumber || '';
                    document.getElementById('edit-investor-initial').value = userData.initialInvestment || 0;
                    document.getElementById('edit-investor-balance').value = userData.currentBalance || userData.initialInvestment || 0;
                    document.getElementById('edit-investor-status').value = userData.accountStatus || 'Active';
                    modal.setAttribute('data-edit-id', id);
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                } catch (error) {
                    console.error('Error loading investor for edit:', error);
                    alert('Error loading investor data: ' + error.message);
                }
            }
            
            function closeInvestorEditModal() {
                document.getElementById('investor-edit-modal').style.display = 'none';
                document.body.style.overflow = '';
            }
            
            // Make function global
            window.openInvestorEditModal = openInvestorEditModal;
            
            // Investor edit form handler - Update Firestore
            const investorEditForm = document.getElementById('investor-edit-form');
            if (investorEditForm) {
                investorEditForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const id = document.getElementById('investor-edit-modal').getAttribute('data-edit-id');
                    if (!id) return;
                    
                    try {
                        const updateData = {
                            fullName: document.getElementById('edit-investor-name').value,
                            email: document.getElementById('edit-investor-email').value,
                            phone: document.getElementById('edit-investor-phone').value,
                            accountNumber: document.getElementById('edit-investor-account').value,
                            initialInvestment: parseFloat(document.getElementById('edit-investor-initial').value) || 0,
                            currentBalance: parseFloat(document.getElementById('edit-investor-balance').value) || 0,
                            accountStatus: document.getElementById('edit-investor-status').value,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        await db.collection('users').doc(id).update(updateData);
                        await loadInvestorsList();
                        closeInvestorEditModal();
                        alert('Investor updated successfully!');
                    } catch (error) {
                        console.error('Error updating investor:', error);
                        alert('Error updating investor: ' + error.message);
                    }
                });
            }
            
            // Add investor button
            if (document.getElementById('add-investor-btn')) {
                document.getElementById('add-investor-btn').addEventListener('click', function() {
                    const modal = document.getElementById('investor-edit-modal');
                    document.getElementById('investor-modal-title').textContent = 'Add New Investor';
                    document.getElementById('investor-edit-form').reset();
                    modal.removeAttribute('data-edit-id');
                    modal.setAttribute('data-add-mode', 'true');
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                });
            }
            
            
            // Users List Functions
            // Note: usersData is now loaded from Firestore
            let usersData = [];
            
            async function loadUsersList() {
                const container = document.getElementById('users-grid');
                if (!container) return;
                
                // Show loading state
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">Loading users...</div>';
                
                try {
                    // Load users from Firestore
                    if (window.firestoreService) {
                        console.log('Loading users from Firestore...');
                        const firestoreUsers = await window.firestoreService.getAllUsers();
                        console.log('Users loaded from Firestore:', firestoreUsers.length);
                        // Convert Firestore format to admin portal format
                        usersData = firestoreUsers.map(user => 
                            window.firestoreService.formatUserForAdminPortal(user)
                        );
                        console.log('Users formatted for display:', usersData.length);
                    } else {
                        console.warn('Firestore service not available, using empty array');
                        usersData = [];
                    }
                } catch (error) {
                    console.error('Error loading users from Firestore:', error);
                    console.error('Error details:', {
                        code: error.code,
                        message: error.message
                    });
                    alert('Error loading users: ' + (error.message || 'Unknown error. Please check console for details.'));
                    usersData = [];
                }
                
                container.innerHTML = '';
                
                if (usersData.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);"><p style="margin: 0 0 1rem 0;">No users found.</p><p style="margin: 0; font-size: 0.875rem;">Click "Add New User" button above to create your first user.</p></div>';
                    return;
                }
                
                usersData.forEach(user => {
                    const card = document.createElement('div');
                    card.className = 'investor-card';
                    const returnPercent = user.initial > 0 ? ((user.balance - user.initial) / user.initial * 100).toFixed(2) : '0.00';
                    const isAdmin = user.type === 'admin';
                    card.innerHTML = `
                        <div class="investor-card-header">
                            <h3>${user.name}</h3>
                            <span class="investor-status investor-status-${user.status.toLowerCase()}">${user.type === 'admin' ? 'Admin' : user.status}</span>
                        </div>
                        <div class="investor-card-body">
                            <p><strong>Type:</strong> ${user.type === 'admin' ? 'Admin' : 'Investor'}</p>
                            <p><strong>Email:</strong> ${user.email}</p>
                            ${user.type === 'admin' ? `
                                <p><strong>Initial Investment:</strong> â‚¬${user.initial.toLocaleString('en-US')}</p>
                                <p><strong>Current Balance:</strong> â‚¬${user.balance.toLocaleString('en-US')}</p>
                                <p><strong>Return:</strong> <span class="return-positive">+${returnPercent}%</span></p>
                            ` : `
                                <p><strong>Initial Investment:</strong> â‚¬${user.initial.toLocaleString('en-US')}</p>
                                <p><strong>Current Balance:</strong> â‚¬${user.balance.toLocaleString('en-US')}</p>
                                <p><strong>Return:</strong> <span class="return-positive">+${returnPercent}%</span></p>
                            `}
                        </div>
                        <div class="investor-card-actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                            <button class="admin-edit-btn" onclick="openUserEditModal('${user.id}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Edit</button>
                            ${isAdmin ? `<button class="admin-btn-add" onclick="openAddUserModal()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">+ Add New User</button>` : ''}
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
            
            function openAddUserModal() {
                const modal = document.getElementById('user-edit-modal');
                document.getElementById('user-modal-title').textContent = 'Add New User';
                document.getElementById('user-edit-form').reset();
                
                // Make password field editable for new users
                const passwordInput = document.getElementById('edit-user-password');
                passwordInput.value = '';
                passwordInput.readOnly = false;
                passwordInput.required = true;
                passwordInput.placeholder = 'Enter password for login';
                passwordInput.style.backgroundColor = '';
                passwordInput.style.cursor = '';
                document.getElementById('user-password-hint').textContent = 'Password must be at least 6 characters.';
                
                // Hide delete button when adding new user
                const deleteBtn = document.getElementById('delete-user-btn');
                if (deleteBtn) deleteBtn.style.display = 'none';
                modal.removeAttribute('data-edit-id');
                modal.removeAttribute('data-user-id-for-delete');
                modal.setAttribute('data-add-mode', 'true');
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            window.openAddUserModal = openAddUserModal;
            
            function openUserEditModal(id) {
                const user = usersData.find(u => u.id === id);
                if (!user) return;
                
                const modal = document.getElementById('user-edit-modal');
                document.getElementById('edit-user-username').value = user.username || '';
                // Display current password (read-only, admin can only view it)
                const passwordInput = document.getElementById('edit-user-password');
                passwordInput.value = user.password || '';
                passwordInput.placeholder = 'Password';
                passwordInput.readOnly = true;
                passwordInput.required = false;
                passwordInput.style.backgroundColor = '#f3f4f6';
                passwordInput.style.cursor = 'not-allowed';
                document.getElementById('user-password-hint').textContent = 'Password is view-only. Cannot be changed after user creation.';
                // Show delete button when editing
                document.getElementById('delete-user-btn').style.display = 'inline-block';
                document.getElementById('edit-user-name').value = user.name;
                document.getElementById('edit-user-email').value = user.email;
                document.getElementById('edit-user-phone').value = user.phone;
                document.getElementById('edit-user-status').value = user.status;
                document.getElementById('edit-user-country').value = user.country;
                // Handle date field - convert from Firestore format if needed
                const memberSinceValue = user.memberSince || '';
                document.getElementById('edit-user-member-since').value = memberSinceValue;
                document.getElementById('edit-user-initial').value = user.initial;
                document.getElementById('edit-user-strategy').value = user.strategy;
                document.getElementById('edit-user-operator').value = user.operator;
                modal.setAttribute('data-edit-id', id);
                modal.setAttribute('data-user-id-for-delete', id);
                modal.removeAttribute('data-add-mode');
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            // Cleanup Database Function - Delete all users except default ones (1,2,3,4)
            async function cleanupDatabase() {
                if (!confirm('âš ï¸ WARNING: This will delete ALL users from the database except the default accounts (username: 1,2,3,4).\n\nThis action CANNOT be undone!\n\nAre you absolutely sure?')) {
                    return;
                }
                
                if (!confirm('This is your last chance. Are you REALLY sure you want to delete all users?')) {
                    return;
                }
                
                try {
                    if (!window.firebaseDb) {
                        alert('Firebase not available. Please refresh the page.');
                        return;
                    }
                    
                    // Get all users from Firestore
                    const usersSnapshot = await window.firebaseDb.collection('users').get();
                    const defaultUsernames = ['1', '2', '3', '4'];
                    let deletedCount = 0;
                    let keptCount = 0;
                    
                    // Delete all users except default ones
                    for (const doc of usersSnapshot.docs) {
                        const userData = doc.data();
                        const username = userData.username || '';
                        
                        // Keep default users (1,2,3,4)
                        if (defaultUsernames.includes(username)) {
                            keptCount++;
                            console.log('Keeping default user:', username);
                            continue;
                        }
                        
                        // Delete non-default users
                        try {
                            await window.firebaseDb.collection('users').doc(doc.id).delete();
                            deletedCount++;
                            console.log('Deleted user:', username, doc.id);
                        } catch (error) {
                            console.error('Error deleting user', doc.id, ':', error);
                        }
                    }
                    
                    alert(`Database cleanup complete!\n\nDeleted: ${deletedCount} user(s)\nKept: ${keptCount} default user(s)\n\nNote: Firebase Auth users may still exist and need to be deleted manually via Firebase Console.`);
                    
                    // Reload users list
                    await loadUsersList();
                    
                } catch (error) {
                    console.error('Error cleaning up database:', error);
                    alert('Error cleaning up database: ' + error.message);
                }
            }
            
            window.cleanupDatabase = cleanupDatabase;
            
            // Delete user function
            async function deleteUser() {
                const modal = document.getElementById('user-edit-modal');
                const userId = modal.getAttribute('data-user-id-for-delete') || modal.getAttribute('data-edit-id');
                
                if (!userId) {
                    console.error('User ID not found for deletion');
                    return;
                }
                
                // Confirm deletion
                if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    if (window.firestoreService) {
                        // Get user data before deletion to get email for Firebase Auth cleanup
                        const user = usersData.find(u => u.id === userId);
                        
                        // Delete from Firestore (this will also trigger cleanup)
                        await window.firestoreService.deleteUser(userId);
                        
                        // Note: Firebase Auth user deletion requires Admin SDK
                        // For now, we delete from Firestore and log a note
                        if (user && user.email) {
                            console.log('User deleted from Firestore. If Firebase Auth user exists with email:', user.email, '- it should be deleted via Firebase Console or Admin SDK.');
                        }
                        
                        // Close modal and reload lists
                        closeUserEditModal();
                        await loadUsersList();
                        
                        // Also reload Performance section
                        await loadInvestorsList();
                        
                        // Also reload Reports section
                        await loadReportsUsersList();
                        
                        alert('User deleted successfully from database.');
                    } else {
                        alert('Firestore service not available. Please refresh the page.');
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Error deleting user: ' + error.message);
                }
            }
            
            function closeUserEditModal() {
                document.getElementById('user-edit-modal').style.display = 'none';
                document.body.style.overflow = '';
            }
            
            window.openUserEditModal = openUserEditModal;
            
            // User edit form handler
            const userEditForm = document.getElementById('user-edit-form');
            if (userEditForm) {
                // Wait for Firestore service to be ready
                function setupFormHandler() {
                    if (!window.firestoreService) {
                        // Wait a bit and try again
                        setTimeout(setupFormHandler, 100);
                        return;
                    }
                    
                    userEditForm.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        const modal = document.getElementById('user-edit-modal');
                        const isAddMode = modal.getAttribute('data-add-mode') === 'true';
                        
                        // Check if service is available
                        if (!window.firestoreService) {
                            alert('Firestore service is still loading. Please wait a moment and try again.');
                            return;
                        }
                        
                        // Disable submit button during processing
                        const submitBtn = userEditForm.querySelector('button[type="submit"]');
                        const originalText = submitBtn.textContent;
                        submitBtn.disabled = true;
                        submitBtn.textContent = isAddMode ? 'Creating...' : 'Saving...';
                        
                        try {
                            // Collect form data
                            // Password is read-only, so we don't include it in updates
                            
                            // Get password only for new users (it's read-only when editing)
                            const passwordInput = document.getElementById('edit-user-password');
                            const passwordValue = isAddMode ? passwordInput.value.trim() : undefined;
                            
                            const formData = {
                                username: document.getElementById('edit-user-username').value.trim(),
                                password: passwordValue, // Only included for new users
                                name: document.getElementById('edit-user-name').value.trim(),
                                email: document.getElementById('edit-user-email').value.trim(),
                                phone: document.getElementById('edit-user-phone').value.trim(),
                                status: document.getElementById('edit-user-status').value,
                                country: document.getElementById('edit-user-country').value.trim(),
                                memberSince: document.getElementById('edit-user-member-since').value,
                                initial: parseFloat(document.getElementById('edit-user-initial').value) || 0,
                                strategy: document.getElementById('edit-user-strategy').value.trim(),
                                operator: document.getElementById('edit-user-operator').value.trim(),
                                type: 'investor'
                            };
                            
                            // Password validation only for new users (password is read-only when editing)
                            // No password validation needed for editing since password field is read-only
                        
                        if (isAddMode) {
                            // Add new user
                            if (!formData.password) {
                                alert('Password is required for new users');
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                return;
                            }
                            
                            // Validate password length
                            if (formData.password.length < 6) {
                                alert('Password must be at least 6 characters long');
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                return;
                            }
                            
                            if (window.firestoreService) {
                                // Check username uniqueness
                                const existingUser = await window.firestoreService.getUserByUsername(formData.username);
                                if (existingUser) {
                                    alert('Username already exists. Please choose a different username.');
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = originalText;
                                    return;
                                }
                                
                                // Check email uniqueness
                                const existingEmail = await window.firestoreService.getUserByEmail(formData.email);
                                if (existingEmail) {
                                    alert('Email already exists. Please use a different email address.');
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = originalText;
                                    return;
                                }
                                
                                // Create user in Firestore
                                console.log('Creating user in Firestore...', formData);
                                const userId = await window.firestoreService.createUser(formData);
                                console.log('User created in Firestore with ID:', userId);
                                
                                // Create Firebase Auth user (only if email doesn't already exist)
                                if (formData.password && window.firebaseAuth) {
                                    try {
                                        // Try to create Firebase Auth user
                                        const authUser = await window.firebaseAuth.createUserWithEmailAndPassword(
                                            formData.email, 
                                            formData.password
                                        );
                                        console.log('Firebase Auth user created:', authUser.user.uid);
                                    } catch (authError) {
                                        console.error('Could not create Firebase Auth user:', authError);
                                        
                                        // If email already exists in Firebase Auth, that's okay - user can still log in
                                        if (authError.code === 'auth/email-already-in-use') {
                                            console.log('Email already exists in Firebase Auth. User can log in with existing credentials.');
                                            // User is created in Firestore, and Auth user already exists, so this is fine
                                        } else {
                                            // Other errors - show warning but continue
                                            alert('User created in database. Note: Firebase Auth user creation failed: ' + authError.message);
                                        }
                                    }
                                }
                                
                                // Close modal first
                                closeUserEditModal();
                                
                                // Reload users list and Performance section (if user is investor)
                                console.log('Reloading users list...');
                                await loadUsersList();
                                
                                // Also reload Performance section so new investor appears there
                                if (formData.type === 'investor' || !formData.type) {
                                    await loadInvestorsList();
                                }
                                
                                // Also reload Reports section
                                await loadReportsUsersList();
                                
                                // User added successfully - no alert needed
                            } else {
                                alert('Firestore service not available. Please refresh the page.');
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                return;
                            }
                        } else {
                            // Edit existing user
                            const userId = modal.getAttribute('data-edit-id');
                            if (!userId) {
                                alert('Error: User ID not found');
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                return;
                            }
                            
                            // Check for conflicts
                            const currentUser = usersData.find(u => u.id === userId);
                            if (currentUser && window.firestoreService) {
                                if (formData.username !== currentUser.username) {
                                    const existingUser = await window.firestoreService.getUserByUsername(formData.username);
                                    if (existingUser && existingUser.id !== userId) {
                                        alert('Username already exists. Please choose a different username.');
                                        submitBtn.disabled = false;
                                        submitBtn.textContent = originalText;
                                        return;
                                    }
                                }
                                
                                if (formData.email !== currentUser.email) {
                                    const existingEmail = await window.firestoreService.getUserByEmail(formData.email);
                                    if (existingEmail && existingEmail.id !== userId) {
                                        alert('Email already exists. Please use a different email address.');
                                        submitBtn.disabled = false;
                                        submitBtn.textContent = originalText;
                                        return;
                                    }
                                }
                            }
                            
                            // Update user in Firestore
                            if (window.firestoreService) {
                                // Password is NOT included in formData when editing (read-only field)
                                // Remove password from formData if editing (it shouldn't be there, but just in case)
                                if (!isAddMode && formData.password !== undefined) {
                                    delete formData.password;
                                }
                                
                                // Only update other fields (password is view-only and cannot be changed)
                                await window.firestoreService.updateUser(userId, formData);
                                // User updated successfully - no alert needed
                            } else {
                                alert('Firestore service not available. Please refresh the page.');
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                return;
                            }
                        }
                        
                        // Close modal first
                        closeUserEditModal();
                        
                        // Reload users list and Performance section
                        console.log('Reloading users list...');
                        await loadUsersList();
                        
                        // Also reload Performance section in case user type changed
                        await loadInvestorsList();
                        
                        // Also reload Reports section
                        await loadReportsUsersList();
                        
                        } catch (error) {
                            console.error('Error saving user:', error);
                            console.error('Error details:', {
                                code: error.code,
                                message: error.message,
                                stack: error.stack
                            });
                            
                            let errorMessage = 'Error saving user: ';
                            if (error.code) {
                                errorMessage += `[${error.code}] `;
                            }
                            errorMessage += error.message || 'Unknown error occurred';
                            
                            alert(errorMessage);
                        } finally {
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                    });
                }
                
                // Try to set up immediately, or wait for service
                if (window.firestoreService) {
                    setupFormHandler();
                } else {
                    window.addEventListener('firestoreReady', setupFormHandler);
                    // Also try after a delay as fallback
                    setTimeout(setupFormHandler, 500);
                }
            }
            
            // News Edit Functions
            // Market News Functions - Now using Firestore
            let newsData = [];
            
            async function loadMarketNews() {
                const container = document.getElementById('news-grid');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">Loading news...</div>';
                
                try {
                    if (window.firestoreService) {
                        newsData = await window.firestoreService.getAllNews();
                        console.log('News loaded from Firestore:', newsData.length);
                    } else {
                        console.warn('Firestore service not available');
                        newsData = [];
                    }
                } catch (error) {
                    console.error('Error loading news:', error);
                    newsData = [];
                }
                
                container.innerHTML = '';
                
                if (newsData.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);"><p style="margin: 0 0 1rem 0;">No news articles found.</p><p style="margin: 0; font-size: 0.875rem;">Click "Add New Article" button above to create your first article.</p></div>';
                    return;
                }
                
                newsData.forEach((news, index) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'news-card-wrapper';
                    wrapper.setAttribute('data-news-id', news.id);
                    wrapper.innerHTML = `
                        <a href="${news.link}" target="_blank" rel="noopener noreferrer" class="news-card">
                            <div class="news-image-container">
                                <img src="${news.image}" alt="${news.title}" class="news-image" />
                                <h3 class="news-title">${news.title}</h3>
                            </div>
                        </a>
                        <button class="news-edit-btn" onclick="openNewsEditModal('${news.id}')">Edit</button>
                    `;
                    container.appendChild(wrapper);
                });
                
                // Update dashboard latest news widget when market news is loaded
                setTimeout(loadDashboardLatestNews, 100);
            }
            
            function openNewsEditModal(newsId) {
                const news = newsData.find(n => n.id === newsId);
                if (!news) return;
                
                const modal = document.getElementById('news-edit-modal');
                document.getElementById('news-modal-title').textContent = 'Edit News Article';
                document.getElementById('edit-news-title').value = news.title;
                document.getElementById('edit-news-link').value = news.link;
                document.getElementById('edit-news-image').value = news.image;
                document.getElementById('edit-news-order').value = news.order || 0;
                // Show delete button
                document.getElementById('delete-news-btn').style.display = 'inline-block';
                modal.setAttribute('data-edit-id', newsId);
                modal.removeAttribute('data-add-mode');
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function openAddNewsModal() {
                const modal = document.getElementById('news-edit-modal');
                document.getElementById('news-modal-title').textContent = 'Add New Article';
                document.getElementById('news-edit-form').reset();
                document.getElementById('edit-news-order').value = newsData.length;
                // Hide delete button
                document.getElementById('delete-news-btn').style.display = 'none';
                modal.removeAttribute('data-edit-id');
                modal.setAttribute('data-add-mode', 'true');
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            window.openAddNewsModal = openAddNewsModal;
            
            function closeNewsEditModal() {
                document.getElementById('news-edit-modal').style.display = 'none';
                document.body.style.overflow = '';
            }
            
            // Delete news function
            async function deleteNews() {
                const modal = document.getElementById('news-edit-modal');
                const newsId = modal.getAttribute('data-edit-id');
                
                if (!newsId) {
                    console.error('News ID not found for deletion');
                    return;
                }
                
                if (!confirm('Are you sure you want to delete this news article? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    if (window.firestoreService) {
                        await window.firestoreService.deleteNews(newsId);
                        closeNewsEditModal();
                        await loadMarketNews();
                        // Update dashboard latest news widget
                        await loadDashboardLatestNews();
                    } else {
                        alert('Firestore service not available. Please refresh the page.');
                    }
                } catch (error) {
                    console.error('Error deleting news:', error);
                    alert('Error deleting news: ' + error.message);
                }
            }
            
            // News edit form handler
            const newsEditForm = document.getElementById('news-edit-form');
            if (newsEditForm) {
                newsEditForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const modal = document.getElementById('news-edit-modal');
                    const isAddMode = modal.getAttribute('data-add-mode') === 'true';
                    
                    const submitBtn = newsEditForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = isAddMode ? 'Creating...' : 'Saving...';
                    
                    try {
                        const formData = {
                            title: document.getElementById('edit-news-title').value.trim(),
                            link: document.getElementById('edit-news-link').value.trim(),
                            image: document.getElementById('edit-news-image').value.trim(),
                            order: parseInt(document.getElementById('edit-news-order').value) || 0
                        };
                        
                        if (isAddMode) {
                            if (window.firestoreService) {
                                await window.firestoreService.createNews(formData);
                            } else {
                                alert('Firestore service not available. Please refresh the page.');
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                return;
                            }
                        } else {
                            const newsId = modal.getAttribute('data-edit-id');
                            if (!newsId) {
                                alert('Error: News ID not found');
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                return;
                            }
                            
                            if (window.firestoreService) {
                                await window.firestoreService.updateNews(newsId, formData);
                            } else {
                                alert('Firestore service not available. Please refresh the page.');
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                return;
                            }
                        }
                        
                        closeNewsEditModal();
                        await loadMarketNews();
                        // Update dashboard latest news widget
                        await loadDashboardLatestNews();
                        
                    } catch (error) {
                        console.error('Error saving news:', error);
                        alert('Error saving news: ' + error.message);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
            
            // Load Latest News titles in Dashboard widget from Market News
            async function loadDashboardLatestNews() {
                const newsWidget = document.getElementById('dashboard-news-widget');
                if (!newsWidget) return;
                
                const newsContent = newsWidget.querySelector('.dashboard-widget-content');
                if (!newsContent) return;
                
                try {
                    let newsData = [];
                    if (window.firestoreService) {
                        newsData = await window.firestoreService.getAllNews();
                    } else {
                        console.warn('Firestore service not available');
                        return;
                    }
                    
                    // Clear existing content
                    newsContent.innerHTML = '';
                    
                    if (newsData.length === 0) {
                        newsContent.innerHTML = '<div class="dashboard-news-item"><div class="dashboard-news-title" style="color: #9ca3af;">No news available</div></div>';
                        return;
                    }
                    
                    // Show up to 4 latest news items
                    const latestNews = newsData.slice(0, 4);
                    
                    latestNews.forEach((news) => {
                        const newsItem = document.createElement('div');
                        newsItem.className = 'dashboard-news-item';
                        newsItem.style.cursor = 'pointer';
                        newsItem.innerHTML = `<div class="dashboard-news-title">${news.title}</div>`;
                        
                        // Make it clickable to open the news link
                        newsItem.addEventListener('click', function() {
                            if (news.link) {
                                window.open(news.link, '_blank', 'noopener,noreferrer');
                            }
                        });
                        
                        newsContent.appendChild(newsItem);
                    });
                } catch (error) {
                    console.error('Error loading dashboard news:', error);
                    newsContent.innerHTML = '<div class="dashboard-news-item"><div class="dashboard-news-title" style="color: #dc2626;">Error loading news</div></div>';
                }
            }
            
            window.openNewsEditModal = openNewsEditModal;
            window.deleteNews = deleteNews;
            window.closeNewsEditModal = closeNewsEditModal;
            window.loadDashboardLatestNews = loadDashboardLatestNews;
            
            // Admin Profile Picture Functions
            function loadAdminProfilePicture(profilePictureUrl) {
                const profileImg = document.getElementById('admin-profile-picture-img');
                const placeholder = document.getElementById('admin-profile-picture-placeholder');
                
                if (profilePictureUrl && profilePictureUrl.trim() !== '') {
                    profileImg.src = profilePictureUrl;
                    profileImg.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                } else {
                    profileImg.style.display = 'none';
                    if (placeholder) placeholder.style.display = 'flex';
                }
            }
            
            // Load admin profile picture from separate admin sessionStorage key
            const adminProfilePicture = sessionStorage.getItem('adminProfilePicture');
            if (adminProfilePicture) {
                try {
                    loadAdminProfilePicture(adminProfilePicture);
                } catch (error) {
                    console.error('Error loading admin profile picture:', error);
                }
            }
            
            // Setup admin profile picture upload
            const adminProfileContainer = document.getElementById('admin-profile-picture-container');
            const adminProfileInput = document.getElementById('admin-profile-picture-input');
            const adminProfileOverlay = adminProfileContainer?.querySelector('.profile-picture-upload-overlay');
            
            if (adminProfileContainer && adminProfileInput) {
                // Show overlay on hover
                adminProfileContainer.addEventListener('mouseenter', function() {
                    if (adminProfileOverlay) adminProfileOverlay.style.display = 'flex';
                });
                
                adminProfileContainer.addEventListener('mouseleave', function() {
                    if (adminProfileOverlay) adminProfileOverlay.style.display = 'none';
                });
                
                // Click to upload
                adminProfileContainer.addEventListener('click', function() {
                    adminProfileInput.click();
                });
                
                // Handle file selection
                adminProfileInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file.');
                        return;
                    }
                    
                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Image size must be less than 5MB.');
                        return;
                    }
                    
                    try {
                        // Show loading state - use spinner
                        const profileImg = document.getElementById('admin-profile-picture-img');
                        const placeholder = document.getElementById('admin-profile-picture-placeholder');
                        if (placeholder) {
                            placeholder.innerHTML = '<div style="width: 20px; height: 20px; border: 2px solid #6b7280; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>';
                            placeholder.style.opacity = '0.7';
                        }
                        
                        // Convert image to base64 data URL (avoids Storage CORS issues)
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            try {
                                const base64DataUrl = e.target.result;
                                
                                // Store admin profile picture in separate sessionStorage key (isolated from users)
                                sessionStorage.setItem('adminProfilePicture', base64DataUrl);
                                
                                // Update display
                                loadAdminProfilePicture(base64DataUrl);
                                
                                // Reset placeholder opacity
                                if (placeholder) {
                                    placeholder.style.opacity = '1';
                                }
                                
                                console.log('Admin profile picture updated successfully');
                            } catch (error) {
                                console.error('Error saving admin profile picture:', error);
                                alert('Error saving profile picture: ' + error.message);
                                if (placeholder) {
                                    placeholder.innerHTML = '<span>ðŸ‘¤</span>';
                                    placeholder.style.opacity = '1';
                                }
                            }
                        };
                        
                        reader.onerror = function(error) {
                            console.error('Error reading file:', error);
                            alert('Error reading image file.');
                            if (placeholder) {
                                placeholder.innerHTML = '<span>ðŸ‘¤</span>';
                                placeholder.style.opacity = '1';
                            }
                        };
                        
                        // Read file as data URL
                        reader.readAsDataURL(file);
                    } catch (error) {
                        console.error('Error uploading admin profile picture:', error);
                        alert('Error uploading profile picture: ' + error.message);
                    }
                });
            }
            
            // Consultations Section
            let consultationsData = [];
            
            let selectedConsultationId = null;
            let currentFilter = 'all';
            
            async function loadConsultationsList() {
                const container = document.getElementById('consultations-grid');
                if (!container) return;
                
                container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 2rem;">Loading consultations...</div>';
                
                try {
                    // Load consultations from Firestore
                    if (window.firestoreService) {
                        consultationsData = await window.firestoreService.getAllConsultations();
                    } else {
                        console.warn('Firestore service not available');
                        consultationsData = [];
                    }
                } catch (error) {
                    console.error('Error loading consultations:', error);
                    consultationsData = [];
                }
                
                container.innerHTML = '';
                
                // Filter consultations based on current filter
                let filteredConsultations = consultationsData;
                if (currentFilter === 'pending') {
                    filteredConsultations = consultationsData.filter(c => c.status === 'pending');
                } else if (currentFilter === 'done') {
                    filteredConsultations = consultationsData.filter(c => c.status === 'done');
                }
                
                if (filteredConsultations.length === 0) {
                    container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 2rem;">No consultations found.</p>';
                    return;
                }
                
                filteredConsultations.forEach(consultation => {
                    const card = document.createElement('div');
                    card.className = 'consultation-card';
                    if (selectedConsultationId === consultation.id) {
                        card.classList.add('selected');
                    }
                    card.setAttribute('data-consultation-id', consultation.id);
                    
                    const statusClass = consultation.status === 'pending' ? 'consultation-status-pending' : 'consultation-status-done';
                    const statusText = consultation.status === 'pending' ? 'Pending' : 'Done';
                    
                    // Format date and time
                    const dateStr = consultation.date || '';
                    const timeStr = consultation.time || '';
                    const formattedDate = dateStr ? new Date(dateStr + 'T00:00:00').toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }) : 'Date not set';
                    const consultationTopic = consultation.consultationTopicDisplay || consultation.consultationTopic || 'Not specified';
                    
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.125rem; color: #1f2937;">${consultation.fullName || 'Unknown'}</h3>
                            <span class="consultation-status ${statusClass}">${statusText}</span>
                        </div>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">
                            <p style="margin: 0.25rem 0;"><strong>Email:</strong> ${consultation.email || 'N/A'}</p>
                            <p style="margin: 0.25rem 0;"><strong>Date:</strong> ${formattedDate}</p>
                            <p style="margin: 0.25rem 0;"><strong>Time:</strong> ${timeStr || 'Not set'}</p>
                            <p style="margin: 0.25rem 0;"><strong>Consultation:</strong> ${consultationTopic}</p>
                        </div>
                    `;
                    
                    // Only allow selection of pending consultations
                    if (consultation.status === 'pending') {
                        card.addEventListener('click', function() {
                            selectConsultation(consultation.id);
                        });
                    }
                    
                    container.appendChild(card);
                });
                
                // Update send email section visibility
                updateSendEmailSection();
            }
            
            function selectConsultation(id) {
                selectedConsultationId = id;
                loadConsultationsList();
                
                const consultation = consultationsData.find(c => c.id === id);
                if (consultation) {
                    const infoDiv = document.getElementById('selected-consultation-info');
                    const dateStr = consultation.date || '';
                    const timeStr = consultation.time || '';
                    const formattedDate = dateStr ? new Date(dateStr + 'T00:00:00').toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }) : 'Date not set';
                    const consultationTopic = consultation.consultationTopicDisplay || consultation.consultationTopic || 'Not specified';
                    
                    infoDiv.innerHTML = `
                        <strong>${consultation.fullName || 'Unknown'}</strong> - ${consultation.email || 'N/A'}<br>
                        <span style="font-size: 0.875rem; color: #6b7280;">${consultationTopic} - ${formattedDate} at ${timeStr || 'TBD'}</span>
                    `;
                    document.getElementById('send-email-section').style.display = 'block';
                }
            }
            
            function updateSendEmailSection() {
                const section = document.getElementById('send-email-section');
                if (selectedConsultationId) {
                    const consultation = consultationsData.find(c => c.id === selectedConsultationId);
                    if (consultation && consultation.status === 'pending') {
                        section.style.display = 'block';
                    } else {
                        section.style.display = 'none';
                        selectedConsultationId = null;
                    }
                } else {
                    section.style.display = 'none';
                }
            }
            
            // Filter tab handlers
            document.querySelectorAll('.consultation-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.consultation-tab-btn').forEach(b => {
                        b.classList.remove('active');
                        b.style.borderBottomColor = 'transparent';
                        b.style.color = '#6b7280';
                        b.style.fontWeight = '500';
                    });
                    
                    this.classList.add('active');
                    this.style.borderBottomColor = '#2563eb';
                    this.style.color = '#2563eb';
                    this.style.fontWeight = '600';
                    
                    currentFilter = this.getAttribute('data-filter');
                    selectedConsultationId = null;
                    loadConsultationsList();
                });
            });
            
            // Send email form handler
            const sendEmailForm = document.getElementById('send-email-form');
            if (sendEmailForm) {
                sendEmailForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    if (!selectedConsultationId) {
                        alert('Please select a consultation first.');
                        return;
                    }
                    
                    const consultation = consultationsData.find(c => c.id === selectedConsultationId);
                    if (!consultation) return;
                    
                    const googleMeetLink = document.getElementById('google-meet-link').value;
                    
                    if (!googleMeetLink) {
                        alert('Please enter a Google Meet link.');
                        return;
                    }
                    
                    // In a real application, this would send an email via a backend service
                    alert(`Google Meet link would be sent to ${consultation.email}:\n\nLink: ${googleMeetLink}\n\nNote: This is a demo. In production, this would send an actual email with the Google Meet link.`);
                    
                    // Mark consultation as done (optional)
                    // consultation.status = 'done';
                    // loadConsultationsList();
                });
            }
            
            // Clear selection button
            const cancelSendEmailBtn = document.getElementById('cancel-send-email');
            if (cancelSendEmailBtn) {
                cancelSendEmailBtn.addEventListener('click', function() {
                    selectedConsultationId = null;
                    document.getElementById('send-email-form').reset();
                    document.getElementById('selected-consultation-info').textContent = 'No consultation selected';
                    document.getElementById('send-email-section').style.display = 'none';
                    loadConsultationsList();
                });
            }
            
            // Emails Section
            function loadEmailUsersList() {
                // Function kept for compatibility but not needed anymore
            }
            
            // Add email recipient field
            function addEmailRecipientField() {
                const container = document.getElementById('email-recipients-container');
                if (!container) return;
                
                const newRow = document.createElement('div');
                newRow.className = 'email-recipient-row';
                newRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
                
                const input = document.createElement('input');
                input.type = 'email';
                input.className = 'admin-form-input email-recipient-input';
                input.placeholder = 'Enter email address';
                input.style.flex = '1';
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-email-btn';
                removeBtn.textContent = 'Remove';
                removeBtn.style.cssText = 'background: #fca5a5; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;';
                
                removeBtn.addEventListener('click', function() {
                    newRow.remove();
                    updateRemoveButtons();
                });
                
                newRow.appendChild(input);
                newRow.appendChild(removeBtn);
                container.appendChild(newRow);
                
                updateRemoveButtons();
            }
            
            function updateRemoveButtons() {
                const rows = document.querySelectorAll('.email-recipient-row');
                rows.forEach((row, index) => {
                    const removeBtn = row.querySelector('.remove-email-btn');
                    if (rows.length > 1) {
                        removeBtn.style.display = 'block';
                    } else {
                        removeBtn.style.display = 'none';
                    }
                });
            }
            
            // Add email recipient button
            const addEmailRecipientBtn = document.getElementById('add-email-recipient-btn');
            if (addEmailRecipientBtn) {
                addEmailRecipientBtn.addEventListener('click', function() {
                    addEmailRecipientField();
                });
            }
            
            // Initial update of remove buttons
            updateRemoveButtons();
            
            // Handle file attachments
            const emailAttachmentInput = document.getElementById('email-attachment');
            const attachmentListDiv = document.getElementById('attachment-list');
            
            if (emailAttachmentInput && attachmentListDiv) {
                emailAttachmentInput.addEventListener('change', function() {
                    const files = Array.from(this.files);
                    attachmentListDiv.innerHTML = '';
                    
                    if (files.length > 0) {
                        files.forEach((file, index) => {
                            if (file.type === 'application/pdf') {
                                const fileItem = document.createElement('div');
                                fileItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f3f4f6; border-radius: 4px; margin-top: 0.5rem;';
                                fileItem.innerHTML = `
                                    <span style="font-size: 0.875rem; color: #374151;">${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
                                    <button type="button" class="remove-attachment-btn" data-index="${index}" style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Remove</button>
                                `;
                                attachmentListDiv.appendChild(fileItem);
                            }
                        });
                        
                        // Add remove button handlers
                        attachmentListDiv.querySelectorAll('.remove-attachment-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const index = parseInt(this.getAttribute('data-index'));
                                const dt = new DataTransfer();
                                const files = Array.from(emailAttachmentInput.files);
                                files.splice(index, 1);
                                files.forEach(file => dt.items.add(file));
                                emailAttachmentInput.files = dt.files;
                                emailAttachmentInput.dispatchEvent(new Event('change'));
                            });
                        });
                    }
                });
            }
            
            // Send email to user form handler
            const sendEmailToUserForm = document.getElementById('send-email-to-user-form');
            if (sendEmailToUserForm) {
                sendEmailToUserForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const emailInputs = document.querySelectorAll('.email-recipient-input');
                    const emails = Array.from(emailInputs)
                        .map(input => input.value.trim())
                        .filter(email => email !== '');
                    
                    if (emails.length === 0) {
                        alert('Please enter at least one email address.');
                        return;
                    }
                    
                    const subject = document.getElementById('email-subject-input').value;
                    const message = document.getElementById('email-message-input').value;
                    const attachments = document.getElementById('email-attachment').files;
                    
                    let attachmentInfo = '';
                    if (attachments.length > 0) {
                        const fileNames = Array.from(attachments).map(f => f.name).join(', ');
                        attachmentInfo = `\n\nAttachments: ${fileNames}`;
                    }
                    
                    const recipientsList = emails.join(', ');
                    
                    // In a real application, this would send an email via a backend service
                    alert(`Email would be sent to: ${recipientsList}\n\nSubject: ${subject}\n\nMessage:\n${message}${attachmentInfo}\n\nNote: This is a demo. In production, this would send an actual email with attachments.`);
                });
            }
            
            // Clear email form button
            const clearEmailFormBtn = document.getElementById('clear-email-form');
            if (clearEmailFormBtn) {
                clearEmailFormBtn.addEventListener('click', function() {
                    document.getElementById('send-email-to-user-form').reset();
                    document.getElementById('attachment-list').innerHTML = '';
                    
                    // Reset to single email field
                    const container = document.getElementById('email-recipients-container');
                    container.innerHTML = `
                        <div class="email-recipient-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="email" class="admin-form-input email-recipient-input" placeholder="Enter email address" required style="flex: 1;">
                            <button type="button" class="remove-email-btn" style="display: none; background: #ef4444; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Remove</button>
                        </div>
                    `;
                    updateRemoveButtons();
                });
            }
            
            // Close modal handlers - set up after DOM is ready
            setTimeout(function() {
                const newsModal = document.getElementById('news-edit-modal');
                if (newsModal) {
                    newsModal.querySelector('.admin-modal-close')?.addEventListener('click', closeNewsEditModal);
                    newsModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeNewsEditModal);
                    document.getElementById('cancel-news-edit')?.addEventListener('click', closeNewsEditModal);
                }
                
                const investorModal = document.getElementById('investor-edit-modal');
                if (investorModal) {
                    investorModal.querySelector('.admin-modal-close')?.addEventListener('click', closeInvestorEditModal);
                    investorModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeInvestorEditModal);
                    document.getElementById('cancel-investor-edit')?.addEventListener('click', closeInvestorEditModal);
                }
                
                const investorPerformanceModal = document.getElementById('investor-performance-modal');
                if (investorPerformanceModal) {
                    investorPerformanceModal.querySelector('.admin-modal-close')?.addEventListener('click', closeInvestorPerformanceModal);
                    investorPerformanceModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeInvestorPerformanceModal);
                    document.getElementById('cancel-investor-performance')?.addEventListener('click', closeInvestorPerformanceModal);
                }
                
                const investorPerformanceTableModal = document.getElementById('investor-performance-table-modal');
                if (investorPerformanceTableModal) {
                    investorPerformanceTableModal.querySelector('.admin-modal-close')?.addEventListener('click', closeInvestorPerformanceTableModal);
                    investorPerformanceTableModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeInvestorPerformanceTableModal);
                }
                
                const userModal = document.getElementById('user-edit-modal');
                if (userModal) {
                    userModal.querySelector('.admin-modal-close')?.addEventListener('click', closeUserEditModal);
                    userModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeUserEditModal);
                    document.getElementById('cancel-user-edit')?.addEventListener('click', closeUserEditModal);
                    document.getElementById('delete-user-btn')?.addEventListener('click', deleteUser);
                }
            }, 100);
            
            // Initial draw if dashboard is visible
            if (dashboardViewEl && dashboardViewEl.style.display !== 'none') {
                setTimeout(function() {
                    calculateProjectionValue();
                }, 100);
            }

            // Redraw chart on window resize
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    if (portfolioView && portfolioView.style.display !== 'none') {
                        drawPortfolioChart();
                    }
                    if (performanceView && performanceView.style.display !== 'none') {
                        drawPerformanceChart();
                        setTimeout(setupPerformanceChartHover, 150);
                    }
                    // Dashboard widgets resized
                }, 250);
            });
    });
    </script>
</body>
</html>

