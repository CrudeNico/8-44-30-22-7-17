<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Opessocius</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Admin Modal Styles */
        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
        }
        .admin-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
        .admin-modal-container {
            position: relative;
            background: white;
            max-width: 500px;
            margin: 50px auto;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        .admin-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6b7280;
            z-index: 1;
        }
        .admin-modal-close:hover {
            color: #1f2937;
        }
        .admin-modal-content {
            padding: 2rem;
        }
        .admin-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #1f2937;
        }
        .admin-form-group {
            margin-bottom: 1.25rem;
        }
        .admin-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        .admin-form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .admin-form-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .admin-form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: flex-end;
        }
        .admin-btn-save, .admin-btn-cancel, .admin-btn-add, .admin-edit-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .admin-btn-save {
            background: #2563eb;
            color: white;
        }
        .admin-btn-save:hover {
            background: #1d4ed8;
        }
        .admin-btn-cancel {
            background: #e5e7eb;
            color: #374151;
        }
        .admin-btn-cancel:hover {
            background: #d1d5db;
        }
        .admin-btn-add {
            background: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .admin-btn-add:hover {
            background: #059669;
        }
        .admin-edit-btn {
            background: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        .admin-edit-btn:hover {
            background: #4b5563;
        }
        .admin-btn-view {
            background: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .admin-btn-view:hover {
            background: #4b5563;
        }
        
        /* Investors/Users Grid */
        .investors-grid, .users-grid, .reports-users-grid, .consultations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        /* Consultation Card Styles */
        .consultation-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s;
        }
        .consultation-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .consultation-card.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }
        .consultation-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        .consultation-status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .consultation-status-done {
            background: #d1fae5;
            color: #065f46;
        }
        .investor-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .investor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .investor-card-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: #1f2937;
        }
        .investor-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .investor-status-active {
            background: #d1fae5;
            color: #065f46;
        }
        .investor-status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }
        .investor-card-body p {
            margin: 0.5rem 0;
            color: #6b7280;
        }
        .investor-card-actions {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .return-positive {
            color: #10b981;
            font-weight: 600;
        }
        
        /* News Edit Button */
        .news-card-wrapper {
            position: relative;
        }
        .news-edit-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(37, 99, 235, 0.9);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            z-index: 10;
        }
        .news-edit-btn:hover {
            background: rgba(37, 99, 235, 1);
        }
        
        /* Transactions table edit button - removed */
        /* .transactions-table th:last-child,
        .transactions-table td:last-child {
            text-align: center;
        } */
        
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="dashboard-active">
    <section class="user-dashboard" id="user-dashboard">
        <div class="dashboard-sidebar">
            <div class="sidebar-profile">
                <div class="sidebar-profile-image-container" id="admin-profile-picture-container" style="position: relative; cursor: pointer; width: 80px; height: 80px; margin: 0 auto;">
                    <img src="" alt="Profile Picture" class="sidebar-profile-image" id="admin-profile-picture-img" style="display: none; width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #ffffff; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);" />
                    <div class="profile-picture-placeholder" id="admin-profile-picture-placeholder" style="width: 80px; height: 80px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 2rem; border: 3px solid #ffffff; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                        <span>ðŸ‘¤</span>
                    </div>
                    <div class="profile-picture-upload-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; font-size: 0.75rem; text-align: center; padding: 0.5rem; cursor: pointer;">
                        Change Photo
                    </div>
                </div>
                <input type="file" id="admin-profile-picture-input" accept="image/*" style="display: none;" />
                <div class="sidebar-profile-name">Admin</div>
            </div>
            <nav class="sidebar-navigation">
                <a href="#" class="sidebar-nav-item active">
                    <span>Dashboard</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Portfolio</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Transactions</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Market News</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Reports</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Consultations</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Emails</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Learning</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Users</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <a href="index.html" class="sidebar-footer-item">
                    <span>Return to Home</span>
                </a>
                <a href="login.html" class="sidebar-footer-item" id="logout-btn">
                    <span>Logout</span>
                </a>
            </div>
        </div>
        <div class="dashboard-content">
            <!-- Dashboard View -->
            <div class="dashboard-view" id="dashboard-view" style="display: block;">
                <div class="dashboard-widgets-grid">
                    <!-- Crude Oil Price - Top Left -->
                    <div class="dashboard-widget dashboard-widget-oil" style="grid-column: 1; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Crude Oil Price</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="tradingview-widget-container-dashboard">
                                <div class="tradingview-widget-container__widget"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                                {
                                    "symbol": "USOIL",
                                    "width": "100%",
                                    "height": "160",
                                    "locale": "en",
                                    "dateRange": "1D",
                                    "colorTheme": "light",
                                    "trendLineColor": "rgba(37, 99, 235, 1)",
                                    "underLineColor": "rgba(37, 99, 235, 0.3)",
                                    "isTransparent": false,
                                    "autosize": true,
                                    "largeChartUrl": ""
                                }
                                </script>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Balance - Top Right Row 1 -->
                    <div class="dashboard-widget" style="grid-column: 2; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Current Balance</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="dashboard-main-metric" id="dashboard-current-balance">â‚¬287,450</div>
                            <div class="dashboard-sub-metric">Capital Invested: â‚¬230,000</div>
                        </div>
                    </div>
                    
                    <!-- Total Gain - Top Right Row 1 -->
                    <div class="dashboard-widget" style="grid-column: 3; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Total Gain</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="dashboard-main-metric dashboard-metric-positive" id="dashboard-total-gain">+24.98%</div>
                            <div class="dashboard-sub-metric">â‚¬57,450 profit</div>
                        </div>
                    </div>
                    
                    <!-- 12 Month Projection - Top Right Row 1 -->
                    <div class="dashboard-widget" style="grid-column: 4; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">12 Month Projection</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="dashboard-projection-value" id="dashboard-projection-value">â‚¬355,108</div>
                            <div class="dashboard-sub-metric">Projected ending capital</div>
                        </div>
                    </div>
                    
                    <!-- Members & Revenue - Second Row -->
                    <div class="dashboard-widget" style="grid-column: 1; grid-row: 2;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Members & Revenue</h3>
                        </div>
                        <div class="dashboard-widget-content" style="padding-bottom: calc(1rem);">
                            <div style="margin-bottom: 1.5rem;">
                                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Current Monthly Revenue</div>
                                <div style="font-size: 2rem; font-weight: 700; color: #10b981;" id="monthly-revenue">â‚¬0</div>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">Total Revenue</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #2563eb;" id="total-revenue">â‚¬0</div>
                            </div>
                            
                            <div style="border-top: 1px solid #e5e7eb; padding-top: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                    <span style="font-size: 0.875rem; color: #6b7280; font-weight: 500;">Total</span>
                                    <span style="font-size: 1rem; font-weight: 700; color: #1f2937;" id="total-members-count">0</span>
                                </div>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.75rem; font-weight: 500;">Members by Plan</div>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 0.875rem; color: #374151;">Basic</span>
                                        <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;" id="basic-members">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 0.875rem; color: #374151;">Premium</span>
                                        <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;" id="premium-members">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 0.875rem; color: #374151;">Plus</span>
                                        <span style="font-size: 0.875rem; font-weight: 600; color: #1f2937;" id="plus-members">0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.75rem; font-weight: 500;">Monthly Members</div>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 0.875rem; color: #374151;">Members In</span>
                                        <span style="font-size: 0.875rem; font-weight: 600; color: #10b981;" id="monthly-members-in">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-size: 0.875rem; color: #374151;">Members Out</span>
                                        <span style="font-size: 0.875rem; font-weight: 600; color: #ef4444;" id="monthly-members-out">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Group Chat - Second Row, spans 3 columns -->
                    <div class="dashboard-widget dashboard-widget-wide" style="grid-column: 2 / 5; grid-row: 2 / 4; display: flex; flex-direction: column;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Group Chat</h3>
                        </div>
                        <div class="dashboard-widget-content" style="flex: 1; display: flex; flex-direction: column; padding: 0;">
                            <!-- Chat Messages Area -->
                            <div id="chat-messages-container" style="flex: 1; overflow-y: auto; padding: 1rem; background: #f9fafb; min-height: 400px; display: flex; flex-direction: column; gap: 0.75rem;">
                                <!-- Messages will be populated by JavaScript -->
                            </div>
                            
                            <!-- Chat Input Area -->
                            <div style="border-top: 1px solid #e5e7eb; padding: 1rem; background: white;">
                                <div id="chat-images-preview" style="display: none; margin-bottom: 0.75rem; padding: 0.75rem; background: #f3f4f6; border-radius: 6px;">
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;" id="chat-images-preview-container">
                                        <!-- Image previews will be shown here -->
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                                    <textarea id="chat-message-input" placeholder="Type your message..." style="flex: 1; padding: 0.5rem 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; resize: none; font-family: inherit; font-size: 0.875rem; min-height: 40px; max-height: 80px;" rows="1"></textarea>
                                    <label for="chat-image-input" style="cursor: pointer; padding: 0.5rem 1rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; color: #374151; display: inline-flex; align-items: center; gap: 0.5rem; white-space: nowrap; height: fit-content;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                            <polyline points="21 15 16 10 5 21"></polyline>
                                        </svg>
                                        Add Image
                                    </label>
                                    <input type="file" id="chat-image-input" accept="image/*" multiple style="display: none;">
                                    <button type="button" id="chat-send-btn" class="admin-btn-save" style="padding: 0.5rem 1.5rem; font-size: 0.875rem; white-space: nowrap; height: fit-content;">
                                        Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio View -->
            <div class="portfolio-view" id="portfolio-view" style="display: none;">
                <div class="portfolio-balance-cards">
                    <div class="balance-card">
                        <div class="balance-label">Total Fund Capital Invested</div>
                        <div class="balance-amount" id="capital-invested">â‚¬8,500,000</div>
                    </div>
                    <div class="balance-card">
                        <div class="balance-label">Total Fund Balance</div>
                        <div class="balance-amount" id="current-balance">â‚¬10,625,000</div>
                    </div>
                    <div class="balance-card">
                        <div class="balance-label">Total Fund Gain</div>
                        <div class="balance-amount balance-amount-gain" id="total-gain">+25.00%</div>
                    </div>
                    <div class="balance-card">
                        <div class="balance-label">12 Month Projection</div>
                        <div class="balance-amount" id="portfolio-projection">â‚¬13,150,000</div>
                    </div>
                </div>
                <div class="portfolio-chart-container">
                    <div class="portfolio-chart-card">
                        <h3 class="portfolio-chart-title">Fund Performance & Projection</h3>
                        <div class="chart-wrapper">
                            <canvas id="portfolio-chart" width="800" height="400"></canvas>
                            <div id="chart-tooltip" class="chart-tooltip" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transactions View -->
            <div class="transactions-view" id="transactions-view" style="display: none;">
                <div class="transactions-table-container">
                    <table class="transactions-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Starting Balance</th>
                                <th>Ending Balance</th>
                                <th>Growth %</th>
                                <th>Deposits</th>
                                <th>Withdrawals</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table-body">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Transaction Edit Modal -->
            <div id="transaction-edit-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title">Edit Transaction</h2>
                        <form id="transaction-edit-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="edit-starting-balance">Starting Balance (â‚¬)</label>
                                <input type="number" id="edit-starting-balance" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-ending-balance">Ending Balance (â‚¬)</label>
                                <input type="number" id="edit-ending-balance" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-growth">Growth %</label>
                                <input type="number" id="edit-growth" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-deposits">Deposits (â‚¬)</label>
                                <input type="number" id="edit-deposits" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-deposit-date">Deposit Date</label>
                                <input type="date" id="edit-deposit-date" class="admin-form-input">
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-withdrawals">Withdrawals (â‚¬)</label>
                                <input type="number" id="edit-withdrawals" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-withdrawal-date">Withdrawal Date</label>
                                <input type="date" id="edit-withdrawal-date" class="admin-form-input">
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="cancel-transaction-edit">Cancel</button>
                                <button type="submit" class="admin-btn-save">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Investor Edit/Add Modal -->
            <div id="investor-edit-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container" style="max-width: 600px;">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="investor-modal-title">Edit Investor</h2>
                        <form id="investor-edit-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="edit-investor-name">Full Name</label>
                                <input type="text" id="edit-investor-name" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-email">Email Address</label>
                                <input type="email" id="edit-investor-email" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-phone">Phone Number</label>
                                <input type="tel" id="edit-investor-phone" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-account">Account Number</label>
                                <input type="text" id="edit-investor-account" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-initial">Initial Investment (â‚¬)</label>
                                <input type="number" id="edit-investor-initial" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-balance">Current Balance (â‚¬)</label>
                                <input type="number" id="edit-investor-balance" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-status">Account Status</label>
                                <select id="edit-investor-status" class="admin-form-input" required>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Suspended">Suspended</option>
                                </select>
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="cancel-investor-edit">Cancel</button>
                                <button type="submit" class="admin-btn-save">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Reports View -->
            <div class="reports-view" id="reports-view" style="display: none;">
                <div class="reports-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <!-- Message Sending Widget -->
                    <div class="reports-widget" style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                        <h2 style="margin-top: 0; margin-bottom: 1.5rem; font-size: 1.5rem; color: #1f2937;">Send Message to Community</h2>
                        <form id="send-message-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="message-title">Title</label>
                                <input type="text" id="message-title" class="admin-form-input" placeholder="Enter message title" required>
                        </div>
                            
                            <div class="admin-form-group">
                                <label for="message-subheading">Subheading</label>
                                <input type="text" id="message-subheading" class="admin-form-input" placeholder="Enter subheading (optional)">
            </div>

                            <div class="admin-form-group">
                                <label for="message-link">Link to Share</label>
                                <input type="url" id="message-link" class="admin-form-input" placeholder="https://example.com">
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">Optional: Add a link to share with the community</span>
                            </div>
                            
                            <div class="admin-form-group">
                                <label for="message-text">Message</label>
                                <textarea id="message-text" class="admin-form-input" rows="8" placeholder="Write your message here..." required style="resize: vertical;"></textarea>
                            </div>
                            
                            
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="clear-message-form">Clear</button>
                                <button type="submit" class="admin-btn-save">Send Message</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Weekly Report Upload Widget -->
                    <div class="reports-widget" style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                        <h2 style="margin-top: 0; margin-bottom: 1.5rem; font-size: 1.5rem; color: #1f2937;">Upload Weekly Report</h2>
                        <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1.5rem;">Upload a new weekly report. It will replace the previous one.</p>
                        <form id="weekly-report-upload-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="weekly-report-author">Author</label>
                                <input type="text" id="weekly-report-author" class="admin-form-input" placeholder="Enter author name" required>
                            </div>
                            
                            <div class="admin-form-group">
                                <label for="weekly-report-date-published">Date Published</label>
                                <input type="date" id="weekly-report-date-published" class="admin-form-input" required>
                            </div>
                            
                            <div class="admin-form-group">
                                <label for="weekly-report-file">Upload Weekly PDF Report</label>
                                <input type="file" id="weekly-report-file" class="admin-form-input" accept=".pdf" required>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">Maximum file size: 10MB</span>
                                <div id="weekly-file-selected-info" style="margin-top: 0.5rem; padding: 0.75rem; background: #eff6ff; border-radius: 6px; display: none;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                        </svg>
                                        <div>
                                            <div style="font-weight: 600; color: #1e40af;" id="weekly-selected-file-name"></div>
                                            <div style="font-size: 0.75rem; color: #374151;" id="weekly-selected-file-size"></div>
                                        </div>
                                        <button type="button" id="weekly-remove-file-btn" style="margin-left: auto; background: #ef4444; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; font-size: 0.75rem; cursor: pointer;">Remove</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="weekly-upload-progress" style="margin-top: 0.5rem; padding: 0.75rem; background: #eff6ff; border-radius: 6px; display: none;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                    </svg>
                                    <span style="font-size: 0.875rem; color: #374151;">Uploading...</span>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: #2563eb;" id="weekly-upload-progress-percent">0%</span>
                                </div>
                                <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                                    <div id="weekly-upload-progress-bar" style="height: 100%; background: #2563eb; width: 0%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                            
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="clear-weekly-report-form">Clear</button>
                                <button type="submit" class="admin-btn-save">Upload Weekly Report</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Admin Reports Widget Modal -->
            <div id="admin-reports-widget-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container" style="max-width: 800px;">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title">Admin Account Reports</h2>
                        <div class="reports-widgets-container" id="admin-reports-widgets-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                            <!-- Report widgets will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Report Upload Modal -->
            <div id="report-upload-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="report-upload-modal-title">Upload Monthly Report</h2>
                        <form id="report-upload-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="report-month">Month</label>
                                <select id="report-month" class="admin-form-input" required>
                                    <option value="">Select Month</option>
                                    <option value="January">January</option>
                                    <option value="February">February</option>
                                    <option value="March">March</option>
                                    <option value="April">April</option>
                                    <option value="May">May</option>
                                    <option value="June">June</option>
                                    <option value="July">July</option>
                                    <option value="August">August</option>
                                    <option value="September">September</option>
                                    <option value="October">October</option>
                                    <option value="November">November</option>
                                    <option value="December">December</option>
                                </select>
                            </div>
                            <div class="admin-form-group">
                                <label for="report-year">Year</label>
                                <input type="number" id="report-year" class="admin-form-input" min="2020" max="2030" value="2024" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="report-file">Upload PDF Report</label>
                                <input type="file" id="report-file" class="admin-form-input" accept=".pdf" required>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">Maximum file size: 10MB</span>
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="cancel-report-upload">Cancel</button>
                                <button type="submit" class="admin-btn-save">Upload Report</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Report Viewer Modal (for Admin) -->
            <div id="report-viewer-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container" style="max-width: 90%; max-height: 90vh;">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content" style="padding: 0;">
                        <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                            <h2 class="admin-modal-title" id="report-viewer-title" style="margin: 0;">Monthly Report</h2>
                        </div>
                        <div style="padding: 2rem; overflow: auto; max-height: calc(90vh - 100px);">
                            <iframe id="report-viewer-iframe" style="width: 100%; height: 800px; border: 1px solid #e5e7eb; border-radius: 6px;"></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Consultations View -->
            <div class="consultations-view" id="consultations-view" style="display: none;">
                <div class="consultations-content">
                    <!-- Filter Tabs -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid #e5e7eb;">
                        <button class="consultation-tab-btn active" data-filter="all" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 600; cursor: pointer; font-size: 1rem;">All Consultations</button>
                        <button class="consultation-tab-btn" data-filter="pending" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; font-size: 1rem;">Pending</button>
                        <button class="consultation-tab-btn" data-filter="done" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 500; cursor: pointer; font-size: 1rem;">Done</button>
                    </div>

                    <!-- Consultations List -->
                    <div class="consultations-list-container">
                        <div class="consultations-grid" id="consultations-grid">
                            <!-- Consultations will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Send Email Section (for Pending Consultations) -->
                    <div class="send-email-section" id="send-email-section" style="display: none; background: white; padding: 2rem; border-radius: 8px; margin-top: 2rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                        <h3 style="margin-top: 0; margin-bottom: 1.5rem; font-size: 1.25rem; color: #1f2937;">Send Google Meet Link</h3>
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Selected Consultation:</label>
                            <div id="selected-consultation-info" style="padding: 1rem; background: #f3f4f6; border-radius: 6px; color: #6b7280;">
                                No consultation selected
                            </div>
                        </div>
                        <form id="send-email-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="google-meet-link">Google Meet Link</label>
                                <input type="url" id="google-meet-link" class="admin-form-input" placeholder="https://meet.google.com/xxx-xxxx-xxx" required>
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="cancel-send-email">Clear Selection</button>
                                <button type="submit" class="admin-btn-save">Send Google Meet Link</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Emails View -->
            <div class="emails-view" id="emails-view" style="display: none;">
                <div class="emails-content">
                    <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                        <h2 style="margin-top: 0; margin-bottom: 2rem; font-size: 1.5rem; color: #1f2937;">Send Email</h2>
                        
                        <form id="send-email-to-user-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="email-recipient">Email Recipient(s)</label>
                                <div id="email-recipients-container">
                                    <div class="email-recipient-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="email" class="admin-form-input email-recipient-input" placeholder="Enter email address" required style="flex: 1;">
                                        <button type="button" class="remove-email-btn" style="display: none; background: #fca5a5; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Remove</button>
                                    </div>
                                </div>
                                <button type="button" id="add-email-recipient-btn" style="margin-top: 0.5rem; padding: 0.5rem 1rem; font-size: 0.875rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">+ Add Another Email</button>
                            </div>

                            <div class="admin-form-group">
                                <label for="email-subject-input">Email Subject</label>
                                <input type="text" id="email-subject-input" class="admin-form-input" placeholder="Enter email subject" required>
                            </div>

                            <div class="admin-form-group">
                                <label for="email-message-input">Email Message</label>
                                <textarea id="email-message-input" class="admin-form-input" rows="10" placeholder="Write your email message here..." required></textarea>
                            </div>

                            <div class="admin-form-group">
                                <label for="email-attachment">Attach PDF (Optional)</label>
                                <input type="file" id="email-attachment" class="admin-form-input" accept=".pdf" multiple>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">You can attach multiple PDF files</span>
                                <div id="attachment-list" style="margin-top: 0.5rem;">
                                    <!-- Selected attachments will be listed here -->
                                </div>
                            </div>

                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="clear-email-form">Clear Form</button>
                                <button type="submit" class="admin-btn-save">Send Email</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Learning View -->
            <div class="learning-view" id="learning-view" style="display: none;">
                <div class="learning-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="margin: 0; font-size: 1.5rem; color: #1f2937;">Learning Modules</h2>
                        <button class="admin-btn-save" id="add-module-btn" style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                            + Add New Module
                        </button>
                    </div>
                    
                    <div class="modules-grid" id="modules-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                        <!-- Modules will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Users View -->
            <div class="users-view" id="users-view" style="display: none;">
                <div class="users-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="margin: 0; font-size: 1.5rem; color: #1f2937;">User Management</h2>
                        <button class="admin-btn-save" id="add-user-btn" style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                            + Add New User
                        </button>
                    </div>
                    
                    <div class="users-table-container" style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); overflow: hidden;">
                        <table class="users-table" id="users-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Type</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Username</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Email</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Tier</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Status</th>
                                    <th style="padding: 1rem; text-align: left; font-weight: 600; color: #374151; font-size: 0.875rem;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Users will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Module View/Edit Modal -->
            <div id="module-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="module-modal-title">Add New Module</h2>
                        <form id="module-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="module-title">Module Title</label>
                                <input type="text" id="module-title" class="admin-form-input" placeholder="Enter module title" required>
                            </div>
                            
                            <div class="admin-form-group">
                                <label for="module-description">Description</label>
                                <textarea id="module-description" class="admin-form-input" rows="3" placeholder="Enter module description"></textarea>
                            </div>
                            
                            <div class="admin-form-group">
                                <label for="module-image">Module Image</label>
                                <input type="file" id="module-image" class="admin-form-input" accept="image/*">
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">Upload an image for this module</span>
                                <div id="module-image-preview" style="margin-top: 1rem; display: none;">
                                    <img id="module-image-preview-img" src="" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                </div>
                            </div>
                            
                            <div class="admin-form-group">
                                <label for="module-content">Content</label>
                                <textarea id="module-content" class="admin-form-input" rows="10" placeholder="Enter module content (supports HTML)"></textarea>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">You can use HTML tags for formatting</span>
                            </div>
                            
                            <div class="admin-form-group">
                                <label for="module-additional-images">Additional Images</label>
                                <input type="file" id="module-additional-images" class="admin-form-input" accept="image/*" multiple>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">You can select multiple images</span>
                                <div id="module-additional-images-preview" style="margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
                                    <!-- Additional images preview will be shown here -->
                                </div>
                            </div>
                            
                            <div class="admin-form-group">
                                <label for="module-order">Display Order</label>
                                <input type="number" id="module-order" class="admin-form-input" min="0" value="0" placeholder="Lower numbers appear first">
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">Modules are sorted by this number (ascending)</span>
                            </div>
                            
                            <div class="admin-form-group">
                                <label>
                                    <input type="checkbox" id="module-published" style="margin-right: 0.5rem;">
                                    Published (visible to users)
                                </label>
                            </div>
                            
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="cancel-module">Cancel</button>
                                <button type="submit" class="admin-btn-save">Save Module</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- User View/Edit Modal -->
            <div id="user-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="user-modal-title">Add New User</h2>
                        <form id="user-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="user-username">Username</label>
                                <input type="text" id="user-username" class="admin-form-input" placeholder="Enter username" required>
                            </div>
                            
                            <div class="admin-form-group">
                                <label for="user-email">Email</label>
                                <input type="email" id="user-email" class="admin-form-input" placeholder="Enter email address" required>
                            </div>
                            
                            <div class="admin-form-group">
                                <label for="user-password">Password</label>
                                <input type="password" id="user-password" class="admin-form-input" placeholder="Enter password" required>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;" id="user-password-hint">Leave blank to keep current password when editing</span>
                            </div>
                            
                            <div class="admin-form-group">
                                <label for="user-role">Tier</label>
                                <select id="user-role" class="admin-form-input" required>
                                    <option value="">Select a tier</option>
                                    <option value="tier1">Tier 1</option>
                                    <option value="tier2">Tier 2</option>
                                    <option value="tier3">Tier 3</option>
                                </select>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">
                                    Tier 1: Learning + Community (view only). Tier 2: + Weekly Reports. Tier 3: + Training.
                                </span>
                            </div>
                            
                            <div class="admin-form-group">
                                <label for="user-firstname">First Name</label>
                                <input type="text" id="user-firstname" class="admin-form-input" placeholder="Enter first name">
                            </div>
                            
                            <div class="admin-form-group">
                                <label for="user-lastname">Last Name</label>
                                <input type="text" id="user-lastname" class="admin-form-input" placeholder="Enter last name">
                            </div>
                            
                            <div class="admin-form-group">
                                <label for="user-phone">Phone Number</label>
                                <input type="tel" id="user-phone" class="admin-form-input" placeholder="Enter phone number">
                            </div>
                            
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="cancel-user">Cancel</button>
                                <button type="submit" class="admin-btn-save">Save User</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Market News View -->
            <div class="market-news-view" id="market-news-view" style="display: none;">
                <div class="market-news-content">
                    <div class="market-news-chart-section">
                        <div class="tradingview-widget-container market-news-chart">
                            <div id="market_news_chart"></div>
                            <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
                            <script type="text/javascript">
                                new TradingView.widget({
                                    "width": "100%",
                                    "height": 500,
                                    "symbol": "USOIL",
                                    "interval": "60",
                                    "theme": "light",
                                    "style": "1",
                                    "timezone": "Europe/Amsterdam",
                                    "locale": "en",
                                    "allow_symbol_change": true,
                                    "withdateranges": true,
                                    "container_id": "market_news_chart",
                                    "hide_volume": true,
                                    "studies": [
                                        {
                                            "id": "MASimple@tv-basicstudies",
                                            "inputs": {
                                                "length": 200,
                                                "source": "close",
                                                "maType": "EMA"
                                            },
                                            "overrides": {
                                                "plot.color": "#FFFF00",
                                                "plot.linewidth": 3
                                            }
                                        }
                                    ]
                                });
                            </script>
                        </div>
                    </div>
                    <div class="market-news-articles-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="margin: 0; font-size: 1.25rem; color: #1f2937;">Market News Articles</h3>
                            <button onclick="openAddNewsModal()" class="admin-btn-add" style="background: #10b981; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 500;">
                                + Add New Article
                            </button>
                        </div>
                        <div class="news-grid" id="news-grid">
                            <!-- News articles will be loaded from Firestore -->
                        </div>
                    </div>
            </div>

            <!-- News Edit Modal -->
            <div id="news-edit-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="news-modal-title">Edit News Article</h2>
                        <form id="news-edit-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="edit-news-title">Title</label>
                                <input type="text" id="edit-news-title" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-news-link">Link URL</label>
                                <input type="url" id="edit-news-link" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-news-image">Image URL</label>
                                <input type="url" id="edit-news-image" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-news-order">Display Order</label>
                                <input type="number" id="edit-news-order" class="admin-form-input" min="0" value="0">
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">Lower numbers appear first</span>
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="delete-news-btn" onclick="deleteNews()" style="background: #dc2626; color: white; font-size: 0.875rem; padding: 0.5rem 1rem; display: none;">Delete</button>
                                <button type="button" class="admin-btn-cancel" id="cancel-news-edit" onclick="closeNewsEditModal()">Cancel</button>
                                <button type="submit" class="admin-btn-save">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <script src="script.js"></script>
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
    
    <!-- Learning Users Firestore Service -->
    <script src="firestore-service-learning-users.js"></script>
    
    <!-- Community Messages Firestore Service -->
    <script src="firestore-service-community-messages.js"></script>
    
    <!-- Weekly Reports Firestore Service -->
    <script src="firestore-service-weekly-reports.js"></script>
    
    <!-- Firebase Configuration and Service -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD9DvEzXUxUppgsp71H5d3abPKWkjkea6A",
            authDomain: "opessocius-17ab9.firebaseapp.com",
            projectId: "opessocius-17ab9",
            storageBucket: "opessocius-17ab9.firebasestorage.app",
            messagingSenderId: "835445796116",
            appId: "1:835445796116:web:71b8595886ecb53e612601",
            measurementId: "G-44CX9N3E3J"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Initialize services
        const db = firebase.firestore();
        const auth = firebase.auth();
        const analytics = firebase.analytics();
        const storage = firebase.storage();
        
        // Make available globally
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseAnalytics = analytics;
        window.firebaseStorage = storage;
        window.firebase = firebase;
        
        // Firestore Service Functions (using CDN API) - Shared collections for consultations and market news
        window.firestoreService = {
            // Consultations Functions
            CONSULTATIONS_COLLECTION: 'consultations',
            
            // Get all consultations
            getAllConsultations: async function() {
                try {
                    const snapshot = await db.collection(this.CONSULTATIONS_COLLECTION)
                        .orderBy('createdAt', 'desc')
                        .get();
                    const consultations = [];
                    snapshot.forEach((doc) => {
                        consultations.push({ id: doc.id, ...doc.data() });
                    });
                    return consultations;
                } catch (error) {
                    console.error('Error getting consultations:', error);
                    throw error;
                }
            },
            
            // Update consultation status
            updateConsultationStatus: async function(consultationId, status) {
                try {
                    await db.collection(this.CONSULTATIONS_COLLECTION)
                        .doc(consultationId)
                        .update({
                            status: status,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                } catch (error) {
                    console.error('Error updating consultation status:', error);
                    throw error;
                }
            },
            
            // Market News Functions
            NEWS_COLLECTION: 'marketNews',
            
            // Create news article
            createNews: async function(newsData) {
                try {
                    const newsDoc = {
                        title: newsData.title,
                        link: newsData.link,
                        image: newsData.image,
                        order: newsData.order || 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    const docRef = await db.collection(this.NEWS_COLLECTION).add(newsDoc);
                    return docRef.id;
                } catch (error) {
                    console.error('Error creating news:', error);
                    throw error;
                }
            },
            
            // Update news article
            updateNews: async function(newsId, newsData) {
                try {
                    const updateData = {
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    if (newsData.title !== undefined) updateData.title = newsData.title;
                    if (newsData.link !== undefined) updateData.link = newsData.link;
                    if (newsData.image !== undefined) updateData.image = newsData.image;
                    if (newsData.order !== undefined) updateData.order = newsData.order;
                    await db.collection(this.NEWS_COLLECTION).doc(newsId).update(updateData);
                } catch (error) {
                    console.error('Error updating news:', error);
                    throw error;
                }
            },
            
            // Delete news article
            deleteNews: async function(newsId) {
                try {
                    await db.collection(this.NEWS_COLLECTION).doc(newsId).delete();
                } catch (error) {
                    console.error('Error deleting news:', error);
                    throw error;
                }
            },
            
            // Get all news articles
            getAllNews: async function() {
                try {
                    const snapshot = await db.collection(this.NEWS_COLLECTION)
                        .orderBy('order', 'asc')
                        .orderBy('createdAt', 'desc')
                        .get();
                    const news = [];
                    snapshot.forEach((doc) => {
                        news.push({ id: doc.id, ...doc.data() });
                    });
                    return news;
                } catch (error) {
                    console.error('Error getting news:', error);
                    // If orderBy fails (no index), try without order
                    try {
                        const snapshot = await db.collection(this.NEWS_COLLECTION)
                            .orderBy('createdAt', 'desc')
                            .get();
                        const news = [];
                        snapshot.forEach((doc) => {
                            news.push({ id: doc.id, ...doc.data() });
                        });
                        // Sort by order manually
                        news.sort((a, b) => (a.order || 0) - (b.order || 0));
                        return news;
                    } catch (fallbackError) {
                        console.error('Error getting news (fallback):', fallbackError);
                        throw fallbackError;
                    }
                }
            }
        };
        
        // Dispatch event when services are ready
        window.dispatchEvent(new CustomEvent('firestoreReady'));
        
        console.log('Firebase and Firestore services loaded from CDN');
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Store transaction data globally
            let transactionData = [];
            
            // Admin Fund Performance Firestore Functions
            const ADMIN_FUND_PERFORMANCE_COLLECTION = 'adminFundPerformance';
            
            // Load admin fund performance from Firestore
            async function loadAdminFundPerformance() {
                try {
                    const snapshot = await db.collection(ADMIN_FUND_PERFORMANCE_COLLECTION)
                        .orderBy('year', 'asc')
                        .orderBy('monthIndex', 'asc')
                        .get();
                    
                    const performanceData = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        performanceData.push({
                            id: doc.id,
                            month: data.month,
                            year: data.year,
                            starting: data.startingBalance,
                            ending: data.endingBalance,
                            growth: data.growth,
                            deposits: data.deposits || 0,
                            withdrawals: data.withdrawals || 0,
                            depositDate: data.depositDate ? data.depositDate.toDate().toISOString().split('T')[0] : null,
                            withdrawalDate: data.withdrawalDate ? data.withdrawalDate.toDate().toISOString().split('T')[0] : null
                        });
                    });
                    
                    return performanceData;
                } catch (error) {
                    console.error('Error loading admin fund performance:', error);
                    // If ordering fails, load all and sort in JavaScript
                    try {
                        const snapshot = await db.collection(ADMIN_FUND_PERFORMANCE_COLLECTION).get();
                        const performanceData = [];
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            performanceData.push({
                                id: doc.id,
                                month: data.month,
                                year: data.year,
                                starting: data.startingBalance,
                                ending: data.endingBalance,
                                growth: data.growth,
                                deposits: data.deposits || 0,
                                withdrawals: data.withdrawals || 0,
                                depositDate: data.depositDate ? data.depositDate.toDate().toISOString().split('T')[0] : null,
                                withdrawalDate: data.withdrawalDate ? data.withdrawalDate.toDate().toISOString().split('T')[0] : null
                            });
                        });
                        
                        // Sort in JavaScript
                        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                        performanceData.sort((a, b) => {
                            const yearDiff = a.year - b.year;
                            if (yearDiff !== 0) return yearDiff;
                            return months.indexOf(a.month) - months.indexOf(b.month);
                        });
                        
                        return performanceData;
                    } catch (fallbackError) {
                        console.error('Error in fallback load:', fallbackError);
                        return [];
                    }
                }
            }
            
            // Transactions Table Population
            async function populateTransactionsTable() {
                const tableBody = document.getElementById('transactions-table-body');
                if (!tableBody) return Promise.resolve();

                // Load from Firestore
                try {
                    transactionData = await loadAdminFundPerformance();
                    
                    // If no data exists, initialize with empty array (no default data)
                    if (transactionData.length === 0) {
                        transactionData = [];
                    }
                } catch (error) {
                    console.error('Error loading transactions:', error);
                    transactionData = [];
                }

                tableBody.innerHTML = '';

                if (transactionData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="6" style="text-align: center; padding: 2rem; color: #6b7280;">No performance data available.</td>';
                    tableBody.appendChild(row);
                } else {
                    transactionData.forEach((data, index) => {
                        const startingBalance = data.starting;
                        const endingBalance = data.ending;
                        const growth = data.growth;
                        const growthValue = parseFloat(growth);
                        const monthYear = `${data.month} ${data.year}`;
                        
                        const row = document.createElement('tr');
                        row.setAttribute('data-index', index);
                        row.setAttribute('data-id', data.id || '');
                        
                        // Format dates
                        const depositDisplay = data.deposits > 0 && data.depositDate 
                            ? `â‚¬${data.deposits.toLocaleString('en-US')}<br><span class="transaction-date">${formatDate(data.depositDate)}</span>`
                            : data.deposits > 0 ? `â‚¬${data.deposits.toLocaleString('en-US')}` : '-';
                        
                        const withdrawalDisplay = data.withdrawals > 0 && data.withdrawalDate 
                            ? `â‚¬${data.withdrawals.toLocaleString('en-US')}<br><span class="transaction-date">${formatDate(data.withdrawalDate)}</span>`
                            : data.withdrawals > 0 ? `â‚¬${data.withdrawals.toLocaleString('en-US')}` : '-';

                        const finalBalance = endingBalance - (data.withdrawals || 0);
                        
                        row.innerHTML = `
                            <td>${monthYear}</td>
                            <td>â‚¬${startingBalance.toLocaleString('en-US')}</td>
                            <td>â‚¬${finalBalance.toLocaleString('en-US')}</td>
                            <td class="${growthValue >= 0 ? 'growth-positive' : 'growth-negative'}">${growthValue >= 0 ? '+' : ''}${growth.toFixed(2)}%</td>
                            <td class="transaction-cell">${depositDisplay}</td>
                            <td class="transaction-cell">${withdrawalDisplay}</td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                }
            }
            
            // Load transactions on initial page load to populate dashboard metrics
            await populateTransactionsTable();
            updateDashboardMetrics();
            
            // Navigation handling
            const navItems = document.querySelectorAll('.sidebar-nav-item');
            const dashboardView = document.getElementById('dashboard-view');
            const portfolioView = document.getElementById('portfolio-view');
            const transactionsView = document.getElementById('transactions-view');

            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Get text from span element
                    const span = this.querySelector('span');
                    const navText = span ? span.textContent.trim() : this.textContent.trim();
                    
                    // Remove active class from all items
                    navItems.forEach(nav => nav.classList.remove('active'));
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Get all views
                    const marketNewsView = document.getElementById('market-news-view');
                    const reportsView = document.getElementById('reports-view');
                    const consultationsView = document.getElementById('consultations-view');
                    const emailsView = document.getElementById('emails-view');
                    const learningView = document.getElementById('learning-view');
                    const usersView = document.getElementById('users-view');
                    
                    // Hide all views
                    if (dashboardView) dashboardView.style.display = 'none';
                    if (portfolioView) portfolioView.style.display = 'none';
                    if (transactionsView) transactionsView.style.display = 'none';
                    if (marketNewsView) marketNewsView.style.display = 'none';
                    if (reportsView) reportsView.style.display = 'none';
                    if (consultationsView) consultationsView.style.display = 'none';
                    if (emailsView) emailsView.style.display = 'none';
                    if (learningView) learningView.style.display = 'none';
                    if (usersView) usersView.style.display = 'none';
                    
                    // Show selected view
                    if (navText === 'Dashboard' && dashboardView) {
                        dashboardView.style.display = 'block';
                        // Load transactions first, then update dashboard metrics
                        populateTransactionsTable().then(() => {
                            updateDashboardMetrics();
                            loadChatMessages();
                            loadMembersAndRevenue();
                        }).catch(() => {
                            // If load fails, still try to load other data
                            updateDashboardMetrics();
                            loadChatMessages();
                            loadMembersAndRevenue();
                        });
                    } else if (navText === 'Portfolio' && portfolioView) {
                        portfolioView.style.display = 'block';
                        // Load transactions first, then update metrics and chart
                        populateTransactionsTable().then(() => {
                            updatePortfolioMetrics();
                            setTimeout(function() {
                                drawPortfolioChart();
                                calculateProjectionValue();
                            }, 100);
                        }).catch(() => {
                            // If load fails, still try to draw chart with existing data
                            updatePortfolioMetrics();
                            setTimeout(function() {
                                drawPortfolioChart();
                                calculateProjectionValue();
                            }, 100);
                        });
                    } else if (navText === 'Transactions' && transactionsView) {
                        transactionsView.style.display = 'block';
                        populateTransactionsTable();
                    } else if (navText === 'Market News' && marketNewsView) {
                        marketNewsView.style.display = 'block';
                        loadMarketNews();
                    } else if (navText === 'Reports' && reportsView) {
                        reportsView.style.display = 'block';
                    } else if (navText === 'Consultations' && consultationsView) {
                        consultationsView.style.display = 'block';
                        loadConsultationsList();
                    } else if (navText === 'Emails' && emailsView) {
                        emailsView.style.display = 'block';
                    } else if (navText === 'Learning' && learningView) {
                        learningView.style.display = 'block';
                        loadModulesList();
                    } else if (navText === 'Users' && usersView) {
                        usersView.style.display = 'block';
                        loadUsersList();
                    }
                });
            });

            // Portfolio Chart Function
            let chartDataPoints = [];
            
            function drawPortfolioChart() {
                const canvas = document.getElementById('portfolio-chart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const container = canvas.parentElement;
                const width = container ? container.clientWidth - 64 : 800;
                const height = 480;
                
                // Set canvas size
                canvas.width = width;
                canvas.height = height;
                
                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                
                // Chart configuration
                const padding = { top: 40, right: 40, bottom: 60, left: 80 };
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;
                
                // Get historical data from transactionData
                let historicalData = [];
                let initialInvestment = 0;
                
                if (transactionData && transactionData.length > 0) {
                    // Use actual transaction data - show final balance (ending balance - withdrawals)
                    initialInvestment = transactionData[0].starting;
                    
                    // Calculate final balance for each entry: ending balance - withdrawals
                    historicalData = transactionData.map(entry => {
                        const finalBalance = entry.ending - (entry.withdrawals || 0);
                        return finalBalance;
                    });
                } else {
                    // Default fallback data
                    initialInvestment = 8500000;
                    historicalData = [
                        8500000, 8700000, 8800000, 8950000, 9100000, 9250000, 9400000, 9550000, 9750000, 9950000, 10150000, 10350000
                    ];
                }
                
                // Calculate projection data based on average growth
                let projectionData = [];
                const lastHistoricalValue = historicalData[historicalData.length - 1];
                
                if (transactionData && transactionData.length > 1) {
                    // Calculate average monthly growth rate
                    let totalGrowth = 0;
                    let growthCount = 0;
                    transactionData.forEach(entry => {
                        if (entry.growth && entry.growth !== 0) {
                            totalGrowth += entry.growth;
                            growthCount++;
                        }
                    });
                    
                    const avgMonthlyGrowth = growthCount > 0 ? (totalGrowth / growthCount) / 100 : 0.02;
                    
                    // Project 12 months forward
                    let projectionValue = lastHistoricalValue;
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * (1 + avgMonthlyGrowth);
                        projectionData.push(projectionValue);
                    }
                } else {
                    // Default projection (2% monthly growth)
                    let projectionValue = lastHistoricalValue;
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * 1.02;
                        projectionData.push(projectionValue);
                    }
                }
                
                // Month labels for chart
                const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const totalMonths = historicalData.length + projectionData.length;
                const months = [];
                
                // Generate month labels based on actual data
                if (transactionData && transactionData.length > 0) {
                    // Only add transaction months (one label per transaction entry)
                    transactionData.forEach((entry) => {
                        const monthAbbr = entry.month.substring(0, 3);
                        const monthIndex = monthLabels.indexOf(monthAbbr);
                        if (monthIndex >= 0) {
                            months.push(monthLabels[monthIndex]);
                        } else {
                            months.push(monthAbbr);
                        }
                    });
                    
                    // Add projection months (12 months forward from last transaction)
                    const lastTransactionMonth = transactionData[transactionData.length - 1].month.substring(0, 3);
                    const lastMonthIndex = monthLabels.indexOf(lastTransactionMonth);
                    let currentMonthIndex = (lastMonthIndex + 1) % 12; // Start from next month
                    for (let i = 0; i < 12; i++) {
                        months.push(monthLabels[currentMonthIndex]);
                        currentMonthIndex = (currentMonthIndex + 1) % 12;
                    }
                } else {
                    // Default labels
                    months.push(...monthLabels, ...monthLabels);
                }
                
                // Combine data
                const allData = [...historicalData, ...projectionData];
                const maxValue = Math.max(...allData) * 1.1;
                const minValue = Math.min(...allData) * 0.9;
                const valueRange = maxValue - minValue;
                
                // Store data points for hover interaction - only for transaction entries
                chartDataPoints = [];
                
                // Historical data points (transaction entries only)
                historicalData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    // Use the growth percentage directly from transactionData - exactly as stored, no calculations
                    // This matches exactly how the transactions table displays it: growth.toFixed(2)
                    // The growth value is stored as a number (e.g., 5.5 for 5.5%), same as in transactions table
                    const growth = transactionData && transactionData[index] ? (transactionData[index].growth || 0) : 0;
                    const growthValue = parseFloat(growth);
                    const growthPercent = growthValue.toFixed(2);
                    chartDataPoints.push({
                        x: x,
                        y: y,
                        value: value,
                        month: months[index] || `M${index + 1}`,
                        growthPercent: growthPercent,
                        growthValue: growthValue, // Store the numeric value for sign calculation
                        isHistorical: true
                    });
                });
                
                // Projection data points
                projectionData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (historicalData.length + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    const growthPercent = ((value - initialInvestment) / initialInvestment * 100).toFixed(2);
                    chartDataPoints.push({
                        x: x,
                        y: y,
                        value: value,
                        month: months[historicalData.length + index] || `P${index + 1}`,
                        growthPercent: growthPercent,
                        isHistorical: false
                    });
                });
                
                // Draw grid lines
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 5; i++) {
                    const y = padding.top + (chartHeight / 5) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding.left, y);
                    ctx.lineTo(width - padding.right, y);
                    ctx.stroke();
                }
                
                // Draw area fill below the line (only historical section with gradient)
                if (historicalData.length > 0) {
                    const gradient = ctx.createLinearGradient(
                        padding.left, 
                        padding.top, 
                        padding.left + (chartWidth / totalMonths) * historicalData.length, 
                        padding.top + chartHeight
                    );
                    gradient.addColorStop(0, 'rgba(37, 99, 235, 0.25)');
                    gradient.addColorStop(1, 'rgba(37, 99, 235, 0.05)');
                    
                    ctx.beginPath();
                    const firstX = padding.left + (chartWidth / totalMonths) / 2;
                    const firstY = padding.top + chartHeight - ((historicalData[0] - minValue) / valueRange) * chartHeight;
                    ctx.moveTo(firstX, height - padding.bottom);
                    ctx.lineTo(firstX, firstY);
                    
                    // Historical area only
                    historicalData.forEach((value, index) => {
                        const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                        const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                        ctx.lineTo(x, y);
                    });
                    
                    // Close at the last historical point
                    const lastHistoricalIndex = historicalData.length - 1;
                    const lastHistoricalX = padding.left + (chartWidth / totalMonths) * lastHistoricalIndex + (chartWidth / totalMonths) / 2;
                    ctx.lineTo(lastHistoricalX, height - padding.bottom);
                    ctx.closePath();
                    ctx.fillStyle = gradient;
                    ctx.fill();
                }
                
                // Draw historical line
                ctx.beginPath();
                ctx.strokeStyle = '#2563eb';
                ctx.lineWidth = 2.5;
                historicalData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Draw projection line (dashed, green, continuing from historical)
                ctx.beginPath();
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 2.5;
                ctx.setLineDash([6, 4]);
                projectionData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (historicalData.length + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        // Connect to last historical point
                        const lastHistIndex = historicalData.length - 1;
                        const lastHistX = padding.left + (chartWidth / totalMonths) * lastHistIndex + (chartWidth / totalMonths) / 2;
                        const lastHistY = padding.top + chartHeight - ((historicalData[lastHistIndex] - minValue) / valueRange) * chartHeight;
                        ctx.moveTo(lastHistX, lastHistY);
                    }
                    ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw historical data points
                historicalData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = '#2563eb';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                });
                
                // Draw projection data points
                projectionData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (historicalData.length + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = '#10b981';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                });
                
                // Draw Y-axis labels
                ctx.fillStyle = '#6b7280';
                ctx.font = '12px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                for (let i = 0; i <= 5; i++) {
                    const value = minValue + (valueRange / 5) * (5 - i);
                    const y = padding.top + (chartHeight / 5) * i;
                    const formattedValue = 'â‚¬' + (value / 1000).toFixed(0) + 'k';
                    ctx.fillText(formattedValue, padding.left - 10, y);
                }
                
                // Draw X-axis labels
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                const labelInterval = Math.max(1, Math.floor(totalMonths / 12)); // Show approximately 12 labels
                for (let i = 0; i < totalMonths; i += labelInterval) {
                    const x = padding.left + (chartWidth / totalMonths) * i + (chartWidth / totalMonths) / 2;
                    if (months[i]) {
                        ctx.fillText(months[i], x, height - padding.bottom + 10);
                    }
                }
            }
            
            // Add hover tooltip functionality
            function setupChartHover() {
                const canvas = document.getElementById('portfolio-chart');
                const tooltip = document.getElementById('chart-tooltip');
                if (!canvas || !tooltip) return;
                
                canvas.addEventListener('mousemove', function(e) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Find nearest data point
                    let nearestPoint = null;
                    let minDistance = Infinity;
                    
                    chartDataPoints.forEach(point => {
                        const distance = Math.sqrt(Math.pow(x - point.x, 2) + Math.pow(y - point.y, 2));
                        if (distance < 30 && distance < minDistance) {
                            minDistance = distance;
                            nearestPoint = point;
                        }
                    });
                    
                    if (nearestPoint) {
                        const formattedValue = 'â‚¬' + nearestPoint.value.toLocaleString('en-US');
                        // Match the exact format from transactions table: ${growthValue >= 0 ? '+' : ''}${growth.toFixed(2)}%
                        const growthValue = nearestPoint.growthValue !== undefined ? nearestPoint.growthValue : parseFloat(nearestPoint.growthPercent);
                        const growthSign = growthValue >= 0 ? '+' : '';
                        const growthDisplay = growthValue.toFixed(2);
                        tooltip.innerHTML = `
                            <div class="tooltip-balance">${formattedValue}</div>
                            <div class="tooltip-growth">${growthSign}${growthDisplay}%</div>
                        `;
                        tooltip.style.display = 'block';
                        tooltip.style.left = (nearestPoint.x + 10) + 'px';
                        tooltip.style.top = (nearestPoint.y - 40) + 'px';
                    } else {
                        tooltip.style.display = 'none';
                    }
                });
                
                canvas.addEventListener('mouseleave', function() {
                    if (tooltip) tooltip.style.display = 'none';
                });
            }
            
            // Setup hover after chart is drawn
            setTimeout(setupChartHover, 150);
            
            // Transaction Edit Modal Functions
            function openTransactionEditModal(index) {
                const data = transactionData[index];
                const modal = document.getElementById('transaction-edit-modal');
                document.getElementById('edit-starting-balance').value = data.starting;
                document.getElementById('edit-ending-balance').value = data.ending;
                document.getElementById('edit-growth').value = data.growth;
                document.getElementById('edit-deposits').value = data.deposits || 0;
                document.getElementById('edit-withdrawals').value = data.withdrawals || 0;
                document.getElementById('edit-deposit-date').value = data.depositDate || '';
                document.getElementById('edit-withdrawal-date').value = data.withdrawalDate || '';
                modal.setAttribute('data-edit-index', index);
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function closeTransactionEditModal() {
                const modal = document.getElementById('transaction-edit-modal');
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
            
            // Transaction edit form handler
            const transactionEditForm = document.getElementById('transaction-edit-form');
            if (transactionEditForm) {
                transactionEditForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const index = parseInt(document.getElementById('transaction-edit-modal').getAttribute('data-edit-index'));
                    transactionData[index].starting = parseFloat(document.getElementById('edit-starting-balance').value);
                    transactionData[index].ending = parseFloat(document.getElementById('edit-ending-balance').value);
                    transactionData[index].growth = parseFloat(document.getElementById('edit-growth').value);
                    transactionData[index].deposits = parseFloat(document.getElementById('edit-deposits').value);
                    transactionData[index].withdrawals = parseFloat(document.getElementById('edit-withdrawals').value);
                    transactionData[index].depositDate = document.getElementById('edit-deposit-date').value || null;
                    transactionData[index].withdrawalDate = document.getElementById('edit-withdrawal-date').value || null;
                    populateTransactionsTable();
                    closeTransactionEditModal();
                });
            }
            
            // Close transaction modal handlers
            const transactionModal = document.getElementById('transaction-edit-modal');
            if (transactionModal) {
                transactionModal.querySelector('.admin-modal-close')?.addEventListener('click', closeTransactionEditModal);
                transactionModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeTransactionEditModal);
                document.getElementById('cancel-transaction-edit')?.addEventListener('click', closeTransactionEditModal);
            }
            

            function formatDate(dateString) {
                const date = new Date(dateString);
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            }


            // Reports Section - Store reports data
            let reportsData = {}; // Structure: { userId: { '2024-01': { file: File, month: 'January', year: 2024 }, ... } }
            
            function loadReportsUsersList() {
                const container = document.getElementById('reports-users-grid');
                if (!container) return;
                
                container.innerHTML = '';
                
                // Get all users (admin + investors)
                const allUsers = [...usersData];
                
                allUsers.forEach(user => {
                    const card = document.createElement('div');
                    card.className = 'investor-card';
                    const userReports = reportsData[user.id] || {};
                    const reportCount = Object.keys(userReports).length;
                    const isAdmin = user.type === 'admin';
                    
                    // Get list of reports for this user
                    const reportsList = Object.values(userReports).sort((a, b) => {
                        const yearDiff = a.year - b.year;
                        if (yearDiff !== 0) return yearDiff;
                        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                        return months.indexOf(a.month) - months.indexOf(b.month);
                    });
                    
                    let reportsHtml = '';
                    if (reportsList.length > 0) {
                        reportsHtml = '<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;"><strong style="font-size: 0.875rem; color: #374151;">Uploaded Reports:</strong><ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem; font-size: 0.875rem; color: #6b7280;">';
                        reportsList.forEach(report => {
                            reportsHtml += `<li>${report.month} ${report.year}</li>`;
                        });
                        reportsHtml += '</ul></div>';
                    }
                    
                    card.innerHTML = `
                        <div class="investor-card-header">
                            <h3>${user.name}</h3>
                            <span class="investor-status investor-status-${user.status.toLowerCase()}">${user.type === 'admin' ? 'Admin' : user.status}</span>
                        </div>
                        <div class="investor-card-body">
                            <p><strong>Email:</strong> ${user.email}</p>
                            <p><strong>Account:</strong> ${user.account}</p>
                            <p><strong>Reports Uploaded:</strong> ${reportCount}</p>
                            ${reportsHtml}
                        </div>
                        <div class="investor-card-actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="admin-btn-save" onclick="openReportUploadModal(${user.id})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Upload Report</button>
                            ${isAdmin ? `<button class="admin-btn-view" onclick="viewAdminReportsWidget()">View Admin Reports</button>` : ''}
                            ${isAdmin && reportCount > 0 ? `<button class="admin-btn-view" onclick="viewAdminReport(${user.id})">View Report</button>` : ''}
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
            
            function openReportUploadModal(userId) {
                const user = usersData.find(u => u.id === userId);
                if (!user) return;
                
                const modal = document.getElementById('report-upload-modal');
                document.getElementById('report-upload-modal-title').textContent = `Upload Report - ${user.name}`;
                document.getElementById('report-upload-form').reset();
                modal.setAttribute('data-user-id', userId);
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function closeReportUploadModal() {
                document.getElementById('report-upload-modal').style.display = 'none';
                document.body.style.overflow = '';
            }
            
            function viewAdminReport(userId) {
                const userReports = reportsData[userId] || {};
                const reportsList = Object.values(userReports).sort((a, b) => {
                    const yearDiff = a.year - b.year;
                    if (yearDiff !== 0) return yearDiff;
                    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                    return months.indexOf(a.month) - months.indexOf(b.month);
                });
                
                if (reportsList.length === 0) {
                    alert('No reports available for this account.');
                    return;
                }
                
                // Get the most recent report
                const latestReport = reportsList[reportsList.length - 1];
                const modal = document.getElementById('report-viewer-modal');
                const iframe = document.getElementById('report-viewer-iframe');
                const title = document.getElementById('report-viewer-title');
                
                title.textContent = `Monthly Report - ${latestReport.month} ${latestReport.year}`;
                
                // Create object URL from the file
                if (latestReport.file) {
                    const fileUrl = URL.createObjectURL(latestReport.file);
                    iframe.src = fileUrl;
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                } else if (latestReport.url) {
                    // If stored as URL (for demo purposes)
                    iframe.src = latestReport.url;
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                }
            }
            
            function closeReportViewerModal() {
                const modal = document.getElementById('report-viewer-modal');
                const iframe = document.getElementById('report-viewer-iframe');
                iframe.src = '';
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
            
            window.openReportUploadModal = openReportUploadModal;
            window.viewAdminReport = viewAdminReport;
            
            // Report upload form handler
            const reportUploadForm = document.getElementById('report-upload-form');
            if (reportUploadForm) {
                reportUploadForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const userId = parseInt(document.getElementById('report-upload-modal').getAttribute('data-user-id'));
                    const month = document.getElementById('report-month').value;
                    const year = parseInt(document.getElementById('report-year').value);
                    const fileInput = document.getElementById('report-file');
                    const file = fileInput.files[0];
                    
                    if (!file) {
                        alert('Please select a PDF file to upload.');
                        return;
                    }
                    
                    if (file.size > 10 * 1024 * 1024) {
                        alert('File size exceeds 10MB limit.');
                        return;
                    }
                    
                    if (!file.type.includes('pdf')) {
                        alert('Please upload a PDF file.');
                        return;
                    }
                    
                    if (!reportsData[userId]) {
                        reportsData[userId] = {};
                    }
                    
                    const reportKey = `${year}-${String(month).padStart(2, '0')}`;
                    reportsData[userId][reportKey] = {
                        file: file,
                        month: month,
                        year: year,
                        fileName: file.name,
                        uploadDate: new Date().toISOString()
                    };
                    
                    loadReportsUsersList();
                    closeReportUploadModal();
                    alert(`Report for ${month} ${year} uploaded successfully!`);
                });
            }
            
            // Admin Reports Widget Functions
            function viewAdminReportsWidget() {
                const adminId = 1; // Admin user ID
                const adminReports = reportsData[adminId] || {};
                const reportsList = Object.values(adminReports).sort((a, b) => {
                    const yearDiff = a.year - b.year;
                    if (yearDiff !== 0) return yearDiff;
                    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                    return months.indexOf(a.month) - months.indexOf(b.month);
                });
                
                const container = document.getElementById('admin-reports-widgets-container');
                const modal = document.getElementById('admin-reports-widget-modal');
                
                if (reportsList.length === 0) {
                    container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 2rem;">No reports uploaded yet.</p>';
                } else {
                    container.innerHTML = '';
                    reportsList.forEach(report => {
                        const widget = document.createElement('div');
                        widget.className = 'report-widget';
                        widget.style.cssText = 'background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);';
                        widget.innerHTML = `
                            <div style="margin-bottom: 1rem;">
                                <h4 style="margin: 0; font-size: 1.1rem; color: #1f2937;">${report.month} ${report.year}</h4>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #6b7280;">${report.fileName || 'Report.pdf'}</p>
                            </div>
                            <button class="admin-btn-save" onclick="downloadAdminReport(${adminId}, '${report.month}', ${report.year})" style="width: 100%;">
                                Download
                            </button>
                        `;
                        container.appendChild(widget);
                    });
                }
                
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function closeAdminReportsWidget() {
                document.getElementById('admin-reports-widget-modal').style.display = 'none';
                document.body.style.overflow = '';
            }
            
            function downloadAdminReport(userId, month, year) {
                const reportKey = `${year}-${String(month).padStart(2, '0')}`;
                const report = reportsData[userId]?.[reportKey];
                if (report && report.file) {
                    const url = URL.createObjectURL(report.file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = report.fileName || `Report_${month}_${year}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            }
            
            window.downloadAdminReport = downloadAdminReport;
            
            
            // Close modal handlers for reports
            setTimeout(function() {
                const reportUploadModal = document.getElementById('report-upload-modal');
                if (reportUploadModal) {
                    reportUploadModal.querySelector('.admin-modal-close')?.addEventListener('click', closeReportUploadModal);
                    reportUploadModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeReportUploadModal);
                    document.getElementById('cancel-report-upload')?.addEventListener('click', closeReportUploadModal);
                }
                
                const reportViewerModal = document.getElementById('report-viewer-modal');
                if (reportViewerModal) {
                    reportViewerModal.querySelector('.admin-modal-close')?.addEventListener('click', closeReportViewerModal);
                    reportViewerModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeReportViewerModal);
                }
                
                const adminReportsWidgetModal = document.getElementById('admin-reports-widget-modal');
                if (adminReportsWidgetModal) {
                    adminReportsWidgetModal.querySelector('.admin-modal-close')?.addEventListener('click', closeAdminReportsWidget);
                    adminReportsWidgetModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeAdminReportsWidget);
                }
            }, 100);
            
            // Group Chat Section
            let chatMessages = [
                {
                    id: 1,
                    sender: 'Admin',
                    message: 'Welcome to the group chat! Feel free to ask questions and share insights.',
                    images: [],
                    timestamp: new Date(Date.now() - 3600000).toISOString() // 1 hour ago
                },
                {
                    id: 2,
                    sender: 'John Investor',
                    message: 'Thanks! Looking forward to learning more about the market trends.',
                    images: [],
                    timestamp: new Date(Date.now() - 3300000).toISOString() // 55 minutes ago
                }
            ];
            
            function loadChatMessages() {
                const container = document.getElementById('chat-messages-container');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (chatMessages.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No messages yet. Start the conversation!</p>';
                    return;
                }
                
                chatMessages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.style.display = 'flex';
                    messageDiv.style.flexDirection = 'column';
                    messageDiv.style.gap = '0.25rem';
                    messageDiv.style.maxWidth = '80%';
                    messageDiv.style.marginLeft = msg.sender === 'Admin' ? 'auto' : '0';
                    
                    const senderName = document.createElement('div');
                    senderName.style.fontSize = '0.75rem';
                    senderName.style.fontWeight = '600';
                    senderName.style.color = msg.sender === 'Admin' ? '#2563eb' : '#6b7280';
                    senderName.textContent = msg.sender;
                    
                    const messageBubble = document.createElement('div');
                    messageBubble.style.padding = '0.75rem 1rem';
                    messageBubble.style.borderRadius = '12px';
                    messageBubble.style.background = msg.sender === 'Admin' ? '#2563eb' : 'white';
                    messageBubble.style.color = msg.sender === 'Admin' ? 'white' : '#1f2937';
                    messageBubble.style.border = msg.sender === 'Admin' ? 'none' : '1px solid #e5e7eb';
                    messageBubble.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
                    
                    if (msg.message) {
                        const messageText = document.createElement('div');
                        messageText.style.fontSize = '0.875rem';
                        messageText.style.lineHeight = '1.5';
                        messageText.style.whiteSpace = 'pre-wrap';
                        messageText.style.wordBreak = 'break-word';
                        messageText.textContent = msg.message;
                        messageBubble.appendChild(messageText);
                    }
                    
                    if (msg.images && msg.images.length > 0) {
                        const imagesContainer = document.createElement('div');
                        imagesContainer.style.display = 'grid';
                        imagesContainer.style.gridTemplateColumns = 'repeat(auto-fill, minmax(150px, 1fr))';
                        imagesContainer.style.gap = '0.5rem';
                        imagesContainer.style.marginTop = msg.message ? '0.5rem' : '0';
                        
                        msg.images.forEach(imgUrl => {
                            const img = document.createElement('img');
                            img.src = imgUrl;
                            img.style.width = '100%';
                            img.style.height = '150px';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '6px';
                            img.style.cursor = 'pointer';
                            img.onclick = function() {
                                // Open image in new window/modal
                                window.open(imgUrl, '_blank');
                            };
                            imagesContainer.appendChild(img);
                        });
                        messageBubble.appendChild(imagesContainer);
                    }
                    
                    const timestamp = document.createElement('div');
                    timestamp.style.fontSize = '0.625rem';
                    timestamp.style.color = '#9ca3af';
                    timestamp.style.marginTop = '0.25rem';
                    timestamp.style.textAlign = msg.sender === 'Admin' ? 'right' : 'left';
                    const date = new Date(msg.timestamp);
                    timestamp.textContent = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    
                    messageDiv.appendChild(senderName);
                    messageDiv.appendChild(messageBubble);
                    messageDiv.appendChild(timestamp);
                    container.appendChild(messageDiv);
                });
                
                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            }
            
            // Chat image preview
            let selectedChatImages = [];
            const chatImageInput = document.getElementById('chat-image-input');
            const chatImagesPreview = document.getElementById('chat-images-preview');
            const chatImagesPreviewContainer = document.getElementById('chat-images-preview-container');
            
            if (chatImageInput && chatImagesPreview && chatImagesPreviewContainer) {
                chatImageInput.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files);
                    selectedChatImages = files;
                    chatImagesPreviewContainer.innerHTML = '';
                    
                    if (files.length > 0) {
                        chatImagesPreview.style.display = 'block';
                    } else {
                        chatImagesPreview.style.display = 'none';
                    }
                    
                    files.forEach((file, index) => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const imgDiv = document.createElement('div');
                                imgDiv.style.position = 'relative';
                                imgDiv.style.width = '80px';
                                imgDiv.style.height = '80px';
                                
                                const img = document.createElement('img');
                                img.src = e.target.result;
                                img.style.width = '100%';
                                img.style.height = '100%';
                                img.style.objectFit = 'cover';
                                img.style.borderRadius = '6px';
                                img.style.border = '1px solid #e5e7eb';
                                
                                const removeBtn = document.createElement('button');
                                removeBtn.textContent = 'Ã—';
                                removeBtn.style.position = 'absolute';
                                removeBtn.style.top = '-8px';
                                removeBtn.style.right = '-8px';
                                removeBtn.style.background = '#ef4444';
                                removeBtn.style.color = 'white';
                                removeBtn.style.border = 'none';
                                removeBtn.style.borderRadius = '50%';
                                removeBtn.style.width = '20px';
                                removeBtn.style.height = '20px';
                                removeBtn.style.cursor = 'pointer';
                                removeBtn.style.fontSize = '14px';
                                removeBtn.style.lineHeight = '1';
                                removeBtn.onclick = function() {
                                    selectedChatImages.splice(index, 1);
                                    const dt = new DataTransfer();
                                    selectedChatImages.forEach(f => dt.items.add(f));
                                    chatImageInput.files = dt.files;
                                    if (selectedChatImages.length === 0) {
                                        chatImagesPreview.style.display = 'none';
                                    } else {
                                        chatImageInput.dispatchEvent(new Event('change'));
                                    }
                                };
                                
                                imgDiv.appendChild(img);
                                imgDiv.appendChild(removeBtn);
                                chatImagesPreviewContainer.appendChild(imgDiv);
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                });
            }
            
            // Send chat message
            const chatSendBtn = document.getElementById('chat-send-btn');
            const chatMessageInput = document.getElementById('chat-message-input');
            
            function sendChatMessage() {
                const messageText = chatMessageInput.value.trim();
                const images = selectedChatImages;
                
                if (!messageText && images.length === 0) {
                    return; // Don't send empty messages
                }
                
                // Process images
                const imageUrls = [];
                images.forEach(file => {
                    imageUrls.push(URL.createObjectURL(file));
                });
                
                // Add message
                const newMessage = {
                    id: chatMessages.length + 1,
                    sender: 'Admin',
                    message: messageText,
                    images: imageUrls,
                    timestamp: new Date().toISOString()
                };
                
                chatMessages.push(newMessage);
                loadChatMessages();
                
                // Clear inputs
                chatMessageInput.value = '';
                selectedChatImages = [];
                chatImageInput.value = '';
                chatImagesPreview.style.display = 'none';
                chatImagesPreviewContainer.innerHTML = '';
            }
            
            if (chatSendBtn) {
                chatSendBtn.addEventListener('click', sendChatMessage);
            }
            
            if (chatMessageInput) {
                chatMessageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
            
            // Load chat messages when dashboard is shown
            if (dashboardView) {
                loadChatMessages();
            }
            
            // Members & Revenue Widget
            // Sample members data with plans (in a real app, this would come from a database)
            let membersData = [
                { id: 1, name: 'John Investor', plan: 'Premium', email: 'john.investor@example.com', subscriptionType: 'monthly' },
                { id: 2, name: 'Sarah Smith', plan: 'Plus', email: 'sarah.smith@example.com', subscriptionType: 'annual' },
                { id: 3, name: 'Michael Brown', plan: 'Basic', email: 'michael.brown@example.com', subscriptionType: 'monthly' },
                { id: 4, name: 'Emma Wilson', plan: 'Premium', email: 'emma.wilson@example.com', subscriptionType: 'annual' },
                { id: 5, name: 'David Lee', plan: 'Basic', email: 'david.lee@example.com', subscriptionType: 'annual' },
                { id: 6, name: 'Lisa Anderson', plan: 'Plus', email: 'lisa.anderson@example.com', subscriptionType: 'monthly' },
                { id: 7, name: 'Robert Taylor', plan: 'Basic', email: 'robert.taylor@example.com', subscriptionType: 'monthly' },
                { id: 8, name: 'Maria Garcia', plan: 'Premium', email: 'maria.garcia@example.com', subscriptionType: 'annual' },
                { id: 9, name: 'James Wilson', plan: 'Plus', email: 'james.wilson@example.com', subscriptionType: 'annual' },
                { id: 10, name: 'Sophia Martinez', plan: 'Basic', email: 'sophia.martinez@example.com', subscriptionType: 'annual' }
            ];
            
            // Monthly members tracking (in a real app, this would come from a database)
            let monthlyMembersTracking = {
                membersIn: 12,  // Number of new members this month
                membersOut: 3   // Number of members who left this month
            };
            
            // Store total revenue accumulated over time
            let accumulatedTotalRevenue = 125000; // Starting total revenue
            
            function loadMembersAndRevenue() {
                // Plan pricing (monthly in euros)
                const planPricing = {
                    'Basic': 49,
                    'Premium': 99,
                    'Plus': 199
                };
                
                // Annual pricing (typically 10 months worth for annual subscriptions)
                const annualPlanPricing = {
                    'Basic': 490,
                    'Premium': 990,
                    'Plus': 1990
                };
                
                // Count members by plan
                let basicCount = 0;
                let premiumCount = 0;
                let plusCount = 0;
                let monthlyRevenue = 0;
                let annualMembersCount = 0;
                
                membersData.forEach(member => {
                    const plan = member.plan || 'Basic'; // Default to Basic if no plan specified
                    const subscriptionType = member.subscriptionType || 'monthly';
                    
                    if (plan === 'Basic') {
                        basicCount++;
                        if (subscriptionType === 'annual') {
                            annualMembersCount++;
                            monthlyRevenue += annualPlanPricing.Basic / 12; // Annual revenue divided by 12 for monthly equivalent
                        } else {
                            monthlyRevenue += planPricing.Basic;
                        }
                    } else if (plan === 'Premium') {
                        premiumCount++;
                        if (subscriptionType === 'annual') {
                            annualMembersCount++;
                            monthlyRevenue += annualPlanPricing.Premium / 12;
                        } else {
                            monthlyRevenue += planPricing.Premium;
                        }
                    } else if (plan === 'Plus') {
                        plusCount++;
                        if (subscriptionType === 'annual') {
                            annualMembersCount++;
                            monthlyRevenue += annualPlanPricing.Plus / 12;
                        } else {
                            monthlyRevenue += planPricing.Plus;
                        }
                    } else {
                        // Default to Basic if plan is unknown
                        basicCount++;
                        if (subscriptionType === 'annual') {
                            annualMembersCount++;
                            monthlyRevenue += annualPlanPricing.Basic / 12;
                        } else {
                            monthlyRevenue += planPricing.Basic;
                        }
                    }
                });
                
                // Calculate total revenue (accumulated + current monthly)
                const totalRevenue = accumulatedTotalRevenue + monthlyRevenue;
                
                // Calculate total members count
                const totalMembersCount = basicCount + premiumCount + plusCount;
                
                // Update the UI
                const monthlyRevenueEl = document.getElementById('monthly-revenue');
                const totalRevenueEl = document.getElementById('total-revenue');
                const totalMembersCountEl = document.getElementById('total-members-count');
                const basicMembersEl = document.getElementById('basic-members');
                const premiumMembersEl = document.getElementById('premium-members');
                const plusMembersEl = document.getElementById('plus-members');
                const monthlyMembersInEl = document.getElementById('monthly-members-in');
                const monthlyMembersOutEl = document.getElementById('monthly-members-out');
                
                if (monthlyRevenueEl) monthlyRevenueEl.textContent = 'â‚¬' + Math.round(monthlyRevenue).toLocaleString('en-US');
                if (totalRevenueEl) totalRevenueEl.textContent = 'â‚¬' + Math.round(totalRevenue).toLocaleString('en-US');
                if (totalMembersCountEl) totalMembersCountEl.textContent = totalMembersCount;
                if (basicMembersEl) basicMembersEl.textContent = basicCount;
                if (premiumMembersEl) premiumMembersEl.textContent = premiumCount;
                if (plusMembersEl) plusMembersEl.textContent = plusCount;
                if (monthlyMembersInEl) monthlyMembersInEl.textContent = monthlyMembersTracking.membersIn;
                if (monthlyMembersOutEl) monthlyMembersOutEl.textContent = monthlyMembersTracking.membersOut;
            }
            
            // Investors Payment Tracking
            let investorsPaymentStatus = {}; // Store payment status: { investorId: { paid: true/false } }
            
            function loadInvestorsPaymentList() {
                const container = document.getElementById('investors-payment-list');
                if (!container) return;
                
                // Get all investors (exclude admin)
                const investors = usersData.filter(user => user.type === 'investor');
                
                if (investors.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No investors found.</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                investors.forEach(investor => {
                    // Determine growth rate (2% or 4%) - default to 2% if not specified
                    const growthRate = investor.growthRate || 2; // Can be 2 or 4
                    const growthPercent = growthRate;
                    const paymentAmount = (investor.balance * (growthRate / 100)).toFixed(2);
                    const isPaid = investorsPaymentStatus[investor.id]?.paid || false;
                    
                    const item = document.createElement('div');
                    item.className = 'investor-payment-item';
                    item.style.cssText = 'display: grid; grid-template-columns: 2fr 1.5fr 0.8fr 1.5fr 0.8fr; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #e5e7eb; gap: 1rem;';
                    if (isPaid) {
                        item.style.opacity = '0.6';
                        item.style.textDecoration = 'line-through';
                    }
                    
                    item.innerHTML = `
                        <div style="font-weight: 600; color: #1f2937; font-size: 0.875rem;">${investor.name}</div>
                        <div style="color: #374151; font-size: 0.875rem; text-align: right;">â‚¬${investor.balance.toLocaleString('en-US')}</div>
                        <div style="color: #374151; font-size: 0.875rem; text-align: center;">${growthPercent}%</div>
                        <div style="color: #2563eb; font-weight: 600; font-size: 0.875rem; text-align: right;">â‚¬${parseFloat(paymentAmount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        <div style="text-align: center;">
                            <input type="checkbox" 
                                   class="payment-checkbox" 
                                   data-investor-id="${investor.id}"
                                   ${isPaid ? 'checked' : ''}
                                   style="width: 18px; height: 18px; cursor: pointer;">
                        </div>
                    `;
                    
                    container.appendChild(item);
                });
                
                // Add event listeners to checkboxes
                container.querySelectorAll('.payment-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const investorId = parseInt(this.getAttribute('data-investor-id'));
                        if (!investorsPaymentStatus[investorId]) {
                            investorsPaymentStatus[investorId] = {};
                        }
                        investorsPaymentStatus[investorId].paid = this.checked;
                        loadInvestorsPaymentList(); // Reload to update styling
                    });
                });
            }
            
            // Load investors payment list when dashboard view is shown
            // Use the dashboardView already declared in navigation handler
            if (dashboardView) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            if (dashboardView.style.display !== 'none') {
                                loadInvestorsPaymentList();
                            }
                        }
                    });
                });
                observer.observe(dashboardView, { attributes: true, attributeFilter: ['style'] });
                
                // Also load on initial page load if dashboard is visible
                if (dashboardView.style.display !== 'none') {
                    setTimeout(loadInvestorsPaymentList, 100);
                }
            }
            
            // Dashboard navigation links
            const dashboardNewsLink = document.getElementById('dashboard-news-link');
            
            if (dashboardNewsLink) {
                dashboardNewsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const navItems = document.querySelectorAll('.sidebar-nav-item');
                    navItems.forEach(item => {
                        const span = item.querySelector('span');
                        if (span && span.textContent.trim() === 'Market News') {
                            item.click();
                        }
                    });
                });
            }
            
            // Dashboard report download buttons
            const dashboardReportDownloads = document.querySelectorAll('.dashboard-report-download');
            dashboardReportDownloads.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const month = this.getAttribute('data-month');
                    const monthNames = {
                        '2024-10': 'October_2024',
                        '2024-11': 'November_2024',
                        '2024-12': 'December_2024',
                        '2025-01': 'January_2025'
                    };
                    const filename = `Monthly_Report_${monthNames[month]}.pdf`;
                    alert(`Downloading ${filename}\n\nNote: This is a demo. In production, this would generate and download the actual PDF report.`);
                });
            });
            
            
            // Dashboard news widget click handler
            const dashboardNewsWidget = document.getElementById('dashboard-news-widget');
            if (dashboardNewsWidget) {
                dashboardNewsWidget.style.cursor = 'pointer';
                dashboardNewsWidget.addEventListener('click', function() {
                    const navItems = document.querySelectorAll('.sidebar-nav-item');
                    navItems.forEach(item => {
                        const span = item.querySelector('span');
                        if (span && span.textContent.trim() === 'Market News') {
                            item.click();
                        }
                    });
                });
            }
            
            // Draw dashboard charts when dashboard is shown
            const dashboardViewEl = document.getElementById('dashboard-view');
            if (dashboardViewEl) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            if (dashboardViewEl.style.display !== 'none') {
                                setTimeout(function() {
                                    calculateProjectionValue();
                                }, 100);
                            }
                        }
                    });
                });
                observer.observe(dashboardViewEl, { attributes: true, attributeFilter: ['style'] });
            }
            
            // Update Portfolio Metrics
            function updatePortfolioMetrics() {
                if (!transactionData || transactionData.length === 0) {
                    // Set default values if no data
                    const capitalInvestedEl = document.getElementById('capital-invested');
                    const currentBalanceEl = document.getElementById('current-balance');
                    const totalGainEl = document.getElementById('total-gain');
                    const portfolioProjectionEl = document.getElementById('portfolio-projection');
                    
                    if (capitalInvestedEl) capitalInvestedEl.textContent = 'â‚¬0';
                    if (currentBalanceEl) currentBalanceEl.textContent = 'â‚¬0';
                    if (totalGainEl) totalGainEl.textContent = '0.00%';
                    if (portfolioProjectionEl) portfolioProjectionEl.textContent = 'â‚¬0';
                    return;
                }
                
                // Calculate total capital invested (sum of all deposits)
                let totalCapitalInvested = 0;
                let firstStartingBalance = transactionData[0].starting;
                
                // Sum all deposits
                transactionData.forEach(entry => {
                    totalCapitalInvested += (entry.deposits || 0);
                });
                
                // Initial capital is the first starting balance
                totalCapitalInvested += firstStartingBalance;
                
                // Get latest final balance (ending balance - withdrawals)
                const latestEntry = transactionData[transactionData.length - 1];
                const currentBalance = latestEntry.ending - (latestEntry.withdrawals || 0);
                
                // Calculate total fund gain percentage by summing all transaction growth percentages
                let totalGain = 0;
                transactionData.forEach(entry => {
                    if (entry.growth) {
                        totalGain += entry.growth;
                    }
                });
                
                // Calculate 12-month projection based on average monthly growth
                let projectionValue = currentBalance;
                if (transactionData.length > 1) {
                    // Calculate average monthly growth rate
                    let totalGrowth = 0;
                    let growthCount = 0;
                    transactionData.forEach(entry => {
                        if (entry.growth && entry.growth !== 0) {
                            totalGrowth += entry.growth;
                            growthCount++;
                        }
                    });
                    
                    const avgMonthlyGrowth = growthCount > 0 ? (totalGrowth / growthCount) / 100 : 0.02; // Default to 2% if no growth data
                    
                    // Project 12 months forward with compound growth
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * (1 + avgMonthlyGrowth);
                    }
                } else {
                    // If only one entry, use 2% monthly growth as default
                    const monthlyGrowthRate = 0.02;
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * (1 + monthlyGrowthRate);
                    }
                }
                
                // Update UI elements
                const capitalInvestedEl = document.getElementById('capital-invested');
                const currentBalanceEl = document.getElementById('current-balance');
                const totalGainEl = document.getElementById('total-gain');
                const portfolioProjectionEl = document.getElementById('portfolio-projection');
                
                if (capitalInvestedEl) capitalInvestedEl.textContent = 'â‚¬' + Math.round(totalCapitalInvested).toLocaleString('en-US');
                if (currentBalanceEl) currentBalanceEl.textContent = 'â‚¬' + Math.round(currentBalance).toLocaleString('en-US');
                if (totalGainEl) totalGainEl.textContent = (totalGain >= 0 ? '+' : '') + totalGain.toFixed(2) + '%';
                if (portfolioProjectionEl) portfolioProjectionEl.textContent = 'â‚¬' + Math.round(projectionValue).toLocaleString('en-US');
            }
            
            // Update Dashboard Metrics based on transaction data
            function updateDashboardMetrics() {
                if (!transactionData || transactionData.length === 0) {
                    // Set default values if no data
                    const dashboardBalanceEl = document.getElementById('dashboard-current-balance');
                    const dashboardGainEl = document.getElementById('dashboard-total-gain');
                    const dashboardProjectionEl = document.getElementById('dashboard-projection-value');
                    if (dashboardBalanceEl) dashboardBalanceEl.textContent = 'â‚¬0';
                    if (dashboardGainEl) dashboardGainEl.textContent = '0.00%';
                    if (dashboardProjectionEl) dashboardProjectionEl.textContent = 'â‚¬0';
                    return;
                }
                
                // Get latest final balance (ending balance - withdrawals)
                const latestEntry = transactionData[transactionData.length - 1];
                const currentBalance = latestEntry.ending - (latestEntry.withdrawals || 0);
                
                // Calculate total capital invested
                let totalCapitalInvested = 0;
                const firstStartingBalance = transactionData[0].starting;
                transactionData.forEach(entry => {
                    totalCapitalInvested += (entry.deposits || 0);
                });
                totalCapitalInvested += firstStartingBalance;
                
                // Calculate total fund gain percentage by summing all transaction growth percentages
                let totalGain = 0;
                transactionData.forEach(entry => {
                    if (entry.growth) {
                        totalGain += entry.growth;
                    }
                });
                
                // Calculate 12-month projection
                let projectionValue = currentBalance;
                if (transactionData.length > 1) {
                    let totalGrowth = 0;
                    let growthCount = 0;
                    transactionData.forEach(entry => {
                        if (entry.growth && entry.growth !== 0) {
                            totalGrowth += entry.growth;
                            growthCount++;
                        }
                    });
                    const avgMonthlyGrowth = growthCount > 0 ? (totalGrowth / growthCount) / 100 : 0.02;
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * (1 + avgMonthlyGrowth);
                    }
                } else {
                    const monthlyGrowthRate = 0.02;
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * (1 + monthlyGrowthRate);
                    }
                }
                
                // Update dashboard widgets
                const dashboardBalanceEl = document.getElementById('dashboard-current-balance');
                const dashboardGainEl = document.getElementById('dashboard-total-gain');
                const dashboardProjectionEl = document.getElementById('dashboard-projection-value');
                
                if (dashboardBalanceEl) {
                    dashboardBalanceEl.textContent = 'â‚¬' + Math.round(currentBalance).toLocaleString('en-US');
                }
                if (dashboardGainEl) {
                    dashboardGainEl.textContent = (totalGain >= 0 ? '+' : '') + totalGain.toFixed(2) + '%';
                    // Update profit text
                    const profit = currentBalance - totalCapitalInvested;
                    const profitElement = dashboardGainEl.nextElementSibling;
                    if (profitElement && profitElement.classList.contains('dashboard-sub-metric')) {
                        profitElement.textContent = 'â‚¬' + Math.round(profit).toLocaleString('en-US') + ' profit';
                    }
                }
                
                // Update capital invested text
                const dashboardCapitalEl = document.querySelector('#dashboard-view .dashboard-widget[style*="grid-column: 2"] .dashboard-sub-metric');
                if (dashboardCapitalEl) {
                    dashboardCapitalEl.textContent = 'Capital Invested: â‚¬' + Math.round(totalCapitalInvested).toLocaleString('en-US');
                }
                if (dashboardProjectionEl) {
                    dashboardProjectionEl.textContent = 'â‚¬' + Math.round(projectionValue).toLocaleString('en-US');
                }
            }
            
            // Calculate 12-month projection value (for dashboard)
            function calculateProjectionValue() {
                const projectionValueEl = document.getElementById('dashboard-projection-value');
                
                if (!transactionData || transactionData.length === 0) {
                    if (projectionValueEl) {
                        projectionValueEl.textContent = 'â‚¬0';
                    }
                    return;
                }
                
                // Get latest final balance (ending balance - withdrawals)
                const latestEntry = transactionData[transactionData.length - 1];
                let currentBalance = latestEntry.ending - (latestEntry.withdrawals || 0);
                
                // Calculate average monthly growth rate
                let avgMonthlyGrowth = 0.02; // Default to 2%
                if (transactionData.length > 1) {
                    let totalGrowth = 0;
                    let growthCount = 0;
                    transactionData.forEach(entry => {
                        if (entry.growth && entry.growth !== 0) {
                            totalGrowth += entry.growth;
                            growthCount++;
                        }
                    });
                    avgMonthlyGrowth = growthCount > 0 ? (totalGrowth / growthCount) / 100 : 0.02;
                }
                
                // Calculate 12 months forward
                for (let i = 0; i < 12; i++) {
                    currentBalance = currentBalance * (1 + avgMonthlyGrowth);
                }
                
                // Round to whole number and format
                const projectedValue = Math.round(currentBalance);
                const formattedValue = 'â‚¬' + projectedValue.toLocaleString('en-US');
                
                if (projectionValueEl) {
                    projectionValueEl.textContent = formattedValue;
                }
            }
            
            // Investors List Functions
            let investorsData = [
                { id: 1, name: 'John Investor', email: 'john.investor@example.com', phone: '+34 123 456 789', account: 'ACC-2024-001234', initial: 230000, balance: 287450, status: 'Active' },
                { id: 2, name: 'Sarah Smith', email: 'sarah.smith@example.com', phone: '+34 234 567 890', account: 'ACC-2024-001235', initial: 150000, balance: 187500, status: 'Active' },
                { id: 3, name: 'Michael Brown', email: 'michael.brown@example.com', phone: '+34 345 678 901', account: 'ACC-2024-001236', initial: 500000, balance: 625000, status: 'Active' },
                { id: 4, name: 'Emma Wilson', email: 'emma.wilson@example.com', phone: '+34 456 789 012', account: 'ACC-2024-001237', initial: 100000, balance: 125000, status: 'Active' }
            ];
            
            function openInvestorEditModal(id) {
                const investor = investorsData.find(inv => inv.id === id);
                if (!investor) return;
                
                const modal = document.getElementById('investor-edit-modal');
                document.getElementById('edit-investor-name').value = investor.name;
                document.getElementById('edit-investor-email').value = investor.email;
                document.getElementById('edit-investor-phone').value = investor.phone;
                document.getElementById('edit-investor-account').value = investor.account;
                document.getElementById('edit-investor-initial').value = investor.initial;
                document.getElementById('edit-investor-balance').value = investor.balance;
                document.getElementById('edit-investor-status').value = investor.status;
                modal.setAttribute('data-edit-id', id);
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function closeInvestorEditModal() {
                document.getElementById('investor-edit-modal').style.display = 'none';
                document.body.style.overflow = '';
            }
            
            // Make function global
            window.openInvestorEditModal = openInvestorEditModal;
            
            // Investor edit form handler
            const investorEditForm = document.getElementById('investor-edit-form');
            if (investorEditForm) {
                investorEditForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const id = parseInt(document.getElementById('investor-edit-modal').getAttribute('data-edit-id'));
                    const investor = investorsData.find(inv => inv.id === id);
                    if (investor) {
                        investor.name = document.getElementById('edit-investor-name').value;
                        investor.email = document.getElementById('edit-investor-email').value;
                        investor.phone = document.getElementById('edit-investor-phone').value;
                        investor.account = document.getElementById('edit-investor-account').value;
                        investor.initial = parseFloat(document.getElementById('edit-investor-initial').value);
                        investor.balance = parseFloat(document.getElementById('edit-investor-balance').value);
                        investor.status = document.getElementById('edit-investor-status').value;
                        closeInvestorEditModal();
                    }
                });
            }
            
            // Add investor button
            if (document.getElementById('add-investor-btn')) {
                document.getElementById('add-investor-btn').addEventListener('click', function() {
                    const modal = document.getElementById('investor-edit-modal');
                    document.getElementById('investor-modal-title').textContent = 'Add New Investor';
                    document.getElementById('investor-edit-form').reset();
                    modal.removeAttribute('data-edit-id');
                    modal.setAttribute('data-add-mode', 'true');
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                });
            }
            
            // New Reports Section - Message Sending and Weekly Report Upload
            
            // Store weekly reports data (only one report, replaces previous)
            let weeklyReportData = null; // Object: { author, datePublished, file, fileName, uploadDate }
            
            // Message sending form handler
            const sendMessageForm = document.getElementById('send-message-form');
            if (sendMessageForm) {
                sendMessageForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const title = document.getElementById('message-title').value.trim();
                    const subheading = document.getElementById('message-subheading').value.trim();
                    const link = document.getElementById('message-link').value.trim();
                    const message = document.getElementById('message-text').value.trim();
                    
                    // Validate required fields
                    if (!title || !message) {
                        alert('Please fill in the title and message fields.');
                        return;
                    }
                    
                    // Disable submit button to prevent double submission
                    const submitBtn = sendMessageForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Sending...';
                    
                    try {
                        // Check if Firestore service is available
                        if (!window.communityMessagesFirestoreService) {
                            throw new Error('Community messages service not available. Please refresh the page.');
                        }
                        
                        // Prepare message data
                        const messageData = {
                            title: title,
                            subheading: subheading,
                            link: link,
                            message: message,
                            professor: 'Admin', // You can get this from admin profile if needed
                            professorTitle: 'Administrator' // You can get this from admin profile if needed
                        };
                        
                        // Save message to Firestore
                        const messageId = await window.communityMessagesFirestoreService.saveCommunityMessage(messageData);
                        
                        // Success - show notification (less intrusive than alert)
                        const notification = document.createElement('div');
                        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10000; font-size: 0.875rem; max-width: 400px;';
                        notification.textContent = 'Message sent successfully to community!';
                        document.body.appendChild(notification);
                        
                        // Remove notification after 3 seconds
                        setTimeout(() => {
                            notification.style.transition = 'opacity 0.3s';
                            notification.style.opacity = '0';
                            setTimeout(() => notification.remove(), 300);
                        }, 3000);
                        
                        console.log('Message saved successfully with ID:', messageId);
                        console.log('Message data saved:', {
                            title: title,
                            subheading: subheading,
                            link: link,
                            message: message.substring(0, 50) + '...'
                        });
                        
                        // Reset form
                        sendMessageForm.reset();
                    } catch (error) {
                        console.error('Error sending message:', error);
                        alert('Error sending message: ' + error.message);
                    } finally {
                        // Re-enable submit button
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
            
            // Clear message form button
            const clearMessageForm = document.getElementById('clear-message-form');
            if (clearMessageForm) {
                clearMessageForm.addEventListener('click', function() {
                    const form = document.getElementById('send-message-form');
                    form.reset();
                });
            }
            
            // Weekly report upload form handler
            const weeklyReportUploadForm = document.getElementById('weekly-report-upload-form');
            if (weeklyReportUploadForm) {
                // PDF file preview functionality
                const weeklyReportFileInput = document.getElementById('weekly-report-file');
                const fileSelectedInfo = document.getElementById('weekly-file-selected-info');
                const selectedFileName = document.getElementById('weekly-selected-file-name');
                const selectedFileSize = document.getElementById('weekly-selected-file-size');
                const removeFileBtn = document.getElementById('weekly-remove-file-btn');
                
                if (weeklyReportFileInput && fileSelectedInfo) {
                    weeklyReportFileInput.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            // Check if it's a PDF
                            if (file.type.includes('pdf') || file.name.toLowerCase().endsWith('.pdf')) {
                                // Show preview
                                selectedFileName.textContent = file.name;
                                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                                selectedFileSize.textContent = `${fileSizeMB} MB`;
                                fileSelectedInfo.style.display = 'block';
                            } else {
                                alert('Please select a PDF file.');
                                e.target.value = '';
                                fileSelectedInfo.style.display = 'none';
                            }
                        } else {
                            fileSelectedInfo.style.display = 'none';
                        }
                    });
                    
                    // Remove button functionality
                    if (removeFileBtn) {
                        removeFileBtn.addEventListener('click', function() {
                            weeklyReportFileInput.value = '';
                            fileSelectedInfo.style.display = 'none';
                        });
                    }
                }
                
                weeklyReportUploadForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const author = document.getElementById('weekly-report-author').value.trim();
                    const datePublished = document.getElementById('weekly-report-date-published').value;
                    const fileInput = document.getElementById('weekly-report-file');
                    const file = fileInput.files[0];
                    
                    // Validate required fields
                    if (!author || !datePublished) {
                        alert('Please fill in the author and date published fields.');
                        return;
                    }
                    
                    if (!file) {
                        alert('Please select a PDF file to upload.');
                        return;
                    }
                    
                    if (file.size > 10 * 1024 * 1024) {
                        alert('File size exceeds 10MB limit.');
                        return;
                    }
                    
                    if (!file.type.includes('pdf')) {
                        alert('Please upload a PDF file.');
                        return;
                    }
                    
                    try {
                        // Show loading state
                        const submitBtn = weeklyReportUploadForm.querySelector('button[type="submit"]');
                        const originalText = submitBtn.textContent;
                        const progressDiv = document.getElementById('weekly-upload-progress');
                        const progressBar = document.getElementById('weekly-upload-progress-bar');
                        const progressPercent = document.getElementById('weekly-upload-progress-percent');
                        
                        submitBtn.textContent = 'Uploading...';
                        submitBtn.disabled = true;
                        progressDiv.style.display = 'block';
                        
                        // Check file size - use base64 for files under 900KB to avoid CORS issues
                        if (file.size > 900000) { // 900KB limit (Firestore has 1MB limit, leave buffer)
                            throw new Error('File is too large (' + (file.size / 1024 / 1024).toFixed(2) + 'MB). Maximum size: 900KB. Please configure Firebase Storage rules to allow larger file uploads.');
                        }
                        
                        // Convert file to base64 and store in Firestore
                        progressPercent.textContent = 'Converting file...';
                        progressBar.style.width = '30%';
                        
                        const reader = new FileReader();
                        const fileBase64 = await new Promise((resolve, reject) => {
                            reader.onload = () => {
                                const base64String = reader.result.split(',')[1]; // Remove data:application/pdf;base64, prefix
                                resolve(base64String);
                            };
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                        
                        progressBar.style.width = '60%';
                        progressPercent.textContent = 'Saving to database...';
                        
                        // Store base64 in Firestore
                        const downloadURL = 'data:application/pdf;base64,' + fileBase64;
                        
                        progressBar.style.width = '100%';
                        progressPercent.textContent = '100%';
                        
                        // Check if Firebase is initialized
                        if (!window.firebaseDb) {
                            throw new Error('Firebase database not initialized. Please refresh the page.');
                        }
                        
                        const db = window.firebaseDb;
                        const reportRef = db.collection('weeklyReports').doc('current');
                        
                        // Get existing report to preserve createdAt
                        let existingReport = null;
                        try {
                            const existingDoc = await reportRef.get();
                            if (existingDoc.exists) {
                                existingReport = existingDoc.data();
                            }
                        } catch (error) {
                            console.log('No existing report found (this is fine for first upload)');
                        }
                        
                        // Prepare report document
                        const reportData = {
                            author: author,
                            datePublished: datePublished,
                            pdfFileName: file.name,
                            fileSize: file.size,
                            storageMethod: 'base64',
                            fileBase64: fileBase64,
                            fileUrl: 'base64', // Marker to indicate base64 storage
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // Preserve createdAt if it exists, otherwise create new
                        if (existingReport && existingReport.createdAt) {
                            reportData.createdAt = existingReport.createdAt;
                        } else {
                            reportData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        }
                        
                        // Save to Firestore
                        await reportRef.set(reportData, { merge: true });
                        
                        // Hide progress and show success
                        setTimeout(() => {
                            progressDiv.style.display = 'none';
                            
                            // Reset form
                            weeklyReportUploadForm.reset();
                            fileSelectedInfo.style.display = 'none';
                        }, 500);
                        
                        // Re-enable submit button
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        
                        console.log('Weekly report saved successfully');
                    } catch (error) {
                        console.error('Error uploading weekly report:', error);
                        alert('Error uploading weekly report: ' + error.message);
                        
                        // Re-enable submit button
                        const submitBtn = weeklyReportUploadForm.querySelector('button[type="submit"]');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Upload Weekly Report';
                        
                        // Hide progress
                        const progressDiv = document.getElementById('weekly-upload-progress');
                        if (progressDiv) progressDiv.style.display = 'none';
                    }
                });
            }
            
            // Clear weekly report form button
            const clearWeeklyReportForm = document.getElementById('clear-weekly-report-form');
            if (clearWeeklyReportForm) {
                clearWeeklyReportForm.addEventListener('click', function() {
                    const form = document.getElementById('weekly-report-upload-form');
                    form.reset();
                    const fileSelectedInfo = document.getElementById('weekly-file-selected-info');
                    if (fileSelectedInfo) fileSelectedInfo.style.display = 'none';
                    const progressDiv = document.getElementById('weekly-upload-progress');
                    if (progressDiv) progressDiv.style.display = 'none';
                });
            }
            
            // Load weekly reports list (no longer needed, but keeping function for compatibility)
            function loadWeeklyReportsList() {
                // Function kept for compatibility but no longer displays a list
                // Weekly reports now replace the previous one automatically
                return;
                
                // Old code removed - reports list no longer displayed
                /*
                const container = document.getElementById('weekly-reports-list');
                if (!container) return;
                
                if (weeklyReportsData.length === 0) {
                    container.innerHTML = '<p style="color: #6b7280; font-size: 0.875rem; margin: 0;">No weekly reports uploaded yet.</p>';
                    return;
                }
                
                container.innerHTML = '';
                weeklyReportsData.forEach((report, index) => {
                    const reportItem = document.createElement('div');
                    reportItem.style.display = 'flex';
                    reportItem.style.justifyContent = 'space-between';
                    reportItem.style.alignItems = 'center';
                    reportItem.style.padding = '0.75rem';
                    reportItem.style.background = '#f9fafb';
                    reportItem.style.borderRadius = '6px';
                    reportItem.style.border = '1px solid #e5e7eb';
                    
                    const reportInfo = document.createElement('div');
                    reportInfo.style.flex = '1';
                    
                    const reportTitle = document.createElement('div');
                    reportTitle.style.fontWeight = '600';
                    reportTitle.style.color = '#1f2937';
                    reportTitle.style.marginBottom = '0.25rem';
                    reportTitle.textContent = `${report.week} - ${report.month} ${report.year}`;
                    
                    const reportDetails = document.createElement('div');
                    reportDetails.style.fontSize = '0.875rem';
                    reportDetails.style.color = '#6b7280';
                    reportDetails.textContent = report.fileName;
                    
                    if (report.description) {
                        const reportDesc = document.createElement('div');
                        reportDesc.style.fontSize = '0.75rem';
                        reportDesc.style.color = '#9ca3af';
                        reportDesc.style.marginTop = '0.25rem';
                        reportDesc.textContent = report.description;
                        reportDetails.appendChild(reportDesc);
                    }
                    
                    reportInfo.appendChild(reportTitle);
                    reportInfo.appendChild(reportDetails);
                    
                    const reportActions = document.createElement('div');
                    reportActions.style.display = 'flex';
                    reportActions.style.gap = '0.5rem';
                    
                    const viewBtn = document.createElement('button');
                    viewBtn.textContent = 'View';
                    viewBtn.className = 'admin-btn-view';
                    viewBtn.style.padding = '0.5rem 1rem';
                    viewBtn.style.fontSize = '0.875rem';
                    viewBtn.onclick = function() {
                        viewWeeklyReport(index);
                    };
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'admin-btn-cancel';
                    deleteBtn.style.padding = '0.5rem 1rem';
                    deleteBtn.style.fontSize = '0.875rem';
                    deleteBtn.onclick = function() {
                        if (confirm('Are you sure you want to delete this weekly report?')) {
                            weeklyReportsData.splice(index, 1);
                            loadWeeklyReportsList();
                        }
                    };
                    
                    reportActions.appendChild(viewBtn);
                    reportActions.appendChild(deleteBtn);
                    
                    reportItem.appendChild(reportInfo);
                    reportItem.appendChild(reportActions);
                    container.appendChild(reportItem);
                });
                */
            }
            
            // Learning Modules Section
            let modulesData = [
                {
                    id: 1,
                    title: 'Introduction to Crude Oil Trading',
                    description: 'Learn the fundamentals of crude oil trading, including market basics, key terminology, and trading strategies.',
                    image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=800&h=400&fit=crop',
                    content: '<h3>Understanding Crude Oil Markets</h3><p>Crude oil is one of the most important commodities in the global economy. This module covers:</p><ul><li>Market fundamentals</li><li>Trading terminology</li><li>Price factors</li><li>Risk management</li></ul>',
                    additionalImages: [],
                    order: 1,
                    published: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: 2,
                    title: 'Technical Analysis Fundamentals',
                    description: 'Master the art of technical analysis with charts, indicators, and patterns used by professional traders.',
                    image: 'https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=800&h=400&fit=crop',
                    content: '<h3>Chart Patterns and Indicators</h3><p>Technical analysis is crucial for successful trading. This module teaches:</p><ul><li>Reading price charts</li><li>Common patterns</li><li>Technical indicators</li><li>Entry and exit signals</li></ul>',
                    additionalImages: [],
                    order: 2,
                    published: true,
                    createdAt: new Date().toISOString()
                }
            ];
            
            function loadModulesList() {
                const container = document.getElementById('modules-grid');
                if (!container) return;
                
                container.innerHTML = '';
                
                // Sort modules by order
                const sortedModules = [...modulesData].sort((a, b) => a.order - b.order);
                
                sortedModules.forEach(module => {
                    const moduleCard = document.createElement('div');
                    moduleCard.style.background = 'white';
                    moduleCard.style.borderRadius = '8px';
                    moduleCard.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                    moduleCard.style.overflow = 'hidden';
                    moduleCard.style.display = 'flex';
                    moduleCard.style.flexDirection = 'column';
                    
                    const imageContainer = document.createElement('div');
                    imageContainer.style.width = '100%';
                    imageContainer.style.height = '200px';
                    imageContainer.style.overflow = 'hidden';
                    imageContainer.style.background = '#f3f4f6';
                    
                    const img = document.createElement('img');
                    img.src = module.image || 'https://via.placeholder.com/400x200?text=No+Image';
                    img.alt = module.title;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    
                    imageContainer.appendChild(img);
                    
                    const cardBody = document.createElement('div');
                    cardBody.style.padding = '1.5rem';
                    cardBody.style.flex = '1';
                    cardBody.style.display = 'flex';
                    cardBody.style.flexDirection = 'column';
                    
                    const title = document.createElement('h3');
                    title.textContent = module.title;
                    title.style.margin = '0 0 0.5rem 0';
                    title.style.fontSize = '1.25rem';
                    title.style.color = '#1f2937';
                    title.style.fontWeight = '600';
                    
                    const description = document.createElement('p');
                    description.textContent = module.description || 'No description available.';
                    description.style.margin = '0 0 1rem 0';
                    description.style.color = '#6b7280';
                    description.style.fontSize = '0.875rem';
                    description.style.lineHeight = '1.5';
                    
                    const status = document.createElement('div');
                    status.style.marginBottom = '1rem';
                    const statusBadge = document.createElement('span');
                    statusBadge.textContent = module.published ? 'Published' : 'Draft';
                    statusBadge.style.padding = '0.25rem 0.75rem';
                    statusBadge.style.borderRadius = '12px';
                    statusBadge.style.fontSize = '0.75rem';
                    statusBadge.style.fontWeight = '600';
                    statusBadge.style.background = module.published ? '#d1fae5' : '#fef3c7';
                    statusBadge.style.color = module.published ? '#065f46' : '#92400e';
                    status.appendChild(statusBadge);
                    
                    cardBody.appendChild(title);
                    cardBody.appendChild(description);
                    cardBody.appendChild(status);
                    
                    const cardActions = document.createElement('div');
                    cardActions.style.display = 'flex';
                    cardActions.style.gap = '0.5rem';
                    cardActions.style.marginTop = 'auto';
                    cardActions.style.paddingTop = '1rem';
                    cardActions.style.borderTop = '1px solid #e5e7eb';
                    
                    const viewBtn = document.createElement('button');
                    viewBtn.textContent = 'View';
                    viewBtn.className = 'admin-btn-view';
                    viewBtn.style.padding = '0.5rem 1rem';
                    viewBtn.style.fontSize = '0.875rem';
                    viewBtn.onclick = function() {
                        viewModule(module.id);
                    };
                    
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.className = 'admin-btn-save';
                    editBtn.style.padding = '0.5rem 1rem';
                    editBtn.style.fontSize = '0.875rem';
                    editBtn.onclick = function() {
                        editModule(module.id);
                    };
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'admin-btn-cancel';
                    deleteBtn.style.padding = '0.5rem 1rem';
                    deleteBtn.style.fontSize = '0.875rem';
                    deleteBtn.onclick = function() {
                        if (confirm('Are you sure you want to delete this module?')) {
                            deleteModule(module.id);
                        }
                    };
                    
                    cardActions.appendChild(viewBtn);
                    cardActions.appendChild(editBtn);
                    cardActions.appendChild(deleteBtn);
                    
                    cardBody.appendChild(cardActions);
                    
                    moduleCard.appendChild(imageContainer);
                    moduleCard.appendChild(cardBody);
                    container.appendChild(moduleCard);
                });
            }
            
            function viewModule(moduleId) {
                const module = modulesData.find(m => m.id === moduleId);
                if (!module) return;
                
                // Create a simple view modal
                const modal = document.createElement('div');
                modal.className = 'admin-modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="admin-modal-overlay"></div>
                    <div class="admin-modal-container" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                        <div class="admin-modal-content">
                            <h2 class="admin-modal-title">${module.title}</h2>
                            ${module.image ? `<img src="${module.image}" alt="${module.title}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 6px; margin-bottom: 1.5rem;">` : ''}
                            ${module.description ? `<p style="color: #6b7280; margin-bottom: 1.5rem;">${module.description}</p>` : ''}
                            <div style="border-top: 1px solid #e5e7eb; padding-top: 1.5rem;">
                                ${module.content || '<p>No content available.</p>'}
                            </div>
                            ${module.additionalImages && module.additionalImages.length > 0 ? `
                                <div style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                                    ${module.additionalImages.map(img => `<img src="${img}" alt="Additional image" style="width: 100%; border-radius: 6px;">`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                document.body.style.overflow = 'hidden';
                
                modal.querySelector('.admin-modal-close').addEventListener('click', function() {
                    document.body.removeChild(modal);
                    document.body.style.overflow = '';
                });
                modal.querySelector('.admin-modal-overlay').addEventListener('click', function() {
                    document.body.removeChild(modal);
                    document.body.style.overflow = '';
                });
            }
            
            function editModule(moduleId) {
                const module = modulesData.find(m => m.id === moduleId);
                if (!module) return;
                
                const modal = document.getElementById('module-modal');
                const form = document.getElementById('module-form');
                
                document.getElementById('module-modal-title').textContent = 'Edit Module';
                document.getElementById('module-title').value = module.title;
                document.getElementById('module-description').value = module.description || '';
                document.getElementById('module-content').value = module.content || '';
                document.getElementById('module-order').value = module.order || 0;
                document.getElementById('module-published').checked = module.published || false;
                
                // Show existing image if available
                const imagePreview = document.getElementById('module-image-preview');
                const imagePreviewImg = document.getElementById('module-image-preview-img');
                if (module.image) {
                    imagePreviewImg.src = module.image;
                    imagePreview.style.display = 'block';
                } else {
                    imagePreview.style.display = 'none';
                }
                
                // Show existing additional images
                const additionalImagesPreview = document.getElementById('module-additional-images-preview');
                additionalImagesPreview.innerHTML = '';
                if (module.additionalImages && module.additionalImages.length > 0) {
                    module.additionalImages.forEach(imgUrl => {
                        const imgDiv = document.createElement('div');
                        imgDiv.style.position = 'relative';
                        const img = document.createElement('img');
                        img.src = imgUrl;
                        img.style.width = '100%';
                        img.style.height = '150px';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '6px';
                        img.style.border = '1px solid #e5e7eb';
                        imgDiv.appendChild(img);
                        additionalImagesPreview.appendChild(imgDiv);
                    });
                }
                
                modal.setAttribute('data-edit-id', moduleId);
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function deleteModule(moduleId) {
                modulesData = modulesData.filter(m => m.id !== moduleId);
                loadModulesList();
            }
            
            window.viewModule = viewModule;
            window.editModule = editModule;
            window.deleteModule = deleteModule;
            
            // Add module button
            const addModuleBtn = document.getElementById('add-module-btn');
            if (addModuleBtn) {
                addModuleBtn.addEventListener('click', function() {
                    const modal = document.getElementById('module-modal');
                    const form = document.getElementById('module-form');
                    
                    document.getElementById('module-modal-title').textContent = 'Add New Module';
                    form.reset();
                    document.getElementById('module-order').value = modulesData.length + 1;
                    document.getElementById('module-published').checked = true;
                    document.getElementById('module-image-preview').style.display = 'none';
                    document.getElementById('module-additional-images-preview').innerHTML = '';
                    
                    modal.removeAttribute('data-edit-id');
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                });
            }
            
            // Module image preview
            const moduleImageInput = document.getElementById('module-image');
            if (moduleImageInput) {
                moduleImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const preview = document.getElementById('module-image-preview');
                            const previewImg = document.getElementById('module-image-preview-img');
                            previewImg.src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // Additional images preview
            const moduleAdditionalImagesInput = document.getElementById('module-additional-images');
            if (moduleAdditionalImagesInput) {
                moduleAdditionalImagesInput.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files);
                    const preview = document.getElementById('module-additional-images-preview');
                    preview.innerHTML = '';
                    
                    files.forEach(file => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const imgDiv = document.createElement('div');
                                imgDiv.style.position = 'relative';
                                const img = document.createElement('img');
                                img.src = e.target.result;
                                img.style.width = '100%';
                                img.style.height = '150px';
                                img.style.objectFit = 'cover';
                                img.style.borderRadius = '6px';
                                img.style.border = '1px solid #e5e7eb';
                                imgDiv.appendChild(img);
                                preview.appendChild(imgDiv);
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                });
            }
            
            // Module form handler
            const moduleForm = document.getElementById('module-form');
            if (moduleForm) {
                moduleForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const modal = document.getElementById('module-modal');
                    const isEditMode = modal.hasAttribute('data-edit-id');
                    const editId = isEditMode ? parseInt(modal.getAttribute('data-edit-id')) : null;
                    
                    const title = document.getElementById('module-title').value;
                    const description = document.getElementById('module-description').value;
                    const content = document.getElementById('module-content').value;
                    const order = parseInt(document.getElementById('module-order').value) || 0;
                    const published = document.getElementById('module-published').checked;
                    
                    // Handle main image
                    let imageUrl = '';
                    const imageInput = document.getElementById('module-image');
                    if (imageInput.files && imageInput.files.length > 0) {
                        const file = imageInput.files[0];
                        imageUrl = URL.createObjectURL(file);
                    } else if (isEditMode) {
                        const existingModule = modulesData.find(m => m.id === editId);
                        imageUrl = existingModule ? existingModule.image : '';
                    }
                    
                    // Handle additional images
                    const additionalImages = [];
                    const additionalImagesInput = document.getElementById('module-additional-images');
                    if (additionalImagesInput.files && additionalImagesInput.files.length > 0) {
                        Array.from(additionalImagesInput.files).forEach(file => {
                            if (file.type.startsWith('image/')) {
                                additionalImages.push(URL.createObjectURL(file));
                            }
                        });
                    } else if (isEditMode) {
                        const existingModule = modulesData.find(m => m.id === editId);
                        if (existingModule && existingModule.additionalImages) {
                            additionalImages.push(...existingModule.additionalImages);
                        }
                    }
                    
                    if (isEditMode) {
                        // Update existing module
                        const moduleIndex = modulesData.findIndex(m => m.id === editId);
                        if (moduleIndex !== -1) {
                            modulesData[moduleIndex] = {
                                ...modulesData[moduleIndex],
                                title,
                                description,
                                content,
                                image: imageUrl || modulesData[moduleIndex].image,
                                additionalImages: additionalImages.length > 0 ? additionalImages : modulesData[moduleIndex].additionalImages,
                                order,
                                published
                            };
                        }
                    } else {
                        // Create new module
                        const newId = Math.max(...modulesData.map(m => m.id), 0) + 1;
                        modulesData.push({
                            id: newId,
                            title,
                            description,
                            content,
                            image: imageUrl,
                            additionalImages,
                            order,
                            published,
                            createdAt: new Date().toISOString()
                        });
                    }
                    
                    loadModulesList();
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    form.reset();
                    alert(isEditMode ? 'Module updated successfully!' : 'Module created successfully!');
                });
            }
            
            // Users Management Section
            let usersData = [];
            
            async function loadUsersList() {
                const tbody = document.getElementById('users-table-body');
                if (!tbody) return;
                
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #6b7280;">Loading users...</td></tr>';
                
                try {
                    usersData = [];
                    
                    // Load investors from 'users' collection
                    if (window.firebaseDb) {
                        try {
                            const investorsSnapshot = await window.firebaseDb.collection('users')
                                .orderBy('createdAt', 'desc')
                                .get();
                            
                            investorsSnapshot.forEach((doc) => {
                                const data = doc.data();
                                usersData.push({
                                    id: doc.id,
                                    type: 'investor',
                                    username: data.username || '',
                                    email: data.email || '',
                                    tier: data.tier || 'tier1', // Default tier if not set
                                    active: data.accountStatus === 'Active',
                                    firstname: data.fullName ? data.fullName.split(' ')[0] : '',
                                    lastname: data.fullName ? data.fullName.split(' ').slice(1).join(' ') : '',
                                    phone: data.phone || '',
                                    firestoreData: data
                                });
                            });
                        } catch (error) {
                            console.error('Error loading investors:', error);
                            // Continue loading learning users even if investors fail
                        }
                    }
                    
                    // Load learning users from 'learningUsers' collection
                    if (window.learningUsersFirestoreService) {
                        try {
                            const learningUsers = await window.learningUsersFirestoreService.getAllLearningUsers();
                            learningUsers.forEach((user) => {
                                usersData.push({
                                    id: user.id,
                                    type: 'learning',
                                    username: user.username || '',
                                    email: user.email || '',
                                    tier: user.tier || 'tier1',
                                    active: user.active !== false,
                                    firstname: user.firstName || '',
                                    lastname: user.lastName || '',
                                    phone: user.phone || '',
                                    firestoreData: user
                                });
                            });
                        } catch (error) {
                            console.error('Error loading learning users:', error);
                            // Continue even if learning users fail
                        }
                    }
                } catch (error) {
                    console.error('Error loading users:', error);
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #dc2626;">Error loading users. Please refresh the page.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                
                if (usersData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #6b7280;">No users found.</td></tr>';
                    return;
                }
                
                usersData.forEach(user => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #e5e7eb';
                    
                    // Type
                    const typeCell = document.createElement('td');
                    typeCell.style.padding = '1rem';
                    const typeBadge = document.createElement('span');
                    typeBadge.textContent = user.type === 'investor' ? 'Investor' : 'Learning';
                    typeBadge.style.padding = '0.25rem 0.75rem';
                    typeBadge.style.borderRadius = '12px';
                    typeBadge.style.fontSize = '0.75rem';
                    typeBadge.style.fontWeight = '600';
                    typeBadge.style.background = user.type === 'investor' ? '#fef3c7' : '#dbeafe';
                    typeBadge.style.color = user.type === 'investor' ? '#92400e' : '#1e40af';
                    typeCell.appendChild(typeBadge);
                    row.appendChild(typeCell);
                    
                    // Username
                    const usernameCell = document.createElement('td');
                    usernameCell.style.padding = '1rem';
                    usernameCell.textContent = user.username;
                    usernameCell.style.color = '#1f2937';
                    row.appendChild(usernameCell);
                    
                    // Email
                    const emailCell = document.createElement('td');
                    emailCell.style.padding = '1rem';
                    emailCell.textContent = user.email;
                    emailCell.style.color = '#1f2937';
                    row.appendChild(emailCell);
                    
                    // Tier
                    const tierCell = document.createElement('td');
                    tierCell.style.padding = '1rem';
                    const tierBadge = document.createElement('span');
                    tierBadge.textContent = user.tier.toUpperCase().replace('TIER', 'Tier ');
                    tierBadge.style.padding = '0.25rem 0.75rem';
                    tierBadge.style.borderRadius = '12px';
                    tierBadge.style.fontSize = '0.75rem';
                    tierBadge.style.fontWeight = '600';
                    if (user.tier === 'tier3') {
                        tierBadge.style.background = '#dbeafe';
                        tierBadge.style.color = '#1e40af';
                    } else if (user.tier === 'tier2') {
                        tierBadge.style.background = '#e0e7ff';
                        tierBadge.style.color = '#3730a3';
                    } else {
                        tierBadge.style.background = '#f3f4f6';
                        tierBadge.style.color = '#374151';
                    }
                    tierCell.appendChild(tierBadge);
                    row.appendChild(tierCell);
                    
                    // Status
                    const statusCell = document.createElement('td');
                    statusCell.style.padding = '1rem';
                    const statusBadge = document.createElement('span');
                    statusBadge.textContent = user.active ? 'Active' : 'Inactive';
                    statusBadge.style.padding = '0.25rem 0.75rem';
                    statusBadge.style.borderRadius = '12px';
                    statusBadge.style.fontSize = '0.75rem';
                    statusBadge.style.fontWeight = '600';
                    statusBadge.style.background = user.active ? '#d1fae5' : '#fee2e2';
                    statusBadge.style.color = user.active ? '#065f46' : '#991b1b';
                    statusCell.appendChild(statusBadge);
                    row.appendChild(statusCell);
                    
                    // Actions
                    const actionsCell = document.createElement('td');
                    actionsCell.style.padding = '1rem';
                    const actionsDiv = document.createElement('div');
                    actionsDiv.style.display = 'flex';
                    actionsDiv.style.gap = '0.5rem';
                    
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.className = 'admin-btn-save';
                    editBtn.style.padding = '0.5rem 1rem';
                    editBtn.style.fontSize = '0.875rem';
                    editBtn.onclick = function() {
                        editUser(user.id, user.type);
                    };
                    
                    actionsDiv.appendChild(editBtn);
                    
                    // Only show delete button for learning users
                    if (user.type === 'learning') {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.className = 'admin-btn-cancel';
                        deleteBtn.style.padding = '0.5rem 1rem';
                        deleteBtn.style.fontSize = '0.875rem';
                        deleteBtn.onclick = function() {
                            if (confirm('Are you sure you want to delete this user?')) {
                                deleteUser(user.id, user.type);
                            }
                        };
                        actionsDiv.appendChild(deleteBtn);
                    }
                    
                    actionsCell.appendChild(actionsDiv);
                    row.appendChild(actionsCell);
                    
                    tbody.appendChild(row);
                });
            }
            
            function editUser(userId, userType) {
                const user = usersData.find(u => u.id === userId && u.type === userType);
                if (!user) return;
                
                const modal = document.getElementById('user-modal');
                const form = document.getElementById('user-form');
                const passwordField = document.getElementById('user-password');
                const passwordHint = document.getElementById('user-password-hint');
                
                document.getElementById('user-modal-title').textContent = userType === 'investor' ? 'Edit Investor (Tier Only)' : 'Edit User';
                document.getElementById('user-username').value = user.username;
                document.getElementById('user-email').value = user.email;
                document.getElementById('user-role').value = user.tier;
                document.getElementById('user-firstname').value = user.firstname || '';
                document.getElementById('user-lastname').value = user.lastname || '';
                document.getElementById('user-phone').value = user.phone || '';
                
                // For investors, disable all fields except tier and hide password
                const isInvestor = userType === 'investor';
                document.getElementById('user-username').disabled = isInvestor;
                document.getElementById('user-email').disabled = isInvestor;
                document.getElementById('user-firstname').disabled = isInvestor;
                document.getElementById('user-lastname').disabled = isInvestor;
                document.getElementById('user-phone').disabled = isInvestor;
                
                // Password field handling
                if (isInvestor) {
                    // Hide password field for investors
                    passwordField.style.display = 'none';
                    passwordField.parentElement.style.display = 'none';
                } else {
                    // Show password field for learning users, but make it read-only (view only)
                    passwordField.parentElement.style.display = 'block';
                    passwordField.style.display = 'block';
                    passwordField.type = 'password';
                    passwordField.value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'; // Show dots to indicate password exists
                    passwordField.readOnly = true;
                    passwordField.disabled = false; // Keep enabled for styling
                    passwordField.style.backgroundColor = '#f3f4f6';
                    passwordField.style.cursor = 'not-allowed';
                    passwordField.required = false;
                    passwordHint.textContent = 'Password is hidden for security. Contact system administrator to change password.';
                }
                
                modal.setAttribute('data-edit-id', userId);
                modal.setAttribute('data-edit-type', userType);
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            async function deleteUser(userId, userType) {
                if (userType === 'investor') {
                    alert('Investors cannot be deleted from this portal.');
                    return;
                }
                
                if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    if (window.learningUsersFirestoreService) {
                        await window.learningUsersFirestoreService.deleteLearningUser(userId);
                        await loadUsersList();
                    } else {
                        alert('Firestore service not available. Please refresh the page.');
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('Error deleting user: ' + error.message);
                }
            }
            
            // Add user button
            const addUserBtn = document.getElementById('add-user-btn');
            if (addUserBtn) {
                addUserBtn.addEventListener('click', function() {
                    const modal = document.getElementById('user-modal');
                    const form = document.getElementById('user-form');
                    
                    document.getElementById('user-modal-title').textContent = 'Add New Learning User';
                    form.reset();
                    
                    const passwordField = document.getElementById('user-password');
                    const passwordHint = document.getElementById('user-password-hint');
                    
                    // Show and enable password field for new users
                    passwordField.parentElement.style.display = 'block';
                    passwordField.style.display = 'block';
                    passwordField.type = 'password';
                    passwordField.value = '';
                    passwordField.readOnly = false;
                    passwordField.disabled = false;
                    passwordField.required = true;
                    passwordField.style.backgroundColor = '';
                    passwordField.style.cursor = '';
                    passwordHint.textContent = 'Enter password for new user';
                    
                    // Enable all fields for new user
                    document.getElementById('user-username').disabled = false;
                    document.getElementById('user-email').disabled = false;
                    document.getElementById('user-firstname').disabled = false;
                    document.getElementById('user-lastname').disabled = false;
                    document.getElementById('user-phone').disabled = false;
                    
                    modal.removeAttribute('data-edit-id');
                    modal.removeAttribute('data-edit-type');
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                });
            }
            
            // User modal close handlers
            const userModal = document.getElementById('user-modal');
            if (userModal) {
                const userModalClose = userModal.querySelector('.admin-modal-close');
                const userModalCancel = document.getElementById('cancel-user');
                
                if (userModalClose) {
                    userModalClose.addEventListener('click', function() {
                        userModal.style.display = 'none';
                        document.body.style.overflow = '';
                        // Reset password field state
                        const passwordField = document.getElementById('user-password');
                        if (passwordField) {
                            passwordField.readOnly = false;
                            passwordField.style.backgroundColor = '';
                            passwordField.style.cursor = '';
                        }
                    });
                }
                
                if (userModalCancel) {
                    userModalCancel.addEventListener('click', function() {
                        userModal.style.display = 'none';
                        document.body.style.overflow = '';
                        // Reset password field state
                        const passwordField = document.getElementById('user-password');
                        if (passwordField) {
                            passwordField.readOnly = false;
                            passwordField.style.backgroundColor = '';
                            passwordField.style.cursor = '';
                        }
                    });
                }
                
                userModal.querySelector('.admin-modal-overlay').addEventListener('click', function() {
                    userModal.style.display = 'none';
                    document.body.style.overflow = '';
                    // Reset password field state
                    const passwordField = document.getElementById('user-password');
                    if (passwordField) {
                        passwordField.readOnly = false;
                        passwordField.style.backgroundColor = '';
                        passwordField.style.cursor = '';
                    }
                });
            }
            
            // User form handler
            const userForm = document.getElementById('user-form');
            if (userForm) {
                userForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const modal = document.getElementById('user-modal');
                    const isEditMode = modal.hasAttribute('data-edit-id');
                    const editId = isEditMode ? modal.getAttribute('data-edit-id') : null;
                    const editType = isEditMode ? modal.getAttribute('data-edit-type') : null;
                    
                    const username = document.getElementById('user-username').value.trim();
                    const email = document.getElementById('user-email').value.trim();
                    const passwordField = document.getElementById('user-password');
                    // If password field is read-only (view mode), ignore its value
                    const password = passwordField.readOnly ? '' : passwordField.value;
                    const tier = document.getElementById('user-role').value;
                    const firstname = document.getElementById('user-firstname').value.trim();
                    const lastname = document.getElementById('user-lastname').value.trim();
                    const phone = document.getElementById('user-phone').value.trim();
                    
                    // Validate password for new users only (not when editing with read-only field)
                    if (!isEditMode && !password) {
                        alert('Password is required for new users');
                        return;
                    }
                    
                    // Validate required fields
                    if (!username || !email || !tier) {
                        alert('Please fill in all required fields');
                        return;
                    }
                    
                    const submitBtn = userForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = isEditMode ? 'Saving...' : 'Creating...';
                    
                    try {
                        if (isEditMode) {
                            // Update existing user
                            if (editType === 'investor') {
                                // Only update tier for investors
                                if (window.firebaseDb) {
                                    await window.firebaseDb.collection('users').doc(editId).update({
                                        tier: tier,
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    await loadUsersList();
                                    modal.style.display = 'none';
                                    document.body.style.overflow = '';
                                    userForm.reset();
                                    // Reset password field state
                                    const passwordFieldReset = document.getElementById('user-password');
                                    if (passwordFieldReset) {
                                        passwordFieldReset.readOnly = false;
                                        passwordFieldReset.style.backgroundColor = '';
                                        passwordFieldReset.style.cursor = '';
                                    }
                                } else {
                                    alert('Firestore service not available. Please refresh the page.');
                                }
                            } else {
                                // Update learning user
                                if (window.learningUsersFirestoreService) {
                                    // Check for username/email conflicts (excluding current user)
                                    const existingByUsername = await window.learningUsersFirestoreService.getLearningUserByUsername(username);
                                    if (existingByUsername && existingByUsername.id !== editId) {
                                        alert('Username already exists. Please choose a different username.');
                                        submitBtn.disabled = false;
                                        submitBtn.textContent = originalText;
                                        return;
                                    }
                                    
                                    const existingByEmail = await window.learningUsersFirestoreService.getLearningUserByEmail(email);
                                    if (existingByEmail && existingByEmail.id !== editId) {
                                        alert('Email already exists. Please use a different email address.');
                                        submitBtn.disabled = false;
                                        submitBtn.textContent = originalText;
                                        return;
                                    }
                                    
                                    await window.learningUsersFirestoreService.updateLearningUser(editId, {
                                        username,
                                        email,
                                        firstname,
                                        lastname,
                                        phone,
                                        tier,
                                        active: true // Learning users are always active
                                    });
                                    
                                    // Note: Password updates in Firebase Auth should be handled server-side
                                    // For now, we only update the Firestore document
                                    
                                    await loadUsersList();
                                    modal.style.display = 'none';
                                    document.body.style.overflow = '';
                                    userForm.reset();
                                    // Reset password field state
                                    const passwordFieldReset2 = document.getElementById('user-password');
                                    if (passwordFieldReset2) {
                                        passwordFieldReset2.readOnly = false;
                                        passwordFieldReset2.style.backgroundColor = '';
                                        passwordFieldReset2.style.cursor = '';
                                    }
                                } else {
                                    alert('Firestore service not available. Please refresh the page.');
                                }
                            }
                        } else {
                            // Create new learning user
                            if (window.learningUsersFirestoreService) {
                                // Check for username/email conflicts
                                const existingByUsername = await window.learningUsersFirestoreService.getLearningUserByUsername(username);
                                if (existingByUsername) {
                                    alert('Username already exists. Please choose a different username.');
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = originalText;
                                    return;
                                }
                                
                                const existingByEmail = await window.learningUsersFirestoreService.getLearningUserByEmail(email);
                                if (existingByEmail) {
                                    alert('Email already exists. Please use a different email address.');
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = originalText;
                                    return;
                                }
                                
                                // Also check investors collection for email conflicts
                                if (window.firebaseDb) {
                                    const investorSnapshot = await window.firebaseDb.collection('users')
                                        .where('email', '==', email)
                                        .get();
                                    if (!investorSnapshot.empty) {
                                        alert('Email already exists in investors. Please use a different email address.');
                                        submitBtn.disabled = false;
                                        submitBtn.textContent = originalText;
                                        return;
                                    }
                                }
                                
                                // Create user in Firestore
                                await window.learningUsersFirestoreService.createLearningUser({
                                    username,
                                    email,
                                    firstname,
                                    lastname,
                                    phone,
                                    tier,
                                    active: true
                                });
                                
                                // Note: Firebase Auth user creation should be handled server-side
                                // For now, we only create the Firestore document
                                // The password can be set up later through Firebase Console or a Cloud Function
                                
                                await loadUsersList();
                                modal.style.display = 'none';
                                document.body.style.overflow = '';
                                userForm.reset();
                                // Reset password field state
                                const passwordField = document.getElementById('user-password');
                                if (passwordField) {
                                    passwordField.readOnly = false;
                                    passwordField.style.backgroundColor = '';
                                    passwordField.style.cursor = '';
                                }
                            } else {
                                alert('Firestore service not available. Please refresh the page.');
                            }
                        }
                    } catch (error) {
                        console.error('Error saving user:', error);
                        alert('Error saving user: ' + error.message);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
            
            // Close module modal handlers
            setTimeout(function() {
                const moduleModal = document.getElementById('module-modal');
                if (moduleModal) {
                    moduleModal.querySelector('.admin-modal-close')?.addEventListener('click', function() {
                        moduleModal.style.display = 'none';
                        document.body.style.overflow = '';
                    });
                    moduleModal.querySelector('.admin-modal-overlay')?.addEventListener('click', function() {
                        moduleModal.style.display = 'none';
                        document.body.style.overflow = '';
                    });
                    document.getElementById('cancel-module')?.addEventListener('click', function() {
                        moduleModal.style.display = 'none';
                        document.body.style.overflow = '';
                    });
                }
            }, 100);
            
            // Market News Functions
            let newsData = [];
            
            async function loadMarketNews() {
                const container = document.getElementById('news-grid');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">Loading news...</div>';
                
                try {
                    if (window.firestoreService) {
                        newsData = await window.firestoreService.getAllNews();
                        console.log('News loaded from Firestore:', newsData.length);
                    } else {
                        console.warn('Firestore service not available');
                        newsData = [];
                    }
                } catch (error) {
                    console.error('Error loading news:', error);
                    newsData = [];
                }
                
                container.innerHTML = '';
                
                if (newsData.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);"><p style="margin: 0 0 1rem 0;">No news articles found.</p><p style="margin: 0; font-size: 0.875rem;">Click "Add New Article" button above to create your first article.</p></div>';
                    return;
                }
                
                newsData.forEach((news, index) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'news-card-wrapper';
                    wrapper.setAttribute('data-news-id', news.id);
                    wrapper.innerHTML = `
                        <a href="${news.link}" target="_blank" rel="noopener noreferrer" class="news-card">
                            <div class="news-image-container">
                                <img src="${news.image}" alt="${news.title}" class="news-image" />
                                <h3 class="news-title">${news.title}</h3>
                            </div>
                        </a>
                        <button class="news-edit-btn" onclick="openNewsEditModal('${news.id}')">Edit</button>
                    `;
                    container.appendChild(wrapper);
                });
            }
            
            function openNewsEditModal(newsId) {
                const news = newsData.find(n => n.id === newsId);
                if (!news) return;
                
                const modal = document.getElementById('news-edit-modal');
                if (!modal) {
                    console.error('News edit modal not found');
                    return;
                }
                document.getElementById('news-modal-title').textContent = 'Edit News Article';
                document.getElementById('edit-news-title').value = news.title;
                document.getElementById('edit-news-link').value = news.link;
                document.getElementById('edit-news-image').value = news.image;
                document.getElementById('edit-news-order').value = news.order || 0;
                // Show delete button
                const deleteBtn = document.getElementById('delete-news-btn');
                if (deleteBtn) deleteBtn.style.display = 'inline-block';
                modal.setAttribute('data-edit-id', newsId);
                modal.removeAttribute('data-add-mode');
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function openAddNewsModal() {
                const modal = document.getElementById('news-edit-modal');
                if (!modal) {
                    console.error('News edit modal not found');
                    return;
                }
                document.getElementById('news-modal-title').textContent = 'Add New Article';
                document.getElementById('news-edit-form').reset();
                document.getElementById('edit-news-order').value = newsData.length;
                // Hide delete button
                const deleteBtn = document.getElementById('delete-news-btn');
                if (deleteBtn) deleteBtn.style.display = 'none';
                modal.removeAttribute('data-edit-id');
                modal.setAttribute('data-add-mode', 'true');
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            window.openAddNewsModal = openAddNewsModal;
            
            function closeNewsEditModal() {
                const modal = document.getElementById('news-edit-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            }
            
            // Delete news function
            async function deleteNews() {
                const modal = document.getElementById('news-edit-modal');
                const newsId = modal.getAttribute('data-edit-id');
                
                if (!newsId) {
                    console.error('News ID not found for deletion');
                    return;
                }
                
                if (!confirm('Are you sure you want to delete this news article? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    if (window.firestoreService) {
                        await window.firestoreService.deleteNews(newsId);
                        closeNewsEditModal();
                        await loadMarketNews();
                    } else {
                        alert('Firestore service not available. Please refresh the page.');
                    }
                } catch (error) {
                    console.error('Error deleting news:', error);
                    alert('Error deleting news: ' + error.message);
                }
            }
            
            window.deleteNews = deleteNews;
            
            // News edit form handler
            const newsEditForm = document.getElementById('news-edit-form');
            if (newsEditForm) {
                newsEditForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const modal = document.getElementById('news-edit-modal');
                    const isAddMode = modal.getAttribute('data-add-mode') === 'true';
                    
                    const submitBtn = newsEditForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = isAddMode ? 'Creating...' : 'Saving...';
                    
                    try {
                        const formData = {
                            title: document.getElementById('edit-news-title').value.trim(),
                            link: document.getElementById('edit-news-link').value.trim(),
                            image: document.getElementById('edit-news-image').value.trim(),
                            order: parseInt(document.getElementById('edit-news-order').value) || 0
                        };
                        
                        if (isAddMode) {
                            if (window.firestoreService) {
                                await window.firestoreService.createNews(formData);
                            } else {
                                alert('Firestore service not available. Please refresh the page.');
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                return;
                            }
                        } else {
                            const newsId = modal.getAttribute('data-edit-id');
                            if (!newsId) {
                                alert('Error: News ID not found');
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                return;
                            }
                            
                            if (window.firestoreService) {
                                await window.firestoreService.updateNews(newsId, formData);
                            } else {
                                alert('Firestore service not available. Please refresh the page.');
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                return;
                            }
                        }
                        
                        closeNewsEditModal();
                        await loadMarketNews();
                        
                    } catch (error) {
                        console.error('Error saving news:', error);
                        alert('Error saving news: ' + error.message);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
            
            // News modal close handlers
            const newsModal = document.getElementById('news-edit-modal');
            if (newsModal) {
                newsModal.querySelector('.admin-modal-close')?.addEventListener('click', closeNewsEditModal);
                newsModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeNewsEditModal);
                document.getElementById('cancel-news-edit')?.addEventListener('click', closeNewsEditModal);
            }
            
            // Consultations Section
            let consultationsData = [];
            let selectedConsultationId = null;
            let currentFilter = 'all';
            
            async function loadConsultationsList() {
                const container = document.getElementById('consultations-grid');
                if (!container) return;
                
                container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 2rem;">Loading consultations...</div>';
                
                try {
                    // Load consultations from Firestore
                    if (window.firestoreService) {
                        consultationsData = await window.firestoreService.getAllConsultations();
                    } else {
                        console.warn('Firestore service not available');
                        consultationsData = [];
                    }
                } catch (error) {
                    console.error('Error loading consultations:', error);
                    consultationsData = [];
                }
                
                container.innerHTML = '';
                
                // Filter consultations based on current filter
                let filteredConsultations = consultationsData;
                if (currentFilter === 'pending') {
                    filteredConsultations = consultationsData.filter(c => c.status === 'pending');
                } else if (currentFilter === 'done') {
                    filteredConsultations = consultationsData.filter(c => c.status === 'done');
                }
                
                if (filteredConsultations.length === 0) {
                    container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 2rem;">No consultations found.</p>';
                    return;
                }
                
                filteredConsultations.forEach(consultation => {
                    const card = document.createElement('div');
                    card.className = 'consultation-card';
                    if (selectedConsultationId === consultation.id) {
                        card.classList.add('selected');
                    }
                    card.setAttribute('data-consultation-id', consultation.id);
                    
                    const statusClass = consultation.status === 'pending' ? 'consultation-status-pending' : 'consultation-status-done';
                    const statusText = consultation.status === 'pending' ? 'Pending' : 'Done';
                    
                    // Format date and time
                    const dateStr = consultation.date || '';
                    const timeStr = consultation.time || '';
                    const formattedDate = dateStr ? new Date(dateStr + 'T00:00:00').toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }) : 'Date not set';
                    const consultationTopic = consultation.consultationTopicDisplay || consultation.consultationTopic || 'Not specified';
                    
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.125rem; color: #1f2937;">${consultation.fullName || 'Unknown'}</h3>
                            <span class="consultation-status ${statusClass}">${statusText}</span>
                        </div>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">
                            <p style="margin: 0.25rem 0;"><strong>Email:</strong> ${consultation.email || 'N/A'}</p>
                            <p style="margin: 0.25rem 0;"><strong>Date:</strong> ${formattedDate}</p>
                            <p style="margin: 0.25rem 0;"><strong>Time:</strong> ${timeStr || 'Not set'}</p>
                            <p style="margin: 0.25rem 0;"><strong>Consultation:</strong> ${consultationTopic}</p>
                        </div>
                    `;
                    
                    // Only allow selection of pending consultations
                    if (consultation.status === 'pending') {
                        card.addEventListener('click', function() {
                            selectConsultation(consultation.id);
                        });
                    }
                    
                    container.appendChild(card);
                });
                
                // Update send email section visibility
                updateSendEmailSection();
            }
            
            function selectConsultation(id) {
                selectedConsultationId = id;
                loadConsultationsList();
                
                const consultation = consultationsData.find(c => c.id === id);
                if (consultation) {
                    const infoDiv = document.getElementById('selected-consultation-info');
                    const dateStr = consultation.date || '';
                    const timeStr = consultation.time || '';
                    const formattedDate = dateStr ? new Date(dateStr + 'T00:00:00').toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    }) : 'Date not set';
                    const consultationTopic = consultation.consultationTopicDisplay || consultation.consultationTopic || 'Not specified';
                    
                    infoDiv.innerHTML = `
                        <strong>${consultation.fullName || 'Unknown'}</strong> - ${consultation.email || 'N/A'}<br>
                        <span style="font-size: 0.875rem; color: #6b7280;">${consultationTopic} - ${formattedDate} at ${timeStr || 'TBD'}</span>
                    `;
                    document.getElementById('send-email-section').style.display = 'block';
                }
            }
            
            function updateSendEmailSection() {
                const section = document.getElementById('send-email-section');
                if (selectedConsultationId) {
                    const consultation = consultationsData.find(c => c.id === selectedConsultationId);
                    if (consultation && consultation.status === 'pending') {
                        section.style.display = 'block';
                    } else {
                        section.style.display = 'none';
                        selectedConsultationId = null;
                    }
                } else {
                    section.style.display = 'none';
                }
            }
            
            // Filter tab handlers
            document.querySelectorAll('.consultation-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.consultation-tab-btn').forEach(b => {
                        b.classList.remove('active');
                        b.style.borderBottomColor = 'transparent';
                        b.style.color = '#6b7280';
                        b.style.fontWeight = '500';
                    });
                    
                    this.classList.add('active');
                    this.style.borderBottomColor = '#2563eb';
                    this.style.color = '#2563eb';
                    this.style.fontWeight = '600';
                    
                    currentFilter = this.getAttribute('data-filter');
                    selectedConsultationId = null;
                    loadConsultationsList();
                });
            });
            
            // Send email form handler
            const sendEmailForm = document.getElementById('send-email-form');
            if (sendEmailForm) {
                sendEmailForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    if (!selectedConsultationId) {
                        alert('Please select a consultation first.');
                        return;
                    }
                    
                    const consultation = consultationsData.find(c => c.id === selectedConsultationId);
                    if (!consultation) return;
                    
                    const googleMeetLink = document.getElementById('google-meet-link').value;
                    
                    if (!googleMeetLink) {
                        alert('Please enter a Google Meet link.');
                        return;
                    }
                    
                    // In a real application, this would send an email via a backend service
                    alert(`Google Meet link would be sent to ${consultation.email}:\n\nLink: ${googleMeetLink}\n\nNote: This is a demo. In production, this would send an actual email with the Google Meet link.`);
                    
                    // Mark consultation as done (optional)
                    // consultation.status = 'done';
                    // loadConsultationsList();
                });
            }
            
            // Clear selection button
            const cancelSendEmailBtn = document.getElementById('cancel-send-email');
            if (cancelSendEmailBtn) {
                cancelSendEmailBtn.addEventListener('click', function() {
                    selectedConsultationId = null;
                    document.getElementById('send-email-form').reset();
                    document.getElementById('selected-consultation-info').textContent = 'No consultation selected';
                    document.getElementById('send-email-section').style.display = 'none';
                    loadConsultationsList();
                });
            }
            
            // Emails Section
            function loadEmailUsersList() {
                // Function kept for compatibility but not needed anymore
            }
            
            // Add email recipient field
            function addEmailRecipientField() {
                const container = document.getElementById('email-recipients-container');
                if (!container) return;
                
                const newRow = document.createElement('div');
                newRow.className = 'email-recipient-row';
                newRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
                
                const input = document.createElement('input');
                input.type = 'email';
                input.className = 'admin-form-input email-recipient-input';
                input.placeholder = 'Enter email address';
                input.style.flex = '1';
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-email-btn';
                removeBtn.textContent = 'Remove';
                removeBtn.style.cssText = 'background: #fca5a5; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;';
                
                removeBtn.addEventListener('click', function() {
                    newRow.remove();
                    updateRemoveButtons();
                });
                
                newRow.appendChild(input);
                newRow.appendChild(removeBtn);
                container.appendChild(newRow);
                
                updateRemoveButtons();
            }
            
            function updateRemoveButtons() {
                const rows = document.querySelectorAll('.email-recipient-row');
                rows.forEach((row, index) => {
                    const removeBtn = row.querySelector('.remove-email-btn');
                    if (rows.length > 1) {
                        removeBtn.style.display = 'block';
                    } else {
                        removeBtn.style.display = 'none';
                    }
                });
            }
            
            // Add email recipient button
            const addEmailRecipientBtn = document.getElementById('add-email-recipient-btn');
            if (addEmailRecipientBtn) {
                addEmailRecipientBtn.addEventListener('click', function() {
                    addEmailRecipientField();
                });
            }
            
            // Initial update of remove buttons
            updateRemoveButtons();
            
            // Handle file attachments
            const emailAttachmentInput = document.getElementById('email-attachment');
            const attachmentListDiv = document.getElementById('attachment-list');
            
            if (emailAttachmentInput && attachmentListDiv) {
                emailAttachmentInput.addEventListener('change', function() {
                    const files = Array.from(this.files);
                    attachmentListDiv.innerHTML = '';
                    
                    if (files.length > 0) {
                        files.forEach((file, index) => {
                            if (file.type === 'application/pdf') {
                                const fileItem = document.createElement('div');
                                fileItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f3f4f6; border-radius: 4px; margin-top: 0.5rem;';
                                fileItem.innerHTML = `
                                    <span style="font-size: 0.875rem; color: #374151;">${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
                                    <button type="button" class="remove-attachment-btn" data-index="${index}" style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Remove</button>
                                `;
                                attachmentListDiv.appendChild(fileItem);
                            }
                        });
                        
                        // Add remove button handlers
                        attachmentListDiv.querySelectorAll('.remove-attachment-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const index = parseInt(this.getAttribute('data-index'));
                                const dt = new DataTransfer();
                                const files = Array.from(emailAttachmentInput.files);
                                files.splice(index, 1);
                                files.forEach(file => dt.items.add(file));
                                emailAttachmentInput.files = dt.files;
                                emailAttachmentInput.dispatchEvent(new Event('change'));
                            });
                        });
                    }
                });
            }
            
            // Send email to user form handler
            const sendEmailToUserForm = document.getElementById('send-email-to-user-form');
            if (sendEmailToUserForm) {
                sendEmailToUserForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const emailInputs = document.querySelectorAll('.email-recipient-input');
                    const emails = Array.from(emailInputs)
                        .map(input => input.value.trim())
                        .filter(email => email !== '');
                    
                    if (emails.length === 0) {
                        alert('Please enter at least one email address.');
                        return;
                    }
                    
                    const subject = document.getElementById('email-subject-input').value;
                    const message = document.getElementById('email-message-input').value;
                    const attachments = document.getElementById('email-attachment').files;
                    
                    let attachmentInfo = '';
                    if (attachments.length > 0) {
                        const fileNames = Array.from(attachments).map(f => f.name).join(', ');
                        attachmentInfo = `\n\nAttachments: ${fileNames}`;
                    }
                    
                    const recipientsList = emails.join(', ');
                    
                    // In a real application, this would send an email via a backend service
                    alert(`Email would be sent to: ${recipientsList}\n\nSubject: ${subject}\n\nMessage:\n${message}${attachmentInfo}\n\nNote: This is a demo. In production, this would send an actual email with attachments.`);
                });
            }
            
            // Clear email form button
            const clearEmailFormBtn = document.getElementById('clear-email-form');
            if (clearEmailFormBtn) {
                clearEmailFormBtn.addEventListener('click', function() {
                    document.getElementById('send-email-to-user-form').reset();
                    document.getElementById('attachment-list').innerHTML = '';
                    
                    // Reset to single email field
                    const container = document.getElementById('email-recipients-container');
                    container.innerHTML = `
                        <div class="email-recipient-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="email" class="admin-form-input email-recipient-input" placeholder="Enter email address" required style="flex: 1;">
                            <button type="button" class="remove-email-btn" style="display: none; background: #ef4444; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Remove</button>
                        </div>
                    `;
                    updateRemoveButtons();
                });
            }
            
            // Close modal handlers - set up after DOM is ready
            setTimeout(function() {
                const newsModal = document.getElementById('news-edit-modal');
                if (newsModal) {
                    newsModal.querySelector('.admin-modal-close')?.addEventListener('click', closeNewsEditModal);
                    newsModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeNewsEditModal);
                    document.getElementById('cancel-news-edit')?.addEventListener('click', closeNewsEditModal);
                }
                
                const investorModal = document.getElementById('investor-edit-modal');
                if (investorModal) {
                    investorModal.querySelector('.admin-modal-close')?.addEventListener('click', closeInvestorEditModal);
                    investorModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeInvestorEditModal);
                    document.getElementById('cancel-investor-edit')?.addEventListener('click', closeInvestorEditModal);
                }
                
            }, 100);
            
            // Initial draw if dashboard is visible
            if (dashboardViewEl && dashboardViewEl.style.display !== 'none') {
                setTimeout(function() {
                    calculateProjectionValue();
                    loadMembersAndRevenue();
                }, 100);
            }

            // Redraw chart on window resize
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    if (portfolioView && portfolioView.style.display !== 'none') {
                        drawPortfolioChart();
                    }
                    // Dashboard widgets resized
                }, 250);
            });
            
            // Admin Profile Picture Functions
            function loadAdminProfilePicture(profilePictureUrl) {
                const profileImg = document.getElementById('admin-profile-picture-img');
                const placeholder = document.getElementById('admin-profile-picture-placeholder');
                
                if (profilePictureUrl && profilePictureUrl.trim() !== '') {
                    profileImg.src = profilePictureUrl;
                    profileImg.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                } else {
                    profileImg.style.display = 'none';
                    if (placeholder) placeholder.style.display = 'flex';
                }
            }
            
            // Load admin profile picture from separate admin sessionStorage key (unique to adminportal3)
            const adminProfilePicture = sessionStorage.getItem('adminProfilePicture3');
            if (adminProfilePicture) {
                try {
                    loadAdminProfilePicture(adminProfilePicture);
                } catch (error) {
                    console.error('Error loading admin profile picture:', error);
                }
            }
            
            // Setup admin profile picture upload
            const adminProfileContainer = document.getElementById('admin-profile-picture-container');
            const adminProfileInput = document.getElementById('admin-profile-picture-input');
            const adminProfileOverlay = adminProfileContainer?.querySelector('.profile-picture-upload-overlay');
            
            if (adminProfileContainer && adminProfileInput) {
                // Show overlay on hover
                adminProfileContainer.addEventListener('mouseenter', function() {
                    if (adminProfileOverlay) adminProfileOverlay.style.display = 'flex';
                });
                
                adminProfileContainer.addEventListener('mouseleave', function() {
                    if (adminProfileOverlay) adminProfileOverlay.style.display = 'none';
                });
                
                // Click to upload
                adminProfileContainer.addEventListener('click', function() {
                    adminProfileInput.click();
                });
                
                // Handle file selection
                adminProfileInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file.');
                        return;
                    }
                    
                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Image size must be less than 5MB.');
                        return;
                    }
                    
                    try {
                        // Show loading state - use spinner
                        const profileImg = document.getElementById('admin-profile-picture-img');
                        const placeholder = document.getElementById('admin-profile-picture-placeholder');
                        if (placeholder) {
                            placeholder.innerHTML = '<div style="width: 20px; height: 20px; border: 2px solid #6b7280; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>';
                            placeholder.style.opacity = '0.7';
                        }
                        
                        // Convert image to base64 data URL (avoids Storage CORS issues)
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            try {
                                const base64DataUrl = e.target.result;
                                
                                // Store admin profile picture in separate sessionStorage key (unique to adminportal3)
                                sessionStorage.setItem('adminProfilePicture3', base64DataUrl);
                                
                                // Update display
                                loadAdminProfilePicture(base64DataUrl);
                                
                                // Reset placeholder opacity
                                if (placeholder) {
                                    placeholder.style.opacity = '1';
                                }
                                
                                console.log('Admin profile picture updated successfully');
                            } catch (error) {
                                console.error('Error saving admin profile picture:', error);
                                alert('Error saving profile picture: ' + error.message);
                                if (placeholder) {
                                    placeholder.innerHTML = '<span>ðŸ‘¤</span>';
                                    placeholder.style.opacity = '1';
                                }
                            }
                        };
                        
                        reader.onerror = function(error) {
                            console.error('Error reading file:', error);
                            alert('Error reading image file.');
                            if (placeholder) {
                                placeholder.innerHTML = '<span>ðŸ‘¤</span>';
                                placeholder.style.opacity = '1';
                            }
                        };
                        
                        reader.readAsDataURL(file);
                    } catch (error) {
                        console.error('Error processing profile picture:', error);
                        alert('Error processing profile picture: ' + error.message);
                    }
                    
                    // Reset input
                    adminProfileInput.value = '';
                });
            }
    });
    </script>
</body>
</html>

