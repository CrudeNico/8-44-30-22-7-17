<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal 2 - Opessocius</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Admin Modal Styles */
        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
        }
        .admin-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
        .admin-modal-container {
            position: relative;
            background: white;
            max-width: 500px;
            margin: 50px auto;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        .admin-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6b7280;
            z-index: 1;
        }
        .admin-modal-close:hover {
            color: #1f2937;
        }
        .admin-modal-content {
            padding: 2rem;
        }
        .admin-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #1f2937;
        }
        .admin-form-group {
            margin-bottom: 1.25rem;
        }
        .admin-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        .admin-form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .admin-form-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .admin-form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: flex-end;
        }
        .admin-btn-save, .admin-btn-cancel, .admin-btn-add, .admin-edit-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .admin-btn-save {
            background: #2563eb;
            color: white;
        }
        .admin-btn-save:hover {
            background: #1d4ed8;
        }
        .admin-btn-cancel {
            background: #e5e7eb;
            color: #374151;
        }
        .admin-btn-cancel:hover {
            background: #d1d5db;
        }
        .admin-btn-add {
            background: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .admin-btn-add:hover {
            background: #059669;
        }
        .admin-edit-btn {
            background: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        .admin-edit-btn:hover {
            background: #4b5563;
        }
        .admin-btn-view {
            background: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .admin-btn-view:hover {
            background: #4b5563;
        }
        
        /* Investors/Users Grid */
        .investors-grid, .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .investor-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .investor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .investor-card-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: #1f2937;
        }
        .investor-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .investor-status-active {
            background: #d1fae5;
            color: #065f46;
        }
        .investor-status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }
        .investor-status-phase1 {
            background: #dbeafe;
            color: #1e40af;
        }
        .investor-status-phase2 {
            background: #e0e7ff;
            color: #4338ca;
        }
        .investor-card-body p {
            margin: 0.5rem 0;
            color: #6b7280;
        }
        .investor-card-actions {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .return-positive {
            color: #10b981;
            font-weight: 600;
        }
        
        /* Transactions table edit button */
        .transactions-table th:last-child,
        .transactions-table td:last-child {
            text-align: center;
        }
    </style>
</head>
<body class="dashboard-active">
    <section class="user-dashboard" id="user-dashboard">
        <div class="dashboard-sidebar">
            <div class="sidebar-profile">
                <div class="sidebar-profile-image-container" id="admin2-profile-picture-container" style="position: relative; cursor: pointer; width: 80px; height: 80px; margin: 0 auto;">
                    <img src="" alt="Profile Picture" class="sidebar-profile-image" id="admin2-profile-picture-img" style="display: none; width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #ffffff; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);" />
                    <div class="profile-picture-placeholder" id="admin2-profile-picture-placeholder" style="width: 80px; height: 80px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 2rem; border: 3px solid #ffffff; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                        <span>ðŸ‘¤</span>
                    </div>
                    <div class="profile-picture-upload-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; font-size: 0.75rem; text-align: center; padding: 0.5rem; cursor: pointer;">
                        Click to upload
                    </div>
                </div>
                <input type="file" id="admin2-profile-picture-input" accept="image/*" style="display: none;" />
                <div class="sidebar-profile-name" id="sidebar-profile-name">Admin</div>
            </div>
            <nav class="sidebar-navigation">
                <a href="#" class="sidebar-nav-item active">
                    <span>Dashboard</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Portfolio</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Transactions</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Performance</span>
                </a>
                <a href="#" class="sidebar-nav-item">
                    <span>Account Settings</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <a href="index.html" class="sidebar-footer-item">
                    <span>Return to Home</span>
                </a>
                <a href="login.html" class="sidebar-footer-item" id="logout-btn">
                    <span>Logout</span>
                </a>
            </div>
        </div>
        <div class="dashboard-content">
            <!-- Dashboard View -->
            <div class="dashboard-view" id="dashboard-view" style="display: block;">
                <div class="dashboard-widgets-grid">
                    <!-- Crude Oil Price - Top Left -->
                    <div class="dashboard-widget dashboard-widget-oil" style="grid-column: 1; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Crude Oil Price</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="tradingview-widget-container-dashboard">
                                <div class="tradingview-widget-container__widget"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                                {
                                    "symbol": "USOIL",
                                    "width": "100%",
                                    "height": "160",
                                    "locale": "en",
                                    "dateRange": "1D",
                                    "colorTheme": "light",
                                    "trendLineColor": "rgba(37, 99, 235, 1)",
                                    "underLineColor": "rgba(37, 99, 235, 0.3)",
                                    "isTransparent": false,
                                    "autosize": true,
                                    "largeChartUrl": ""
                                }
                                </script>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Balance - Top Right Row 1 -->
                    <div class="dashboard-widget" style="grid-column: 2; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Current Balance</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="dashboard-main-metric" id="dashboard-current-balance">â‚¬287,450</div>
                            <div class="dashboard-sub-metric">Capital Invested: â‚¬230,000</div>
                        </div>
                    </div>
                    
                    <!-- Total Gain - Top Right Row 1 -->
                    <div class="dashboard-widget" style="grid-column: 3; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Total Gain</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="dashboard-main-metric dashboard-metric-positive" id="dashboard-total-gain">+24.98%</div>
                            <div class="dashboard-sub-metric">â‚¬57,450 profit</div>
                        </div>
                    </div>
                    
                    <!-- 12 Month Projection - Top Right Row 1 -->
                    <div class="dashboard-widget" style="grid-column: 4; grid-row: 1;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">12 Month Projection</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="dashboard-projection-value" id="dashboard-projection-value">â‚¬355,108</div>
                            <div class="dashboard-sub-metric">Projected ending capital</div>
                        </div>
                    </div>
                    
                    <!-- Top Accounts - Second Row -->
                    <!-- To adjust widget height, modify min-height values below (line 303 and 307) -->
                    <div class="dashboard-widget" id="top-accounts-widget" style="grid-column: 1; grid-row: 2 / 3; min-height: 575px;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Top Accounts</h3>
                        </div>
                        <div class="dashboard-widget-content" style="min-height: 520px;">
                            <div id="top-accounts-list">
                                <!-- Top 5 accounts will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Crude Oil Trading View Chart - Big Widget spans rows 2-3, columns 2-5 -->
                    <div class="dashboard-widget dashboard-widget-wide" style="grid-column: 2 / 5; grid-row: 2 / 4;">
                        <div class="dashboard-widget-header">
                            <h3 class="dashboard-widget-title">Crude Oil Chart</h3>
                        </div>
                        <div class="dashboard-widget-content">
                            <div class="tradingview-widget-container-dashboard">
                                <div id="crude-oil-chart-dashboard"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
                                <script type="text/javascript">
                                new TradingView.widget({
                                    "width": "100%",
                                    "height": "525",
                                    "symbol": "USOIL",
                                    "interval": "60",
                                    "theme": "light",
                                    "style": "1",
                                    "timezone": "Europe/Amsterdam",
                                    "locale": "en",
                                    "allow_symbol_change": true,
                                    "withdateranges": true,
                                    "container_id": "crude-oil-chart-dashboard",
                                    "hide_volume": false,
                                    "studies": [
                                        {
                                            "id": "MASimple@tv-basicstudies",
                                            "inputs": {
                                                "length": 200,
                                                "source": "close",
                                                "maType": "EMA"
                                            },
                                            "overrides": {
                                                "plot.color": "#FFFF00",
                                                "plot.linewidth": 3
                                            }
                                        }
                                    ]
                                });
                                </script>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>

            <!-- Portfolio View -->
            <div class="portfolio-view" id="portfolio-view" style="display: none;">
                <div class="portfolio-balance-cards">
                    <div class="balance-card">
                        <div class="balance-label">Total Fund Capital Invested</div>
                        <div class="balance-amount" id="capital-invested">â‚¬8,500,000</div>
                    </div>
                    <div class="balance-card">
                        <div class="balance-label">Total Fund Balance</div>
                        <div class="balance-amount" id="current-balance">â‚¬10,625,000</div>
                    </div>
                    <div class="balance-card">
                        <div class="balance-label">Total Fund Gain</div>
                        <div class="balance-amount balance-amount-gain" id="total-gain">+25.00%</div>
                    </div>
                    <div class="balance-card">
                        <div class="balance-label">12 Month Projection</div>
                        <div class="balance-amount" id="portfolio-projection">â‚¬13,150,000</div>
                    </div>
                </div>
                <div class="portfolio-chart-container">
                    <div class="portfolio-chart-card">
                        <h3 class="portfolio-chart-title">Fund Performance & Projection</h3>
                        <div class="chart-wrapper">
                            <canvas id="portfolio-chart" width="800" height="400"></canvas>
                            <div id="chart-tooltip" class="chart-tooltip" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transactions View -->
            <div class="transactions-view" id="transactions-view" style="display: none;">
                <div class="transactions-add-section" style="background: white; padding: 2rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                    <h3 style="margin-top: 0; margin-bottom: 1.5rem; font-size: 1.25rem; color: #1f2937;">Add Fund Performance</h3>
                    <form id="fund-performance-form" class="admin-modal-form" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; align-items: end;">
                        <div class="admin-form-group">
                            <label for="fund-month">Month</label>
                            <select id="fund-month" class="admin-form-input" required>
                                <option value="">Select Month</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-year">Year</label>
                            <input type="number" id="fund-year" class="admin-form-input" min="2020" max="2030" value="2024" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-starting-balance">Starting Balance (â‚¬)</label>
                            <input type="number" id="fund-starting-balance" class="admin-form-input" step="0.01" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-ending-balance">Ending Balance (â‚¬)</label>
                            <input type="number" id="fund-ending-balance" class="admin-form-input" step="0.01" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-growth">Growth %</label>
                            <input type="number" id="fund-growth" class="admin-form-input" step="0.01" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-deposits">Deposits (â‚¬)</label>
                            <input type="number" id="fund-deposits" class="admin-form-input" step="0.01" value="0" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-deposit-date">Deposit Date</label>
                            <input type="date" id="fund-deposit-date" class="admin-form-input">
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-withdrawals">Withdrawals (â‚¬)</label>
                            <input type="number" id="fund-withdrawals" class="admin-form-input" step="0.01" value="0" required>
                        </div>
                        <div class="admin-form-group">
                            <label for="fund-withdrawal-date">Withdrawal Date</label>
                            <input type="date" id="fund-withdrawal-date" class="admin-form-input">
                        </div>
                        <div class="admin-form-group">
                            <button type="submit" class="admin-btn-save" style="width: 100%;">Add Performance</button>
                        </div>
                    </form>
                </div>
                <div class="transactions-table-container">
                    <table class="transactions-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Starting Balance</th>
                                <th>Ending Balance</th>
                                <th>Growth %</th>
                                <th>Deposits</th>
                                <th>Withdrawals</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table-body">
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Transaction Edit Modal -->
            <div id="transaction-edit-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title">Edit Transaction</h2>
                        <form id="transaction-edit-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="edit-starting-balance">Starting Balance (â‚¬)</label>
                                <input type="number" id="edit-starting-balance" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-ending-balance">Ending Balance (â‚¬)</label>
                                <input type="number" id="edit-ending-balance" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-growth">Growth %</label>
                                <input type="number" id="edit-growth" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-deposits">Deposits (â‚¬)</label>
                                <input type="number" id="edit-deposits" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-deposit-date">Deposit Date</label>
                                <input type="date" id="edit-deposit-date" class="admin-form-input">
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-withdrawals">Withdrawals (â‚¬)</label>
                                <input type="number" id="edit-withdrawals" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-withdrawal-date">Withdrawal Date</label>
                                <input type="date" id="edit-withdrawal-date" class="admin-form-input">
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="delete-transaction-btn" style="background: #dc2626; color: white; margin-right: auto;">Delete Transaction</button>
                                <button type="button" class="admin-btn-cancel" id="cancel-transaction-edit">Cancel</button>
                                <button type="submit" class="admin-btn-save">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Performance View - Funded Accounts List -->
            <div class="performance-view" id="performance-view" style="display: none;">
                <div class="investors-list-container">
                    <div class="investors-grid" id="investors-grid">
                        <!-- Funded Accounts will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Funded Account Performance Modal -->
            <div id="investor-performance-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="investor-performance-modal-title">Add Performance</h2>
                        <form id="investor-performance-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="performance-month">Month</label>
                                <select id="performance-month" class="admin-form-input" required>
                                    <option value="">Select Month</option>
                                    <option value="January">January</option>
                                    <option value="February">February</option>
                                    <option value="March">March</option>
                                    <option value="April">April</option>
                                    <option value="May">May</option>
                                    <option value="June">June</option>
                                    <option value="July">July</option>
                                    <option value="August">August</option>
                                    <option value="September">September</option>
                                    <option value="October">October</option>
                                    <option value="November">November</option>
                                    <option value="December">December</option>
                                </select>
                            </div>
                            <div class="admin-form-group">
                                <label for="performance-year">Year</label>
                                <input type="number" id="performance-year" class="admin-form-input" min="2020" max="2030" value="2024" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="performance-growth">Return % (Actual monthly return)</label>
                                <input type="number" id="performance-growth" class="admin-form-input" step="0.01" required>
                                <span style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; display: block;">Enter the actual return percentage for this month. All calculations will use this value.</span>
                            </div>
                            <div class="admin-form-group">
                                <label for="performance-withdrawals">Withdrawals (â‚¬)</label>
                                <input type="number" id="performance-withdrawals" class="admin-form-input" step="0.01" value="0" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="performance-withdrawal-date">Withdrawal Date</label>
                                <input type="date" id="performance-withdrawal-date" class="admin-form-input">
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="cancel-investor-performance">Cancel</button>
                                <button type="submit" class="admin-btn-save">Add Performance</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Funded Account Performance Table Modal -->
            <div id="investor-performance-table-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container" style="max-width: 900px;">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="investor-performance-table-title">Performance History</h2>
                        <div class="performance-table-container">
                            <table class="transactions-table">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Starting Balance</th>
                                        <th>Ending Balance of Month</th>
                                        <th>Growth %</th>
                                        <th>Withdrawals</th>
                                    </tr>
                                </thead>
                                <tbody id="investor-performance-table-body">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Funded Account Edit/Add Modal -->
            <div id="investor-edit-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container" style="max-width: 600px;">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="investor-modal-title">Edit Funded Account</h2>
                        <form id="investor-edit-form" class="admin-modal-form">
                            <div class="admin-form-group">
                                <label for="edit-investor-name">Full Name</label>
                                <input type="text" id="edit-investor-name" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-email">Email Address</label>
                                <input type="email" id="edit-investor-email" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-phone">Phone Number</label>
                                <input type="tel" id="edit-investor-phone" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-account">Account Number</label>
                                <input type="text" id="edit-investor-account" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-initial">Initial Investment (â‚¬)</label>
                                <input type="number" id="edit-investor-initial" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-balance">Current Balance (â‚¬)</label>
                                <input type="number" id="edit-investor-balance" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-investor-status">Account Status</label>
                                <select id="edit-investor-status" class="admin-form-input" required>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Suspended">Suspended</option>
                                </select>
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="cancel-investor-edit">Cancel</button>
                                <button type="submit" class="admin-btn-save">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Account Settings View -->
            <div class="account-settings-view" id="account-settings-view" style="display: none;">
                <div class="account-settings-content">
                    <div class="users-list-container">
                        <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="margin: 0; font-size: 1.5rem; color: #1f2937;">Account Management</h2>
                            <button class="admin-btn-add" onclick="openAddUserModal()" style="padding: 0.75rem 1.5rem; font-size: 1rem;">+ Add New Account</button>
                        </div>
                        <div class="users-grid" id="users-grid">
                            <!-- Admin widget will be added first, then users -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Edit Modal -->
            <div id="user-edit-modal" class="admin-modal" style="display: none;">
                <div class="admin-modal-overlay"></div>
                <div class="admin-modal-container" style="max-width: 700px;">
                    <button class="admin-modal-close" aria-label="Close modal">&times;</button>
                    <div class="admin-modal-content">
                        <h2 class="admin-modal-title" id="user-modal-title">Edit Account</h2>
                        <form id="user-edit-form" class="admin-modal-form">
                            <h3 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem; color: #1f2937;">Account Information</h3>
                            <div class="admin-form-group">
                                <label for="edit-user-name">Title</label>
                                <input type="text" id="edit-user-name" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-user-email">Email Address</label>
                                <input type="email" id="edit-user-email" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-user-account">Account Number</label>
                                <input type="text" id="edit-user-account" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-user-status">Account Status</label>
                                <select id="edit-user-status" class="admin-form-input" required>
                                    <option value="Phase 1">Phase 1</option>
                                    <option value="Phase 2">Phase 2</option>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-user-member-since">Initiation Date</label>
                                <input type="date" id="edit-user-member-since" class="admin-form-input" required>
                            </div>

                            <h3 style="margin-top: 2rem; margin-bottom: 1rem; font-size: 1.1rem; color: #1f2937;">Investment Details</h3>
                            <div class="admin-form-group">
                                <label for="edit-user-initial">Initial Investment (â‚¬)</label>
                                <input type="number" id="edit-user-initial" class="admin-form-input" step="0.01" required>
                            </div>
                            <div class="admin-form-group">
                                <label for="edit-user-strategy">Investment Strategy</label>
                                <input type="text" id="edit-user-strategy" class="admin-form-input" required>
                            </div>
                            <div class="admin-form-actions">
                                <button type="button" class="admin-btn-cancel" id="cancel-user-edit">Cancel</button>
                                <button type="button" class="admin-btn-delete" id="delete-user-btn" style="display: none; background-color: #dc2626; color: white; margin-right: auto; padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">Delete Account</button>
                                <button type="submit" class="admin-btn-save">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>


        </div>
    </section>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
    
    <!-- Firebase Configuration and Service -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD9DvEzXUxUppgsp71H5d3abPKWkjkea6A",
            authDomain: "opessocius-17ab9.firebaseapp.com",
            projectId: "opessocius-17ab9",
            storageBucket: "opessocius-17ab9.firebasestorage.app",
            messagingSenderId: "835445796116",
            appId: "1:835445796116:web:71b8595886ecb53e612601",
            measurementId: "G-44CX9N3E3J"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Initialize services
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();
        const analytics = firebase.analytics();
        
        // Make available globally
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firebaseStorage = storage;
        window.firebaseAnalytics = analytics;
        window.firebase = firebase;
    </script>
    
    <script src="script.js"></script>
    <script src="firestore-service-admin2.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation handling
            const navItems = document.querySelectorAll('.sidebar-nav-item');
            const dashboardView = document.getElementById('dashboard-view');
            const portfolioView = document.getElementById('portfolio-view');
            const transactionsView = document.getElementById('transactions-view');
            const performanceView = document.getElementById('performance-view');

            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Get text from span element
                    const span = this.querySelector('span');
                    const navText = span ? span.textContent.trim() : this.textContent.trim();
                    
                    // Remove active class from all items
                    navItems.forEach(nav => nav.classList.remove('active'));
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Get all views
                    const accountSettingsView = document.getElementById('account-settings-view');
                    
                    // Hide all views
                    if (dashboardView) dashboardView.style.display = 'none';
                    if (portfolioView) portfolioView.style.display = 'none';
                    if (transactionsView) transactionsView.style.display = 'none';
                    if (performanceView) performanceView.style.display = 'none';
                    if (accountSettingsView) accountSettingsView.style.display = 'none';
                    
                    // Show selected view
                    if (navText === 'Dashboard' && dashboardView) {
                        dashboardView.style.display = 'block';
                        // Load transactions first, then update dashboard metrics
                        populateTransactionsTable().then(() => {
                            updateDashboardMetrics();
                            loadTopAccounts();
                        }).catch(() => {
                            loadTopAccounts();
                        });
                    } else if (navText === 'Portfolio' && portfolioView) {
                        portfolioView.style.display = 'block';
                        // Load transactions first, then update metrics and chart
                        populateTransactionsTable().then(() => {
                            updatePortfolioMetrics();
                            setTimeout(() => {
                                drawPortfolioChart();
                            }, 100);
                        }).catch(() => {
                            setTimeout(() => {
                                drawPortfolioChart();
                            }, 100);
                        });
                    } else if (navText === 'Transactions' && transactionsView) {
                        transactionsView.style.display = 'block';
                        populateTransactionsTable();
                    } else if (navText === 'Performance' && performanceView) {
                        performanceView.style.display = 'block';
                        loadInvestorsList();
                    } else if (navText === 'Account Settings' && accountSettingsView) {
                        accountSettingsView.style.display = 'block';
                        loadUsersList();
                    }
                });
            });

            // Portfolio Chart Function
            let chartDataPoints = [];
            
            function drawPortfolioChart() {
                const canvas = document.getElementById('portfolio-chart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const container = canvas.parentElement;
                const width = container ? container.clientWidth - 64 : 800;
                const height = 480;
                
                // Set canvas size
                canvas.width = width;
                canvas.height = height;
                
                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                
                // Chart configuration
                const padding = { top: 40, right: 40, bottom: 60, left: 80 };
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;
                
                // Get historical data from transactionData
                let historicalData = [];
                let initialInvestment = 0;
                
                if (transactionData && transactionData.length > 0) {
                    // Use actual transaction data - show final balance (ending balance - withdrawals)
                    initialInvestment = transactionData[0].starting;
                    
                    // Calculate final balance for each entry: ending balance - withdrawals
                    historicalData = transactionData.map(entry => {
                        const finalBalance = entry.ending - (entry.withdrawals || 0);
                        return finalBalance;
                    });
                } else {
                    // Default fallback data
                    initialInvestment = 8500000;
                    historicalData = [
                        8500000, 8700000, 8800000, 8950000, 9100000, 9250000, 9400000, 9550000, 9750000, 9950000, 10150000, 10350000
                    ];
                }
                
                // Calculate projection data based on average growth
                let projectionData = [];
                const lastHistoricalValue = historicalData[historicalData.length - 1];
                
                if (transactionData && transactionData.length > 1) {
                    // Calculate average monthly growth rate
                    let totalGrowth = 0;
                    let growthCount = 0;
                    transactionData.forEach(entry => {
                        if (entry.growth && entry.growth !== 0) {
                            totalGrowth += entry.growth;
                            growthCount++;
                        }
                    });
                    
                    const avgMonthlyGrowth = growthCount > 0 ? (totalGrowth / growthCount) / 100 : 0.02;
                    
                    // Project 12 months forward
                    let projectionValue = lastHistoricalValue;
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * (1 + avgMonthlyGrowth);
                        projectionData.push(projectionValue);
                    }
                } else {
                    // Default projection (2% monthly growth)
                    let projectionValue = lastHistoricalValue;
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * 1.02;
                        projectionData.push(projectionValue);
                    }
                }
                
                // Month labels for chart
                const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const totalMonths = historicalData.length + projectionData.length;
                const months = [];
                
                // Generate month labels based on actual data
                if (transactionData && transactionData.length > 0) {
                    // Only add transaction months (one label per transaction entry)
                    transactionData.forEach((entry) => {
                        const monthAbbr = entry.month.substring(0, 3);
                        const monthIndex = monthLabels.indexOf(monthAbbr);
                        if (monthIndex >= 0) {
                            months.push(monthLabels[monthIndex]);
                        } else {
                            months.push(monthAbbr);
                        }
                    });
                    
                    // Add projection months (12 months forward from last transaction)
                    const lastTransactionMonth = transactionData[transactionData.length - 1].month.substring(0, 3);
                    const lastMonthIndex = monthLabels.indexOf(lastTransactionMonth);
                    let currentMonthIndex = (lastMonthIndex + 1) % 12; // Start from next month
                    for (let i = 0; i < 12; i++) {
                        months.push(monthLabels[currentMonthIndex]);
                        currentMonthIndex = (currentMonthIndex + 1) % 12;
                    }
                } else {
                    // Default labels
                    months.push(...monthLabels, ...monthLabels);
                }
                
                // Combine data
                const allData = [...historicalData, ...projectionData];
                const maxValue = Math.max(...allData) * 1.1;
                const minValue = Math.min(...allData) * 0.9;
                const valueRange = maxValue - minValue;
                
                // Store data points for hover interaction - only for transaction entries
                chartDataPoints = [];
                
                // Historical data points (transaction entries only)
                historicalData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    // Use the growth percentage directly from transactionData - exactly as stored, no calculations
                    // This matches exactly how the transactions table displays it: growth.toFixed(2)
                    // The growth value is stored as a number (e.g., 5.5 for 5.5%), same as in transactions table
                    const growth = transactionData && transactionData[index] ? (transactionData[index].growth || 0) : 0;
                    const growthValue = parseFloat(growth);
                    const growthPercent = growthValue.toFixed(2);
                    chartDataPoints.push({
                        x: x,
                        y: y,
                        value: value,
                        month: months[index] || `M${index + 1}`,
                        growthPercent: growthPercent,
                        growthValue: growthValue, // Store the numeric value for sign calculation
                        isHistorical: true
                    });
                });
                
                // Projection data points
                projectionData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (historicalData.length + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    const growthPercent = ((value - initialInvestment) / initialInvestment * 100).toFixed(2);
                    chartDataPoints.push({
                        x: x,
                        y: y,
                        value: value,
                        month: months[historicalData.length + index] || `P${index + 1}`,
                        growthPercent: growthPercent,
                        isHistorical: false
                    });
                });
                
                // Draw grid lines
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 5; i++) {
                    const y = padding.top + (chartHeight / 5) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding.left, y);
                    ctx.lineTo(width - padding.right, y);
                    ctx.stroke();
                }
                
                // Draw area fill below the line (only historical section with gradient)
                if (historicalData.length > 0) {
                    const gradient = ctx.createLinearGradient(
                        padding.left, 
                        padding.top, 
                        padding.left + (chartWidth / totalMonths) * historicalData.length, 
                        padding.top + chartHeight
                    );
                    gradient.addColorStop(0, 'rgba(37, 99, 235, 0.25)');
                    gradient.addColorStop(1, 'rgba(37, 99, 235, 0.05)');
                    
                    ctx.beginPath();
                    const firstX = padding.left + (chartWidth / totalMonths) / 2;
                    const firstY = padding.top + chartHeight - ((historicalData[0] - minValue) / valueRange) * chartHeight;
                    ctx.moveTo(firstX, height - padding.bottom);
                    ctx.lineTo(firstX, firstY);
                    
                    // Historical area only
                    historicalData.forEach((value, index) => {
                        const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                        const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                        ctx.lineTo(x, y);
                    });
                    
                    // Close at the last historical point
                    const lastHistoricalIndex = historicalData.length - 1;
                    const lastHistoricalX = padding.left + (chartWidth / totalMonths) * lastHistoricalIndex + (chartWidth / totalMonths) / 2;
                    ctx.lineTo(lastHistoricalX, height - padding.bottom);
                    ctx.closePath();
                    ctx.fillStyle = gradient;
                    ctx.fill();
                }
                
                // Draw historical line
                if (historicalData.length > 0) {
                    ctx.beginPath();
                    ctx.strokeStyle = '#2563eb';
                    ctx.lineWidth = 2.5;
                    historicalData.forEach((value, index) => {
                        const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                        const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                        
                        if (index === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    ctx.stroke();
                }
                
                // Draw projection line (dashed, green, continuing from historical)
                if (projectionData.length > 0 && historicalData.length > 0) {
                    ctx.beginPath();
                    ctx.strokeStyle = '#10b981';
                    ctx.lineWidth = 2.5;
                    ctx.setLineDash([6, 4]);
                    projectionData.forEach((value, index) => {
                        const x = padding.left + (chartWidth / totalMonths) * (historicalData.length + index) + (chartWidth / totalMonths) / 2;
                        const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                        
                        if (index === 0) {
                            // Connect to last historical point
                            const lastHistX = padding.left + (chartWidth / totalMonths) * (historicalData.length - 1) + (chartWidth / totalMonths) / 2;
                            const lastHistY = padding.top + chartHeight - ((historicalData[historicalData.length - 1] - minValue) / valueRange) * chartHeight;
                            ctx.moveTo(lastHistX, lastHistY);
                        }
                        ctx.lineTo(x, y);
                    });
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
                
                // Draw data points - only for transaction entries (one dot per transaction)
                historicalData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = '#2563eb';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                });
                
                // Draw projection data points
                projectionData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (historicalData.length + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = '#10b981';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                });
                
                // Draw Y-axis labels
                ctx.fillStyle = '#6b7280';
                ctx.font = '12px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                for (let i = 0; i <= 5; i++) {
                    const value = minValue + (valueRange / 5) * (5 - i);
                    const y = padding.top + (chartHeight / 5) * i;
                    const formattedValue = 'â‚¬' + (value / 1000).toFixed(0) + 'k';
                    ctx.fillText(formattedValue, padding.left - 10, y);
                }
                
                // Draw X-axis labels
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                const labelInterval = Math.max(1, Math.floor(totalMonths / 12)); // Show approximately 12 labels
                for (let i = 0; i < totalMonths; i += labelInterval) {
                    const x = padding.left + (chartWidth / totalMonths) * i + (chartWidth / totalMonths) / 2;
                    if (months[i]) {
                        ctx.fillText(months[i], x, height - padding.bottom + 10);
                    }
                }
            }
            
            // Add hover tooltip functionality
            function setupChartHover() {
                const canvas = document.getElementById('portfolio-chart');
                const tooltip = document.getElementById('chart-tooltip');
                if (!canvas || !tooltip) return;
                
                canvas.addEventListener('mousemove', function(e) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Find nearest data point
                    let nearestPoint = null;
                    let minDistance = Infinity;
                    
                    chartDataPoints.forEach(point => {
                        const distance = Math.sqrt(Math.pow(x - point.x, 2) + Math.pow(y - point.y, 2));
                        if (distance < 30 && distance < minDistance) {
                            minDistance = distance;
                            nearestPoint = point;
                        }
                    });
                    
                    if (nearestPoint) {
                        const formattedValue = 'â‚¬' + nearestPoint.value.toLocaleString('en-US');
                        // Match the exact format from transactions table: ${growthValue >= 0 ? '+' : ''}${growth.toFixed(2)}%
                        const growthValue = nearestPoint.growthValue !== undefined ? nearestPoint.growthValue : parseFloat(nearestPoint.growthPercent);
                        const growthSign = growthValue >= 0 ? '+' : '';
                        const growthDisplay = growthValue.toFixed(2);
                        tooltip.innerHTML = `
                            <div class="tooltip-balance">${formattedValue}</div>
                            <div class="tooltip-growth">${growthSign}${growthDisplay}%</div>
                        `;
                        tooltip.style.display = 'block';
                        tooltip.style.left = (nearestPoint.x + 10) + 'px';
                        tooltip.style.top = (nearestPoint.y - 40) + 'px';
                    } else {
                        tooltip.style.display = 'none';
                    }
                });
                
                canvas.addEventListener('mouseleave', function() {
                    if (tooltip) tooltip.style.display = 'none';
                });
            }
            
            // Setup hover after chart is drawn
            setTimeout(setupChartHover, 150);

            // Store transaction data globally for editing
            let transactionData = [];
            
            // Admin2 Fund Performance Firestore Functions
            const ADMIN2_FUND_PERFORMANCE_COLLECTION = 'admin2FundPerformance';
            
            // Save admin2 fund performance to Firestore
            async function saveAdmin2FundPerformance(performanceData) {
                try {
                    const monthIndex = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'].indexOf(performanceData.month);
                    
                    const docData = {
                        month: performanceData.month,
                        year: performanceData.year,
                        monthIndex: monthIndex,
                        startingBalance: performanceData.starting,
                        endingBalance: performanceData.ending,
                        growth: performanceData.growth,
                        deposits: performanceData.deposits || 0,
                        withdrawals: performanceData.withdrawals || 0,
                        depositDate: performanceData.depositDate ? firebase.firestore.Timestamp.fromDate(new Date(performanceData.depositDate)) : null,
                        withdrawalDate: performanceData.withdrawalDate ? firebase.firestore.Timestamp.fromDate(new Date(performanceData.withdrawalDate)) : null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Check if entry exists for this month/year
                    const db = window.firebaseDb || firebase.firestore();
                    const querySnapshot = await db.collection(ADMIN2_FUND_PERFORMANCE_COLLECTION)
                        .where('month', '==', performanceData.month)
                        .where('year', '==', performanceData.year)
                        .get();
                    
                    if (!querySnapshot.empty) {
                        // Update existing document
                        const docId = querySnapshot.docs[0].id;
                        await db.collection(ADMIN2_FUND_PERFORMANCE_COLLECTION).doc(docId).update({
                            ...docData,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        return docId;
                    } else {
                        // Create new document
                        const docRef = await db.collection(ADMIN2_FUND_PERFORMANCE_COLLECTION).add(docData);
                        return docRef.id;
                    }
                } catch (error) {
                    console.error('Error saving admin2 fund performance:', error);
                    throw error;
                }
            }
            
            // Load admin2 fund performance from Firestore
            async function loadAdmin2FundPerformance() {
                try {
                    const db = window.firebaseDb || firebase.firestore();
                    const snapshot = await db.collection(ADMIN2_FUND_PERFORMANCE_COLLECTION)
                        .orderBy('year', 'asc')
                        .orderBy('monthIndex', 'asc')
                        .get();
                    
                    const performanceData = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        performanceData.push({
                            id: doc.id,
                            month: data.month,
                            year: data.year,
                            starting: data.startingBalance,
                            ending: data.endingBalance,
                            growth: data.growth,
                            deposits: data.deposits || 0,
                            withdrawals: data.withdrawals || 0,
                            depositDate: data.depositDate ? data.depositDate.toDate().toISOString().split('T')[0] : null,
                            withdrawalDate: data.withdrawalDate ? data.withdrawalDate.toDate().toISOString().split('T')[0] : null
                        });
                    });
                    
                    return performanceData;
                } catch (error) {
                    console.error('Error loading admin2 fund performance:', error);
                    // If ordering fails, load all and sort in JavaScript
                    try {
                        const db = window.firebaseDb || firebase.firestore();
                        const snapshot = await db.collection(ADMIN2_FUND_PERFORMANCE_COLLECTION).get();
                        const performanceData = [];
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            performanceData.push({
                                id: doc.id,
                                month: data.month,
                                year: data.year,
                                starting: data.startingBalance,
                                ending: data.endingBalance,
                                growth: data.growth,
                                deposits: data.deposits || 0,
                                withdrawals: data.withdrawals || 0,
                                depositDate: data.depositDate ? data.depositDate.toDate().toISOString().split('T')[0] : null,
                                withdrawalDate: data.withdrawalDate ? data.withdrawalDate.toDate().toISOString().split('T')[0] : null
                            });
                        });
                        
                        // Sort in JavaScript
                        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                        performanceData.sort((a, b) => {
                            const yearDiff = a.year - b.year;
                            if (yearDiff !== 0) return yearDiff;
                            return months.indexOf(a.month) - months.indexOf(b.month);
                        });
                        
                        return performanceData;
                    } catch (fallbackError) {
                        console.error('Error in fallback load:', fallbackError);
                        return [];
                    }
                }
            }
            
            // Update admin2 fund performance in Firestore
            async function updateAdmin2FundPerformance(docId, performanceData) {
                try {
                    const db = window.firebaseDb || firebase.firestore();
                    const monthIndex = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'].indexOf(performanceData.month);
                    
                    await db.collection(ADMIN2_FUND_PERFORMANCE_COLLECTION).doc(docId).update({
                        month: performanceData.month,
                        year: performanceData.year,
                        monthIndex: monthIndex,
                        startingBalance: performanceData.starting,
                        endingBalance: performanceData.ending,
                        growth: performanceData.growth,
                        deposits: performanceData.deposits || 0,
                        withdrawals: performanceData.withdrawals || 0,
                        depositDate: performanceData.depositDate ? firebase.firestore.Timestamp.fromDate(new Date(performanceData.depositDate)) : null,
                        withdrawalDate: performanceData.withdrawalDate ? firebase.firestore.Timestamp.fromDate(new Date(performanceData.withdrawalDate)) : null,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error updating admin2 fund performance:', error);
                    throw error;
                }
            }
            
            // Delete admin2 fund performance from Firestore
            async function deleteAdmin2FundPerformance(docId) {
                try {
                    const db = window.firebaseDb || firebase.firestore();
                    await db.collection(ADMIN2_FUND_PERFORMANCE_COLLECTION).doc(docId).delete();
                    console.log('Admin2 fund performance deleted successfully');
                } catch (error) {
                    console.error('Error deleting admin2 fund performance:', error);
                    throw error;
                }
            }
            
            // Transactions Table Population
            async function populateTransactionsTable() {
                const tableBody = document.getElementById('transactions-table-body');
                if (!tableBody) return Promise.resolve();

                // Load from Firestore
                try {
                    transactionData = await loadAdmin2FundPerformance();
                    
                    // If no data exists, initialize with empty array (no default data)
                    if (transactionData.length === 0) {
                        transactionData = [];
                    }
                } catch (error) {
                    console.error('Error loading transactions:', error);
                    transactionData = [];
                }

                tableBody.innerHTML = '';

                if (transactionData.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="7" style="text-align: center; padding: 2rem; color: #6b7280;">No performance data available. Add your first performance entry above.</td>';
                    tableBody.appendChild(row);
                } else {
                    transactionData.forEach((data, index) => {
                        const startingBalance = data.starting;
                        const endingBalance = data.ending;
                        const growth = data.growth;
                        const growthValue = parseFloat(growth);
                        const monthYear = `${data.month} ${data.year}`;
                        
                        const row = document.createElement('tr');
                        row.setAttribute('data-index', index);
                        row.setAttribute('data-id', data.id || '');
                        
                        // Format dates
                        const depositDisplay = data.deposits > 0 && data.depositDate 
                            ? `â‚¬${data.deposits.toLocaleString('en-US')}<br><span class="transaction-date">${formatDate(data.depositDate)}</span>`
                            : data.deposits > 0 ? `â‚¬${data.deposits.toLocaleString('en-US')}` : '-';
                        
                        const withdrawalDisplay = data.withdrawals > 0 && data.withdrawalDate 
                            ? `â‚¬${data.withdrawals.toLocaleString('en-US')}<br><span class="transaction-date">${formatDate(data.withdrawalDate)}</span>`
                            : data.withdrawals > 0 ? `â‚¬${data.withdrawals.toLocaleString('en-US')}` : '-';

                        const finalBalance = endingBalance - (data.withdrawals || 0);
                        
                        row.innerHTML = `
                            <td>${monthYear}</td>
                            <td>â‚¬${startingBalance.toLocaleString('en-US')}</td>
                            <td>â‚¬${endingBalance.toLocaleString('en-US')}</td>
                            <td class="${growthValue >= 0 ? 'growth-positive' : 'growth-negative'}">${growthValue >= 0 ? '+' : ''}${growth.toFixed(2)}%</td>
                            <td class="transaction-cell">${depositDisplay}</td>
                            <td class="transaction-cell">${withdrawalDisplay}</td>
                            <td><button class="admin-edit-btn" data-index="${index}">Edit</button></td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                    // Add edit button handlers
                    document.querySelectorAll('.admin-edit-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const index = parseInt(this.getAttribute('data-index'));
                            openTransactionEditModal(index);
                        });
                    });
                }
                
                // Update Portfolio section after loading transactions
                updatePortfolioMetrics();
                
                // Update Dashboard metrics if dashboard is visible
                const dashboardView = document.getElementById('dashboard-view');
                if (dashboardView && dashboardView.style.display !== 'none') {
                    updateDashboardMetrics();
                }
            }
            
            // Transaction Edit Modal Functions
            function openTransactionEditModal(index) {
                const data = transactionData[index];
                const modal = document.getElementById('transaction-edit-modal');
                document.getElementById('edit-starting-balance').value = data.starting;
                document.getElementById('edit-ending-balance').value = data.ending;
                document.getElementById('edit-deposits').value = data.deposits || 0;
                document.getElementById('edit-withdrawals').value = data.withdrawals || 0;
                document.getElementById('edit-deposit-date').value = data.depositDate || '';
                document.getElementById('edit-withdrawal-date').value = data.withdrawalDate || '';
                // Auto-calculate growth percentage using the correct formula
                updateEditGrowthPercentage();
                modal.setAttribute('data-edit-index', index);
                modal.setAttribute('data-transaction-id', data.id || '');
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function closeTransactionEditModal() {
                const modal = document.getElementById('transaction-edit-modal');
                modal.style.display = 'none';
                modal.removeAttribute('data-edit-index');
                modal.removeAttribute('data-transaction-id');
                document.body.style.overflow = '';
            }
            
            // Delete transaction handler
            const deleteTransactionBtn = document.getElementById('delete-transaction-btn');
            if (deleteTransactionBtn) {
                deleteTransactionBtn.addEventListener('click', async function() {
                    const modal = document.getElementById('transaction-edit-modal');
                    const transactionId = modal.getAttribute('data-transaction-id');
                    const index = parseInt(modal.getAttribute('data-edit-index'));
                    
                    if (!transactionId) {
                        alert('Cannot delete: Transaction ID not found.');
                        return;
                    }
                    
                    if (!confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
                        return;
                    }
                    
                    try {
                        // Disable button during deletion
                        this.disabled = true;
                        this.textContent = 'Deleting...';
                        
                        // Delete from Firestore
                        await deleteAdmin2FundPerformance(transactionId);
                        
                        // Close modal
                        closeTransactionEditModal();
                        
                        // Reload transactions table
                        await populateTransactionsTable();
                        
                        // Update portfolio chart if Portfolio view is visible
                        const portfolioView = document.getElementById('portfolio-view');
                        if (portfolioView && portfolioView.style.display !== 'none') {
                            setTimeout(() => {
                                drawPortfolioChart();
                            }, 100);
                        }
                        
                        alert('Transaction deleted successfully!');
                    } catch (error) {
                        console.error('Error deleting transaction:', error);
                        alert('Error deleting transaction. Please try again.');
                    } finally {
                        this.disabled = false;
                        this.textContent = 'Delete Transaction';
                    }
                });
            }
            
            // Transaction edit form handler
            const transactionEditForm = document.getElementById('transaction-edit-form');
            if (transactionEditForm) {
                transactionEditForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Disable submit button
                    const submitBtn = transactionEditForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Saving...';
                    
                    try {
                        const index = parseInt(document.getElementById('transaction-edit-modal').getAttribute('data-edit-index'));
                        const transactionId = document.getElementById('transaction-edit-modal').getAttribute('data-transaction-id');
                        const data = transactionData[index];
                        
                        const updatedEntry = {
                            month: data.month,
                            year: data.year,
                            starting: parseFloat(document.getElementById('edit-starting-balance').value),
                            ending: parseFloat(document.getElementById('edit-ending-balance').value),
                            growth: parseFloat(document.getElementById('edit-growth').value),
                            deposits: parseFloat(document.getElementById('edit-deposits').value) || 0,
                            withdrawals: parseFloat(document.getElementById('edit-withdrawals').value) || 0,
                            depositDate: document.getElementById('edit-deposit-date').value || null,
                            withdrawalDate: document.getElementById('edit-withdrawal-date').value || null
                        };
                        
                        if (transactionId) {
                            // Update existing transaction
                            await updateAdmin2FundPerformance(transactionId, updatedEntry);
                        } else {
                            // Save as new transaction
                            await saveAdmin2FundPerformance(updatedEntry);
                        }
                        
                        // Reload transactions table
                        await populateTransactionsTable();
                        
                        // Update portfolio chart if Portfolio view is visible
                        const portfolioView = document.getElementById('portfolio-view');
                        if (portfolioView && portfolioView.style.display !== 'none') {
                            setTimeout(() => {
                                drawPortfolioChart();
                            }, 100);
                        }
                        
                        // Update dashboard if visible
                        const dashboardView = document.getElementById('dashboard-view');
                        if (dashboardView && dashboardView.style.display !== 'none') {
                            updateDashboardMetrics();
                        }
                        
                        closeTransactionEditModal();
                        // Transaction updated successfully (no popup)
                    } catch (error) {
                        console.error('Error updating transaction:', error);
                        alert('Error updating transaction. Please try again.');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
            
            // Auto-calculate growth percentage for edit form
            function updateEditGrowthPercentage() {
                const starting = parseFloat(document.getElementById('edit-starting-balance').value) || 0;
                const ending = parseFloat(document.getElementById('edit-ending-balance').value) || 0;
                const deposits = parseFloat(document.getElementById('edit-deposits').value) || 0;
                const withdrawals = parseFloat(document.getElementById('edit-withdrawals').value) || 0;
                
                if (starting > 0) {
                    const growth = calculateGrowthPercentage(starting, ending, deposits, withdrawals);
                    document.getElementById('edit-growth').value = growth.toFixed(2);
                }
            }
            
            // Calculate growth percentage
            function calculateGrowthPercentage(starting, ending, deposits, withdrawals) {
                if (starting <= 0) return 0;
                // Growth = ((Ending - Starting - Deposits + Withdrawals) / Starting) * 100
                const netChange = ending - starting - deposits + withdrawals;
                return (netChange / starting) * 100;
            }
            
            // Add event listeners for auto-calculation
            const editStartingBalance = document.getElementById('edit-starting-balance');
            const editEndingBalance = document.getElementById('edit-ending-balance');
            const editDeposits = document.getElementById('edit-deposits');
            const editWithdrawals = document.getElementById('edit-withdrawals');
            
            if (editStartingBalance) editStartingBalance.addEventListener('input', updateEditGrowthPercentage);
            if (editEndingBalance) editEndingBalance.addEventListener('input', updateEditGrowthPercentage);
            if (editDeposits) editDeposits.addEventListener('input', updateEditGrowthPercentage);
            if (editWithdrawals) editWithdrawals.addEventListener('input', updateEditGrowthPercentage);
            
            // Close transaction modal handlers
            const transactionModal = document.getElementById('transaction-edit-modal');
            if (transactionModal) {
                transactionModal.querySelector('.admin-modal-close')?.addEventListener('click', closeTransactionEditModal);
                transactionModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeTransactionEditModal);
                document.getElementById('cancel-transaction-edit')?.addEventListener('click', closeTransactionEditModal);
            }
            
            // Auto-calculate growth percentage for fund performance form
            function updateFundGrowthPercentage() {
                const starting = parseFloat(document.getElementById('fund-starting-balance').value) || 0;
                const ending = parseFloat(document.getElementById('fund-ending-balance').value) || 0;
                const deposits = parseFloat(document.getElementById('fund-deposits').value) || 0;
                const withdrawals = parseFloat(document.getElementById('fund-withdrawals').value) || 0;
                
                if (starting > 0) {
                    const growth = calculateGrowthPercentage(starting, ending, deposits, withdrawals);
                    document.getElementById('fund-growth').value = growth.toFixed(2);
                }
            }
            
            const fundStartingBalance = document.getElementById('fund-starting-balance');
            const fundEndingBalance = document.getElementById('fund-ending-balance');
            const fundDeposits = document.getElementById('fund-deposits');
            const fundWithdrawals = document.getElementById('fund-withdrawals');
            
            if (fundStartingBalance) fundStartingBalance.addEventListener('input', updateFundGrowthPercentage);
            if (fundEndingBalance) fundEndingBalance.addEventListener('input', updateFundGrowthPercentage);
            if (fundDeposits) fundDeposits.addEventListener('input', updateFundGrowthPercentage);
            if (fundWithdrawals) fundWithdrawals.addEventListener('input', updateFundGrowthPercentage);
            
            // Fund Performance Form Handler
            const fundPerformanceForm = document.getElementById('fund-performance-form');
            if (fundPerformanceForm) {
                fundPerformanceForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Disable submit button to prevent double submission
                    const submitBtn = fundPerformanceForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Saving...';
                    
                    try {
                        const month = document.getElementById('fund-month').value;
                        const year = parseInt(document.getElementById('fund-year').value);
                        const starting = parseFloat(document.getElementById('fund-starting-balance').value);
                        const ending = parseFloat(document.getElementById('fund-ending-balance').value);
                        const deposits = parseFloat(document.getElementById('fund-deposits').value) || 0;
                        const withdrawals = parseFloat(document.getElementById('fund-withdrawals').value) || 0;
                        // Auto-calculate growth if not manually overridden
                        let growth = parseFloat(document.getElementById('fund-growth').value);
                        if (isNaN(growth) || growth === 0) {
                            growth = calculateGrowthPercentage(starting, ending, deposits, withdrawals);
                        }
                        
                        const depositDate = document.getElementById('fund-deposit-date').value || (deposits > 0 ? new Date().toISOString().split('T')[0] : null);
                        const withdrawalDate = document.getElementById('fund-withdrawal-date').value || (withdrawals > 0 ? new Date().toISOString().split('T')[0] : null);
                        
                        const newEntry = {
                            month: month,
                            year: year,
                            starting: starting,
                            ending: ending,
                            growth: growth,
                            deposits: deposits,
                            withdrawals: withdrawals,
                            depositDate: depositDate,
                            withdrawalDate: withdrawalDate
                        };
                        
                        // Save to Firestore
                        await saveAdmin2FundPerformance(newEntry);
                        
                        // Reload transactions table
                        await populateTransactionsTable();
                        
                        // Update portfolio chart if Portfolio view is visible
                        const portfolioView = document.getElementById('portfolio-view');
                        if (portfolioView && portfolioView.style.display !== 'none') {
                            setTimeout(() => {
                                drawPortfolioChart();
                            }, 100);
                        }
                        
                        // Update dashboard if visible
                        const dashboardView = document.getElementById('dashboard-view');
                        if (dashboardView && dashboardView.style.display !== 'none') {
                            updateDashboardMetrics();
                        }
                        
                        // Reset form
                        fundPerformanceForm.reset();
                        document.getElementById('fund-year').value = new Date().getFullYear();
                        
                        // Fund performance saved successfully (no popup)
                    } catch (error) {
                        console.error('Error saving fund performance:', error);
                        alert('Error saving fund performance. Please try again.');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }

            function formatDate(dateString) {
                const date = new Date(dateString);
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            }

            // Performance Chart Function
            let performanceDataPoints = [];
            
            function drawPerformanceChart() {
                const canvas = document.getElementById('performance-chart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const container = canvas.parentElement;
                const width = container ? container.clientWidth - 64 : 800;
                const height = 700;
                
                // Set canvas size
                canvas.width = width;
                canvas.height = height;
                
                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                
                // Chart configuration
                const padding = { top: 80, right: 40, bottom: 60, left: 80 };
                const chartWidth = width - padding.left - padding.right;
                const chartHeight = height - padding.top - padding.bottom;
                
                const months = ['Start', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec',
                              'Jan', 'Feb', 'Mar', 'Apr'];
                
                // Use actual account balance values (not normalized)
                const initialInvestment = 230000;
                
                // Historical data (12 months) - actual account balances - with Month 0
                // All lines start from the exact same initial investment
                const opessociusHistorical = [
                    initialInvestment,  // Month 0 - exact same starting balance as S&P 500 and Banks
                    235000, 238000, 242000, 245000, 248000, 252000, 255000, 260000, 265000, 270000, 275000, 280000
                ];
                
                // Projection data (4 months) - fixed values (2% compound growth per month for Opessocius)
                const lastHistoricalValue = opessociusHistorical[12];
                const projectionData = [
                    lastHistoricalValue * 1.02,
                    lastHistoricalValue * 1.02 * 1.02,
                    lastHistoricalValue * 1.02 * 1.02 * 1.02,
                    lastHistoricalValue * 1.02 * 1.02 * 1.02 * 1.02
                ];
                
                // S&P 500 monthly returns (%): +2.3%, âˆ’1.4%, +3.1%, +0.6%, âˆ’2.8%, +4.5%, +1.2%, âˆ’3.6%, +2.9%, +0.4%, +5.1%, âˆ’1.9%, +1.7%, +3.8%, âˆ’0.7%, +2.5%
                const sp500MonthlyReturns = [
                    2.3, -1.4, 3.1, 0.6, -2.8, 4.5, 1.2, -3.6, 2.9, 0.4, 5.1, -1.9,  // 12 historical
                    1.7, 3.8, -0.7, 2.5  // 4 projection
                ];
                
                // Calculate S&P 500 values - SIMPLE INTEREST (no compound, each return based on initial investment)
                const sp500DataRaw = [initialInvestment]; // Month 0
                let cumulativeReturn = 0;
                sp500MonthlyReturns.forEach((returnPercent) => {
                    cumulativeReturn += returnPercent;
                    const monthValue = initialInvestment * (1 + cumulativeReturn / 100);
                    sp500DataRaw.push(monthValue);
                });
                
                // Light smoothing for S&P 500 (2-point average) to reduce sharp peaks but keep volatility visible
                function lightSmooth(data) {
                    const smoothed = [data[0]]; // Keep month 0 unchanged
                    for (let i = 1; i < data.length; i++) {
                        if (i === data.length - 1) {
                            smoothed.push(data[i]);
                        } else {
                            // Average with adjacent points (60% current, 20% each adjacent)
                            smoothed.push(data[i] * 0.6 + data[i - 1] * 0.2 + data[i + 1] * 0.2);
                        }
                    }
                    return smoothed;
                }
                
                const sp500Data = lightSmooth(sp500DataRaw);
                
                // Split S&P 500 data into historical and projection (Month 0 + 12 historical, 4 projection)
                const sp500Historical = sp500Data.slice(0, 13); // Month 0 + 12 months
                const sp500Projection = sp500Data.slice(13, 17); // 4 months
                
                // Banks: constant 0.20% monthly growth - SIMPLE INTEREST (no compound)
                // Ensure it starts from exact same initial investment
                const banksMonthlyGrowth = 0.20; // 0.20% per month
                const banksData = [initialInvestment]; // Month 0 - exact same starting balance
                for (let i = 1; i <= 16; i++) {
                    // Simple interest: add 0.20% of initial investment each month
                    const monthValue = initialInvestment * (1 + (banksMonthlyGrowth * i) / 100);
                    banksData.push(monthValue);
                }
                
                // Split Banks data into historical and projection
                const banksHistorical = banksData.slice(0, 13); // Month 0 + 12 months
                const banksProjection = banksData.slice(13, 17); // 4 months
                
                
                // Combine all data for max/min calculation
                const allData = [...opessociusHistorical, ...projectionData, ...sp500Data, ...banksData];
                const maxValue = Math.max(...allData) * 1.1;
                const minValue = Math.min(...allData) * 0.9;
                const valueRange = maxValue - minValue;
                
                // Store data points for hover
                performanceDataPoints = [];
                
                // Draw grid lines
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 5; i++) {
                    const y = padding.top + (chartHeight / 5) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding.left, y);
                    ctx.lineTo(width - padding.right, y);
                    ctx.stroke();
                }
                
                // Total months: 17 (Month 0 + 12 historical + 4 projection)
                const totalMonths = 17;
                
                // Draw area fill for user investment historical section only (Month 0 + 12 months)
                const gradient = ctx.createLinearGradient(
                    padding.left, 
                    padding.top, 
                    padding.left + (chartWidth / totalMonths) * 13, 
                    padding.top + chartHeight
                );
                gradient.addColorStop(0, 'rgba(37, 99, 235, 0.25)');
                gradient.addColorStop(1, 'rgba(37, 99, 235, 0.05)');
                
                ctx.beginPath();
                const firstX = padding.left + (chartWidth / totalMonths) / 2;
                const firstY = padding.top + chartHeight - ((opessociusHistorical[0] - minValue) / valueRange) * chartHeight;
                ctx.moveTo(firstX, height - padding.bottom);
                ctx.lineTo(firstX, firstY);
                
                opessociusHistorical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    ctx.lineTo(x, y);
                });
                
                const lastHistoricalX = padding.left + (chartWidth / totalMonths) * 12 + (chartWidth / totalMonths) / 2;
                ctx.lineTo(lastHistoricalX, height - padding.bottom);
                ctx.closePath();
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // Draw area fill for S&P 500 historical section only - orange shade (Month 0 + 12 months)
                const sp500Gradient = ctx.createLinearGradient(
                    padding.left, 
                    padding.top, 
                    padding.left + (chartWidth / totalMonths) * 13, 
                    padding.top + chartHeight
                );
                sp500Gradient.addColorStop(0, 'rgba(249, 115, 22, 0.25)');
                sp500Gradient.addColorStop(1, 'rgba(249, 115, 22, 0.05)');
                
                ctx.beginPath();
                const sp500FirstX = padding.left + (chartWidth / totalMonths) / 2;
                const sp500FirstY = padding.top + chartHeight - ((sp500Historical[0] - minValue) / valueRange) * chartHeight;
                ctx.moveTo(sp500FirstX, height - padding.bottom);
                ctx.lineTo(sp500FirstX, sp500FirstY);
                
                sp500Historical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    ctx.lineTo(x, y);
                });
                
                const sp500LastHistoricalX = padding.left + (chartWidth / totalMonths) * 12 + (chartWidth / totalMonths) / 2;
                ctx.lineTo(sp500LastHistoricalX, height - padding.bottom);
                ctx.closePath();
                ctx.fillStyle = sp500Gradient;
                ctx.fill();
                
                // Draw area fill for Banks historical section only - grey shade (Month 0 + 12 months)
                const banksGradient = ctx.createLinearGradient(
                    padding.left, 
                    padding.top, 
                    padding.left + (chartWidth / totalMonths) * 13, 
                    padding.top + chartHeight
                );
                banksGradient.addColorStop(0, 'rgba(107, 114, 128, 0.25)');
                banksGradient.addColorStop(1, 'rgba(107, 114, 128, 0.05)');
                
                ctx.beginPath();
                const banksFirstX = padding.left + (chartWidth / totalMonths) / 2;
                const banksFirstY = padding.top + chartHeight - ((banksHistorical[0] - minValue) / valueRange) * chartHeight;
                ctx.moveTo(banksFirstX, height - padding.bottom);
                ctx.lineTo(banksFirstX, banksFirstY);
                
                banksHistorical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    ctx.lineTo(x, y);
                });
                
                const banksLastHistoricalX = padding.left + (chartWidth / totalMonths) * 12 + (chartWidth / totalMonths) / 2;
                ctx.lineTo(banksLastHistoricalX, height - padding.bottom);
                ctx.closePath();
                ctx.fillStyle = banksGradient;
                ctx.fill();
                
                // Draw Opessocius historical line
                ctx.beginPath();
                ctx.strokeStyle = '#2563eb';
                ctx.lineWidth = 2.5;
                opessociusHistorical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Draw Opessocius projection line (dashed, green)
                ctx.beginPath();
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 2.5;
                ctx.setLineDash([6, 4]);
                projectionData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (13 + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        // Connect to last historical point
                        const lastHistX = padding.left + (chartWidth / totalMonths) * 12 + (chartWidth / totalMonths) / 2;
                        const lastHistY = padding.top + chartHeight - ((opessociusHistorical[12] - minValue) / valueRange) * chartHeight;
                        ctx.moveTo(lastHistX, lastHistY);
                    }
                    ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw S&P 500 historical line (orange) - straight lines to show ups and downs
                ctx.beginPath();
                ctx.strokeStyle = '#f97316';
                ctx.lineWidth = 2.5;
                sp500Historical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Draw S&P 500 projection line (dashed, orange)
                ctx.beginPath();
                ctx.strokeStyle = '#f97316';
                ctx.lineWidth = 2.5;
                ctx.setLineDash([6, 4]);
                sp500Projection.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (13 + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        // Connect to last historical point
                        const lastHistX = padding.left + (chartWidth / totalMonths) * 12 + (chartWidth / totalMonths) / 2;
                        const lastHistY = padding.top + chartHeight - ((sp500Historical[12] - minValue) / valueRange) * chartHeight;
                        ctx.moveTo(lastHistX, lastHistY);
                    }
                    ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw Banks historical line (grey) - constant growth
                ctx.beginPath();
                ctx.strokeStyle = '#6b7280';
                ctx.lineWidth = 2.5;
                banksHistorical.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Draw Banks projection line (dashed, grey)
                ctx.beginPath();
                ctx.strokeStyle = '#6b7280';
                ctx.lineWidth = 2.5;
                ctx.setLineDash([6, 4]);
                banksProjection.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * (13 + index) + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    
                    if (index === 0) {
                        // Connect to last historical point
                        const lastHistX = padding.left + (chartWidth / totalMonths) * 12 + (chartWidth / totalMonths) / 2;
                        const lastHistY = padding.top + chartHeight - ((banksHistorical[12] - minValue) / valueRange) * chartHeight;
                        ctx.moveTo(lastHistX, lastHistY);
                    }
                    ctx.lineTo(x, y);
                });
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw data points for Opessocius investment
                [...opessociusHistorical, ...projectionData].forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    const isHistorical = index < 13; // Month 0 + 12 months
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = isHistorical ? '#2563eb' : '#10b981';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Store for hover
                    const growthPercent = ((value - initialInvestment) / initialInvestment * 100).toFixed(2);
                    performanceDataPoints.push({
                        x: x,
                        y: y,
                        value: value,
                        month: months[index],
                        name: 'Investment',
                        color: isHistorical ? '#2563eb' : '#10b981',
                        growthPercent: growthPercent,
                        isHistorical: isHistorical
                    });
                });
                
                // Draw data points for S&P 500
                sp500Data.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    const isHistorical = index < 13; // Month 0 + 12 months
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = '#f97316';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Store for hover
                    const growthPercent = ((value - initialInvestment) / initialInvestment * 100).toFixed(2);
                    performanceDataPoints.push({
                        x: x,
                        y: y,
                        value: value,
                        month: months[index],
                        name: 'S&P 500',
                        color: '#f97316',
                        growthPercent: growthPercent,
                        isHistorical: isHistorical
                    });
                });
                
                // Draw data points for Banks
                banksData.forEach((value, index) => {
                    const x = padding.left + (chartWidth / totalMonths) * index + (chartWidth / totalMonths) / 2;
                    const y = padding.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;
                    const isHistorical = index < 13; // Month 0 + 12 months
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.strokeStyle = '#6b7280';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Store for hover
                    const growthPercent = ((value - initialInvestment) / initialInvestment * 100).toFixed(2);
                    performanceDataPoints.push({
                        x: x,
                        y: y,
                        value: value,
                        month: months[index],
                        name: 'Banks',
                        color: '#6b7280',
                        growthPercent: growthPercent,
                        isHistorical: isHistorical
                    });
                });
                
                // Draw Y-axis labels (in euros)
                ctx.fillStyle = '#6b7280';
                ctx.font = '12px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                for (let i = 0; i <= 5; i++) {
                    const value = minValue + (valueRange / 5) * (5 - i);
                    const y = padding.top + (chartHeight / 5) * i;
                    const formattedValue = 'â‚¬' + (value / 1000).toFixed(0) + 'k';
                    ctx.fillText(formattedValue, padding.left - 10, y);
                }
                
                // Draw X-axis labels (17 months total: Month 0 + 12 historical + 4 projection)
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                for (let i = 0; i < totalMonths; i += 2) {
                    const x = padding.left + (chartWidth / totalMonths) * i + (chartWidth / totalMonths) / 2;
                    ctx.fillText(months[i], x, height - padding.bottom + 10);
                }
                
                // Draw legend at the top
                const legendY = padding.top - 50;
                const legendX = padding.left;
                const legendItems = [
                    { name: 'Opessocius', color: '#2563eb', risk: '0%' },
                    { name: 'Savings Account', color: '#6b7280', risk: '0%' },
                    { name: 'S&P 500', color: '#f97316', risk: '100%' }
                ];
                
                let currentX = legendX;
                const legendSpacing = 180;
                
                legendItems.forEach((item) => {
                    // Draw colored line
                    ctx.strokeStyle = item.color;
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(currentX, legendY);
                    ctx.lineTo(currentX + 30, legendY);
                    ctx.stroke();
                    
                    // Draw name
                    ctx.fillStyle = '#1f2937';
                    ctx.font = 'bold 13px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                    ctx.textAlign = 'left';
                    ctx.fillText(item.name, currentX + 35, legendY + 5);
                    
                    // Draw risk percentage below
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '11px Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
                    ctx.fillText(`Risk: ${item.risk}`, currentX + 35, legendY + 20);
                    
                    // Move to next position
                    currentX += legendSpacing;
                });
            }
            
            // Setup performance chart hover
            function setupPerformanceChartHover() {
                const canvas = document.getElementById('performance-chart');
                const tooltip = document.getElementById('performance-tooltip');
                if (!canvas || !tooltip) return;
                
                canvas.addEventListener('mousemove', function(e) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Find nearest data point
                    let nearestPoint = null;
                    let minDistance = Infinity;
                    
                    performanceDataPoints.forEach(point => {
                        const distance = Math.sqrt(Math.pow(x - point.x, 2) + Math.pow(y - point.y, 2));
                        if (distance < 30 && distance < minDistance) {
                            minDistance = distance;
                            nearestPoint = point;
                        }
                    });
                    
                    if (nearestPoint) {
                        const formattedValue = 'â‚¬' + nearestPoint.value.toLocaleString('en-US');
                        const growthSign = parseFloat(nearestPoint.growthPercent) >= 0 ? '+' : '';
                        tooltip.innerHTML = `
                            <div class="tooltip-name" style="color: ${nearestPoint.color}; font-weight: 600;">${nearestPoint.name}</div>
                            <div class="tooltip-balance">${formattedValue}</div>
                            <div class="tooltip-growth">${growthSign}${nearestPoint.growthPercent}%</div>
                        `;
                        tooltip.style.display = 'block';
                        tooltip.style.left = (nearestPoint.x + 10) + 'px';
                        tooltip.style.top = (nearestPoint.y - 40) + 'px';
                    } else {
                        tooltip.style.display = 'none';
                    }
                });
                
                canvas.addEventListener('mouseleave', function() {
                    if (tooltip) tooltip.style.display = 'none';
                });
            }
            
            // Setup performance hover after chart is drawn
            setTimeout(setupPerformanceChartHover, 150);

            // Draw dashboard charts when dashboard is shown
            const dashboardViewEl = document.getElementById('dashboard-view');
            if (dashboardViewEl) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            if (dashboardViewEl.style.display !== 'none') {
                                // Load transactions first, then update dashboard metrics
                                populateTransactionsTable().then(() => {
                                    updateDashboardMetrics();
                                    loadTopAccounts();
                                }).catch(() => {
                                    loadTopAccounts();
                                });
                            }
                        }
                    });
                });
                observer.observe(dashboardViewEl, { attributes: true, attributeFilter: ['style'] });
                
                // Also load on initial page load if dashboard is visible
                if (dashboardViewEl.style.display !== 'none') {
                    // Load transactions first, then update dashboard metrics
                    populateTransactionsTable().then(() => {
                        updateDashboardMetrics();
                        loadTopAccounts();
                    }).catch(() => {
                        loadTopAccounts();
                    });
                }
            }
            
            // Update Portfolio Metrics based on transaction data
            function updatePortfolioMetrics() {
                if (!transactionData || transactionData.length === 0) {
                    // Set default values if no data
                    document.getElementById('capital-invested').textContent = 'â‚¬0';
                    document.getElementById('current-balance').textContent = 'â‚¬0';
                    document.getElementById('total-gain').textContent = '0.00%';
                    document.getElementById('portfolio-projection').textContent = 'â‚¬0';
                    return;
                }
                
                // Calculate total capital invested (sum of all deposits)
                let totalCapitalInvested = 0;
                let firstStartingBalance = transactionData[0].starting;
                
                // Sum all deposits
                transactionData.forEach(entry => {
                    totalCapitalInvested += (entry.deposits || 0);
                });
                
                // Initial capital is the first starting balance
                totalCapitalInvested += firstStartingBalance;
                
                // Get latest final balance (ending balance - withdrawals)
                const latestEntry = transactionData[transactionData.length - 1];
                const currentBalance = latestEntry.ending - (latestEntry.withdrawals || 0);
                
                // Calculate total fund gain percentage by summing all transaction growth percentages
                let totalGain = 0;
                transactionData.forEach(entry => {
                    if (entry.growth) {
                        totalGain += entry.growth;
                    }
                });
                
                // Calculate 12-month projection based on average monthly growth
                let projectionValue = currentBalance;
                if (transactionData.length > 1) {
                    // Calculate average monthly growth rate
                    let totalGrowth = 0;
                    let growthCount = 0;
                    transactionData.forEach(entry => {
                        if (entry.growth && entry.growth !== 0) {
                            totalGrowth += entry.growth;
                            growthCount++;
                        }
                    });
                    
                    const avgMonthlyGrowth = growthCount > 0 ? (totalGrowth / growthCount) / 100 : 0.02; // Default to 2% if no growth data
                    
                    // Project 12 months forward with compound growth
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * (1 + avgMonthlyGrowth);
                    }
                } else {
                    // If only one entry, use 2% monthly growth as default
                    const monthlyGrowthRate = 0.02;
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * (1 + monthlyGrowthRate);
                    }
                }
                
                // Update UI elements
                document.getElementById('capital-invested').textContent = 'â‚¬' + Math.round(totalCapitalInvested).toLocaleString('en-US');
                document.getElementById('current-balance').textContent = 'â‚¬' + Math.round(currentBalance).toLocaleString('en-US');
                document.getElementById('total-gain').textContent = (totalGain >= 0 ? '+' : '') + totalGain.toFixed(2) + '%';
                document.getElementById('portfolio-projection').textContent = 'â‚¬' + Math.round(projectionValue).toLocaleString('en-US');
            }
            
            // Update Dashboard Metrics based on transaction data
            function updateDashboardMetrics() {
                if (!transactionData || transactionData.length === 0) {
                    // Set default values if no data
                    const dashboardBalanceEl = document.getElementById('dashboard-current-balance');
                    const dashboardGainEl = document.getElementById('dashboard-total-gain');
                    const dashboardProjectionEl = document.getElementById('dashboard-projection-value');
                    if (dashboardBalanceEl) dashboardBalanceEl.textContent = 'â‚¬0';
                    if (dashboardGainEl) dashboardGainEl.textContent = '0.00%';
                    if (dashboardProjectionEl) dashboardProjectionEl.textContent = 'â‚¬0';
                    // Update capital invested text
                    const dashboardCapitalEl = document.querySelector('#dashboard-view .dashboard-widget[style*="grid-column: 2"] .dashboard-sub-metric');
                    if (dashboardCapitalEl) dashboardCapitalEl.textContent = 'Capital Invested: â‚¬0';
                    // Update profit text
                    const profitElement = dashboardGainEl ? dashboardGainEl.nextElementSibling : null;
                    if (profitElement && profitElement.classList.contains('dashboard-sub-metric')) {
                        profitElement.textContent = 'â‚¬0 profit';
                    }
                    return;
                }
                
                // Get latest final balance (ending balance - withdrawals)
                const latestEntry = transactionData[transactionData.length - 1];
                const currentBalance = latestEntry.ending - (latestEntry.withdrawals || 0);
                
                // Calculate total capital invested
                let totalCapitalInvested = 0;
                const firstStartingBalance = transactionData[0].starting;
                transactionData.forEach(entry => {
                    totalCapitalInvested += (entry.deposits || 0);
                });
                totalCapitalInvested += firstStartingBalance;
                
                // Calculate total fund gain percentage by summing all transaction growth percentages
                let totalGain = 0;
                transactionData.forEach(entry => {
                    if (entry.growth) {
                        totalGain += entry.growth;
                    }
                });
                
                // Calculate 12-month projection
                let projectionValue = currentBalance;
                if (transactionData.length > 1) {
                    let totalGrowth = 0;
                    let growthCount = 0;
                    transactionData.forEach(entry => {
                        if (entry.growth && entry.growth !== 0) {
                            totalGrowth += entry.growth;
                            growthCount++;
                        }
                    });
                    const avgMonthlyGrowth = growthCount > 0 ? (totalGrowth / growthCount) / 100 : 0.02;
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * (1 + avgMonthlyGrowth);
                    }
                } else {
                    const monthlyGrowthRate = 0.02;
                    for (let i = 0; i < 12; i++) {
                        projectionValue = projectionValue * (1 + monthlyGrowthRate);
                    }
                }
                
                // Update dashboard widgets
                const dashboardBalanceEl = document.getElementById('dashboard-current-balance');
                const dashboardGainEl = document.getElementById('dashboard-total-gain');
                const dashboardProjectionEl = document.getElementById('dashboard-projection-value');
                
                if (dashboardBalanceEl) {
                    dashboardBalanceEl.textContent = 'â‚¬' + Math.round(currentBalance).toLocaleString('en-US');
                }
                if (dashboardGainEl) {
                    dashboardGainEl.textContent = (totalGain >= 0 ? '+' : '') + totalGain.toFixed(2) + '%';
                    // Update profit text
                    const profit = currentBalance - totalCapitalInvested;
                    const profitElement = dashboardGainEl.nextElementSibling;
                    if (profitElement && profitElement.classList.contains('dashboard-sub-metric')) {
                        profitElement.textContent = 'â‚¬' + Math.round(profit).toLocaleString('en-US') + ' profit';
                    }
                }
                
                // Update capital invested text
                const dashboardCapitalEl = document.querySelector('#dashboard-view .dashboard-widget[style*="grid-column: 2"] .dashboard-sub-metric');
                if (dashboardCapitalEl) {
                    dashboardCapitalEl.textContent = 'Capital Invested: â‚¬' + Math.round(totalCapitalInvested).toLocaleString('en-US');
                }
                if (dashboardProjectionEl) {
                    dashboardProjectionEl.textContent = 'â‚¬' + Math.round(projectionValue).toLocaleString('en-US');
                }
            }
            
            // Top Accounts Widget Function
            function loadTopAccounts() {
                const container = document.getElementById('top-accounts-list');
                if (!container || typeof investorsData === 'undefined') return;
                
                // Sort accounts by balance (highest first) and get top 5
                const topAccounts = [...investorsData]
                    .sort((a, b) => b.balance - a.balance)
                    .slice(0, 5);
                
                if (topAccounts.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No accounts found.</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                topAccounts.forEach((account, index) => {
                    const returnPercent = ((account.balance - account.initial) / account.initial * 100).toFixed(2);
                    const item = document.createElement('div');
                    item.style.cssText = 'padding: 0.875rem 0; border-bottom: 1px solid #e5e7eb;';
                    if (index === topAccounts.length - 1) {
                        item.style.borderBottom = 'none';
                    }
                    
                    item.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="font-weight: 600; color: #1f2937; font-size: 0.9375rem;">${account.name}</div>
                            <span style="background: #2563eb; color: white; padding: 0.125rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">#${index + 1}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem;">
                            <div style="color: #6b7280;">
                                <div>${account.account}</div>
                                <div style="margin-top: 0.25rem; color: #10b981; font-weight: 600;">+${returnPercent}%</div>
                            </div>
                            <div style="text-align: right; font-weight: 600; color: #1f2937;">
                                â‚¬${account.balance.toLocaleString('en-US')}
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(item);
                });
            }
            
            // Funded Accounts List Functions
            let investorsData = [];
            
            // Funded Account Performance Data - stores performance entries for each funded account
            // Structure: { accountId: [performance entries] }
            let investorPerformanceData = {};
            
            async function loadInvestorsList() {
                const container = document.getElementById('investors-grid');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">Loading accounts...</div>';
                
                try {
                    // Load accounts from Firestore (same collection as Account Settings)
                    if (!window.admin2FirestoreService) {
                        throw new Error('Admin2 Firestore service not loaded');
                    }
                    
                    const firestoreAccounts = await window.admin2FirestoreService.getAllAdmin2Accounts();
                    investorsData = firestoreAccounts.map(account => {
                        const formatted = window.admin2FirestoreService.formatAccountForAdminPortal2(account);
                        return {
                            id: formatted.id,
                            name: formatted.name,
                            email: formatted.email,
                            phone: formatted.phone,
                            account: formatted.account,
                            initial: formatted.initial,
                            balance: formatted.balance,
                            status: formatted.status,
                            type: formatted.type
                        };
                    });
                    
                    container.innerHTML = '';
                    
                    if (investorsData.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);"><p style="margin: 0 0 1rem 0;">No accounts found.</p><p style="margin: 0; font-size: 0.875rem;">Add accounts in Account Settings to track their performance.</p></div>';
                    } else {
                        investorsData.forEach(investor => {
                            const card = document.createElement('div');
                            card.className = 'investor-card';
                            const returnPercent = investor.initial > 0 ? ((investor.balance - investor.initial) / investor.initial * 100).toFixed(2) : '0.00';
                            const performanceCount = investorPerformanceData[investor.id] ? investorPerformanceData[investor.id].length : 0;
                            
                            // Map status to CSS class
                            let statusClass = 'investor-status-active';
                            const statusLower = (investor.status || 'Active').toLowerCase().replace(/\s+/g, '');
                            if (statusLower === 'phase1' || statusLower === 'phase 1') {
                                statusClass = 'investor-status-phase1';
                            } else if (statusLower === 'phase2' || statusLower === 'phase 2') {
                                statusClass = 'investor-status-phase2';
                            } else if (statusLower === 'inactive') {
                                statusClass = 'investor-status-inactive';
                            } else {
                                statusClass = 'investor-status-active';
                            }
                            
                            const returnClass = parseFloat(returnPercent) >= 0 ? 'return-positive' : 'return-negative';
                            const returnSign = parseFloat(returnPercent) >= 0 ? '+' : '';
                            
                            card.innerHTML = `
                                <div class="investor-card-header" style="position: relative;">
                                    <h3>${investor.name || 'Unnamed Account'}</h3>
                                    <span class="investor-status ${statusClass}" style="position: absolute; top: 0; right: 0;">${investor.status}</span>
                                </div>
                                <div class="investor-card-body">
                                    <p><strong>Email:</strong> ${investor.email || 'N/A'}</p>
                                    <p><strong>Account:</strong> ${investor.account || 'N/A'}</p>
                                    <p><strong>Initial Investment:</strong> â‚¬${(investor.initial || 0).toLocaleString('en-US')}</p>
                                    <p><strong>Current Balance:</strong> â‚¬${(investor.balance || 0).toLocaleString('en-US')}</p>
                                    <p><strong>Return:</strong> <span class="${returnClass}">${returnSign}${returnPercent}%</span></p>
                                    <p><strong>Performance Entries:</strong> ${performanceCount}</p>
                                </div>
                                <div class="investor-card-actions" style="display: flex; gap: 0.5rem;">
                                    <button class="admin-btn-save" onclick="openInvestorPerformanceModal('${investor.id}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Add Performance</button>
                                    <button class="admin-btn-view" onclick="viewInvestorPerformance('${investor.id}')">View History</button>
                                </div>
                            `;
                            container.appendChild(card);
                        });
                    }
                } catch (error) {
                    console.error('Error loading investors list:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #dc2626;">Error loading accounts: ' + error.message + '</div>';
                }
            }
            
            function openInvestorPerformanceModal(investorId) {
                const investor = investorsData.find(inv => inv.id === investorId);
                if (!investor) return;
                
                const modal = document.getElementById('investor-performance-modal');
                document.getElementById('investor-performance-modal-title').textContent = `Add Performance - ${investor.name}`;
                document.getElementById('investor-performance-form').reset();
                modal.setAttribute('data-investor-id', investorId);
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function closeInvestorPerformanceModal() {
                document.getElementById('investor-performance-modal').style.display = 'none';
                document.body.style.overflow = '';
            }
            
            function viewInvestorPerformance(investorId) {
                const investor = investorsData.find(inv => inv.id === investorId);
                if (!investor) return;
                
                const modal = document.getElementById('investor-performance-table-modal');
                document.getElementById('investor-performance-table-title').textContent = `Performance History - ${investor.name}`;
                
                const tableBody = document.getElementById('investor-performance-table-body');
                const performanceEntries = investorPerformanceData[investorId] || [];
                
                if (performanceEntries.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #6b7280;">No performance entries yet</td></tr>';
                } else {
                    tableBody.innerHTML = '';
                    let currentBalance = investor.initial;
                    
                    performanceEntries.sort((a, b) => {
                        const yearDiff = a.year - b.year;
                        if (yearDiff !== 0) return yearDiff;
                        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                        return months.indexOf(a.month) - months.indexOf(b.month);
                    });
                    
                    performanceEntries.forEach((entry, index) => {
                        // Starting balance is the ending balance from the previous month (or initial investment for first entry)
                        const startingBalance = index === 0 ? investor.initial : currentBalance;
                        // Ending balance calculation: starting balance + growth - withdrawals
                        // Note: deposits are not included in the calculation as per user request
                        const endingBalance = startingBalance * (1 + entry.growth / 100) - (entry.withdrawals || 0);
                        // This ending balance becomes the starting balance for the next month
                        currentBalance = endingBalance;
                        
                        const row = document.createElement('tr');
                        const withdrawalDisplay = entry.withdrawals > 0 && entry.withdrawalDate
                            ? `â‚¬${entry.withdrawals.toLocaleString('en-US')}<br><span class="transaction-date">${formatDate(entry.withdrawalDate)}</span>`
                            : entry.withdrawals > 0 ? `â‚¬${entry.withdrawals.toLocaleString('en-US')}` : '-';
                        
                        row.innerHTML = `
                            <td>${entry.month} ${entry.year}</td>
                            <td>â‚¬${startingBalance.toLocaleString('en-US')}</td>
                            <td>â‚¬${endingBalance.toLocaleString('en-US')}</td>
                            <td class="${entry.growth >= 0 ? 'growth-positive' : 'growth-negative'}">${entry.growth >= 0 ? '+' : ''}${entry.growth.toFixed(2)}%</td>
                            <td class="transaction-cell">${withdrawalDisplay}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
                
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function closeInvestorPerformanceTableModal() {
                document.getElementById('investor-performance-table-modal').style.display = 'none';
                document.body.style.overflow = '';
            }
            
            window.openInvestorPerformanceModal = openInvestorPerformanceModal;
            window.viewInvestorPerformance = viewInvestorPerformance;
            
            // Funded Account performance form handler
            const investorPerformanceForm = document.getElementById('investor-performance-form');
            if (investorPerformanceForm) {
                investorPerformanceForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const investorId = document.getElementById('investor-performance-modal').getAttribute('data-investor-id');
                    
                    if (!investorId) {
                        alert('Error: Account ID not found.');
                        return;
                    }
                    
                    if (!investorPerformanceData[investorId]) {
                        investorPerformanceData[investorId] = [];
                    }
                    
                    const entry = {
                        month: document.getElementById('performance-month').value,
                        year: parseInt(document.getElementById('performance-year').value),
                        growth: parseFloat(document.getElementById('performance-growth').value),
                        deposits: 0,
                        withdrawals: parseFloat(document.getElementById('performance-withdrawals').value) || 0,
                        depositDate: null,
                        withdrawalDate: document.getElementById('performance-withdrawal-date').value || null
                    };
                    
                    investorPerformanceData[investorId].push(entry);
                    
                    // Update account balance in Firestore
                    const investor = investorsData.find(inv => inv.id === investorId);
                    if (investor && window.admin2FirestoreService) {
                        // Calculate new balance: current balance + growth - withdrawals
                        // Note: deposits are not included in balance calculation
                        const currentBalance = investor.balance || investor.initial || 0;
                        const newBalance = currentBalance * (1 + entry.growth / 100) - (entry.withdrawals || 0);
                        
                        // Update in Firestore
                        window.admin2FirestoreService.updateAdmin2AccountBalance(investorId, newBalance).catch(err => {
                            console.error('Error updating account balance:', err);
                        });
                    }
                    
                    loadInvestorsList();
                    closeInvestorPerformanceModal();
                });
            }
            
            function openInvestorEditModal(id) {
                const investor = investorsData.find(inv => inv.id === id || inv.id === String(id));
                if (!investor) return;
                
                const modal = document.getElementById('investor-edit-modal');
                document.getElementById('edit-investor-name').value = investor.name || '';
                document.getElementById('edit-investor-email').value = investor.email || '';
                document.getElementById('edit-investor-phone').value = investor.phone || '';
                document.getElementById('edit-investor-account').value = investor.account || '';
                document.getElementById('edit-investor-initial').value = investor.initial || 0;
                document.getElementById('edit-investor-balance').value = investor.balance || 0;
                document.getElementById('edit-investor-status').value = investor.status || 'Active';
                modal.setAttribute('data-edit-id', investor.id);
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function closeInvestorEditModal() {
                document.getElementById('investor-edit-modal').style.display = 'none';
                document.body.style.overflow = '';
            }
            
            // Make function global
            window.openInvestorEditModal = openInvestorEditModal;
            
            // Funded Account edit form handler
            const investorEditForm = document.getElementById('investor-edit-form');
            if (investorEditForm) {
                investorEditForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const id = document.getElementById('investor-edit-modal').getAttribute('data-edit-id');
                    const investor = investorsData.find(inv => inv.id === id || inv.id === String(id));
                    if (investor) {
                        investor.name = document.getElementById('edit-investor-name').value;
                        investor.email = document.getElementById('edit-investor-email').value;
                        investor.phone = document.getElementById('edit-investor-phone').value;
                        investor.account = document.getElementById('edit-investor-account').value;
                        investor.initial = parseFloat(document.getElementById('edit-investor-initial').value);
                        investor.balance = parseFloat(document.getElementById('edit-investor-balance').value);
                        investor.status = document.getElementById('edit-investor-status').value;
                        loadInvestorsList();
                        closeInvestorEditModal();
                    }
                });
            }
            
            // Add funded account button
            if (document.getElementById('add-investor-btn')) {
                document.getElementById('add-investor-btn').addEventListener('click', function() {
                    const modal = document.getElementById('investor-edit-modal');
                    document.getElementById('investor-modal-title').textContent = 'Add New Funded Account';
                    document.getElementById('investor-edit-form').reset();
                    modal.removeAttribute('data-edit-id');
                    modal.setAttribute('data-add-mode', 'true');
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                });
            }
            
            
            // Users List Functions
            let usersData = [];
            
            async function loadUsersList() {
                // Make function globally accessible
                window.loadUsersList = loadUsersList;
                const container = document.getElementById('users-grid');
                if (!container) return;
                
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">Loading accounts...</div>';
                
                try {
                    // Load accounts from Firestore
                    if (!window.admin2FirestoreService) {
                        throw new Error('Admin2 Firestore service not loaded');
                    }
                    
                    const firestoreAccounts = await window.admin2FirestoreService.getAllAdmin2Accounts();
                    usersData = firestoreAccounts.map(account => 
                        window.admin2FirestoreService.formatAccountForAdminPortal2(account)
                    );
                    
                    container.innerHTML = '';
                    
                    // Load Admin2 profile settings from Firestore (fresh data)
                    let admin2Data = {
                        name: 'Admin 2',
                        email: 'admin2@opessocius.com',
                        account: 'ADMIN2',
                        status: 'Active',
                        memberSince: '2024-01-01',
                        initial: 8500000,
                        strategy: 'Fund Management'
                    };
                    
                    try {
                        if (window.admin2FirestoreService) {
                            console.log('Loading Admin2 settings for widget display...');
                            const settings = await window.admin2FirestoreService.getAdmin2ProfileSettings();
                            console.log('Admin2 settings loaded for widget:', settings);
                            
                            if (settings) {
                                if (settings.profileName) admin2Data.name = settings.profileName;
                                if (settings.admin2Email) admin2Data.email = settings.admin2Email;
                                if (settings.admin2Account) admin2Data.account = settings.admin2Account;
                                if (settings.admin2Status) admin2Data.status = settings.admin2Status;
                                if (settings.admin2MemberSince) {
                                    // Handle both string dates and Firestore timestamps
                                    if (typeof settings.admin2MemberSince === 'string') {
                                        admin2Data.memberSince = settings.admin2MemberSince;
                                    } else if (settings.admin2MemberSince && settings.admin2MemberSince.toDate) {
                                        // Convert Firestore timestamp to YYYY-MM-DD format
                                        const date = settings.admin2MemberSince.toDate();
                                        const year = date.getFullYear();
                                        const month = String(date.getMonth() + 1).padStart(2, '0');
                                        const day = String(date.getDate()).padStart(2, '0');
                                        admin2Data.memberSince = `${year}-${month}-${day}`;
                                    }
                                }
                                if (settings.admin2Initial !== undefined && settings.admin2Initial !== null) {
                                    admin2Data.initial = parseFloat(settings.admin2Initial) || 0;
                                }
                                if (settings.admin2Strategy) admin2Data.strategy = settings.admin2Strategy;
                            }
                        }
                    } catch (error) {
                        console.error('Error loading Admin2 settings:', error);
                    }
                    
                    // Map status to CSS class
                    let statusClass = 'investor-status-active';
                    const statusLower = (admin2Data.status || 'Active').toLowerCase().replace(/\s+/g, '');
                    if (statusLower === 'phase1' || statusLower === 'phase 1') {
                        statusClass = 'investor-status-phase1';
                    } else if (statusLower === 'phase2' || statusLower === 'phase 2') {
                        statusClass = 'investor-status-phase2';
                    } else if (statusLower === 'inactive') {
                        statusClass = 'investor-status-inactive';
                    } else {
                        statusClass = 'investor-status-active';
                    }
                    
                    // Add predetermined admin widget first
                    const adminCard = document.createElement('div');
                    adminCard.className = 'investor-card';
                    adminCard.innerHTML = `
                        <div class="investor-card-header" style="position: relative;">
                            <h3>${admin2Data.name}</h3>
                            <span class="investor-status ${statusClass}" style="position: absolute; top: 0; right: 0;">Admin</span>
                        </div>
                        <div class="investor-card-body">
                            <p><strong>Type:</strong> Admin</p>
                            <p><strong>Email:</strong> ${admin2Data.email}</p>
                            <p><strong>Account:</strong> ${admin2Data.account}</p>
                            <p><strong>Initial Investment:</strong> â‚¬${(admin2Data.initial || 0).toLocaleString('en-US')}</p>
                            <p><strong>Current Balance:</strong> <span id="admin2-current-balance">â‚¬0</span></p>
                            <p><strong>Total Return:</strong> <span id="admin2-total-return">0.00%</span></p>
                        </div>
                        <div class="investor-card-actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                            <button class="admin-edit-btn" onclick="openAdmin2EditModal()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Edit</button>
                        </div>
                    `;
                    container.appendChild(adminCard);
                    
                    // Update admin2 metrics from transaction data
                    if (transactionData && transactionData.length > 0) {
                        const latestEntry = transactionData[transactionData.length - 1];
                        const currentBalance = latestEntry.ending - (latestEntry.withdrawals || 0);
                        
                        // Calculate total gain
                        let totalGain = 0;
                        transactionData.forEach(entry => {
                            if (entry.growth) {
                                totalGain += entry.growth;
                            }
                        });
                        
                        document.getElementById('admin2-current-balance').textContent = 'â‚¬' + Math.round(currentBalance).toLocaleString('en-US');
                        document.getElementById('admin2-total-return').textContent = (totalGain >= 0 ? '+' : '') + totalGain.toFixed(2) + '%';
                        document.getElementById('admin2-total-return').className = totalGain >= 0 ? 'return-positive' : 'return-negative';
                    }
                    
                    if (usersData.length === 0) {
                        container.innerHTML += '<div style="text-align: center; padding: 2rem; color: #6b7280; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);"><p style="margin: 0 0 1rem 0;">No accounts found.</p><p style="margin: 0; font-size: 0.875rem;">Click "Add New Account" button above to create your first account.</p></div>';
                    } else {
                        usersData.forEach(user => {
                            const card = document.createElement('div');
                            card.className = 'investor-card';
                            const returnPercent = user.initial > 0 ? ((user.balance - user.initial) / user.initial * 100).toFixed(2) : '0.00';
                            const isAdmin = user.type === 'admin';
                            const returnClass = parseFloat(returnPercent) >= 0 ? 'return-positive' : 'return-negative';
                            const returnSign = parseFloat(returnPercent) >= 0 ? '+' : '';
                            // Map status to CSS class
                            let statusClass = 'investor-status-active';
                            const statusLower = (user.status || 'Active').toLowerCase().replace(/\s+/g, '');
                            if (statusLower === 'phase1' || statusLower === 'phase 1') {
                                statusClass = 'investor-status-phase1';
                            } else if (statusLower === 'phase2' || statusLower === 'phase 2') {
                                statusClass = 'investor-status-phase2';
                            } else if (statusLower === 'inactive') {
                                statusClass = 'investor-status-inactive';
                            } else {
                                statusClass = 'investor-status-active';
                            }
                            
                            card.innerHTML = `
                                <div class="investor-card-header" style="position: relative;">
                                    <h3>${user.name || 'Unnamed Account'}</h3>
                                    <span class="investor-status ${statusClass}" style="position: absolute; top: 0; right: 0;">${user.type === 'admin' ? 'Admin' : user.status}</span>
                                </div>
                                <div class="investor-card-body">
                                    <p><strong>Type:</strong> ${user.type === 'admin' ? 'Admin' : 'Investor'}</p>
                                    <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                                    <p><strong>Account:</strong> ${user.account || 'N/A'}</p>
                                    <p><strong>Initial Investment:</strong> â‚¬${(user.initial || 0).toLocaleString('en-US')}</p>
                                    <p><strong>Current Balance:</strong> â‚¬${(user.balance || 0).toLocaleString('en-US')}</p>
                                    <p><strong>Return:</strong> <span class="${returnClass}">${returnSign}${returnPercent}%</span></p>
                                </div>
                                <div class="investor-card-actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                                    <button class="admin-edit-btn" onclick="openUserEditModal('${user.id}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Edit</button>
                                </div>
                            `;
                            container.appendChild(card);
                        });
                    }
                } catch (error) {
                    console.error('Error loading accounts:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #dc2626;">Error loading accounts: ' + error.message + '</div>';
                }
            }
            
            function openAddUserModal() {
                const modal = document.getElementById('user-edit-modal');
                document.getElementById('user-modal-title').textContent = 'Add New Account';
                document.getElementById('user-edit-form').reset();
                modal.removeAttribute('data-edit-id');
                modal.setAttribute('data-add-mode', 'true');
                // Hide delete button when adding new account
                const deleteBtn = document.getElementById('delete-user-btn');
                if (deleteBtn) deleteBtn.style.display = 'none';
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            window.openAddUserModal = openAddUserModal;
            
            function openUserEditModal(id) {
                const user = usersData.find(u => u.id === id);
                if (!user) {
                    console.error('User not found with id:', id);
                    return;
                }
                
                const modal = document.getElementById('user-edit-modal');
                document.getElementById('user-modal-title').textContent = 'Edit Account';
                document.getElementById('edit-user-name').value = user.name || '';
                document.getElementById('edit-user-email').value = user.email || '';
                document.getElementById('edit-user-account').value = user.account || '';
                document.getElementById('edit-user-status').value = user.status || 'Active';
                document.getElementById('edit-user-member-since').value = user.memberSince || '';
                document.getElementById('edit-user-initial').value = user.initial || 0;
                document.getElementById('edit-user-strategy').value = user.strategy || '';
                modal.setAttribute('data-edit-id', id);
                modal.removeAttribute('data-add-mode');
                modal.removeAttribute('data-admin2-mode');
                // Show delete button when editing
                const deleteBtn = document.getElementById('delete-user-btn');
                if (deleteBtn) deleteBtn.style.display = 'block';
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            window.openUserEditModal = openUserEditModal;
            
            async function openAdmin2EditModal() {
                const modal = document.getElementById('user-edit-modal');
                document.getElementById('user-modal-title').textContent = 'Edit Admin 2 Account';
                
                // Load Admin2 account data from profile settings
                let admin2Data = {
                    name: 'Admin 2',
                    email: 'admin2@opessocius.com',
                    account: 'ADMIN2',
                    status: 'Active',
                    memberSince: '2024-01-01',
                    initial: 8500000,
                    strategy: 'Fund Management'
                };
                
                try {
                    if (window.admin2FirestoreService) {
                        console.log('Loading Admin2 data from Firestore...');
                        const settings = await window.admin2FirestoreService.getAdmin2ProfileSettings();
                        console.log('Loaded Admin2 settings from Firestore:', settings);
                        
                        if (settings) {
                            // Load all saved values with proper fallbacks
                            if (settings.profileName) admin2Data.name = settings.profileName;
                            if (settings.admin2Email) admin2Data.email = settings.admin2Email;
                            if (settings.admin2Account) admin2Data.account = settings.admin2Account;
                            if (settings.admin2Status) admin2Data.status = settings.admin2Status;
                            if (settings.admin2MemberSince) {
                                // Handle both string dates and Firestore timestamps
                                if (typeof settings.admin2MemberSince === 'string') {
                                    admin2Data.memberSince = settings.admin2MemberSince;
                                } else if (settings.admin2MemberSince && settings.admin2MemberSince.toDate) {
                                    // Convert Firestore timestamp to YYYY-MM-DD format
                                    const date = settings.admin2MemberSince.toDate();
                                    const year = date.getFullYear();
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const day = String(date.getDate()).padStart(2, '0');
                                    admin2Data.memberSince = `${year}-${month}-${day}`;
                                }
                            }
                            if (settings.admin2Initial !== undefined && settings.admin2Initial !== null) {
                                admin2Data.initial = parseFloat(settings.admin2Initial) || 0;
                            }
                            if (settings.admin2Strategy) admin2Data.strategy = settings.admin2Strategy;
                        }
                    } else {
                        console.warn('Admin2 Firestore service not available');
                    }
                } catch (error) {
                    console.error('Error loading Admin2 data:', error);
                    alert('Error loading Admin2 data: ' + error.message);
                }
                
                console.log('Populating form with Admin2 data:', admin2Data);
                
                // Populate form fields with loaded data
                document.getElementById('edit-user-name').value = admin2Data.name || '';
                document.getElementById('edit-user-email').value = admin2Data.email || '';
                document.getElementById('edit-user-account').value = admin2Data.account || '';
                document.getElementById('edit-user-status').value = admin2Data.status || 'Active';
                document.getElementById('edit-user-member-since').value = admin2Data.memberSince || '';
                document.getElementById('edit-user-initial').value = admin2Data.initial || 0;
                document.getElementById('edit-user-strategy').value = admin2Data.strategy || '';
                
                modal.setAttribute('data-edit-id', 'admin2');
                modal.setAttribute('data-admin2-mode', 'true');
                // Hide delete button for Admin2
                const deleteBtn = document.getElementById('delete-user-btn');
                if (deleteBtn) deleteBtn.style.display = 'none';
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            window.openAdmin2EditModal = openAdmin2EditModal;
            
            function closeUserEditModal() {
                document.getElementById('user-edit-modal').style.display = 'none';
                document.body.style.overflow = '';
            }
            
            async function deleteUserAccount() {
                const modal = document.getElementById('user-edit-modal');
                const accountId = modal.getAttribute('data-edit-id');
                
                if (!accountId) {
                    console.error('No account ID found for deletion');
                    return;
                }
                
                // Confirm deletion
                if (!confirm('Are you sure you want to delete this account? This action cannot be undone.')) {
                    return;
                }
                
                if (!window.admin2FirestoreService) {
                    alert('Error: Firestore service not loaded. Please refresh the page.');
                    return;
                }
                
                try {
                    await window.admin2FirestoreService.deleteAdmin2Account(accountId);
                    console.log('Account deleted:', accountId);
                    
                    // Reload the list
                    await loadUsersList();
                    closeUserEditModal();
                } catch (error) {
                    console.error('Error deleting account:', error);
                    alert('Error deleting account: ' + error.message);
                }
            }
            
            window.deleteUserAccount = deleteUserAccount;
            
            // User edit form handler
            const userEditForm = document.getElementById('user-edit-form');
            if (userEditForm) {
                userEditForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const modal = document.getElementById('user-edit-modal');
                    const isAddMode = modal.getAttribute('data-add-mode') === 'true';
                    const isAdmin2Mode = modal.getAttribute('data-admin2-mode') === 'true';
                    
                    if (!window.admin2FirestoreService) {
                        alert('Error: Firestore service not loaded. Please refresh the page.');
                        return;
                    }
                    
                    // Disable form during submission
                    const submitButton = userEditForm.querySelector('button[type="submit"]');
                    const originalButtonText = submitButton.textContent;
                    submitButton.disabled = true;
                    submitButton.textContent = 'Saving...';
                    
                    try {
                        if (isAddMode) {
                            // Add new account
                            const formData = {
                                name: document.getElementById('edit-user-name').value,
                                email: document.getElementById('edit-user-email').value,
                                phone: '',
                                account: document.getElementById('edit-user-account').value,
                                status: document.getElementById('edit-user-status').value,
                                country: '',
                                memberSince: document.getElementById('edit-user-member-since').value,
                                initial: parseFloat(document.getElementById('edit-user-initial').value) || 0,
                                strategy: document.getElementById('edit-user-strategy').value,
                                operator: '',
                                type: 'investor'
                            };
                            
                            // Validate required fields
                            if (!formData.name || !formData.email || !formData.account) {
                                alert('Please fill in all required fields (Title, Email, Account Number).');
                                submitButton.disabled = false;
                                submitButton.textContent = originalButtonText;
                                return;
                            }
                            
                            // Check for duplicate email
                            const existingAccount = await window.admin2FirestoreService.getAdmin2AccountByEmail(formData.email);
                            if (existingAccount) {
                                alert('An account with this email already exists.');
                                submitButton.disabled = false;
                                submitButton.textContent = originalButtonText;
                                return;
                            }
                            
                            // Create account in Firestore
                            const accountId = await window.admin2FirestoreService.createAdmin2Account(formData);
                            console.log('Account created with ID:', accountId);
                            
                            // Reload the list
                            await loadUsersList();
                            closeUserEditModal();
                        } else if (isAdmin2Mode) {
                            // Edit Admin2 account - save to profile settings
                            const updateData = {
                                name: document.getElementById('edit-user-name').value.trim(),
                                email: document.getElementById('edit-user-email').value.trim(),
                                account: document.getElementById('edit-user-account').value.trim(),
                                status: document.getElementById('edit-user-status').value,
                                memberSince: document.getElementById('edit-user-member-since').value,
                                initial: parseFloat(document.getElementById('edit-user-initial').value) || 0,
                                strategy: document.getElementById('edit-user-strategy').value.trim()
                            };
                            
                            // Validate required fields
                            if (!updateData.name || !updateData.email || !updateData.account) {
                                alert('Please fill in all required fields (Title, Email, Account Number).');
                                submitButton.disabled = false;
                                submitButton.textContent = originalButtonText;
                                return;
                            }
                            
                            // Update profile settings in Firestore
                            try {
                                const settingsToSave = {
                                    profileName: updateData.name,
                                    admin2Email: updateData.email,
                                    admin2Account: updateData.account,
                                    admin2Status: updateData.status,
                                    admin2MemberSince: updateData.memberSince || '',
                                    admin2Initial: updateData.initial,
                                    admin2Strategy: updateData.strategy
                                };
                                
                                console.log('Saving Admin2 settings to Firestore:', settingsToSave);
                                
                                await window.admin2FirestoreService.updateAdmin2ProfileSettings(settingsToSave);
                                
                                // Verify the save by reading it back
                                const savedSettings = await window.admin2FirestoreService.getAdmin2ProfileSettings();
                                console.log('Verified saved Admin2 settings from Firestore:', savedSettings);
                                
                                if (!savedSettings || savedSettings.profileName !== updateData.name) {
                                    throw new Error('Failed to verify saved data. Please try again.');
                                }
                                
                                console.log('Admin2 account updated successfully in Firestore and verified');
                            } catch (error) {
                                console.error('Error updating Admin2 profile settings:', error);
                                alert('Error saving Admin2 account: ' + error.message);
                                submitButton.disabled = false;
                                submitButton.textContent = originalButtonText;
                                return;
                            }
                            
                            // Update profile name in UI immediately
                            const profileNameElement = document.getElementById('sidebar-profile-name');
                            if (profileNameElement) {
                                profileNameElement.textContent = updateData.name;
                            }
                            
                            // Close modal first
                            closeUserEditModal();
                            
                            // Reload the list to refresh Admin2 widget with fresh data from Firestore
                            await loadUsersList();
                            
                            // Re-enable button
                            submitButton.disabled = false;
                            submitButton.textContent = originalButtonText;
                            return;
                        } else {
                            // Edit existing account
                            const accountId = modal.getAttribute('data-edit-id');
                            if (!accountId) {
                                alert('Error: Account ID not found.');
                                submitButton.disabled = false;
                                submitButton.textContent = originalButtonText;
                                return;
                            }
                            
                            const updateData = {
                                name: document.getElementById('edit-user-name').value,
                                email: document.getElementById('edit-user-email').value,
                                account: document.getElementById('edit-user-account').value,
                                status: document.getElementById('edit-user-status').value,
                                memberSince: document.getElementById('edit-user-member-since').value,
                                initial: parseFloat(document.getElementById('edit-user-initial').value) || 0,
                                strategy: document.getElementById('edit-user-strategy').value
                            };
                            
                            // Validate required fields
                            if (!updateData.name || !updateData.email || !updateData.account) {
                                alert('Please fill in all required fields (Title, Email, Account Number).');
                                submitButton.disabled = false;
                                submitButton.textContent = originalButtonText;
                                return;
                            }
                            
                            // Check for duplicate email (excluding current account)
                            const existingAccount = await window.admin2FirestoreService.getAdmin2AccountByEmail(updateData.email);
                            if (existingAccount && existingAccount.id !== accountId) {
                                alert('An account with this email already exists.');
                                submitButton.disabled = false;
                                submitButton.textContent = originalButtonText;
                                return;
                            }
                            
                            // Update account in Firestore
                            await window.admin2FirestoreService.updateAdmin2Account(accountId, updateData);
                            console.log('Account updated:', accountId);
                            
                            // If this is the Admin2 account, update profile name
                            if (accountId === 'admin2' && updateData.name && window.admin2FirestoreService) {
                                await window.admin2FirestoreService.updateAdmin2ProfileSettings({
                                    profileName: updateData.name
                                });
                                // Update UI immediately
                                const profileNameElement = document.getElementById('sidebar-profile-name');
                                if (profileNameElement) {
                                    profileNameElement.textContent = updateData.name;
                                }
                            }
                            
                            // Reload the list
                            await loadUsersList();
                            closeUserEditModal();
                        }
                    } catch (error) {
                        console.error('Error saving account:', error);
                        alert('Error saving account: ' + error.message);
                    } finally {
                        submitButton.disabled = false;
                        submitButton.textContent = originalButtonText;
                    }
                });
            }
            
            // Close modal handlers - set up after DOM is ready
            setTimeout(function() {
                
                const investorModal = document.getElementById('investor-edit-modal');
                if (investorModal) {
                    investorModal.querySelector('.admin-modal-close')?.addEventListener('click', closeInvestorEditModal);
                    investorModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeInvestorEditModal);
                    document.getElementById('cancel-investor-edit')?.addEventListener('click', closeInvestorEditModal);
                }
                
                const investorPerformanceModal = document.getElementById('investor-performance-modal');
                if (investorPerformanceModal) {
                    investorPerformanceModal.querySelector('.admin-modal-close')?.addEventListener('click', closeInvestorPerformanceModal);
                    investorPerformanceModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeInvestorPerformanceModal);
                    document.getElementById('cancel-investor-performance')?.addEventListener('click', closeInvestorPerformanceModal);
                }
                
                const investorPerformanceTableModal = document.getElementById('investor-performance-table-modal');
                if (investorPerformanceTableModal) {
                    investorPerformanceTableModal.querySelector('.admin-modal-close')?.addEventListener('click', closeInvestorPerformanceTableModal);
                    investorPerformanceTableModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeInvestorPerformanceTableModal);
                }
                
                const userModal = document.getElementById('user-edit-modal');
                if (userModal) {
                    userModal.querySelector('.admin-modal-close')?.addEventListener('click', closeUserEditModal);
                    userModal.querySelector('.admin-modal-overlay')?.addEventListener('click', closeUserEditModal);
                    document.getElementById('cancel-user-edit')?.addEventListener('click', closeUserEditModal);
                    document.getElementById('delete-user-btn')?.addEventListener('click', deleteUserAccount);
                }
            }, 100);
            
            // Admin2 Profile Picture Functions (matching adminportal.html style)
            function loadAdmin2ProfilePicture(profilePictureUrl) {
                const profileImg = document.getElementById('admin2-profile-picture-img');
                const placeholder = document.getElementById('admin2-profile-picture-placeholder');
                
                if (profilePictureUrl && profilePictureUrl.trim() !== '') {
                    profileImg.src = profilePictureUrl;
                    profileImg.style.display = 'block';
                    if (placeholder) placeholder.style.display = 'none';
                } else {
                    profileImg.style.display = 'none';
                    if (placeholder) placeholder.style.display = 'flex';
                }
            }
            
            // Setup admin2 profile picture upload
            const admin2ProfileContainer = document.getElementById('admin2-profile-picture-container');
            const admin2ProfileInput = document.getElementById('admin2-profile-picture-input');
            const admin2ProfileOverlay = admin2ProfileContainer?.querySelector('.profile-picture-upload-overlay');
            const profileNameElement = document.getElementById('sidebar-profile-name');
            
            if (admin2ProfileContainer && admin2ProfileInput) {
                // Show overlay on hover
                admin2ProfileContainer.addEventListener('mouseenter', function() {
                    if (admin2ProfileOverlay) admin2ProfileOverlay.style.display = 'flex';
                });
                
                admin2ProfileContainer.addEventListener('mouseleave', function() {
                    if (admin2ProfileOverlay) admin2ProfileOverlay.style.display = 'none';
                });
                
                // Click to upload
                admin2ProfileContainer.addEventListener('click', function() {
                    admin2ProfileInput.click();
                });
                
                // Handle file selection
                admin2ProfileInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file.');
                        return;
                    }
                    
                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Image size must be less than 5MB.');
                        return;
                    }
                    
                    try {
                        // Show loading state - use spinner
                        const profileImg = document.getElementById('admin2-profile-picture-img');
                        const placeholder = document.getElementById('admin2-profile-picture-placeholder');
                        if (placeholder) {
                            placeholder.innerHTML = '<div style="width: 20px; height: 20px; border: 2px solid #6b7280; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>';
                            placeholder.style.opacity = '0.7';
                        }
                        
                        // Convert image to base64 data URL (matching adminportal.html approach)
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            try {
                                const base64DataUrl = e.target.result;
                                
                                // Store admin2 profile picture in sessionStorage
                                sessionStorage.setItem('admin2ProfilePicture', base64DataUrl);
                                
                                // Also save to Firestore
                                if (window.admin2FirestoreService) {
                                    try {
                                        await window.admin2FirestoreService.updateAdmin2ProfileSettings({
                                            profilePictureUrl: base64DataUrl
                                        });
                                        console.log('Profile picture saved to Firestore');
                                    } catch (error) {
                                        console.error('Error saving profile picture to Firestore:', error);
                                        // Don't show alert here as the image is already in sessionStorage
                                    }
                                }
                                
                                // Update display
                                loadAdmin2ProfilePicture(base64DataUrl);
                                
                                // Reset placeholder opacity
                                if (placeholder) {
                                    placeholder.style.opacity = '1';
                                }
                                
                                console.log('Admin2 profile picture updated successfully');
                            } catch (error) {
                                console.error('Error saving admin2 profile picture:', error);
                                alert('Error saving profile picture: ' + error.message);
                                if (placeholder) {
                                    placeholder.innerHTML = '<span>ðŸ‘¤</span>';
                                    placeholder.style.opacity = '1';
                                }
                            }
                        };
                        
                        reader.onerror = function(error) {
                            console.error('Error reading file:', error);
                            alert('Error reading image file.');
                            if (placeholder) {
                                placeholder.innerHTML = '<span>ðŸ‘¤</span>';
                                placeholder.style.opacity = '1';
                            }
                        };
                        
                        reader.readAsDataURL(file);
                    } catch (error) {
                        console.error('Error uploading profile picture:', error);
                        alert('Error uploading profile picture: ' + error.message);
                    }
                });
            }
            
            // Load Profile Settings
            async function loadProfileSettings() {
                const profileNameElement = document.getElementById('sidebar-profile-name');
                
                try {
                    // First, try to load from sessionStorage for immediate display
                    const sessionPic = sessionStorage.getItem('admin2ProfilePicture');
                    if (sessionPic) {
                        loadAdmin2ProfilePicture(sessionPic);
                    }
                    
                    // Then load from Firestore (which will override sessionStorage if available)
                    if (!window.admin2FirestoreService) {
                        // If no service, use sessionStorage defaults
                        if (!sessionPic && profileNameElement) {
                            profileNameElement.textContent = 'Admin 2';
                        }
                        return;
                    }
                    
                    const settings = await window.admin2FirestoreService.getAdmin2ProfileSettings();
                    
                    if (settings) {
                        // Update profile picture if available (prefer Firestore over sessionStorage)
                        if (settings.profilePictureUrl) {
                            loadAdmin2ProfilePicture(settings.profilePictureUrl);
                            // Also update sessionStorage to keep them in sync
                            sessionStorage.setItem('admin2ProfilePicture', settings.profilePictureUrl);
                        } else if (sessionPic) {
                            // If Firestore doesn't have it but sessionStorage does, keep sessionStorage
                            loadAdmin2ProfilePicture(sessionPic);
                        }
                        
                        // Update profile name if available
                        if (settings.profileName && profileNameElement) {
                            profileNameElement.textContent = settings.profileName;
                        } else if (profileNameElement) {
                            profileNameElement.textContent = 'Admin 2';
                        }
                    } else {
                        // No settings in Firestore, use sessionStorage or defaults
                        if (!sessionPic && profileNameElement) {
                            profileNameElement.textContent = 'Admin 2';
                        }
                    }
                } catch (error) {
                    console.error('Error loading profile settings:', error);
                    // Set default name on error
                    if (profileNameElement) {
                        profileNameElement.textContent = 'Admin 2';
                    }
                    // Try sessionStorage as fallback for picture
                    const sessionPic = sessionStorage.getItem('admin2ProfilePicture');
                    if (sessionPic) {
                        loadAdmin2ProfilePicture(sessionPic);
                    }
                }
            }
            
            // Load profile settings on page load (after a short delay to ensure Firebase is initialized)
            setTimeout(() => {
                loadProfileSettings();
            }, 500);
            
            // Initial draw if dashboard is visible (already handled above with populateTransactionsTable)

            // Redraw chart on window resize
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    if (portfolioView && portfolioView.style.display !== 'none') {
                        drawPortfolioChart();
                    }
                    if (performanceView && performanceView.style.display !== 'none') {
                        drawPerformanceChart();
                        setTimeout(setupPerformanceChartHover, 150);
                    }
                    // Dashboard widgets resized
                }, 250);
            });
    });
    </script>
</body>
</html>

